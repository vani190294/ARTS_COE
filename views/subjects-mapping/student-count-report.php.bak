<?php

use yii\helpers\Html;
use yii\widgets\ActiveForm;
use yii\helpers\ArrayHelper;
use yii\helpers\Url;
use app\assets\AppAsset;
use app\models\Batch;
use app\models\StudentMapping;
use kartik\widgets\Select2;
use app\components\ConfigConstants;
use app\components\ConfigUtilities;
use kartik\dialog\Dialog;
use yii\db\Query;


echo Dialog::widget();
$batch_id = isset($subjects->batch_mapping_id)?$subjects->batchMapping->coeBatch->coe_batch_id:"";
$year= isset($_POST['mark_year'])?$_POST['mark_year']:date('Y');

$this->title = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)." COUNT REPORT";
?>
<h1><?php echo $this->title;     ?></h1>
<style type="text/css">
.left-padding
{
    margin-left: -10px; 
    padding-right: -0px;
}
.righh-padding
{
    padding-right: -0px;
}
</style>

<div class="subjects-form">
<div class="box box-success">
<div class="box-body"> 
   
     <?php Yii::$app->ShowFlashMessages->showFlashes();?>
<div>&nbsp;</div>

    <?php 
    $condition = $model->isNewRecord?true:false;
    $form = ActiveForm::begin([
                    'id' => 'categories-form',
                    'enableAjaxValidation' => $condition,
                    'fieldConfig' => [
                    'template' => "{label}{input}{error}",

                    ],
            ]); ?>

    <div class="col-xs-12 col-sm-12 col-lg-12">
        <div class="col-xs-12 col-sm-12 col-lg-12">
            <div class="col-lg-2 col-sm-2">
                <?php echo $form->field($model,'coe_batch_id')->widget(
                    Select2::classname(), [
                        'data' => ConfigUtilities::getBatchDetails(),
                        
                        'options' => [
                            'placeholder' => '-----Select '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH).' ----',
                            'id' => 'batch_id',
                            'value'=> $batch_id,
                            'name'=>'bat_val',
                        ],
                       'pluginOptions' => [
                           'allowClear' => true,
                        ],
                    ])->label(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH)); 
                ?>
            </div>

            <div class="col-sm-2">
                <?php if(!empty($semester)){ $semester=$semester;}else{$semester='';}    ?>
                        <?= $form->field($model, 'semester1')->textInput(['value' => "$semester"]) ?>

                    </div>
           
            
            <div class="col-lg-4 col-sm-4">
                <br />
                <?= Html::submitButton( 'Get', ['class' =>  'btn btn-success']) ?>

                <?= Html::a('Reset', ['student-count-report'], ['class' => 'btn btn-default']) ?> 
        </div>
        </div>

    <?php ActiveForm::end(); ?>

<?php $print_pdf = Html::a('<i class="fa fa-file-pdf-o"></i> PDF', ['/subjects-mapping/student-count-report-pdf'], [
                    'class'=>'pull-right btn btn-block btn-primary', 
                    'target'=>'_blank', 
                    'data-toggle'=>'tooltip', 
                    'title'=>'Will open the generated PDF file in a new window'
                ]);  
$print_excel = Html::a('<i class="fa fa-file-pdf-o"></i> EXCEL', ['/subjects-mapping/student-count-report-excel'], [
                    'class'=>'pull-right btn btn-block btn-warning', 
                    'target'=>'_blank', 
                    'data-toggle'=>'tooltip', 
                    'title'=>'Will open the generated PDF file in a new window'
                ]); 
?>

 
</div>
</div>
</div>

<?php 
if(isset($content_1))
{

?>
<div class="box box-primary">
    <div class="box-body">
        <div class="row" >
            <div class="col-xs-12" >
                <div class="col-lg-12" > 
                    <div class="col-lg-2" > 
                    <?php echo $print_excel.$print_pdf; ?> </div>
                    </div>
                <div class="col-lg-12"  style="overflow-x:auto;"> 
                    <?php 
                    require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                    $html = $body ='';

                    $html .='<table  style="overflow-x:auto;" width="100%"  cellspacing="0" cellpadding="0" border="0" class="table table-bordered table-responsive dum_edit_table table-hover" >
                        <tr>
                         
                          <td colspan=16 align="center"> 
                              <center><b><font size="6px">'.$org_name.'</font></b></center>
                              <center> <font size="3px">'.$org_address.'</font></center>
                              <center> Phone : <b>'.$org_phone.'</b></center>
                              <center class="tag_line"><b>'.$org_tagline.'</b></center> 
                         </td>
                        
                        </tr> 
                        <tr>
                            <td colspan=16 align="center"><b>SEMESTER : '.$semester.'
                            </b></td>
                        </tr>
                        <tr class="table-danger">
                            
                            <th rowspan="2">SNO</th>                
                            <th rowspan="2">'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH)).'</th>
                            <th rowspan="2">'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE)).'</th>
                            <th rowspan="2">'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)).'</th>
                            <th rowspan="2"> COUNT</th>
                            <th colspan="4" style="text-align:center;">CURRENT SEM</th>
                             <th colspan="4" style="text-align:center;">TOTAL</th>
                            <th rowspan="2">LATERAL ENTRY</th>
                            <th rowspan="2">GENERAL</th>
                            <th rowspan="2">ACTIVE COUNT</th>
                        </tr>   
                        <tr>
                            
                            <th>DETAIN/DEBAR</th>
                            <th>DISCONTINUED</th>
                            <th>REJOIN</th>
                            <th>TRANSFER</th>

                            <th>DETAIN/DEBAR</th>
                            <th>DISCONTINUED</th>
                            <th>REJOIN</th>
                            <th>TRANSFER</th>
                        </tr>
                        ';
                        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

                        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
                        $transfer = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%TRANSFER%'")->queryScalar();

                        $rejoin_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%rejoin%'")->queryScalar();
                         $latearl = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Lateral Entry%'")->queryScalar();
                         

                        $sn_no = 1;
                        $detain_total = $ug_count = $pg_count = $others_count_total = $transfer_total = $rejoin_total =$latearl_total= $disc_total=$first_year_count = $GRAND_TOTAL = $total_strength = 0;

                         $detain_total_sem = $transfer_total_sem = $rejoin_total_sem = $disc_total_sem=0;

                        $detain_total_phd = $ug_count_phd = $pg_count_phd = $others_count_total_phd = $transfer_total_phd = $rejoin_total_phd = $ACTIVE_count_php = $disc_total_phd =$latearl_total_phd=$first_year_count_phd  = $GRAND_TOTAL_phd = $total_strength_phd = $printed = $phd_printed  = 0;
                        $body_phd= '';

                        $pg_general_count=0;
                       
                        foreach ($content_1 as $key => $value) 
                        {
                            //$detain_count1 = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$det_cat_type]);
                            //echo "<br>".$detain_count1->createCommand()->getRawSql();
                            $detain_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$det_cat_type])->all();
                            $detain_total +=count($detain_count); 
                            $detain_disp = count($detain_count)==0?'-':count($detain_count);


                            $query_detain_count_sem = new Query();
                            $query_detain_count_sem->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['a.semester_detain'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$value['course_batch_mapping_id']])
                              ->andWhere(['=', 'a.status_category_type_id', $det_cat_type]);
                            //echo "<br>".$query_detain_count_sem->createCommand()->getRawSql();
                            $stu_detain_count_sem = $query_detain_count_sem->createCommand()->queryAll();

                             $detain_count_sem=$stu_detain_count_sem[0]['count']; 
                             $detain_total_sem +=$detain_count_sem;
                             $detain_disp_sem = $detain_count_sem;
                            
                           // $disc_count1 = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$det_disc_type]);
                            //echo "<br>".$disc_count1->createCommand()->getRawSql();
                            $disc_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$det_disc_type])->all();
                            $disc_total +=count($disc_count); 
                            $disc_disp = count($disc_count)==0?'-':count($disc_count);

                             $query_disc_count_sem = new Query();
                            $query_disc_count_sem->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['a.semester_detain'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$value['course_batch_mapping_id']])
                              ->andWhere(['=', 'a.status_category_type_id', $det_disc_type]);
                            
                            $stu_disc_count_sem = $query_disc_count_sem->createCommand()->queryAll();

                             $disc_count_sem=$stu_disc_count_sem[0]['count']; 
                             $disc_total_sem +=$disc_count_sem;
                             $disc_disp_sem = $disc_count_sem;
                            

                            $rejoin_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$rejoin_type])->all();
                            $rejoin_total +=count($rejoin_count); 
                            $rejoin_dip = count($rejoin_count)==0?'-':count($rejoin_count);

                            $query_rejoin_count_sem = new Query();
                            $query_rejoin_count_sem->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['a.semester_detain'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$value['course_batch_mapping_id']])
                              ->andWhere(['=', 'a.status_category_type_id', $rejoin_type]);
                           $stu_rejoin_count_sem = $query_rejoin_count_sem->createCommand()->queryAll();

                             $rejoin_count_sem=$stu_rejoin_count_sem[0]['count']; 
                             $rejoin_total_sem +=$rejoin_count_sem;
                             $rejoin_dip_sem = $rejoin_count_sem;
                            

                            $transfer_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$transfer])->all();
                            $transfer_total +=count($transfer_count); 
                            $transfer_count_dip = count($transfer_count)==0?'-':count($transfer_count);

                             $query_transfer_count_sem = new Query();
                            $query_transfer_count_sem->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['a.semester_detain'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$value['course_batch_mapping_id']])
                              ->andWhere(['=', 'a.status_category_type_id', $transfer]);
                            
                            $stu_transfer_count_sem = $query_transfer_count_sem->createCommand()->queryAll();

                             $transfer_count_sem=$stu_transfer_count_sem[0]['count']; 
                             $transfer_total_sem +=$transfer_count_sem;
                             $transfer_count_dip_sem = $transfer_count_sem;

                            $lateral_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id'],'status_category_type_id'=>$latearl])->all();
                            $latearl_total +=count($lateral_count); 
                            $lateral_count_dip = count($lateral_count)==0?'-':count($lateral_count);
                            

                            $others_count = StudentMapping::find()->where(['course_batch_mapping_id'=>$value['course_batch_mapping_id']])->andWhere(['NOT IN','status_category_type_id',[$transfer,$rejoin_type,$det_disc_type,$det_cat_type,$latearl]])->all();

                            $others_count_total +=(count($others_count)==0 || count($others_count)=='' )?0:count($others_count); 
                            $other_disp = count($others_count)==0?'-':count($others_count);
                            

                            $ACTIVE_count = $other_disp+$transfer_count_dip+$rejoin_dip+$lateral_count_dip; 
                            $active_final_disp = count($ACTIVE_count)==0?'-':$ACTIVE_count;

                            $checkStuInfo = new Query();
                            $checkStuInfo->select(['count(distinct coe_student_mapping_id) as count'])
                                ->from('coe_student_mapping as A')            
                                ->JOIN('JOIN','coe_bat_deg_reg as B','B.coe_bat_deg_reg_id=A.course_batch_mapping_id')
                                ->JOIN('JOIN','coe_batch as C','C.coe_batch_id=B.coe_batch_id')
                                ->JOIN('JOIN','coe_degree as D','D.coe_degree_id=B.coe_degree_id')
                                ->JOIN('JOIN','coe_programme as E','E.coe_programme_id=B.coe_programme_id')
                                ->Where(['B.coe_batch_id' => $batch_id_value, 'C.coe_batch_id' => $batch_id_value,'A.course_batch_mapping_id'=>$value['course_batch_mapping_id']]);

                            $strength = $checkStuInfo->createCommand()->queryAll();

                             $strength_count=$strength[0]['count'];
                            
                            if($value['degree_type']=='PG' && $printed==0 &&$value['degree_code']!=='Ph.D' )
                            {
                                $others_count_total_disp = $others_count_total-((count($others_count)==0 || count($others_count)=='' )?0:count($others_count));
                                $body .='<tr><td colspan=4 algin="right" ><strong>TOTAL STRENGTH UG</strong></td>';
                                $body .='<td>'.$total_strength.'</td>';
                                $body .='<td>'.$detain_total_sem.'</td>';
                                 $body .='<td>'.$disc_total_sem.'</td>';
                                 $body .='<td>'.$rejoin_total_sem.'</td>';
                                $body .='<td>'.$transfer_total_sem.'</td>';
                                $body .='<td>'.$detain_total.'</td>';
                                $body .='<td>'.$disc_total.'</td>';
                                $body .='<td>'.$rejoin_total.'</td>';
                                $body .='<td>'.$transfer_total.'</td>';
                                $body .='<td>'.$latearl_total.'</td>';
                                $body .='<td>'.$others_count_total_disp.'</td>';
                                $body .='<td>'.$GRAND_TOTAL.'</td></tr>';

                                $detain_total = $ug_count = $pg_count = $others_count_total = $transfer_total =$latearl_total= $rejoin_total = $disc_total = $GRAND_TOTAL = $total_strength = 0;
                                $others_count_total +=((count($others_count)==0 || count($others_count)=='' )?0:count($others_count));
                                $printed = 1; $pg_general_count=0;
                                $detain_total_sem = $transfer_total_sem = $rejoin_total_sem = $disc_total_sem=0;
                            }
                            
                            if($value['degree_type']=='PG' && ($value['degree_code']=='Ph.D' || $value['degree_code']=='Ph.d') )
                            {
                                $body_phd .='<tr>';
                                $body_phd .='<td>'.$sn_no.'</td>';
                                $body_phd .='<td>'.$value['batch_name'].'</td>';
                                $body_phd .='<td>'.$value['degree_code'].'</td>';
                                $body_phd .='<td>'.strtoupper($value['programme_name']).'</td>';
                                $body_phd .='<td>'.$strength_count.'</td>';
                                 $body_phd .='<td>'.$detain_disp_sem.'</td>';
                                 $body_phd .='<td>'.$disc_disp_sem.'</td>';
                                 $body_phd .='<td>'.$rejoin_dip_sem.'</td>';
                                 $body_phd .='<td>'.$transfer_count_dip_sem.'</td>';
                                $body_phd .='<td>'.$detain_disp.'</td>';
                                $body_phd .='<td>'.$disc_disp.'</td>';
                                $body_phd .='<td>'.$rejoin_dip.'</td>';
                                $body_phd .='<td>'.$transfer_count_dip.'</td>';
                                $body_phd .='<td>'.$lateral_count_dip.'</td>';
                                $body_phd .='<td>'.$other_disp.'</td>';
                                $body_phd .='<td>'.$active_final_disp.'</td></tr>';

                                $detain_total_phd +=count($detain_count); 
                                $disc_total_phd +=count($disc_count); 
                                $rejoin_total_phd +=count($rejoin_count); 
                                $transfer_total_phd +=count($transfer_count); 
                                $latearl_total_phd+=count($lateral_count);
                                $ACTIVE_count_php = $other_disp+$transfer_count_dip+$rejoin_dip+$lateral_count_dip; 

                                $others_count_total_phd +=(count($others_count)==0 || count($others_count)=='' )?0:count($others_count); 
                                $GRAND_TOTAL_phd +=$active_final_disp;
                                $total_strength_phd +=$strength_count;
                                $phd_printed = 1;
                            }
                            
                           
                            if($value['degree_type']=='UG')
                            {
                                $body .='<tr>';
                                $body .='<td>'.$sn_no.'</td>';
                                $body .='<td>'.$value['batch_name'].'</td>';
                                $body .='<td>'.$value['degree_code'].'</td>';
                                $body .='<td>'.strtoupper($value['programme_name']).'</td>';
                                $body .='<td>'.$strength_count.'</td>';
                                $body .='<td>'.$detain_disp_sem.'</td>';
                                 $body .='<td>'.$disc_disp_sem.'</td>';
                                 $body .='<td>'.$rejoin_dip_sem.'</td>';
                                 $body .='<td>'.$transfer_count_dip_sem.'</td>';
                                $body .='<td>'.$detain_disp.'</td>';
                                $body .='<td>'.$disc_disp.'</td>';
                                $body .='<td>'.$rejoin_dip.'</td>';
                                $body .='<td>'.$transfer_count_dip.'</td>';
                                 $body .='<td>'.$lateral_count_dip.'</td>';
                                $body .='<td>'.$other_disp.'</td>';
                                $body .='<td>'.$active_final_disp.'</td></tr>';
                                $sn_no++;

                                 $GRAND_TOTAL +=$active_final_disp;
                                $total_strength +=$strength_count;
                                 
                            }

                            if(($value['degree_type']=='PG') && ($value['degree_code']!='Ph.D') && ($value['semester']<=$semester && $value['degree_total_semesters']>=$semester))
                            {
                                $body .='<tr>';
                                $body .='<td>'.$sn_no.'</td>';
                                $body .='<td>'.$value['batch_name'].'</td>';
                                $body .='<td>'.$value['degree_code'].'</td>';
                                $body .='<td>'.strtoupper($value['programme_name']).'</td>';
                                $body .='<td>'.$strength_count.'</td>';
                                $body .='<td>'.$detain_disp_sem.'</td>';
                                 $body .='<td>'.$disc_disp_sem.'</td>';
                                 $body .='<td>'.$rejoin_dip_sem.'</td>';
                                 $body .='<td>'.$transfer_count_dip_sem.'</td>';
                                $body .='<td>'.$detain_disp.'</td>';
                                $body .='<td>'.$disc_disp.'</td>';
                                $body .='<td>'.$rejoin_dip.'</td>';
                                $body .='<td>'.$transfer_count_dip.'</td>';
                                 $body .='<td>'.$lateral_count_dip.'</td>';
                                $body .='<td>'.$other_disp.'</td>';
                                $body .='<td>'.$active_final_disp.'</td></tr>';
                                $sn_no++;

                                 $GRAND_TOTAL +=$active_final_disp;
                                $total_strength +=$strength_count;
                                $pg_general_count+=$other_disp;
                                 
                            }
                        }

                        if($total_strength>'0')
                       {
                            $body .='<tr><td colspan=4 algin="center" ><strong>TOTAL STRENGTH PG</strong> </td>';
                            $body .='<td>'.$total_strength.'</td>';
                            $body .='<td>'.$detain_total_sem.'</td>';
                                 $body .='<td>'.$disc_total_sem.'</td>';
                                 $body .='<td>'.$rejoin_total_sem.'</td>';
                                $body .='<td>'.$transfer_total_sem.'</td>';
                                $body .='<td>'.$detain_total.'</td>';
                                $body .='<td>'.$disc_total.'</td>';
                                $body .='<td>'.$rejoin_total.'</td>';
                                $body .='<td>'.$transfer_total.'</td>';
                            $body .='<td>'.$latearl_total.'</td>';
                            $body .='<td>'.$pg_general_count.'</td>';
                            $body .='<td>'.$GRAND_TOTAL.'</td></tr>';
                      }
                      /*  if($phd_printed==1)
                        {
                            $body .=$body_phd.'<tr><td colspan=4 algin="center" ><strong>TOTAL STRENGTH PH.D</strong> </td><td>'.$total_strength_phd.'</td><td>'.$detain_total_phd.'</td><td>'.$disc_total_phd.'</td><td>'.$rejoin_total_phd.'</td><td>'.$transfer_total_phd.'</td><td>'.$latearl_total_phd.'</td><td>'.$others_count_total_phd.'</td><td>'.$GRAND_TOTAL_phd.'</td></tr>';    
                        }*/
                        echo $html .='<tbody id="show_dummy_numbers" style="font-weight:bold !important"> '.$body.'</tbody> </table>'; 

                        if(isset($_SESSION['student_count_repo']))
                        {
                            unset($_SESSION['student_count_repo']);
                        }
                        $_SESSION['student_count_repo'] = $html;

                    ?>


                </div>
            </div>
         </div>
    </div>
</div>

<?php 
}
?>

</div>