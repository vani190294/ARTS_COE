<?php
namespace app\controllers;
use Yii;
use kartik\mpdf\Pdf;
use yii\helpers\Html;
use app\models\MarkEntry;
use app\models\AbsentEntry;
use app\models\ExamTimetable;
use app\models\CoeBatDegReg;
use app\models\Degree;
use app\models\Programme;
use app\models\Batch;
use app\models\Categories;
use app\models\MandatorySubjects;
use app\models\MarkEntrySearch;
use app\models\MarkEntryMaster;
use app\models\MarkEntryMasterSearch;
use app\models\Categorytype;
use app\models\Student;
use app\models\StuInfo;
use app\models\SubInfo;
use app\models\StudentMapping;
use app\models\Subjects;
use app\models\Regulation;
use app\models\Revaluation;
use app\models\SubjectsMapping;
use app\models\HallAllocate;
use app\models\DummyNumbers;
use app\models\AdditionalCredits;
use app\models\StudentCategoryDetails;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
use yii\filters\VerbFilter;
use app\components\ConfigConstants;
use app\components\ConfigUtilities;
use app\models\ExternalWightageMarks;
use yii\db\Query;
use yii\helpers\Json;
use PHPExcel;
use PHPExcel_IOFactory;
use PHPExcel_Cell;
use PHPExcel_Style_Fill;
use PHPExcel_Style_Alignment;
use app\models\MarkEntryMasterTemp;
use app\models\PracticalEntry;
error_reporting(0);
/**
 * MarkEntryController implements the CRUD actions for MarkEntry model.
 */
class MarkEntryController extends Controller
{
    /**
     * @inheritdoc
    **/
    public function behaviors()
    {
        return [
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => [
                    'delete' => ['POST'],
                ],
            ],
        ];
    }
    /**
     * Lists all MarkEntry models.
     * @return mixed
    **/
    public function actionIndex()
    {
        $searchModel = new MarkEntrySearch();
        $dataProvider = $searchModel->search(Yii::$app->request->queryParams);
        return $this->render('index', [
            'searchModel' => $searchModel,
            'dataProvider' => $dataProvider,
        ]);
    }
    /**
     * Lists all MarkEntry models.
     * @return mixed
     * @throws \yii\db\Exception
     */
    public function actionMarkStatement()
    {
        $model = new MarkEntry();
        $student = new Student();
        
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $det_transfer= Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();


        if (isset($_POST['get_marks']) && Yii::$app->request->post() && !empty($_POST['bat_map_val'])) 
        {            
            $get_batc_map = CoeBatDegReg::findOne($_POST['bat_map_val']);
            $deg_info = Degree::findOne($get_batc_map->coe_degree_id);
            $print_trimester = (($deg_info->degree_total_semesters/2)==3 && $deg_info->degree_code=='MBA') ? 1: 0;
            $top_margin = $_POST['top_margin'];
            $bottom_margin = $_POST['bottom_margin'];
            $count_of_subs = $_POST['count_of_subs']=='' || empty($_POST['count_of_subs'])?23:$_POST['count_of_subs'];
            $mark_statement_type = $_POST['deg_credit_type'];
            

         $query = new  Query();
            $query->select('G.paper_no,F.student_map_id,H.subject_code,  A.name, A.register_number, G.semester, H.subject_name,A.dob,A.gender, H.credit_points, H.ESE_min,H.ESE_max, H.CIA_max,H.CIA_min, H.end_semester_exam_value_mark as sub_total_marks, B.course_batch_mapping_id,K.description as month, F.month as add_month , C.regulation_year,F.year, F.ESE,F.CIA, F.total,F.result,F.withheld,F.grade_name, F.grade_point, D.degree_code,D.degree_name,E.programme_name,F.year_of_passing, sum(H.credit_points) as cumulative,part_no,I.batch_name,D.degree_type')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], "C.coe_batch_id" => $_POST['bat_val'], 'F.year' => $_POST['MarkEntry']['year'], 'F.month' => $_POST['MarkEntry']['month'], 'A.student_status' => 'Active'])
                ->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                ->andWhere(['between', "A.register_number", $_POST['from_reg'], $_POST['to_reg']]);
            $query->groupBy('F.student_map_id,F.subject_map_id,G.semester')
                ->orderBy('A.register_number,G.semester,G.paper_no');
               
            $mark_statement = $query->createCommand()->queryAll();
           
            $query_man = new  Query();
            $query_man->select('distinct (H.subject_code),G.paper_no,F.student_map_id,A.name, A.register_number, H.subject_name,G.sub_cat_code,A.dob,A.gender,credit_points, H.ESE_min,H.ESE_max, H.CIA_max,H.CIA_min, H.end_semester_exam_value_mark as sub_total_marks, B.course_batch_mapping_id,K.description as month, F.month as add_month , C.regulation_year,F.year,F.subject_map_id,F.student_map_id, F.ESE,F.CIA, F.total,F.result,F.semester ,F.withheld,F.grade_name, F.grade_point, G.is_additional, D.degree_code,D.degree_name,E.programme_name,F.year_of_passing, sum(credit_points) as cumulative,part_no,I.batch_name,D.degree_type')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], "C.coe_batch_id" => $_POST['bat_val'], 'F.year' => $_POST['MarkEntry']['year'], 'F.month' => $_POST['MarkEntry']['month'], 'A.student_status' => 'Active'])
                //->andWhere(['<>', 'status_category_type_id', s$det_disc_type])
                //->andWhere(['NOT IN', "F.student_map_id", $withheld])
                ->andWhere(['between', "A.register_number", $_POST['from_reg'], $_POST['to_reg']]);
            $query_man->groupBy('A.register_number,G.sub_cat_code,H.subject_code,G.paper_no')
                ->orderBy('H.subject_code,G.sub_cat_code,A.register_number');


                
               
            $mandatory_statement = $query_man->createCommand()->queryAll();

             //echo  $mandatory_statement = $query_man->createCommand()->getRawSql();exit;
//print_r( $mandatory_statement );exit;
        
            if(!empty($mandatory_statement))
            {
                $mark_statement = array_merge($mark_statement,$mandatory_statement);
            }
          //print_r($mark_statement);exit;





        array_multisort(array_column($mark_statement, 'semester'),  SORT_ASC, $mark_statement);
          array_multisort(array_column($mark_statement, 'paper_no'),  SORT_ASC, $mark_statement);
          array_multisort(array_column($mark_statement, 'subject_code'),  SORT_ASC, $mark_statement);
         array_multisort(array_column($mark_statement, 'register_number'),  SORT_ASC, $mark_statement);
            $_SESSION['degree_info'] = $deg_info;
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            if (!empty($mark_statement)) {
                if ($file_content_available == "Yes") {
                    return $this->render('mark-statement', [
                        'model' => $model,
                        'top_margin'=>$top_margin,
                        'bottom_margin'=>$bottom_margin,
                        'student' => $student,
                        'mark_statement' => $mark_statement,
                        'print_trimester' => $print_trimester,
                        'mark_statement_type' => $mark_statement_type,
                        'date_print' =>$_POST['created_at'],
                        'deg_info' =>$deg_info,
                        'count_of_subs'=>$count_of_subs,
                    ]);
                } else {
                    Yii::$app->ShowFlashMessages->setMsg('Error', "No Institute Information Found");
                    return $this->redirect(['mark-entry/mark-statement']);
                }
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found ");
                return $this->redirect(['mark-entry/mark-statement']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Mark Statement');
            return $this->render('mark-statement', [
                'model' => $model,
                'student' => $student,
            ]);
        }
    }
    // Mark Statement Pdf
    public function actionMarkStatementPrintPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $change_css_file =  'css/newmarkstatement.css';
        $degree_code = 'UG';   
        $ug_top_margin = 7.4;
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_oldmarkstatement.css';
        }
        if(isset($_SESSION['degree_info']))
        {
            $degree_code = $_SESSION['degree_info']->degree_type;
            $ug_top_margin = 9.8;
        }
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "5.5";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = $ug_top_margin;
            $pdf->marginLeft = "7.2";
            $pdf->marginRight = "0";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementPrintSkcetOldNonCbcsPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $change_css_file = 'css/skcet_non_cbcs_newmarkstatement.css';
        
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]); 

        $pdf->marginTop = '13';
        $pdf->marginLeft = "6";
        $pdf->marginRight = "2.2";
        $pdf->marginBottom = "0";
        $pdf->marginHeader = "3";
        $pdf->marginFooter = "0";

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementPrintSkcetNewPgPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $change_css_file =  'css/newmarkstatement.css';   
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_newmarkstatement_pg.css';
        }

        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT PG.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT PG'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "6";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "4.7";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementPrintSkcetNewPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $change_css_file =  'css/newmarkstatement.css';   
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_newmarkstatement.css';
        }

        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "6.9";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "4.7";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementArtsPrintPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => 'css/arts_college_mark_statement.css',
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        
        $pdf->marginTop = "4.0";
        $pdf->marginLeft = "8";
        $pdf->marginRight = "3.5";
        $pdf->marginBottom = "2";
        $pdf->marginHeader = "2";
        $pdf->marginFooter = "2";
        
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementArtsPrintPgPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => 'css/arts_college_mark_statement.css',
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        
        $pdf->marginTop = "3.0";
        $pdf->marginLeft = "6";
        $pdf->marginRight = "3.5";
        $pdf->marginBottom = "2";
        $pdf->marginHeader = "2";
        $pdf->marginFooter = "2";
        
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionExcelMarkstatementprint()
    {
        
        $content = $_SESSION['mark_statement_pdf'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Application' . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // // Mark Statement Pdf
    // Reports Starts Here

    //markstatement for transfer 

     public function actionMarkStatementTransfer()
    {
        $model = new MarkEntry();
        $student = new Student();
        $studentcategorydetails=new StudentCategoryDetails;
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        if (isset($_POST['get_marks'])) 
        {            
            $get_batc_map = CoeBatDegReg::findOne($_POST['bat_map_val']);
            $deg_info = Degree::findOne($get_batc_map->coe_degree_id);
            $print_trimester = (($deg_info->degree_total_semesters/2)==3 && $deg_info->degree_code=='MBA') ? 1: 0;
            $top_margin = $_POST['top_margin'];
            $bottom_margin = $_POST['bottom_margin'];
            $count_of_subs = $_POST['count_of_subs']=='' || empty($_POST['count_of_subs'])?23:$_POST['count_of_subs'];
            $mark_statement_type = $_POST['deg_credit_type'];
            $withheld_list = Yii::$app->db->createCommand('SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master WHERE month="'.$_POST['MarkEntry']['month'].'" AND year="'.$_POST['MarkEntry']['year'].'" AND withheld="w" ')->queryAll();
            $withheld = [];
            foreach ($withheld_list as $key => $value) {
                $withheld[$value['id']]=$value['id'];
            }
            //$withheld = array_filter($withheld);
             $query = new  Query();
            $query->select('G.paper_no,F.student_map_id,H.subject_code,  A.name, A.register_number, G.semester, H.subject_name,A.dob,A.gender, H.credit_points,x.credit_point, H.ESE_min,H.ESE_max, H.CIA_max,H.CIA_min, H.end_semester_exam_value_mark as sub_total_marks, B.course_batch_mapping_id,K.description as month, F.month as add_month , C.regulation_year,F.year, F.ESE,F.CIA, F.total,F.result,F.withheld,F.grade_name, F.grade_point, D.degree_code,D.degree_name,E.programme_name,F.year_of_passing, sum(H.credit_points+x.credit_point) as cumulative,part_no')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
               
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_student_category_details as x', 'x.student_map_id=F.student_map_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], 'C.coe_batch_id' => $_POST['bat_val'], 'F.year' => $_POST['MarkEntry']['year'], 'F.month' => $_POST['MarkEntry']['month'], 'A.student_status' => 'Active','F.student_map_id'=>$_POST['MarkEntry']['student_map_id']]);
                //->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                //->andWhere(['NOT IN', "F.student_map_id", $withheld])
                
            $query->groupBy('F.student_map_id,F.subject_map_id,G.semester')
                ->orderBy('A.register_number,G.semester,G.paper_no');
               
            $mark_statement = $query->createCommand()->queryAll();
          
            $query_man = new  Query();
            $query_man->select('G.paper_no,F.student_map_id,H.subject_code,  A.name, A.register_number, H.subject_name,A.dob,A.gender,credit_points, H.ESE_min,H.ESE_max, H.CIA_max,H.CIA_min, H.end_semester_exam_value_mark as sub_total_marks, B.course_batch_mapping_id,K.description as month, F.month as add_month , C.regulation_year,F.year,F.subject_map_id,F.student_map_id, F.ESE,F.CIA, F.total,F.result,F.semester ,F.withheld,F.grade_name, F.grade_point, G.is_additional, D.degree_code,D.degree_name,E.programme_name,F.year_of_passing, sum(credit_points) as cumulative,part_no')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], "C.coe_batch_id" => $_POST['bat_val'], 'F.year' => $_POST['MarkEntry']['year'], 'F.month' => $_POST['MarkEntry']['month'], 'A.student_status' => 'Active','F.student_map_id'=>$_POST['MarkEntry']['student_map_id']]);
                //->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                //->andWhere(['NOT IN', "F.student_map_id", $withheld])
                
            $query_man->groupBy('F.student_map_id,F.subject_map_id')
                ->orderBy('A.register_number,F.semester,G.paper_no');
               
            $mandatory_statement = $query_man->createCommand()->queryAll();

        
            if(!empty($mandatory_statement))
            {
                $mark_statement = array_merge($mark_statement,$mandatory_statement);
            }

            array_multisort(array_column($mark_statement, 'semester'),  SORT_ASC, $mark_statement);
            array_multisort(array_column($mark_statement, 'paper_no'),  SORT_ASC, $mark_statement);
            array_multisort(array_column($mark_statement, 'register_number'),  SORT_ASC, $mark_statement);
            $_SESSION['degree_info'] = $deg_info;
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            if (!empty($mark_statement)) {
                if ($file_content_available == "Yes") {
                    return $this->render('mark-statement-transfer', [
                        'model' => $model,
                        'top_margin'=>$top_margin,
                        'bottom_margin'=>$bottom_margin,
                        'student' => $student,
                        'mark_statement' => $mark_statement,
                        'print_trimester' => $print_trimester,
                        'mark_statement_type' => $mark_statement_type,
                        'date_print' =>$_POST['created_at'],
                        'deg_info' =>$deg_info,
                        'count_of_subs'=>$count_of_subs,
                    ]);
                } else {
                    Yii::$app->ShowFlashMessages->setMsg('Error', "No Institute Information Found");
                    return $this->redirect(['mark-entry/mark-statement-transfer']);
                }
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found ");
                return $this->redirect(['mark-entry/mark-statement-transfer']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Mark Statement Transfer');
            return $this->render('mark-statement-transfer', [
                'model' => $model,
                'student' => $student,
            ]);
        }
    }
      public function actionMarkStatementTransferPrintPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_pdf'];
        $change_css_file =  'css/newmarkstatement.css';
        $degree_code = 'UG';   
        $ug_top_margin = 7.4;
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_oldmarkstatement.css';
        }
        if(isset($_SESSION['degree_info']))
        {
            $degree_code = $_SESSION['degree_info']->degree_type;
            $ug_top_margin = 9.8;
        }
       $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "5.5";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = $ug_top_margin;
            $pdf->marginLeft = "6.2";
            $pdf->marginRight = "2";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementArtsPrintPdfTransferPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_transfer_pdf'];
        $change_css_file =  'css/newmarkstatement.css';
        $degree_code = 'UG';   
        $ug_top_margin = 7.4;
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_oldmarkstatement.css';
        }
        if(isset($_SESSION['degree_info']))
        {
            $degree_code = $_SESSION['degree_info']->degree_type;
            $ug_top_margin = 9.8;
        }
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "5.5";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = $ug_top_margin;
            $pdf->marginLeft = "6.2";
            $pdf->marginRight = "2";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementTransferPrintSkcetOldNonCbcsPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_transfer_pdf'];
        $change_css_file = 'css/skcet_non_cbcs_newmarkstatement.css';
        
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]); 

        $pdf->marginTop = '13';
        $pdf->marginLeft = "6";
        $pdf->marginRight = "2.2";
        $pdf->marginBottom = "0";
        $pdf->marginHeader = "3";
        $pdf->marginFooter = "0";

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionMarkStatementTransferPrintSkcetNewPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_statement_transfer_pdf'];
        $change_css_file =  'css/newmarkstatement.css';   
        if($org_email=='coe@skcet.in')
        {
            $change_css_file = 'css/skcet_newmarkstatement.css';
        }

        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' MARK STATEMENT.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,         
            'cssFile' => $change_css_file,
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)) . ' MARK STATEMENT'],
        ]);
        if($org_email=='coe@skcet.in')
        {
            $pdf->marginTop = "6.9";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "4.7";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        }
        else
        {
            $pdf->marginTop = "7";
            $pdf->marginLeft = "4.7";
            $pdf->marginRight = "3";
            $pdf->marginBottom = "0";
            $pdf->marginHeader = "3";
            $pdf->marginFooter = "0";
        
        }

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
  
    public function actionExcelMarkstatementTransferprint()
    {
        
        $content = $_SESSION['mark_statement_pdf'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Application' . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // // Mark Statement Pdf

    public function actionArrearreport()
    {
        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $omit_batch = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_MAX_EXAM_CONDUTION);
            $year = DATE('Y');
            $omit_batches = $year-$omit_batch;
            $query_1= "select batch_mapping_id,batch_name,programme_code,subject_code,count(distinct student_map_id) as count from coe_subjects as A 
             JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id 
             JOIN coe_mark_entry_master as C ON C.subject_map_id=B.coe_subjects_mapping_id 
             JOIN coe_bat_deg_reg as E ON E.coe_bat_deg_reg_id=B.batch_mapping_id  
             JOIN coe_programme as D ON  D.coe_programme_id=E.coe_programme_id 
             JOIN coe_batch as F ON F.coe_batch_id=E.coe_batch_id
             JOIN coe_student_mapping as abc ON abc.course_batch_mapping_id=B.batch_mapping_id and abc.coe_student_mapping_id=C.student_map_id 
              where C.year<='".$year."' and student_map_id NOT IN (select student_map_id FROM coe_mark_entry_master as ab 
              where ab.subject_map_id=C.subject_map_id and ab.student_map_id=C.student_map_id and result like '%Pass%' and abc.status_category_type_id!='".$det_disc_type."' ) and C.result not like 
             '%Pass%' and (year_of_passing='' or year_of_passing=NULL) and status_category_type_id!='".$det_disc_type."' 
             group by batch_mapping_id,subject_map_id order by batch_name,D.programme_code asc"; 
            
            $arrear = Yii::$app->db->createCommand($query_1)->queryAll();
            if (!empty($arrear)) {
                return $this->render('arrearreport', [
                    'model' => $model,
                    'arrear' => $arrear,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found Kindly re-check your Submission");
                return $this->redirect(['mark-entry/arrearreport']);
            }
        } else {
            return $this->render('arrearreport', [
                'model' => $model,
            ]);
        }
    }
    public function actionSubArrearCountPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['sub_arrear_count'];
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' COUNT ARREAR.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
             'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'content' => $content,    
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' COUNT ARREAR LIST'],
        ]);
        
        
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        
        return $pdf->render();
    }
    public function actionSubArrearCountExcel()
    {
        
        $content = $_SESSION['sub_arrear_count'];
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' COUNT ARREAR .xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionRevalfeespaid()
    {
        $model = new MarkEntry();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        if (Yii::$app->request->post()) 
        {
            if(empty($_POST['reval_entry_month']) || empty($_POST['reval_entry_year']))
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', "Select Required Month");
                return $this->redirect(['mark-entry/revalfeespaid']);
            }
            $reval_fees_paid_list = Revaluation::find()->where(['year'=>$_POST['reval_entry_year'],'month'=>$_POST['reval_entry_month'],'reval_status'=>'YES'])->all();
            $month_name = Categorytype::findOne($_POST['reval_entry_month']);
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $headers = $body = '';
            $headers ='<table border="1"  class="table table-bordered table-responsive bulk_edit_table table-hover" >';                 
            $headers.='<tr>
                        <td> 
                            <img width="100" height="100" src="'.Yii::getAlias("@web").'/images/main_logo.png" alt="College Logo">
                        </td>
                        <td colspan=6 align="center"> 
                            <center><b><font size="4px">'.$org_name.'</font></b></center>
                            <center>'.$org_address.'</center>
                            
                            <center>'.$org_tagline.'</center> 
                        </td>
                        <td align="right">  
                            <img width="100" height="100" src="'.Yii::getAlias("@web").'/images/skacas.png" alt="College Logo 2">
                        </td>
                    </tr>';
            $headers.='<tr><td colspan="8" align="center"><h3 align="center">Revaluation Fees Paid List For - '.$_POST['reval_entry_year'].'-'.$month_name->description.'</h3></td></tr>';
            if(isset($_POST['MarkEntry']['mark_type'][0]) && !empty($_POST['MarkEntry']['mark_type'][0]))
            {
                $headers.='<tr>
                            <th>SNO</th>
                            <th>REGISTER NUMBER</th>
                            <th>NAME</th>
                            <th colspan=2>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DUMMY)).'</th>
                            <th>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' CODE</th>
                            <th colspan=2>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' NAME</th>
                            </tr>';    
                $sn=0;   
                $old_reg_num = '';
                foreach ($reval_fees_paid_list as $value) 
                {
                    $reg_no = Yii::$app->db->createCommand('SELECT register_number,name FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id WHERE B.coe_student_mapping_id="'.$value['student_map_id'].'" and status_category_type_id NOT IN("'.$det_disc_type.'") ')->queryOne();
                    $course = Yii::$app->db->createCommand('SELECT subject_code,subject_name FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE B.coe_subjects_mapping_id="'.$value['subject_map_id'].'"')->queryOne();
                    $dummynumber = DummyNumbers::find()->where(['year'=>$_POST['reval_entry_year'],'month'=>$_POST['reval_entry_month'],'student_map_id'=>$value['student_map_id'],'subject_map_id'=>$value['subject_map_id']])->one();

                    $sn = $sn+1;
                    $body .='<tr>';
                        $body .= '<td>'.$sn.'</td>';
                        $body .='<td>'.strtoupper($reg_no['register_number']).'</td>';
                        $body .='<td>'.strtoupper($reg_no['name']).'</td>';
                        $body .='<td colspan=2>'.strtoupper($dummynumber['dummy_number']).'</td>';
                        $body .='<td>'.strtoupper($course['subject_code']).'</td>';
                        $body .='<td colspan=2>'.strtoupper($course['subject_name']).'</td>';
                    $body .='</tr>';         
                }
                $print_pdf = Html::a('<i class="fa fa-file-pdf-o"></i> PDF', ['mark-entry/revaluation-fees-paid-pdf'], [
                            'class' => 'pull-right btn btn-block btn-primary',
                            'target' => '_blank',
                            'data-toggle' => 'tooltip',
                            'title' => 'Will open the generated PDF file in a new window'
                ]);
                $print_excel = Html::a('<i class="fa fa-file-pdf-o"></i> EXCEL', ['/mark-entry/excel-revaluation-fees-paid'], [
                            'class' => 'pull-right btn btn-block btn-warning',
                            'target' => '_blank',
                            'data-toggle' => 'tooltip',
                            'title' => 'Will open the generated PDF file in a new window'
                ]);
                $body .='</table>';
                $_SESSION['reval_fees_paid_list'] = $content = $headers. $body;

                $final_body = '<div class="box box-primary">
                                    <div class="box-body">
                                        <div class="row" >
                                            <div class="col-xs-12" >
                                                <div class="col-lg-2" > ' . $print_pdf. $print_excel . ' </div>
                                                <div class="col-lg-10" >' . $headers. $body . '</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>';
            }
            else
            {        
                $headers.='<tr>
                            <th>SNO</th>
                            <th>REGISTER NUMBER</th>
                            <th>NAME</th>
                            <th colspan=2>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' CODE</th>
                            <th colspan=3>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' NAME</th>
                            </tr>';    
                $sn=0;   
                $old_reg_num = '';
                foreach ($reval_fees_paid_list as $value) 
                {
                    $reg_no = Yii::$app->db->createCommand('SELECT register_number,name FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id WHERE B.coe_student_mapping_id="'.$value['student_map_id'].'" and status_category_type_id NOT IN("'.$det_disc_type.'")')->queryOne();
                    $course = Yii::$app->db->createCommand('SELECT subject_code,subject_name FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE B.coe_subjects_mapping_id="'.$value['subject_map_id'].'"')->queryOne();
                    $sn = $old_reg_num!==$reg_no ? $sn+1 : $sn;
                    $body .='<tr>';
                        $body .= $old_reg_num!==$reg_no ? '<td>'.$sn.'</td>' : '<td>&nbsp;</td>';
                        $body .='<td>'.strtoupper($reg_no['register_number']).'</td>';
                        $body .='<td>'.strtoupper($reg_no['name']).'</td>';
                        $body .='<td colspan=2>'.strtoupper($course['subject_code']).'</td>';
                        $body .='<td colspan=3>'.strtoupper($course['subject_name']).'</td>';
                    $body .='</tr>';   
                    $old_reg_num = $reg_no;           
                }
                $print_pdf = Html::a('<i class="fa fa-file-pdf-o"></i> PDF', ['mark-entry/revaluation-fees-paid-pdf'], [
                            'class' => 'pull-right btn btn-block btn-primary',
                            'target' => '_blank',
                            'data-toggle' => 'tooltip',
                            'title' => 'Will open the generated PDF file in a new window'
                ]);
                $print_excel = Html::a('<i class="fa fa-file-pdf-o"></i> EXCEL', ['/mark-entry/excel-revaluation-fees-paid'], [
                            'class' => 'pull-right btn btn-block btn-warning',
                            'target' => '_blank',
                            'data-toggle' => 'tooltip',
                            'title' => 'Will open the generated PDF file in a new window'
                ]);
                $body .='</table>';
                $_SESSION['reval_fees_paid_list'] = $content = $headers. $body;

                $final_body = '<div class="box box-primary">
                                    <div class="box-body">
                                        <div class="row" >
                                            <div class="col-xs-12" >
                                                <div class="col-lg-2" > ' . $print_pdf. $print_excel . ' </div>
                                                <div class="col-lg-10" >' . $headers. $body . '</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>';
            }
            if (empty($reval_fees_paid_list)) 
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->render('revalfeespaid', [
                    'model' => $model,
                ]);
            }
            else if (!empty($final_body)) {
                return $this->render('revalfeespaid', [
                    'model' => $model,
                    'final_body' => $final_body,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found Kindly re-check your Submission");
                return $this->redirect(['mark-entry/revalfeespaid']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('WELCOME', "WELCOME TO REVALUATION FEES PAID LIST");
            return $this->render('revalfeespaid', [
                'model' => $model,
            ]);
        }
    }
    public function actionRevaluationFeesPaidPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));        
        $content = $_SESSION['reval_fees_paid_list'];           
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => "Revaluation Fees Paid List.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' =>"Revaluation Fees Paid List"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ "Revaluation Fees Paid List " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ],
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelRevaluationFeesPaid()
    {
        $content = $_SESSION['reval_fees_paid_list'];
        $fileName = "Revaluation Fees Paid List " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionGetarrearstudent()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $pgm_code = Yii::$app->request->post('pgm_code');
        $sub_code = Yii::$app->request->post('sub_code');
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $reg = Yii::$app->db->createCommand("select register_number,name from coe_programme as A,coe_bat_deg_reg as B,coe_subjects as C,coe_subjects_mapping as D,coe_student as E,coe_student_mapping as F,coe_mark_entry_master as G where A.coe_programme_id=B.coe_programme_id and C.coe_subjects_id=D.subject_id and E.coe_student_id=F.student_rel_id and D.batch_mapping_id=F.course_batch_mapping_id and B.coe_bat_deg_reg_id=D.batch_mapping_id and D.coe_subjects_mapping_id=G.subject_map_id and F.coe_student_mapping_id=G.student_map_id and F.course_batch_mapping_id ='" . $pgm_code . "' and D.batch_mapping_id='".$pgm_code."' and C.subject_code='" . $sub_code . "' and G.year<='" . $year . "' and (result='Fail' or result='Absent') and status_category_type_id NOT IN('".$det_disc_type."') and student_map_id NOT IN(select student_map_id FROM coe_mark_entry_master as abc where abc.subject_map_id = G.subject_map_id and result like '%Pass%') and (year_of_passing='' or year_of_passing=NULL) group by register_number")->queryAll();
        return Json::encode($reg);
    }
    public function actionProgrammewisearrear()
    {
        $model = new MarkEntry();
        if (Yii::$app->request->post()) {
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            
            $select_query = "SELECT distinct (H.subject_code) as subject_code,concat(D.degree_code,'-',E.programme_code) as degree_code,batch_name,count(DISTINCT F.student_map_id) as count,H.subject_name,G.semester,F.year,E.programme_name,D.degree_name FROM  coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id  JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_subjects_mapping as G ON G.batch_mapping_id=B.course_batch_mapping_id and G.batch_mapping_id=C.coe_bat_deg_reg_id JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id JOIN coe_subjects H ON H.coe_subjects_id=G.subject_id JOIN coe_batch I ON I.coe_batch_id=C.coe_batch_id WHERE I.coe_batch_id='".$_POST['bat_val']."' and B.course_batch_mapping_id='".$_POST['bat_map_val']."' and G.batch_mapping_id='".$_POST['bat_map_val']."' AND A.student_status='Active' and F.year_of_passing='' and F.student_map_id NOT IN (SELECT student_map_id FROM coe_mark_entry_master WHERE subject_map_id=F.subject_map_id and student_map_id=F.student_map_id and result like '%pass%' ) AND F.year<='".$_POST['mark_year']."' AND  status_category_type_id NOT IN ('".$det_disc_type."') group by F.subject_map_id order by degree_code,G.semester";
            
            $programmewisearrear = Yii::$app->db->createCommand($select_query)->queryAll();

            if (!empty($programmewisearrear)) {
                return $this->render('programmewisearrear', [
                    'model' => $model,
                    'programmewisearrear' => $programmewisearrear,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found Kindly re-check your Submission");
                return $this->redirect(['mark-entry/programmewisearrear']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Wise Arrear ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
            return $this->render('programmewisearrear', [
                'model' => $model,
            ]);
        }
    }

    public function actionProgrammewisearrearnominal()
    {
        $model = new MarkEntry();
        if(isset($_SESSION['programmewisearrearnominal'])){ unset($_SESSION['programmewisearrearnominal']);}
        if (Yii::$app->request->post()) 
        {
            $omit_batch = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_MAX_EXAM_CONDUTION);
            $year = DATE('Y');
            $omit_batches = $year-$omit_batch;
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $month = $_POST['MarkEntry']['month'];
            $batch_val = $_POST['bat_val'];
            $catType = Categories::find()->where(['category_name'=>'Trisem'])->orWhere(['description'=>'Trisem'])->orWhere(['category_name'=>'Trisemester'])->one();
            $month_ids = '';
            $reval_status = isset($_POST['sub_type_val'])?$_POST['sub_type_val']:'';
            $remove_det = isset($_POST['MarkEntry']['term'][0])?$_POST['MarkEntry']['term'][0]:'';
            $addIntheQuery = (!empty($reval_status) && $reval_status!='') ?' and paper_type_id="'.$_POST['sub_type_val'].'" ':'';

            $addIntheQueryDet = $remove_det=='yes'?" AND status_category_type_id NOT IN ('".$det_disc_type."','".$det_cat_type."') ":" AND status_category_type_id NOT IN ('".$det_disc_type."') ";
            if($month==29 || $month==30)
            {
                $month_ids = $month;   
            }
            else
            {
                if(!empty($catType))
                {
                    $triMonths = Categorytype::find()->where(['category_id'=>$catType->coe_category_id])->all();
                    foreach ($triMonths as $key => $value) 
                    {
                        $month_ids .="'".$value['coe_category_type_id']."',";
                    }
                    $month_ids = trim($month_ids,",");
                }
            }
            
            $select_query = "SELECT distinct (H.subject_code) as subject_code,G.semester,concat(D.degree_code,'-',E.programme_code) as degree_code,count(DISTINCT F.student_map_id) as count,H.subject_name,I.description as subject_type,J.description as course_type,K.description as paper_type ,E.programme_name,D.degree_name,bat.batch_name  FROM  coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id  JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_batch as bat ON bat.coe_batch_id=C.coe_batch_id  JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id JOIN coe_subjects H ON H.coe_subjects_id=G.subject_id JOIN coe_category_type as I ON I.coe_category_type_id=G.subject_type_id JOIN coe_category_type as J ON J.coe_category_type_id=G.course_type_id JOIN coe_category_type as K ON K.coe_category_type_id=G.paper_type_id WHERE  A.student_status='Active' and F.year_of_passing='' and F.student_map_id NOT IN (SELECT student_map_id FROM coe_mark_entry_master WHERE subject_map_id=F.subject_map_id and result like '%pass%' ) AND F.year<='".$_POST['mark_year']."' and C.coe_batch_id='".$batch_val."' and bat.coe_batch_id='".$batch_val."' ".$addIntheQueryDet." ".$addIntheQuery." group by B.course_batch_mapping_id,F.subject_map_id order by batch_name,degree_code,G.semester";
            
            $programmewisearrearnominal = Yii::$app->db->createCommand($select_query)->queryAll();

            if (!empty($programmewisearrearnominal)) {
                return $this->render('programmewisearrearnominal', [
                    'model' => $model,
                    'programmewisearrearnominal' => $programmewisearrearnominal,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found Kindly re-check your Submission");
                return $this->redirect(['mark-entry/programmewisearrearnominal']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Wise Arrear ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
            return $this->render('programmewisearrearnominal', [
                'model' => $model,
            ]);
        }
    }
    public function actionElectiveCount()
    {
        $model = new MarkEntry();
        if(isset($_SESSION['electivecount'])){ unset($_SESSION['electivecount']);}
        if (Yii::$app->request->post()) 
        {
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
           
            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $sem_verify = ConfigUtilities::SemCaluclation($_POST['mark_year'],$_POST['MarkEntry']['month'],$_POST['bat_map_val']);
            $select_query = "SELECT distinct (H.subject_code) as subject_code,concat(D.degree_code,'-',E.programme_code) as degree_code,count(DISTINCT F.coe_student_id) as count,B.course_batch_mapping_id,H.subject_name,F.coe_student_id,F.coe_subjects_id,F.semester,E.programme_name,D.degree_name,bat.batch_name  FROM  coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id  JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_batch as bat ON bat.coe_batch_id=C.coe_batch_id  JOIN coe_nominal as F ON F.coe_student_id=A.coe_student_id JOIN coe_subjects H ON H.coe_subjects_id=F.coe_subjects_id JOIN coe_subjects_mapping as G ON G.subject_id=H.coe_subjects_id WHERE B.course_batch_mapping_id='".$_POST['bat_map_val']."' and F.semester='".$sem_verify."' and  A.student_status='Active' AND  status_category_type_id NOT IN ('".$det_cat_type."','".$det_disc_type."') group by subject_code,semester order by batch_name,degree_code,F.semester";
            
            $programmewisearrearnominal = Yii::$app->db->createCommand($select_query)->queryAll();

            if (!empty($programmewisearrearnominal)) {
                return $this->render('elective-count', [
                    'model' => $model,
                    'programmewisearrearnominal' => $programmewisearrearnominal,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found Kindly re-check your Submission");
                return $this->redirect(['mark-entry/elective-count']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Elective Count');
            return $this->render('elective-count', [
                'model' => $model,
            ]);
        }
    }

    public function actionProgrammeWiseArrearPdfElective()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
        $content = $_SESSION['elective-count'];
        
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => "FULL ARREAR LIST.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => "FULL ARREAR LIST"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ["FULL ARREAR LIST" . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionProgrammeWiseArrearElectiveExcel()
    {
       
        $content = $_SESSION['elective-count'];
        
        $fileName = "FULL ARREAR LIST-" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
	public function actionElectiveStudentRepoExcel()
    {       
        $content = $_SESSION['elective_stu_count'];        
        $fileName = "Elective Count-" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionElectiveStudentRepoPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['elective_stu_count'];
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => "Elective Count.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => "Elective Count"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ["Elective Count" . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionProgrammeWiseArrearPdfNominal()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
        $content = $_SESSION['programmewisearrearnominal'];
        
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => "FULL ARREAR LIST.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => "FULL ARREAR LIST"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ["FULL ARREAR LIST" . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionProgrammeWiseArrearNominalExcel()
    {
       
        $content = $_SESSION['programmewisearrearnominal'];
        
        $fileName = "FULL ARREAR LIST-" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionProgrammeWiseArrearPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
        $content = $_SESSION['programmewisearrear'];
           
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . " WISE ARREAR.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: left;  font-family:"Roboto, sans-serif"; width:100%; font-size: 13px; } 
                        
                        table td{
                            border: 1px solid #000;
                            text-align: left;
                        }
                        table th{
                            border: 1px solid #000;
                            text-align: left;
                        }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . " WISE ARREAR "],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . " WISE ARREAR " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionProgrammeWiseArrearExcel()
    {
        
            $content = $_SESSION['programmewisearrear'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . " WISE ARREAR " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // Programme Wise Arrear Ends Here
     public function actionCoursewisearrear()
    {
        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            
            $query = new  Query();
            
            $omit_batch = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_MAX_EXAM_CONDUTION);
            $year = DATE('Y');
            $omit_batches = $year-$omit_batch;
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

            $det_rejoin=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Rejoin%'")->queryScalar();
           
            $query_map_id = new Query();
                    $query_map_id->select('(previous_reg_number)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=c.subject_id')
                        ->where(['H.subject_code' => $_POST['subject_code'],'b.result'=>'Pass'])
                        ->andWhere(['=', 'a.status_category_type_id', $det_rejoin]);

             $query_map_id = $query_map_id->createCommand()->queryAll();
//print_r($query_map_id); exit;
             $notIn = array_filter(['']);
                foreach ($query_map_id as $key => $fails) 
                {
                    
                        $notIn[$fails['previous_reg_number']]=$fails['previous_reg_number'];
                  
                }
                 $notIn = array_filter($notIn);

            $query->select(["distinct (H.subject_code) as subject_code", "concat(D.degree_code,'-',E.programme_code) as degree_code", "A.register_number", "A.name", "H.subject_name", "G.semester", "F.year",'F.student_map_id','F.subject_map_id',"F.grade_name", "E.programme_name", "K.batch_name", "D.degree_name","subject_fee","G.paper_type_id","subject_type_id","course_type_id","paper_no","coe_subjects_id","F.month","F.term","F.CIA","F.ESE","F.total","F.result","F.grade_point","F.grade_name"])
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_batch as K', 'K.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id  AND G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['H.subject_code'=>$_POST['subject_code'], 'A.student_status' => 'Active', 'F.year_of_passing' => ''])
                 ->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                 ->andWhere(['NOT IN', 'register_number', $notIn])
                 //->andWhere(['>=','batch_name',$omit_batches])     
                 ->andWhere(['NOT LIKE','F.result','Pass']) ;            
            $query->groupBy('F.subject_map_id,F.student_map_id');
            $query->orderBy('batch_name,degree_code,subject_code,semester,register_number');
            $coursewisearrear = $query->createCommand()->queryAll();
            
            if (!empty($coursewisearrear)) 
            {
                return $this->render('coursewisearrear', [
                    'model' => $model,
                    'coursewisearrear' => $coursewisearrear,
                    'det_disc_type '=>$det_disc_type,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/coursewisearrear']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Wise Arrear ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
            return $this->render('coursewisearrear', [
                'model' => $model,
            ]);
        }
    }
    public function actionCourseWiseArrearPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
       
            $content = $_SESSION['coursewisearrear'];
            
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " WISE ARREAR.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " WISE ARREAR "],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " WISE ARREAR " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionCourseWiseArrearExcel()
    {
        
            $content = $_SESSION['coursewisearrear'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " WISE ARREAR " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // COURSE Wise Arrear Ends Here
    //Student Wise Arrear
    public function actionStudentwisearrear()
    {
        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            
            $sem_count = ConfigUtilities::SemCaluclation($_POST['mark_year'],$_POST['MarkEntry']['month'],$_POST['bat_map_val']);

            $query = new  Query();
            $query->select(["distinct (H.subject_code) as subject_code", "concat(D.degree_code,'-',E.programme_code) as degree_code", "A.register_number", "A.name", "H.subject_name", "G.semester", "F.year",'F.student_map_id','F.subject_map_id', "E.programme_name", "K.batch_name", "D.degree_name"])
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_batch as K', 'K.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], 'A.student_status' => 'Active', 'F.year_of_passing' => ''])->andWhere(['<=','F.year',$_POST['mark_year']])
                ->andWhere(['<=','G.semester',$sem_count]);            
            $query->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->groupBy('F.student_map_id,F.subject_map_id');
            $query->orderBy('semester,register_number');
            $studentwisearrear = $query->createCommand()->queryAll();
            if (!empty($studentwisearrear)) {
                return $this->render('studentwisearrear', [
                    'model' => $model,
                    'studentwisearrear' => $studentwisearrear,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/studentwisearrear']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Wise Arrear ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
            return $this->render('studentwisearrear', [
                'model' => $model,
            ]);
        }
    }
    public function actionStudentWiseArrearPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
        $content = $_SESSION['studentwisearrear'];
            
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . " WISE ARREAR.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . " WISE ARREAR "],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . " WISE ARREAR " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionStudentWiseArrearExcel()
    {
        
        $content = $_SESSION['studentwisearrear'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . " WISE ARREAR " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // Student wise arrear ends here
    /*public function actionCiamarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        
        $category_type_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Internal%' OR category_type like '%CIA%' ")->queryScalar();

        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            $sem_valc = ConfigUtilities::SemCaluclation($_POST['mark_year'],$_POST['month'],$_POST['bat_map_val']);
            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.category_type_id_marks as CIA,F.year,E.programme_name,D.degree_name')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')                
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc, 'A.student_status' => 'Active','F.category_type_id'=>$category_type_id]);
             //   ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
             //   ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->orderBy('A.register_number,H.subject_code');
            $cia_list = $query->createCommand()->queryAll();

            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,total_minimum_pass as min_pass')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc,'F.category_type_id'=>$category_type_id]);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $subject_get_data->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();
            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc,'F.category_type_id'=>$category_type_id]);
           // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //    ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $countOfSubjects = $countQuery->createCommand()->queryAll();
            if (!empty($cia_list)) {
                return $this->render('ciamarklist', [
                    'model' => $model,
                    'cia_list' => $cia_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/ciamarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to CIA Mark List');
            return $this->render('ciamarklist', [
                'model' => $model,
            ]);
        }
    }*/
    public function actionCiamarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        
        $category_type_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Internal%' OR category_type like '%CIA%' ")->queryScalar();

        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            $sem_valc = ConfigUtilities::SemCaluclation($_POST['mark_year'],$_POST['month'],$_POST['bat_map_val']);
        
           /* $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.CIA,F.year,E.programme_name,D.degree_name')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')                
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc, 'A.student_status' => 'Active']);
               // 'F.category_type_id'=>$category_type_id]);
             //   ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
             //   ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->orderBy('A.register_number,H.subject_code');
            $cia_list = $query->createCommand()->queryAll();*/
             $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.category_type_id_marks as CIA,F.year,E.programme_name,D.degree_name')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')                
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc, 'A.student_status' => 'Active','F.category_type_id'=>$category_type_id]);
             //   ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
             //   ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->orderBy('A.register_number,H.subject_code');
            $cia_list = $query->createCommand()->queryAll();

            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,total_minimum_pass as min_pass')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
              //  ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc]);
                //'F.category_type_id'=>$category_type_id]);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $subject_get_data->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();
            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
             //   ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')

                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id and F.subject_map_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $sem_valc]);
                //'F.category_type_id'=>$category_type_id]);
           // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //    ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $countOfSubjects = $countQuery->createCommand()->queryAll();
            if (!empty($cia_list)) {
                return $this->render('ciamarklist', [
                    'model' => $model,
                    'cia_list' => $cia_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/ciamarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to CIA Mark List');
            return $this->render('ciamarklist', [
                'model' => $model,
            ]);
        }
    }
    public function actionCiaMarkListPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['cia_mark_list'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'CIA MARK LIST.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => 'CIA MARK LIST'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate CIA Mark List' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelCiaMarkList()
    {
        
        $content = $_SESSION['cia_mark_list'];
            
        $fileName = "CIA Mark List" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionEsemarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {
            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.CIA,F.ESE,F.grade_name,F.year,J.category_type as month,K.category_type as exam_type,E.programme_name,D.degree_name')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.mark_type')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term'], 'A.student_status' => 'Active']);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->orderBy('A.register_number,H.subject_code');
            $ese_list = $query->createCommand()->queryAll();
            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term']]);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $subject_get_data->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();
            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term']]);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $countOfSubjects = $countQuery->createCommand()->queryAll();
            if (!empty($ese_list)) {
                return $this->render('esemarklist', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/esemarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ESE Mark List');
            return $this->render('esemarklist', [
                'model' => $model,
            ]);
        }
    }
    public function actionEseMarkListPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['ese_mark_list'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'ESE MARK LIST.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'ESE MARK LIST'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate ESE Mark List' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelEseMarkList()
    {
        
        $content = $_SESSION['ese_mark_list'];
           
        $fileName = "ESE Mark List" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }


 public function actionEsemarklist1()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $dummy_entry_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE(Dummy)%' OR description like '%ESE(Dummy)%'")->queryScalar();
        $Reval = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Revaluation%' OR description like '%Revaluation%'")->queryScalar();
        $Mod = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Moderation%' OR description like '%Moderation%'")->queryScalar();



        $model = new MarkEntry();
        if (Yii::$app->request->post()) {
            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.category_type_id_marks as ESE,F.year,J.category_type as month,K.category_type as exam_type,E.programme_name,D.degree_name')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.mark_type')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term'], 'A.student_status' => 'Active','F.category_type_id'=>'49']);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query->orderBy('A.register_number,H.subject_code');
            $ese_list= $query->createCommand()->queryAll();
            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term'],'student_status'=>'Active','F.category_type_id'=>'49']);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $subject_get_data->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();
            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.mark_type' => $_POST['mark_type'], 'F.term' => $_POST['term'],'student_status'=>'Active','F.category_type_id'=>'49']);
            // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //     ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $countOfSubjects = $countQuery->createCommand()->queryAll();
            if (!empty($ese_list)) {
                return $this->render('esemarklist1', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                   
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/esemarklist1']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ESE Mark List');
            return $this->render('esemarklist1', [
                'model' => $model,
            ]);
        }
    }

    public function actionEseMarkList1Pdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['ese_mark_list1'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'ESE MARK LIST 100.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'ESE MARK LIST'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate ESE Mark List' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelEseMarkList1()
    {
        
        $content = $_SESSION['ese_mark_list1'];
           
        $fileName = "ESE Mark List 100" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

  public function actionScrutinyEsemarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $dummy_entry_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE(Dummy)%' OR description like '%ESE(Dummy)%'")->queryScalar();
       // $ESE = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       
        $Reval = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Revaluation%' OR description like '%Revaluation%'")->queryScalar();
        $Mod = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Moderation%' OR description like '%Moderation%'")->queryScalar();

        
        $model = new MarkEntry();
        if (Yii::$app->request->post()) {

            $sem = ConfigUtilities::semCaluclation($_POST['mark_year'], $_POST['month'], $_POST['bat_map_val']);

            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,BAR.grand_total as ese_mark,F.student_map_id,F.month,F.subject_map_id,G.paper_type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_dummy_number as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_val_barcode_verify_details as BAR', 'BAR.dummy_number=DUM.dummy_number')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.category_type_id' => '46'])->andWhere(['<>','G.paper_type_id','137'])->andWhere(['<>','G.paper_type_id','10'])->andWhere(['<>','G.paper_type_id','106']);

            if($_POST['mark_range_to']>0)
            {
                 $query->andWhere(['between', 'I.grand_total', $_POST['mark_range_from'], $_POST['mark_range_to']]);
            }
            $query->orderBy('A.register_number,H.subject_code');

            $ese_list= $query->createCommand()->queryAll();

           /* $query_sw = new  Query();
            $query_sw->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,DUM.grand_total as ese_mark,F.student_map_id,F.month,F.subject_map_id,G.paper_type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_scrtny_sw_based as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_sw->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.category_type_id' => '46'])->andWhere(['=','G.paper_type_id','137'])->andWhere(['<>','G.paper_type_id','10']);

            if($_POST['mark_range_to']>0)
            {
                 $query_sw->andWhere(['between', 'F.grand_total', $_POST['mark_range_from'], $_POST['mark_range_to']]);
            }
            $query_sw->orderBy('A.register_number,H.subject_code');

            $ese_list1= $query_sw->createCommand()->queryAll();*/
            $ese_list1 =array();
            if(!empty($ese_list1))
            {
                $ese_list = array_merge($ese_list,$ese_list1);
            }
 
            
            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code,G.coe_subjects_mapping_id as subject_map_id, H.subject_name, H.CIA_min, H.CIA_max, H.ESE_min, H.ESE_max,H.total_minimum_pass,G.paper_type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']])->andWhere(['<>','G.paper_type_id','10'])->andWhere(['<>','G.paper_type_id','106']);
            $query->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();

            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']])->andWhere(['<>','G.paper_type_id','10'])->andWhere(['<>','G.paper_type_id','106']);
            $countOfSubjects = $countQuery->createCommand()->queryScalar();

            if (!empty($ese_list)) {
                return $this->render('scrutiny-esemarklist', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                    'batch_mapping_id'=>$_POST['bat_map_val'],
                    'year'=>$_POST['mark_year'],
                    'month'=>$_POST['month'],
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/scrutiny-esemarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ESE Mark List');
            return $this->render('scrutiny-esemarklist', [
                'model' => $model,
            ]);
        }
    }

    public function actionScruEseMarkList1Pdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['scrutiny_ese_mark_list1'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'ESE MARK LIST 100 Before Moderation.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'ESE MARK LIST Before Moderation'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate ESE Mark List Before Moderation' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelScruEseMarkList1()
    {
        
        $content = $_SESSION['scrutiny_ese_mark_list1'];
           
        $fileName = "ESE Mark List 100 Before Moderation" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

     public function actionCiaesemigrate()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMasterTemp();
        $verify_stu_data='';
        if(Yii::$app->request->post())
        {
            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $externAl = Categorytype::find()->where(['category_type'=>'ESE'])->one();
            $category_type_id = Categorytype::find()->where(['description'=>"ESE(Dummy)"])->one();
            $cia_type_id = Categorytype::find()->where(['description'=>"CIA"])->orWhere(['description'=>'Internal'])->orWhere(['description'=>"Internal Final"])->one();
            $reg_cat_id = Categorytype::find()->where(['description'=>"Regular"])->one();
            $arr_cat_id = Categorytype::find()->where(['description'=>"Arrear"])->one();
            $exam_term_id = Categorytype::find()->where(['description'=>"End"])->one();
            $exam_term = $exam_term_id->coe_category_type_id;
            $notFound = 0;
                        
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId();

            $exam_year = $_POST['year'];
            $exam_month = $_POST['month'];
            $batch_id = $_POST['bat_val'];
            $batch_map_id = $_POST['bat_map_val'];
            if($_POST['moderation']!='')
            {
                 $moderation = $_POST['moderation']; //exit;
            }
            else
            {
                  $moderation = 'off';
            }

            $sem_verify = ConfigUtilities::SemCaluclation($exam_year,$exam_month,$batch_map_id);

            $get_tempmark_data = "SELECT A.subject_map_id,A.dummy_number,S.subject_code,S.subject_name,F.total as dummy_marks FROM coe_dummy_number AS A 
                    JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                    JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                    JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                    JOIN coe_mark_entry_master_temp as F ON F.student_map_id=A.student_map_id AND F.subject_map_id=A.subject_map_id  
                     WHERE F.mark_type=27 AND C.semester='".$sem_verify."' AND F.year='".$exam_year."' AND F.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND C.paper_type_id=8";

            $verify_tempmark_data = Yii::$app->db->createCommand($get_tempmark_data)->queryAll();
            //print_r($verify_tempmark_data); exit;
            if(empty($verify_tempmark_data))
            {
                $get_stu_data = "SELECT A.student_map_id,A.subject_map_id,A.dummy_number,S.subject_code,S.subject_name,F.grand_total as dummy_marks FROM coe_dummy_number AS A 
                    JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                    JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                    JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                    JOIN coe_val_barcode_verify_details as F ON F.dummy_number=A.dummy_number 
                     WHERE C.semester='".$sem_verify."' AND A.year='".$exam_year."' AND A.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND C.paper_type_id=8 ORDER BY S.subject_code "; //exit;

                $verify_stu_data = Yii::$app->db->createCommand($get_stu_data)->queryAll();
                //echo "<pre>";                
                //print_r($verify_stu_data); exit;
                $get_id_details_data = ['exam_year'=>$_POST['year'],'exam_month'=>$_POST['month']];

                foreach ($verify_stu_data as $value_mig) 
                {
                    $splited_dum_num = ltrim($value_mig['dummy_number'], '0');

                    $stu_cia_marks_check='';
                    $student_map_id = '';
                    $subject_map_id_dum = '';
                    $esemark=0;

                    $moderation_marks = Yii::$app->db->createCommand("SELECT mark FROM coe_vmoderation_normalization WHERE dummy_number='".$splited_dum_num."'")->queryScalar();

                    if($moderation=='on' && $moderation_marks>0)
                    {    
                         $esemark=$moderation_marks;
                    }
                    else
                    {
                         $esemark=$value_mig['dummy_marks'];
                    }

                    $getInfo = DummyNumbers::findOne(['dummy_number'=>$splited_dum_num,'ab_status'=>'NO','year'=>$_POST['year'],'month'=>$_POST['month']]);
                    if(empty($getInfo))
                    {
                        $notFound = $notFound+1;
                    }
                    else
                    {
                        $subject_map_id_dum = $getInfo['subject_map_id'];
                        $student_map_id = $getInfo['student_map_id'];
                        $stu_cia_marks_check = MarkEntry::find()->where(['student_map_id'=>$getInfo['student_map_id'],'category_type_id'=>$cia_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum])->one();
                    }
                    
                    if(empty($stu_cia_marks_check))
                    {
                        $stu_cia_marks_check_master = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->orderBy('coe_mark_entry_master_id asc')->one();
                        if(empty($stu_cia_marks_check_master))
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error','No Data Found!! Kindly Fininsh the Internal Mark Entry First.');
                                   
                           return $this->redirect(['mark-entry/ciaesemigrate']);   
                        }
                        else
                        {
                             $stu_cia_marks_check['category_type_id_marks'] = $stu_cia_marks_check_master['CIA'];
                        }
                                
                    }

                    $stu_cia_marks = MarkEntry::find()->where(['student_map_id'=>$student_map_id,'category_type_id'=>$category_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month']])->all();

                    $stu_ese_marks = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();
                       //echo $category_type_id->coe_category_type_id;exit; 

                          
                    if(empty($stu_cia_marks) && empty($stu_ese_marks))
                    { 
                        $mark_entry_master_temp = new MarkEntryMasterTemp();
                        $mark_entry = new MarkEntry();
                        $regulation = new Regulation();
                        $student = StudentMapping::findOne($student_map_id);
                        $checkMarkEntry = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->one();                    
                        $sub_map_ids = $subject_map_id_dum;
                        $exam_type = empty($checkMarkEntry)?$reg_cat_id->coe_category_type_id:$arr_cat_id->coe_category_type_id;

                        $stu_reg=StuInfo::findOne(['stu_map_id'=>$student_map_id]);

                        $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();

                        $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                        $batch_name= $getbatch['batch_name'];

                        $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$exam_type,'absent_term'=>$exam_term,'exam_subject_id'=>$sub_map_ids,'exam_month'=>$get_id_details_data['exam_month'],'exam_year'=>$get_id_details_data['exam_year']])->all();
                           
                        if(!empty($getAbsentList))
                        {
                            for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                            {        
                                $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$stu_cia_marks_check['category_type_id_marks'],'subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->orderBy('coe_mark_entry_id desc')->one();

                                $check_mark_entry_master = MarkEntryMaster::find()->where(['subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->one();

                                       /*  Send Student Mapping Id, Subject Mapping Id , CIA Marks & ESE Marks to get the appropriate results  */
                                
                                $ab_stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],'0',$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                                        /*  Result Completed Here */

                                $absen_model_save = new MarkEntry();
                                $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $absen_model_save->subject_map_id = $sub_map_ids;
                                $absen_model_save->category_type_id =$externAl->coe_category_type_id;
                                $absen_model_save->category_type_id_marks =0;
                                $absen_model_save->year = $get_id_details_data['exam_year'];
                                $absen_model_save->month = $get_id_details_data['exam_month'];
                                $absen_model_save->term = $exam_term;
                                $absen_model_save->mark_type = $exam_type;
                                $absen_model_save->created_at = $created_at;
                                $absen_model_save->created_by = $updateBy;
                                $absen_model_save->updated_at = $created_at;
                                $absen_model_save->updated_by = $updateBy;

                                if(empty($check_mark_entry) && empty($check_mark_entry_master) && $absen_model_save->save(false))
                                {
                                    $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                    $cia_marks = $ab_stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 

                                    unset($absen_model_save);
                                    $ab_MarkEntryMaster = new MarkEntryMaster();
                                    $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                    $ab_MarkEntryMaster->subject_map_id =$sub_map_ids;
                                    $ab_MarkEntryMaster->CIA = $cia_marks;
                                    $ab_MarkEntryMaster->ESE = 0;
                                    $ab_MarkEntryMaster->total = $cia_marks;
                                    $ab_MarkEntryMaster->result = 'Absent';
                                    $ab_MarkEntryMaster->grade_point = 0;
                                    $ab_MarkEntryMaster->grade_name = 'AB';
                                    $ab_MarkEntryMaster->attempt = $ab_stu_result_data['attempt'];
                                    $ab_MarkEntryMaster->year = $get_id_details_data['exam_year'];
                                    $ab_MarkEntryMaster->month = $get_id_details_data['exam_month'];
                                    $ab_MarkEntryMaster->term = $exam_term;
                                    $ab_MarkEntryMaster->mark_type = $exam_type;
                                    $ab_MarkEntryMaster->year_of_passing = '';
                                    $ab_MarkEntryMaster->status_id = 0;
                                    $ab_MarkEntryMaster->created_by = $updateBy;
                                    $ab_MarkEntryMaster->created_at = $created_at;
                                    $ab_MarkEntryMaster->updated_by = $updateBy;
                                    $ab_MarkEntryMaster->updated_at = $created_at;
                                    $ab_MarkEntryMaster->save(false);
                                    unset($ab_MarkEntryMaster);
                                }

                            }
                        }

                        $mark_entry->student_map_id = $student_map_id;
                        $mark_entry->subject_map_id = $sub_map_ids;
                        $mark_entry->category_type_id = $category_type_id->coe_category_type_id;
                        $mark_entry->category_type_id_marks =$esemark;
                        $mark_entry->year = $get_id_details_data['exam_year'];
                        $mark_entry->attendance_remarks = "Allowed";
                        $mark_entry->attendance_percentage = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_ABSENT_STATUS);
                        $mark_entry->month = $get_id_details_data['exam_month'];
                        $mark_entry->term = $exam_term;
                        $mark_entry->mark_type = $exam_type;
                        $mark_entry->status_id = 0;
                        $mark_entry->created_by = $updateBy;
                        $mark_entry->created_at = $created_at;                
                        $mark_entry->updated_at = $created_at;
                        $mark_entry->updated_by = $updateBy;

                                
                        $stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],$esemark,$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                
                        $cia_marks = $stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 
                                
                        $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $get_id_details_data['exam_month']. "-" . $get_id_details_data['exam_year'] : '';

                                /*  Result Completed Here */

                        if(!empty($stu_cia_marks_check) && empty($stu_ese_marks_temp) && $batch_name>=2021)
                        { 
                            $mark_entry_master_temp->student_map_id = $student_map_id;
                            $mark_entry_master_temp->subject_map_id = $sub_map_ids;
                            $mark_entry_master_temp->CIA = $cia_marks;
                            $mark_entry_master_temp->ESE = $stu_result_data['ese_marks'];
                            $mark_entry_master_temp->total = ($stu_result_data['ese_marks']+$cia_marks);
                            $mark_entry_master_temp->result = $stu_result_data['result'];
                            $mark_entry_master_temp->grade_point = $stu_result_data['grade_point'];
                            $mark_entry_master_temp->grade_name = $stu_result_data['grade_name'];
                            $mark_entry_master_temp->year = $get_id_details_data['exam_year'];
                            $mark_entry_master_temp->month = $get_id_details_data['exam_month'];
                            $mark_entry_master_temp->term = $exam_term;
                            $mark_entry_master_temp->mark_type = $exam_type;
                            $mark_entry_master_temp->status_id = 0;
                            $mark_entry_master_temp->attempt = $stu_result_data['attempt'];
                            $mark_entry_master_temp->year_of_passing = $year_of_passing;
                            $mark_entry_master_temp->created_by = $updateBy;
                            $mark_entry_master_temp->created_at = $created_at;                
                            $mark_entry_master_temp->updated_at = $created_at;
                            $mark_entry_master_temp->updated_by = $updateBy;
                            $mark_entry_master_temp->save(false);

                        }
                                   
                            
                        $transaction = Yii::$app->db->beginTransaction();
                        try
                        {
                            if($mark_entry->save(false))
                            {
                                $transaction->commit();
                                $totalSuccess+=1;
                                $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                            }
                            else
                            {
                                $transaction->rollback(); 
                                $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                            }
                            unset($mark_entry);unset($mark_entry_master);
                        }
                        catch(\Exception $e)
                        {
                            if($e->getCode()=='23000')
                            {
                                $message = "Duplicate Entry";
                            }
                            else
                            {
                                $message = "Error";
                            }
                            $dispResults[] = ['type' => 'E',  'message' => $message];
                        }

                        Yii::$app->ShowFlashMessages->setMsg('Success','Successfully Migrated');
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error',$student_map_id.'Unable to Insert the Data. Marks Already Exists');
                    }

                }
                if(isset($totalSuccess) && $totalSuccess>0)
                {
                    if(count($verify_stu_data)>0)
                    { 
                            Yii::$app->ShowFlashMessages->setMsg('Success','Mark entry data Successfully Migrated');
                             return $this->redirect(['mark-entry/ciaesemigrate']);
                            /*return $this->render('ciaesemigrate', [
                                'model' => $model,
                                'verify_stu_data'=>$verify_stu_data,
                            ]);*/
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error','Something Error! Please Check');
                        return $this->redirect(['mark-entry/ciaesemigrate']);
                    }
                }
                else
                {
                    Yii::$app->ShowFlashMessages->setMsg('Error','Unable to Insert Data! Please Check');
                    return $this->redirect(['mark-entry/ciaesemigrate']);
                }
                return $this->redirect(['mark-entry/ciaesemigrate']);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('WARNING', 'Marks already Migrated');
                return $this->render('ciaesemigrate', [
                    'model' => $model,
                    'verify_stu_data'=>$verify_stu_data,
                ]);
            }
        }
        else
        {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to CIA+ESE Migrate');
            return $this->render('ciaesemigrate', [
                'model' => $model,
                'verify_stu_data'=>$verify_stu_data,
            ]);
        }
        
    }

    public function actionTpmigrate()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMasterTemp();
        $verify_stu_data='';
        if(Yii::$app->request->post())
        {
            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $externAl = Categorytype::find()->where(['category_type'=>'ESE'])->one();
            $category_type_id = Categorytype::find()->where(['description'=>"ESE(Dummy)"])->one();
            $cia_type_id = Categorytype::find()->where(['description'=>"CIA"])->orWhere(['description'=>'Internal'])->orWhere(['description'=>"Internal Final"])->one();
            $reg_cat_id = Categorytype::find()->where(['description'=>"Regular"])->one();
            $arr_cat_id = Categorytype::find()->where(['description'=>"Arrear"])->one();
            $exam_term_id = Categorytype::find()->where(['description'=>"End"])->one();
            $exam_term = $exam_term_id->coe_category_type_id;
            $notFound = 0;
                        
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId();

            $exam_year = $_POST['year'];
            $exam_month = $_POST['month'];
            $batch_id = $_POST['bat_val'];
            $batch_map_id = $_POST['bat_map_val'];
            $mark_subject_code = $_POST['mark_subject_code'];
            if($_POST['moderation']!='')
            {
                 $moderation = $_POST['moderation']; //exit;
            }
            else
            {
                  $moderation = 'off';
            }

            $get_tempmark_data = "SELECT A.subject_map_id,A.dummy_number,S.subject_code,S.subject_name,F.total as dummy_marks FROM coe_dummy_number AS A 
                    JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                    JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                    JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                    JOIN coe_mark_entry_master_temp as F ON F.student_map_id=A.student_map_id AND F.subject_map_id=A.subject_map_id  
                    WHERE F.mark_type=27 AND F.year='".$exam_year."' AND F.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND A.subject_map_id = '".$mark_subject_code."' AND (C.paper_type_id=136 OR C.paper_type_id=137 OR C.paper_type_id=121)";

            $verify_tempmark_data = Yii::$app->db->createCommand($get_tempmark_data)->queryAll();

            $register_number='';
            if(empty($verify_tempmark_data))
            {
                $subMapping = SubjectsMapping::findOne($mark_subject_code);

                if($subMapping['paper_type_id']==137 && $subMapping['type_id']==144)
                {
                    $get_stu_data = "SELECT St.register_number,A.student_map_id,A.subject_map_id,S.subject_code,S.subject_name,A.out_of_100 as dummy_marks, C.type_id as subject_type_id FROM coe_practical_entry AS A 
                    JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                    JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                    JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id                   
                    JOIN coe_student St ON St.coe_student_id=B.student_rel_id
                     WHERE A.year='".$exam_year."' AND A.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND A.subject_map_id = '".$mark_subject_code."' AND (C.paper_type_id=137) ORDER BY S.subject_code "; //exit;
                    //echo Yii::$app->db->createCommand($get_stu_data)->getrawsql();exit;
                    $verify_stu_data = Yii::$app->db->createCommand($get_stu_data)->queryAll();

                     $get_id_details_data = ['exam_year'=>$_POST['year'],'exam_month'=>$_POST['month']];

                    foreach ($verify_stu_data as $value_mig) 
                    {
                        
                        $stu_cia_marks_check='';
                        $student_map_id = '';
                        $subject_map_id_dum = '';
                        $esemark=0;
                       
                        $tpesemark1=$value_mig['dummy_marks'];
                        $tpesemark=$value_mig['dummy_marks']*0.50;
                       
                        $subject_map_id_dum = $value_mig['subject_map_id'];
                        $student_map_id = $value_mig['student_map_id'];
                        $stu_cia_marks_check = MarkEntry::find()->where(['student_map_id'=>$value_mig['student_map_id'],'category_type_id'=>$cia_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum])->one();
                       
                        
                        if(empty($stu_cia_marks_check))
                        {
                            $stu_cia_marks_check_master = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->orderBy('coe_mark_entry_master_id asc')->one();
                            if(empty($stu_cia_marks_check_master))
                            {
                                Yii::$app->ShowFlashMessages->setMsg('Error','No Data Found!! Kindly Fininsh the Internal Mark Entry First.');
                                       
                               return $this->redirect(['mark-entry/tpmigrate']);   
                            }
                            else
                            {
                                 $stu_cia_marks_check['category_type_id_marks'] = $stu_cia_marks_check_master['CIA'];
                            }
                                    
                        }
                       
                       
                        $stu_cia_marks = MarkEntry::find()->where(['student_map_id'=>$student_map_id,'category_type_id'=>$category_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month']])->all();

                        $stu_ese_marks = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();
                          // echo $category_type_id->coe_category_type_id;exit; 

                        $register_number=$value_mig['register_number'];    
                        if(empty($stu_cia_marks) && empty($stu_ese_marks))
                        {
                            $mark_entry_master_temp = new MarkEntryMasterTemp();
                            $mark_entry = new MarkEntry();
                            $regulation = new Regulation();
                            $student = StudentMapping::findOne($student_map_id);
                            $checkMarkEntry = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->one();                    
                            $sub_map_ids = $subject_map_id_dum;
                            $exam_type = empty($checkMarkEntry)?$reg_cat_id->coe_category_type_id:$arr_cat_id->coe_category_type_id;

                            $stu_reg=StuInfo::findOne(['stu_map_id'=>$student_map_id]);

                            $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();

                            $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                            $batch_name= $getbatch['batch_name'];

                            $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$exam_type,'absent_term'=>$exam_term,'exam_subject_id'=>$sub_map_ids,'exam_month'=>$get_id_details_data['exam_month'],'exam_year'=>$get_id_details_data['exam_year']])->all();
                               
                            if(!empty($getAbsentList))
                            {
                                for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                                {        
                                    $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$stu_cia_marks_check['category_type_id_marks'],'subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->orderBy('coe_mark_entry_id desc')->one();

                                    $check_mark_entry_master = MarkEntryMaster::find()->where(['subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->one();

                                           /*  Send Student Mapping Id, Subject Mapping Id , CIA Marks & ESE Marks to get the appropriate results  */
                                    
                                    $ab_stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],'0',$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                                            /*  Result Completed Here */

                                    $absen_model_save = new MarkEntry();
                                    $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                    $absen_model_save->subject_map_id = $sub_map_ids;
                                    $absen_model_save->category_type_id =$externAl->coe_category_type_id;
                                    $absen_model_save->category_type_id_marks =0;
                                    $absen_model_save->year = $get_id_details_data['exam_year'];
                                    $absen_model_save->month = $get_id_details_data['exam_month'];
                                    $absen_model_save->term = $exam_term;
                                    $absen_model_save->mark_type = $exam_type;
                                    $absen_model_save->created_at = $created_at;
                                    $absen_model_save->created_by = $updateBy;
                                    $absen_model_save->updated_at = $created_at;
                                    $absen_model_save->updated_by = $updateBy;

                                    if(empty($check_mark_entry) && empty($check_mark_entry_master) && $absen_model_save->save(false))
                                    {
                                        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                        $cia_marks = $ab_stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 

                                        unset($absen_model_save);
                                        $ab_MarkEntryMaster = new MarkEntryMaster();
                                        $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                        $ab_MarkEntryMaster->subject_map_id =$sub_map_ids;
                                        $ab_MarkEntryMaster->CIA = $cia_marks;
                                        $ab_MarkEntryMaster->ESE = 0;
                                        $ab_MarkEntryMaster->total = $cia_marks;
                                        $ab_MarkEntryMaster->result = 'Absent';
                                        $ab_MarkEntryMaster->grade_point = 0;
                                        $ab_MarkEntryMaster->grade_name = 'AB';
                                        $ab_MarkEntryMaster->attempt = $ab_stu_result_data['attempt'];
                                        $ab_MarkEntryMaster->year = $get_id_details_data['exam_year'];
                                        $ab_MarkEntryMaster->month = $get_id_details_data['exam_month'];
                                        $ab_MarkEntryMaster->term = $exam_term;
                                        $ab_MarkEntryMaster->mark_type = $exam_type;
                                        $ab_MarkEntryMaster->year_of_passing = '';
                                        $ab_MarkEntryMaster->status_id = 0;
                                        $ab_MarkEntryMaster->created_by = $updateBy;
                                        $ab_MarkEntryMaster->created_at = $created_at;
                                        $ab_MarkEntryMaster->updated_by = $updateBy;
                                        $ab_MarkEntryMaster->updated_at = $created_at;
                                        $ab_MarkEntryMaster->save(false);
                                        unset($ab_MarkEntryMaster);
                                    }

                                }
                            }

                            $mark_entry->student_map_id = $student_map_id;
                            $mark_entry->subject_map_id = $sub_map_ids;
                            $mark_entry->category_type_id = $category_type_id->coe_category_type_id;
                            $mark_entry->category_type_id_marks =$tpesemark1;
                            $mark_entry->year = $get_id_details_data['exam_year'];
                            $mark_entry->attendance_remarks = "Allowed";
                            $mark_entry->attendance_percentage = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_ABSENT_STATUS);
                            $mark_entry->month = $get_id_details_data['exam_month'];
                            $mark_entry->term = $exam_term;
                            $mark_entry->mark_type = $exam_type;
                            $mark_entry->status_id = 0;
                            $mark_entry->created_by = $updateBy;
                            $mark_entry->created_at = $created_at;                
                            $mark_entry->updated_at = $created_at;
                            $mark_entry->updated_by = $updateBy;

                                    
                            $stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],$tpesemark1,$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                            $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                    
                            $cia_marks = $stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 
                                    
                            $year_of_passing ='';
                            $stu_result='';
                            $stu_grade_point='';
                            $stu_grade_name='';
                            if($tpesemark1>=45 && $stu_result_data['result']=='Pass')
                            {
                                $stutotal=($tpesemark+$cia_marks);
                                $getgradename = Yii::$app->db->createCommand("SELECT grade_name,grade_point FROM `coe_regulation` WHERE '".$stutotal."' between `grade_point_from` and `grade_point_to` and `coe_batch_id`='".$getbatch["coe_batch_id"]."' ")->queryOne();

                                $stu_result=$stu_result_data['result'];

                                $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $get_id_details_data['exam_month']. "-" . $get_id_details_data['exam_year'] : '';
                                $stu_grade_point=$stu_result_data['grade_point'];
                                $stu_grade_name=$stu_result_data['grade_name'];
                            }
                            else
                            {
                                $stutotal=($tpesemark+$cia_marks);
                                $stu_result='Fail';
                                $stu_grade_point='0';
                                $stu_grade_name='U';
                        
                            }

                                    /*  Result Completed Here */

                            if(!empty($stu_cia_marks_check) && empty($stu_ese_marks_temp) && $batch_name>=2021)
                            { 
                                $mark_entry_master_temp->student_map_id = $student_map_id;
                                $mark_entry_master_temp->subject_map_id = $sub_map_ids;
                                $mark_entry_master_temp->CIA = $cia_marks;
                                $mark_entry_master_temp->ESE = $tpesemark;
                                $mark_entry_master_temp->total = ($tpesemark+$cia_marks);
                                $mark_entry_master_temp->result = $stu_result;
                                $mark_entry_master_temp->grade_point = $stu_grade_point;
                                $mark_entry_master_temp->grade_name = $stu_grade_name;
                                $mark_entry_master_temp->year = $get_id_details_data['exam_year'];
                                $mark_entry_master_temp->month = $get_id_details_data['exam_month'];
                                $mark_entry_master_temp->term = $exam_term;
                                $mark_entry_master_temp->mark_type = $exam_type;
                                $mark_entry_master_temp->status_id = 0;
                                $mark_entry_master_temp->attempt = $stu_result_data['attempt'];
                                $mark_entry_master_temp->year_of_passing = $year_of_passing;
                                $mark_entry_master_temp->created_by = $updateBy;
                                $mark_entry_master_temp->created_at = $created_at;                
                                $mark_entry_master_temp->updated_at = $created_at;
                                $mark_entry_master_temp->updated_by = $updateBy;
                                $mark_entry_master_temp->save(false);

                            }
                                       
                                
                            $transaction = Yii::$app->db->beginTransaction();
                            try
                            {
                                if($mark_entry->save(false))
                                {
                                    $transaction->commit();
                                    $totalSuccess+=1;
                                    $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                                }
                                else
                                {
                                    $transaction->rollback(); 
                                    $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                                }
                                unset($mark_entry);unset($mark_entry_master);
                            }
                            catch(\Exception $e)
                            {
                                if($e->getCode()=='23000')
                                {
                                    $message = "Duplicate Entry";
                                }
                                else
                                {
                                    $message = "Error";
                                }
                                $dispResults[] = ['type' => 'E',  'message' => $message];
                            }

                            //Yii::$app->ShowFlashMessages->setMsg('Success','Successfully Migrated');
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error',$register_number.'Unable to Insert the Data. Marks Already Exists');
                        }

                    }
                    if(isset($totalSuccess) && $totalSuccess>0)
                    {
                        if(count($verify_stu_data)>0)
                        { 
                            $get_tempmark_data = "SELECT A.subject_map_id,St.register_number,S.subject_code,S.subject_name,F.* FROM coe_practical_entry AS A 
                            JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                            JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                            JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                            JOIN coe_mark_entry_master_temp as F ON F.student_map_id=A.student_map_id AND F.subject_map_id=A.subject_map_id 
                            JOIN coe_student St ON St.coe_student_id=B.student_rel_id
                            WHERE F.mark_type=27 AND F.year='".$exam_year."' AND F.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND A.subject_map_id = '".$mark_subject_code."' AND (C.paper_type_id=137)";

                             $verify_tempmark_data = Yii::$app->db->createCommand($get_tempmark_data)->queryAll();
                                Yii::$app->ShowFlashMessages->setMsg('Success','Mark entry data Successfully Migrated');
                                 //return $this->redirect(['mark-entry/tpmigrate']);
                                 return $this->render('tpmigrate', [
                                    'model' => $model,
                                    'verify_tempmark_data'=>$verify_tempmark_data,
                                ]);
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error','Something Error! Please Check');
                            return $this->redirect(['mark-entry/tpmigrate']);
                        }
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error',$register_number.'Unable to Insert Data! Please Check');
                        return $this->redirect(['mark-entry/tpmigrate']);
                    }
                }   
                else
                {
                    $get_stu_data = "SELECT St.register_number,A.student_map_id,A.subject_map_id,A.dummy_number,S.subject_code,S.subject_name,F.grand_total as dummy_marks, C.type_id as subject_type_id FROM coe_dummy_number AS A 
                    JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                    JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                    JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                    JOIN coe_val_barcode_verify_details as F ON F.dummy_number=A.dummy_number 
                    JOIN coe_student St ON St.coe_student_id=B.student_rel_id
                     WHERE A.year='".$exam_year."' AND A.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND A.subject_map_id = '".$mark_subject_code."' AND (C.paper_type_id=137 OR C.paper_type_id=136 OR C.paper_type_id=121) ORDER BY S.subject_code "; //exit;
                    //echo Yii::$app->db->createCommand($get_stu_data)->getrawsql();exit;
                    $verify_stu_data = Yii::$app->db->createCommand($get_stu_data)->queryAll();
                    $get_id_details_data = ['exam_year'=>$_POST['year'],'exam_month'=>$_POST['month']];

                    foreach ($verify_stu_data as $value_mig) 
                    {
                        $splited_dum_num = ltrim($value_mig['dummy_number'], '0');

                        $stu_cia_marks_check='';
                        $student_map_id = '';
                        $subject_map_id_dum = '';
                        $esemark=0;

                        $moderation_marks = Yii::$app->db->createCommand("SELECT mark FROM coe_vmoderation_normalization WHERE dummy_number='".$splited_dum_num."'")->queryScalar();

                        if($moderation=='on' && $moderation_marks>0)
                        {    
                             $esemark=$moderation_marks;
                        }
                        else
                        {
                             $esemark=$value_mig['dummy_marks'];
                        }

                        $getInfo = DummyNumbers::findOne(['dummy_number'=>$splited_dum_num,'ab_status'=>'NO','year'=>$_POST['year'],'month'=>$_POST['month']]);
                        if(empty($getInfo))
                        {
                            $notFound = $notFound+1;
                        }
                        else
                        {
                            $subject_map_id_dum = $getInfo['subject_map_id'];
                            $student_map_id = $getInfo['student_map_id'];
                            $stu_cia_marks_check = MarkEntry::find()->where(['student_map_id'=>$getInfo['student_map_id'],'category_type_id'=>$cia_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum])->one();
                        }
                        
                        if(empty($stu_cia_marks_check))
                        {
                            $stu_cia_marks_check_master = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->orderBy('coe_mark_entry_master_id asc')->one();
                            if(empty($stu_cia_marks_check_master))
                            {
                                Yii::$app->ShowFlashMessages->setMsg('Error','No Data Found!! Kindly Fininsh the Internal Mark Entry First.');
                                       
                               return $this->redirect(['mark-entry/tpmigrate']);   
                            }
                            else
                            {
                                 $stu_cia_marks_check['category_type_id_marks'] = $stu_cia_marks_check_master['CIA'];
                            }
                                    
                        }

                        $practical_mark = PracticalEntry::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month']])->one();
                       
                        $prac_mark=0;
                        if(!empty($practical_mark))
                        {
                            $prac_mark = $practical_mark['out_of_100'];
                        }
                        else
                        {
                            $prac_mark=0;
                        }
                        
                        $tpesemark=0;
                        if($value_mig['subject_type_id']=='140')
                        {

                            $tpesemark = round(($esemark*0.25) + ($prac_mark*0.25));
                        }
                        else if($value_mig['subject_type_id']=='141')
                        {
                            $tpesemark = round(($esemark*0.35) + ($prac_mark*0.15));
                        }
                        else if($value_mig['subject_type_id']=='142')
                        {
                            $tpesemark = round(($esemark*0.15) + ($prac_mark*0.35));
                        }
                        else
                        {
                            $tpesemark =round($esemark*0.50);
                        } 

                        $tpesemark1 =$tpesemark*2;
                       //echo $tpesemark1 =$tpesemark*2; exit;
                        //echo $value_mig['subject_type_id'].$esemark.$prac_mark; exit;
                        $stu_cia_marks = MarkEntry::find()->where(['student_map_id'=>$student_map_id,'category_type_id'=>$category_type_id->coe_category_type_id,'subject_map_id'=>$subject_map_id_dum,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month']])->all();

                        $stu_ese_marks = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();
                          // echo $category_type_id->coe_category_type_id;exit; 

                        $register_number=$value_mig['register_number'];    
                        if(empty($stu_cia_marks) && empty($stu_ese_marks))
                        {
                            $mark_entry_master_temp = new MarkEntryMasterTemp();
                            $mark_entry = new MarkEntry();
                            $regulation = new Regulation();
                            $student = StudentMapping::findOne($student_map_id);
                            $checkMarkEntry = MarkEntryMaster::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id_dum])->one();                    
                            $sub_map_ids = $subject_map_id_dum;
                            $exam_type = empty($checkMarkEntry)?$reg_cat_id->coe_category_type_id:$arr_cat_id->coe_category_type_id;

                            $stu_reg=StuInfo::findOne(['stu_map_id'=>$student_map_id]);

                            $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();

                            $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                            $batch_name= $getbatch['batch_name'];

                            $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$exam_type,'absent_term'=>$exam_term,'exam_subject_id'=>$sub_map_ids,'exam_month'=>$get_id_details_data['exam_month'],'exam_year'=>$get_id_details_data['exam_year']])->all();
                               
                            if(!empty($getAbsentList))
                            {
                                for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                                {        
                                    $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$stu_cia_marks_check['category_type_id_marks'],'subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->orderBy('coe_mark_entry_id desc')->one();

                                    $check_mark_entry_master = MarkEntryMaster::find()->where(['subject_map_id'=>$sub_map_ids,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'term'=>$exam_term,'mark_type'=>$exam_type])->one();

                                           /*  Send Student Mapping Id, Subject Mapping Id , CIA Marks & ESE Marks to get the appropriate results  */
                                    
                                    $ab_stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],'0',$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                                            /*  Result Completed Here */

                                    $absen_model_save = new MarkEntry();
                                    $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                    $absen_model_save->subject_map_id = $sub_map_ids;
                                    $absen_model_save->category_type_id =$externAl->coe_category_type_id;
                                    $absen_model_save->category_type_id_marks =0;
                                    $absen_model_save->year = $get_id_details_data['exam_year'];
                                    $absen_model_save->month = $get_id_details_data['exam_month'];
                                    $absen_model_save->term = $exam_term;
                                    $absen_model_save->mark_type = $exam_type;
                                    $absen_model_save->created_at = $created_at;
                                    $absen_model_save->created_by = $updateBy;
                                    $absen_model_save->updated_at = $created_at;
                                    $absen_model_save->updated_by = $updateBy;

                                    if(empty($check_mark_entry) && empty($check_mark_entry_master) && $absen_model_save->save(false))
                                    {
                                        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                        $cia_marks = $ab_stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 

                                        unset($absen_model_save);
                                        $ab_MarkEntryMaster = new MarkEntryMaster();
                                        $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                        $ab_MarkEntryMaster->subject_map_id =$sub_map_ids;
                                        $ab_MarkEntryMaster->CIA = $cia_marks;
                                        $ab_MarkEntryMaster->ESE = 0;
                                        $ab_MarkEntryMaster->total = $cia_marks;
                                        $ab_MarkEntryMaster->result = 'Absent';
                                        $ab_MarkEntryMaster->grade_point = 0;
                                        $ab_MarkEntryMaster->grade_name = 'AB';
                                        $ab_MarkEntryMaster->attempt = $ab_stu_result_data['attempt'];
                                        $ab_MarkEntryMaster->year = $get_id_details_data['exam_year'];
                                        $ab_MarkEntryMaster->month = $get_id_details_data['exam_month'];
                                        $ab_MarkEntryMaster->term = $exam_term;
                                        $ab_MarkEntryMaster->mark_type = $exam_type;
                                        $ab_MarkEntryMaster->year_of_passing = '';
                                        $ab_MarkEntryMaster->status_id = 0;
                                        $ab_MarkEntryMaster->created_by = $updateBy;
                                        $ab_MarkEntryMaster->created_at = $created_at;
                                        $ab_MarkEntryMaster->updated_by = $updateBy;
                                        $ab_MarkEntryMaster->updated_at = $created_at;
                                        $ab_MarkEntryMaster->save(false);
                                        unset($ab_MarkEntryMaster);
                                    }

                                }
                            }

                            $mark_entry->student_map_id = $student_map_id;
                            $mark_entry->subject_map_id = $sub_map_ids;
                            $mark_entry->category_type_id = $category_type_id->coe_category_type_id;
                            $mark_entry->category_type_id_marks =$tpesemark1;
                            $mark_entry->year = $get_id_details_data['exam_year'];
                            $mark_entry->attendance_remarks = "Allowed";
                            $mark_entry->attendance_percentage = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_ABSENT_STATUS);
                            $mark_entry->month = $get_id_details_data['exam_month'];
                            $mark_entry->term = $exam_term;
                            $mark_entry->mark_type = $exam_type;
                            $mark_entry->status_id = 0;
                            $mark_entry->created_by = $updateBy;
                            $mark_entry->created_at = $created_at;                
                            $mark_entry->updated_at = $created_at;
                            $mark_entry->updated_by = $updateBy;

                                    
                            $stu_result_data = ConfigUtilities::StudentResult($student_map_id,$sub_map_ids,$stu_cia_marks_check['category_type_id_marks'],$tpesemark1,$get_id_details_data['exam_year'],$get_id_details_data['exam_month']);

                            $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                    
                            $cia_marks = $stu_result_data['attempt']>$config_attempt ? 0:$stu_cia_marks_check['category_type_id_marks']; 
                                    
                            $year_of_passing ='';
                            $stu_result='';
                            $stu_grade_point='';
                            $stu_grade_name='';
                            if($tpesemark1>=45 && $stu_result_data['result']=='Pass')
                            {
                                $stutotal=($tpesemark+$cia_marks);
                                $getgradename = Yii::$app->db->createCommand("SELECT grade_name,grade_point FROM `coe_regulation` WHERE '".$stutotal."' between `grade_point_from` and `grade_point_to` and `coe_batch_id`='".$getbatch["coe_batch_id"]."' ")->queryOne();

                                $stu_result=$stu_result_data['result'];

                                $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $get_id_details_data['exam_month']. "-" . $get_id_details_data['exam_year'] : '';
                                $stu_grade_point=$stu_result_data['grade_point'];
                                $stu_grade_name=$stu_result_data['grade_name'];
                            }
                            else
                            {
                                $stutotal=($tpesemark+$cia_marks);
                                $stu_result='Fail';
                                $stu_grade_point='0';
                                $stu_grade_name='U';

                               /* $stu_ese_mark_master = MarkEntryMasterTemp::find()->where(['student_map_id'=>$student_map_id,'year'=>$get_id_details_data['exam_year'],'month'=>$get_id_details_data['exam_month'],'subject_map_id'=>$subject_map_id_dum])->all();

                                if(empty($stu_ese_mark_master))
                                {
                                    $mark_entry_master = new MarkEntryMaster();
                                    $mark_entry_master->student_map_id = $student_map_id;
                                    $mark_entry_master->subject_map_id = $sub_map_ids;
                                    $mark_entry_master->CIA = $cia_marks;
                                    $mark_entry_master->ESE = $tpesemark;
                                    $mark_entry_master->total = ($tpesemark+$cia_marks);
                                    $mark_entry_master->result = $stu_result;
                                    $mark_entry_master->grade_point = $stu_grade_point;
                                    $mark_entry_master->grade_name = $stu_grade_name;
                                    $mark_entry_master->year = $get_id_details_data['exam_year'];
                                    $mark_entry_master->month = $get_id_details_data['exam_month'];
                                    $mark_entry_master->term = $exam_term;
                                    $mark_entry_master->mark_type = $exam_type;
                                    $mark_entry_master->status_id = 0;
                                    $mark_entry_master->attempt = $stu_result_data['attempt'];
                                    $mark_entry_master->year_of_passing = $year_of_passing;
                                    $mark_entry_master->created_by = $updateBy;
                                    $mark_entry_master->created_at = $created_at;                
                                    $mark_entry_master->updated_at = $created_at;
                                    $mark_entry_master->updated_by = $updateBy;
                                    $mark_entry_master->save(false);
                                }*/
                            }

                                    /*  Result Completed Here */

                            if(!empty($stu_cia_marks_check) && empty($stu_ese_marks_temp) && $batch_name>=2021)
                            { 
                                $mark_entry_master_temp->student_map_id = $student_map_id;
                                $mark_entry_master_temp->subject_map_id = $sub_map_ids;
                                $mark_entry_master_temp->CIA = $cia_marks;
                                $mark_entry_master_temp->ESE = $tpesemark;
                                $mark_entry_master_temp->total = ($tpesemark+$cia_marks);
                                $mark_entry_master_temp->result = $stu_result;
                                $mark_entry_master_temp->grade_point = $stu_grade_point;
                                $mark_entry_master_temp->grade_name = $stu_grade_name;
                                $mark_entry_master_temp->year = $get_id_details_data['exam_year'];
                                $mark_entry_master_temp->month = $get_id_details_data['exam_month'];
                                $mark_entry_master_temp->term = $exam_term;
                                $mark_entry_master_temp->mark_type = $exam_type;
                                $mark_entry_master_temp->status_id = 0;
                                $mark_entry_master_temp->attempt = $stu_result_data['attempt'];
                                $mark_entry_master_temp->year_of_passing = $year_of_passing;
                                $mark_entry_master_temp->created_by = $updateBy;
                                $mark_entry_master_temp->created_at = $created_at;                
                                $mark_entry_master_temp->updated_at = $created_at;
                                $mark_entry_master_temp->updated_by = $updateBy;
                                $mark_entry_master_temp->save(false);

                            }
                                       
                                
                            $transaction = Yii::$app->db->beginTransaction();
                            try
                            {
                                if($mark_entry->save(false))
                                {
                                    $transaction->commit();
                                    $totalSuccess+=1;
                                    $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                                }
                                else
                                {
                                    $transaction->rollback(); 
                                    $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                                }
                                unset($mark_entry);unset($mark_entry_master);
                            }
                            catch(\Exception $e)
                            {
                                if($e->getCode()=='23000')
                                {
                                    $message = "Duplicate Entry";
                                }
                                else
                                {
                                    $message = "Error";
                                }
                                $dispResults[] = ['type' => 'E',  'message' => $message];
                            }

                            //Yii::$app->ShowFlashMessages->setMsg('Success','Successfully Migrated');
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error',$register_number.'Unable to Insert the Data. Marks Already Exists');
                        }

                    }
                    if(isset($totalSuccess) && $totalSuccess>0)
                    {
                        if(count($verify_stu_data)>0)
                        { 
                            $get_tempmark_data = "SELECT A.subject_map_id,St.register_number,S.subject_code,S.subject_name,F.* FROM coe_dummy_number AS A 
                            JOIN coe_student_mapping As B ON B.coe_student_mapping_id=A.student_map_id
                            JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.subject_map_id 
                            JOIN coe_subjects as S ON S.coe_subjects_id=C.subject_id
                            JOIN coe_mark_entry_master_temp as F ON F.student_map_id=A.student_map_id AND F.subject_map_id=A.subject_map_id 
                            JOIN coe_student St ON St.coe_student_id=B.student_rel_id
                            WHERE F.mark_type=27 AND F.year='".$exam_year."' AND F.month='".$exam_month."' AND C.batch_mapping_id = '".$batch_map_id."' AND A.subject_map_id = '".$mark_subject_code."' AND (C.paper_type_id=136 OR C.paper_type_id=137 OR C.paper_type_id=121)";

                             $verify_tempmark_data = Yii::$app->db->createCommand($get_tempmark_data)->queryAll();
                                Yii::$app->ShowFlashMessages->setMsg('Success','Mark entry data Successfully Migrated');
                                 //return $this->redirect(['mark-entry/tpmigrate']);
                                 return $this->render('tpmigrate', [
                                    'model' => $model,
                                    'verify_tempmark_data'=>$verify_tempmark_data,
                                ]);
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error','Something Error! Please Check');
                            return $this->redirect(['mark-entry/tpmigrate']);
                        }
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error',$register_number.'Unable to Insert Data! Please Check');
                        return $this->redirect(['mark-entry/tpmigrate']);
                    }
                }

                
                return $this->redirect(['mark-entry/tpmigrate']);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('WARNING', 'Marks already Migrated');
                return $this->render('tpmigrate', [
                    'model' => $model,
                    'verify_stu_data'=>$verify_stu_data,
                ]);
            }
        }
        else
        {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to T & P Migrate');
            return $this->render('tpmigrate', [
                'model' => $model,
                'verify_stu_data'=>$verify_stu_data,
            ]);
        }
        
    }

    public function actionPracticalmigrate()
    {
        $model = new MarkEntry();
        $practicalmodel = new PracticalEntry();

        if (Yii::$app->request->post()) 
        {
            if(isset($_POST['stu_map_ids']) && !empty($_POST['stu_map_ids']) && isset($_POST['stu_marks']) && !empty($_POST['stu_marks']) )
            {
                $stuCount = count($_POST['stu_map_ids']);
                $stuMarksCount = count($_POST['stu_marks']);
                $subject_map_id = $_POST['sub_val'];
                $month = $_POST['month'];
                $year = $_POST['year'];
               
                $mark_type =$_POST['MarkEntry']['mark_type'];
                $created_at = date("Y-m-d H:i:s");
                $updateBy = Yii::$app->user->getId(); 
                $cia = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%CIA%' OR category_type like '%Internal%'")->queryScalar();
                $externAl = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%'")->queryScalar();
                $term = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%End%'")->queryScalar();

                $subMapping = SubjectsMapping::findOne($subject_map_id);
                $subJecs = Subjects::findOne($subMapping->subject_id);

                $check_CIA_marks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id])->one();
                $migrade_status = 0;

                if(!empty($check_CIA_marks) && $subJecs['ESE_max']!==0 )
                { 
                    if($mark_type==28 && $subMapping['semester']==1)
                    {
                        $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year])->all();
                        
                        $ab_stuMap_ids = [];
                        if(!empty($getAbsentList))
                        {
                            for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                            { 
                                $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                               
                               $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                                $absen_model_save = new MarkEntry();
                                $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $absen_model_save->subject_map_id = $subject_map_id;
                                $absen_model_save->category_type_id =$externAl;
                                $absen_model_save->category_type_id_marks =0;
                                $absen_model_save->year = $year;
                                $absen_model_save->month = $month;
                                $absen_model_save->term = $term;
                                $absen_model_save->mark_type = $mark_type;
                                $absen_model_save->created_at = $created_at;
                                $absen_model_save->created_by = $updateBy;
                                $absen_model_save->updated_at = $created_at;
                                $absen_model_save->updated_by = $updateBy;

                                $check_mark_entry_master = MarkEntryMaster::find()->where(['student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();


                                if(empty($check_mark_entry_master) && empty($check_mark_entry) && !empty($stuCiaMarks) && $absen_model_save->save(false))
                                {
                                    $ab_stuMap_ids[$getAbsentList[$abse]['absent_student_reg']] = $getAbsentList[$abse]['absent_student_reg'];
                                    unset($absen_model_save);
                                    $ab_MarkEntryMaster = new MarkEntryMaster();
                                    $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                    $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                                    $ab_MarkEntryMaster->CIA = $stuCiaMarks->category_type_id_marks;
                                    $ab_MarkEntryMaster->ESE = 0;
                                    $ab_MarkEntryMaster->total = $stuCiaMarks->category_type_id_marks;
                                    $ab_MarkEntryMaster->result = 'Absent';
                                    $ab_MarkEntryMaster->grade_point = 0;
                                    $ab_MarkEntryMaster->grade_name = 'AB';
                                    $ab_MarkEntryMaster->attempt = 0;
                                    $ab_MarkEntryMaster->year = $year;
                                    $ab_MarkEntryMaster->month = $month;
                                    $ab_MarkEntryMaster->term = $term;
                                    $ab_MarkEntryMaster->mark_type = $mark_type;
                                    $ab_MarkEntryMaster->year_of_passing = '';
                                    $ab_MarkEntryMaster->status_id = 0;
                                    $ab_MarkEntryMaster->created_by = $updateBy;
                                    $ab_MarkEntryMaster->created_at = $created_at;
                                    $ab_MarkEntryMaster->updated_by = $updateBy;
                                    $ab_MarkEntryMaster->updated_at = $created_at;
                                    if($ab_MarkEntryMaster->save(false))
                                    {
                                        $migrate_ab = Yii::$app->db;
                                        $update_status = $command_ab = $migrate_ab->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$getAbsentList[$abse]['absent_student_reg'].'" and year="'.$year.'" and month="'.$month.'" ');
                                        $command_ab->execute();
                                        $migrade_status++;
                                    }
                                    unset($ab_MarkEntryMaster);

                                }

                            }
                        } // Absent Entry result For Loop Ends Here 
                        for ($i=0; $i <count($_POST['stu_map_ids']) ; $i++) 
                        { 
                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i]])->orderBy('coe_mark_entry_id desc')->one();

                            $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                                $markEntry = new MarkEntry();
                                $markEntry->student_map_id = $_POST['stu_map_ids'][$i];
                                $markEntry->subject_map_id = $subject_map_id;
                                $markEntry->category_type_id =$externAl;
                                $markEntry->category_type_id_marks =$_POST['stu_marks'][$i];
                                $markEntry->year = $year;
                                $markEntry->month = $month;
                                $markEntry->term = $term;
                                $markEntry->mark_type = $mark_type;
                                $markEntry->created_at = $created_at;
                                $markEntry->created_by = $updateBy;
                                $markEntry->updated_at = $created_at;
                                $markEntry->updated_by = $updateBy;

                            if(empty($check_mark_entry) && !in_array($_POST['stu_map_ids'][$i], $ab_stuMap_ids) && $markEntry->save(false))
                            {

                                unset($markEntry);

                                $markentrymaster = new MarkEntryMaster();
                                $markentrymastertemp = new MarkEntryMasterTemp();
                                $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $subject_map_id . '" AND student_map_id="' . $_POST['stu_map_ids'][$i] . '" AND result not like "%pass%"')->queryScalar();
                                $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                if ($check_attempt >= $config_attempt) {
                                    $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, 0, $_POST['stu_marks'][$i],$year,$month);
                                    $markentrymaster->CIA = 0;
                                    $markentrymastertemp->CIA = 0;
                                    
                                } else {
                                    $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, $stuCiaMarks->category_type_id_marks, $_POST['stu_marks'][$i],$year,$month);
                                    if(!empty($stuCiaMarks->category_type_id_marks))
                                    {
                                        $markentrymaster->CIA = $stuCiaMarks->category_type_id_marks;
                                        $markentrymastertemp->CIA = $stuCiaMarks->category_type_id_marks;
                                    }
                                    else
                                    {
                                        $markentrymaster->CIA = 0;
                                        $markentrymastertemp->CIA = 0;
                                    }
                                 
                                    
                                }
                                $year_of_passing = ($stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS") ? $month. "-" . $year : '';

                                $sub_info = Yii::$app->db->createCommand('SELECT subject_code,semester FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE B.coe_subjects_mapping_id="'.$subject_map_id.'"')->queryOne();

                                $getgradename = Yii::$app->db->createCommand("SELECT grade_name FROM `coe_grade_range` WHERE '".$stu_result_data['total_marks']."' between `min_mark` and `max_mark` and `subject_code`='".$sub_info["subject_code"]."' and semester='".$sub_info["semester"]."'")->queryScalar();

                                $grade_point=0;
                                if($stu_result_data['result']=='Pass' || $stu_result_data['result']=='pass' || $stu_result_data['result']=='PASS')
                                {
                                    if($getgradename=='O')
                                    {
                                        $grade_point=10;
                                    }
                                    else if($getgradename=='A+')
                                    {
                                        $grade_point=9;
                                    }
                                    else if($getgradename=='A')
                                    {
                                        $grade_point=8;
                                    }
                                    else if($getgradename=='B+')
                                    {
                                        $grade_point=7;
                                    }
                                    else if($getgradename=='B')
                                    {
                                        $grade_point=6;
                                    }
                                    else if($getgradename=='C')
                                    {
                                        $grade_point=5;
                                    }
                                }
                                else
                                {
                                    $grade_point=0;
                                    $getgradename='U';
                                }


                                $stu_ese_marks_master = MarkEntryMaster::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();
                    
                                if(empty($stu_ese_marks_master))
                                {
                                    $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                    $markentrymaster->subject_map_id =$subject_map_id;
                                    $markentrymaster->ESE = $stu_result_data['ese_marks'];
                                    $markentrymaster->total = $stu_result_data['total_marks'];
                                    $markentrymaster->result = $stu_result_data['result'];
                                    $markentrymaster->grade_point = $grade_point;
                                    $markentrymaster->grade_name = $getgradename;
                                    $markentrymaster->attempt = $stu_result_data['attempt'];
                                    $markentrymaster->year = $year;
                                    $markentrymaster->month = $month;
                                    $markentrymaster->term = $term;
                                    $markentrymaster->mark_type = $mark_type;
                                    $markentrymaster->year_of_passing = $year_of_passing;
                                    $markentrymaster->status_id = 0;
                                    $markentrymaster->created_by = $updateBy;
                                    $markentrymaster->created_at = $created_at;
                                    $markentrymaster->updated_by = $updateBy;
                                    $markentrymaster->updated_at = $created_at;
                                    if($markentrymaster->save(false))
                                    {
                                        $connection = Yii::$app->db;
                                        $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                        $command->execute();
                                        $migrade_status++;
                                    }
                                    unset($markentrymaster);
                                }
                                
                            }
                        } // Student result For Loop Ends Here 
                        if($migrade_status>0)
                        { //echo $migrade_status; exit();
                            Yii::$app->ShowFlashMessages->setMsg('Success',"Data Migrated Successfully!!!!");
                            return $this->redirect(['mark-entry/practicalmigrate']);
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error'," Something Wrong With ".$subJecs->subject_code." CODE OR ALREADY MIGRATED");
                            return $this->redirect(['mark-entry/practicalmigrate']);
                        }
                    }
                    else
                    {
                        $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year])->all();
                        
                        $ab_stuMap_ids = [];
                        if(!empty($getAbsentList))
                        {
                            for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                            { 
                                $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                               
                               $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                                $absen_model_save = new MarkEntry();
                                $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $absen_model_save->subject_map_id = $subject_map_id;
                                $absen_model_save->category_type_id =$externAl;
                                $absen_model_save->category_type_id_marks =0;
                                $absen_model_save->year = $year;
                                $absen_model_save->month = $month;
                                $absen_model_save->term = $term;
                                $absen_model_save->mark_type = $mark_type;
                                $absen_model_save->created_at = $created_at;
                                $absen_model_save->created_by = $updateBy;
                                $absen_model_save->updated_at = $created_at;
                                $absen_model_save->updated_by = $updateBy;

                                $check_mark_entry_master = MarkEntryMaster::find()->where(['student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();


                                if(empty($check_mark_entry_master) && empty($check_mark_entry) && !empty($stuCiaMarks) && $absen_model_save->save(false))
                                {
                                    $ab_stuMap_ids[$getAbsentList[$abse]['absent_student_reg']] = $getAbsentList[$abse]['absent_student_reg'];
                                    unset($absen_model_save);
                                    $ab_MarkEntryMaster = new MarkEntryMaster();
                                    $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                    $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                                    $ab_MarkEntryMaster->CIA = $stuCiaMarks->category_type_id_marks;
                                    $ab_MarkEntryMaster->ESE = 0;
                                    $ab_MarkEntryMaster->total = $stuCiaMarks->category_type_id_marks;
                                    $ab_MarkEntryMaster->result = 'Absent';
                                    $ab_MarkEntryMaster->grade_point = 0;
                                    $ab_MarkEntryMaster->grade_name = 'AB';
                                    $ab_MarkEntryMaster->attempt = 0;
                                    $ab_MarkEntryMaster->year = $year;
                                    $ab_MarkEntryMaster->month = $month;
                                    $ab_MarkEntryMaster->term = $term;
                                    $ab_MarkEntryMaster->mark_type = $mark_type;
                                    $ab_MarkEntryMaster->year_of_passing = '';
                                    $ab_MarkEntryMaster->status_id = 0;
                                    $ab_MarkEntryMaster->created_by = $updateBy;
                                    $ab_MarkEntryMaster->created_at = $created_at;
                                    $ab_MarkEntryMaster->updated_by = $updateBy;
                                    $ab_MarkEntryMaster->updated_at = $created_at;
                                    if($ab_MarkEntryMaster->save(false))
                                    {
                                        $migrate_ab = Yii::$app->db;
                                        $update_status = $command_ab = $migrate_ab->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$getAbsentList[$abse]['absent_student_reg'].'" and year="'.$year.'" and month="'.$month.'" ');
                                        $command_ab->execute();
                                        $migrade_status++;
                                    }
                                    unset($ab_MarkEntryMaster);

                                }

                            }
                        } // Absent Entry result For Loop Ends Here 
                        for ($i=0; $i <count($_POST['stu_map_ids']) ; $i++) 
                        { 
                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i]])->orderBy('coe_mark_entry_id desc')->one();

                            $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                                $markEntry = new MarkEntry();
                                $markEntry->student_map_id = $_POST['stu_map_ids'][$i];
                                $markEntry->subject_map_id = $subject_map_id;
                                $markEntry->category_type_id =$externAl;
                                $markEntry->category_type_id_marks =$_POST['stu_marks'][$i];
                                $markEntry->year = $year;
                                $markEntry->month = $month;
                                $markEntry->term = $term;
                                $markEntry->mark_type = $mark_type;
                                $markEntry->created_at = $created_at;
                                $markEntry->created_by = $updateBy;
                                $markEntry->updated_at = $created_at;
                                $markEntry->updated_by = $updateBy;

                            if(empty($check_mark_entry) && !in_array($_POST['stu_map_ids'][$i], $ab_stuMap_ids) && $markEntry->save(false))
                            {

                                unset($markEntry);

                                $markentrymaster = new MarkEntryMaster();
                                $markentrymastertemp = new MarkEntryMasterTemp();
                                $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $subject_map_id . '" AND student_map_id="' . $_POST['stu_map_ids'][$i] . '" AND result not like "%pass%"')->queryScalar();
                                $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                                if ($check_attempt >= $config_attempt) {
                                    $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, 0, $_POST['stu_marks'][$i],$year,$month);
                                    $markentrymaster->CIA = 0;
                                    $markentrymastertemp->CIA = 0;
                                    
                                } else {
                                    $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, $stuCiaMarks->category_type_id_marks, $_POST['stu_marks'][$i],$year,$month);
                                    if(!empty($stuCiaMarks->category_type_id_marks))
                                    {
                                        $markentrymaster->CIA = $stuCiaMarks->category_type_id_marks;
                                        $markentrymastertemp->CIA = $stuCiaMarks->category_type_id_marks;
                                    }
                                    else
                                    {
                                        $markentrymaster->CIA = 0;
                                        $markentrymastertemp->CIA = 0;
                                    }
                                 
                                    
                                }
                                $year_of_passing = ($stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS") ? $month. "-" . $year : '';

                                $stu_reg=StuInfo::findOne(['stu_map_id'=>$_POST['stu_map_ids'][$i]]);

                                $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                                $batch_name= $getbatch['batch_name']; 
                                //echo "1";exit;
                                $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();

                                $stu_ese_marks_master = MarkEntryMaster::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();
                    
                                if(empty($stu_ese_marks_master) && $batch_name>=2021)
                                {
                                    $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                    $markentrymaster->subject_map_id =$subject_map_id;
                                    $markentrymaster->ESE = $stu_result_data['ese_marks'];
                                    $markentrymaster->total = $stu_result_data['total_marks'];
                                    $markentrymaster->result = $stu_result_data['result'];
                                    $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                    $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                    $markentrymaster->attempt = $stu_result_data['attempt'];
                                    $markentrymaster->year = $year;
                                    $markentrymaster->month = $month;
                                    $markentrymaster->term = $term;
                                    $markentrymaster->mark_type = $mark_type;
                                    $markentrymaster->year_of_passing = $year_of_passing;
                                    $markentrymaster->status_id = 0;
                                    $markentrymaster->created_by = $updateBy;
                                    $markentrymaster->created_at = $created_at;
                                    $markentrymaster->updated_by = $updateBy;
                                    $markentrymaster->updated_at = $created_at;
                                    if($markentrymaster->save(false))
                                    {
                                         $get_submapid = SubjectsMapping::find()->where(['coe_subjects_mapping_id'=>$subject_map_id])->one();

                                        if($get_submapid['paper_type_id']==136)
                                        {
                                            $connection = Yii::$app->db;
                                            $update_status = $command = $connection->createCommand('UPDATE coe_scrtny_sw_based SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                            $command->execute();
                                        }
                                        else
                                        {
                                             $connection = Yii::$app->db;
                                            $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                            $command->execute();
                                        }
                                        $migrade_status++;
                                    }
                                    unset($markentrymastertemp);
                                }
                                else if(empty($stu_ese_marks_master) && $batch_name<2021)
                                {
                                    $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                    $markentrymaster->subject_map_id =$subject_map_id;
                                    $markentrymaster->ESE = $stu_result_data['ese_marks'];
                                    $markentrymaster->total = $stu_result_data['total_marks'];
                                    $markentrymaster->result = $stu_result_data['result'];
                                    $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                    $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                    $markentrymaster->attempt = $stu_result_data['attempt'];
                                    $markentrymaster->year = $year;
                                    $markentrymaster->month = $month;
                                    $markentrymaster->term = $term;
                                    $markentrymaster->mark_type = $mark_type;
                                    $markentrymaster->year_of_passing = $year_of_passing;
                                    $markentrymaster->status_id = 0;
                                    $markentrymaster->created_by = $updateBy;
                                    $markentrymaster->created_at = $created_at;
                                    $markentrymaster->updated_by = $updateBy;
                                    $markentrymaster->updated_at = $created_at;
                                    if($markentrymaster->save(false))
                                    {
                                        $connection = Yii::$app->db;
                                        $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                        $command->execute();
                                        $migrade_status++;
                                    }
                                    unset($markentrymaster);
                                }
                                
                            }
                        } // Student result For Loop Ends Here 
                        if($migrade_status>0)
                        { //echo $migrade_status; exit();
                            Yii::$app->ShowFlashMessages->setMsg('Success',"Data Migrated Successfully!!!!");
                            return $this->redirect(['mark-entry/practicalmigrate']);
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error'," Something Wrong With ".$subJecs->subject_code." CODE OR ALREADY MIGRATED");
                            return $this->redirect(['mark-entry/practicalmigrate']);
                        }
                    }
                    
                }
                else if(!empty($subJecs->CIA_max==0))
                {
                    $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year])->all();
                    
                    $ab_stuMap_ids = [];
                    if(!empty($getAbsentList))
                    {
                        for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                        { 
                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                           
                           $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                            if(empty($stuCiaMarks))
                            {
                                $absen_model_save_internal = new MarkEntry();
                                $absen_model_save_internal->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $absen_model_save_internal->subject_map_id = $subject_map_id;
                                $absen_model_save_internal->category_type_id =$cia;
                                $absen_model_save_internal->category_type_id_marks =0;
                                $absen_model_save_internal->year = $year;
                                $absen_model_save_internal->month = $month;
                                $absen_model_save_internal->term = $term;
                                $absen_model_save_internal->mark_type = $mark_type;
                                $absen_model_save_internal->created_at = $created_at;
                                $absen_model_save_internal->created_by = $updateBy;
                                $absen_model_save_internal->updated_at = $created_at;
                                $absen_model_save_internal->updated_by = $updateBy;
                                $absen_model_save_internal->save(false);
                                $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                            }

                            $absen_model_save = new MarkEntry();
                            $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                            $absen_model_save->subject_map_id = $subject_map_id;
                            $absen_model_save->category_type_id =$externAl;
                            $absen_model_save->category_type_id_marks =0;
                            $absen_model_save->year = $year;
                            $absen_model_save->month = $month;
                            $absen_model_save->term = $term;
                            $absen_model_save->mark_type = $mark_type;
                            $absen_model_save->created_at = $created_at;
                            $absen_model_save->created_by = $updateBy;
                            $absen_model_save->updated_at = $created_at;
                            $absen_model_save->updated_by = $updateBy;

                            $check_mark_entry_master = MarkEntryMaster::find()->where(['student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();

                            if(empty($check_mark_entry_master) && empty($check_mark_entry) && $absen_model_save->save(false))
                            {
                                $ab_stuMap_ids[$getAbsentList[$abse]['absent_student_reg']] = $getAbsentList[$abse]['absent_student_reg'];
                                unset($absen_model_save);
                                $ab_MarkEntryMaster = new MarkEntryMaster();
                                $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                                $ab_MarkEntryMaster->CIA = $stuCiaMarks->category_type_id_marks;
                                $ab_MarkEntryMaster->ESE = 0;
                                $ab_MarkEntryMaster->total = $stuCiaMarks->category_type_id_marks;
                                $ab_MarkEntryMaster->result = 'Absent';
                                $ab_MarkEntryMaster->grade_point = 0;
                                $ab_MarkEntryMaster->grade_name = 'AB';
                                $ab_MarkEntryMaster->attempt = 0;
                                $ab_MarkEntryMaster->year = $year;
                                $ab_MarkEntryMaster->month = $month;
                                $ab_MarkEntryMaster->term = $term;
                                $ab_MarkEntryMaster->mark_type = $mark_type;
                                $ab_MarkEntryMaster->year_of_passing = '';
                                $ab_MarkEntryMaster->status_id = 0;
                                $ab_MarkEntryMaster->created_by = $updateBy;
                                $ab_MarkEntryMaster->created_at = $created_at;
                                $ab_MarkEntryMaster->updated_by = $updateBy;
                                $ab_MarkEntryMaster->updated_at = $created_at;
                                $ab_MarkEntryMaster->save(false);
                                unset($ab_MarkEntryMaster);
                            }

                        }
                    } // Absent Entry result For Loop Ends Here 
                    for ($i=0; $i <count($_POST['stu_map_ids']) ; $i++) 
                    { 
                        $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i]])->orderBy('coe_mark_entry_id desc')->one();

                        $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                        if(empty($stuCiaMarks))
                        {
                            $absen_model_save_internal = new MarkEntry();
                            $absen_model_save_internal->student_map_id = $_POST['stu_map_ids'][$i];
                            $absen_model_save_internal->subject_map_id = $subject_map_id;
                            $absen_model_save_internal->category_type_id =$cia;
                            $absen_model_save_internal->category_type_id_marks =0;
                            $absen_model_save_internal->year = $year;
                            $absen_model_save_internal->month = $month;
                            $absen_model_save_internal->term = $term;
                            $absen_model_save_internal->mark_type = $mark_type;
                            $absen_model_save_internal->created_at = $created_at;
                            $absen_model_save_internal->created_by = $updateBy;
                            $absen_model_save_internal->updated_at = $created_at;
                            $absen_model_save_internal->updated_by = $updateBy;
                            $absen_model_save_internal->save(false);

                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i]])->orderBy('coe_mark_entry_id desc')->one();
                        }

                            $markEntry = new MarkEntry();
                            $markEntry->student_map_id = $_POST['stu_map_ids'][$i];
                            $markEntry->subject_map_id = $subject_map_id;
                            $markEntry->category_type_id =$externAl;
                            $markEntry->category_type_id_marks =$_POST['stu_marks'][$i];
                            $markEntry->year = $year;
                            $markEntry->month = $month;
                            $markEntry->term = $term;
                            $markEntry->mark_type = $mark_type;
                            $markEntry->created_at = $created_at;
                            $markEntry->created_by = $updateBy;
                            $markEntry->updated_at = $created_at;
                            $markEntry->updated_by = $updateBy;

                        if(empty($check_mark_entry) && !in_array($_POST['stu_map_ids'][$i], $ab_stuMap_ids) && $markEntry->save(false))
                        {
                            $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, $stuCiaMarks->category_type_id_marks, $_POST['stu_marks'][$i],$year,$month);

                            unset($markEntry);
                            $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $month. "-" . $year : '';
                            
                            $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                            $batch_name= $getbatch['batch_name']; 

                            $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();

                             $stu_ese_marks_master = MarkEntryMaster::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();
                
                            if(empty($stu_ese_marks_master) && empty($stu_ese_marks_temp) && $batch_name>=2021 && $subMapping->paper_type_id!=10)
                            {
                                $markentrymastertemp = new MarkEntryMasterTemp();
                                $markentrymastertemp->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymastertemp->subject_map_id =$subject_map_id;
                                $markentrymastertemp->CIA = $stuCiaMarks->category_type_id_marks;
                                $markentrymastertemp->ESE = $stu_result_data['ese_marks'];
                                $markentrymastertemp->total = $stu_result_data['total_marks'];
                                $markentrymastertemp->result = $stu_result_data['result'];
                                $markentrymastertemp->grade_point = $stu_result_data['grade_point'];
                                $markentrymastertemp->grade_name = $stu_result_data['grade_name'];
                                $markentrymastertemp->attempt = $stu_result_data['attempt'];
                                $markentrymastertemp->year = $year;
                                $markentrymastertemp->month = $month;
                                $markentrymastertemp->term = $term;
                                $markentrymastertemp->mark_type = $mark_type;
                                $markentrymastertemp->year_of_passing = $year_of_passing;
                                $markentrymastertemp->status_id = 0;
                                $markentrymastertemp->created_by = $updateBy;
                                $markentrymastertemp->created_at = $created_at;
                                $markentrymastertemp->updated_by = $updateBy;
                                $markentrymastertemp->updated_at = $created_at;
                                if($markentrymastertemp->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymastertemp);
                            }
                            else if(empty($stu_ese_marks_master) && $batch_name>=2021 && $subMapping->paper_type_id==10)
                            {
                                $markentrymaster = new MarkEntryMaster();
                                $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymaster->subject_map_id =$subject_map_id;
                                $markentrymaster->CIA = $stuCiaMarks->category_type_id_marks;
                                $markentrymaster->ESE = $stu_result_data['ese_marks'];
                                $markentrymaster->total = $stu_result_data['total_marks'];
                                $markentrymaster->result = $stu_result_data['result'];
                                $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                $markentrymaster->attempt = $stu_result_data['attempt'];
                                $markentrymaster->year = $year;
                                $markentrymaster->month = $month;
                                $markentrymaster->term = $term;
                                $markentrymaster->mark_type = $mark_type;
                                $markentrymaster->year_of_passing = $year_of_passing;
                                $markentrymaster->status_id = 0;
                                $markentrymaster->created_by = $updateBy;
                                $markentrymaster->created_at = $created_at;
                                $markentrymaster->updated_by = $updateBy;
                                $markentrymaster->updated_at = $created_at;
                                if($markentrymaster->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymaster);
                            }
                            else if(empty($stu_ese_marks_master) && $batch_name<2021)
                            {
                                $markentrymaster = new MarkEntryMaster();
                                $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymaster->subject_map_id =$subject_map_id;
                                $markentrymaster->CIA = $stuCiaMarks->category_type_id_marks;
                                $markentrymaster->ESE = $stu_result_data['ese_marks'];
                                $markentrymaster->total = $stu_result_data['total_marks'];
                                $markentrymaster->result = $stu_result_data['result'];
                                $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                $markentrymaster->attempt = $stu_result_data['attempt'];
                                $markentrymaster->year = $year;
                                $markentrymaster->month = $month;
                                $markentrymaster->term = $term;
                                $markentrymaster->mark_type = $mark_type;
                                $markentrymaster->year_of_passing = $year_of_passing;
                                $markentrymaster->status_id = 0;
                                $markentrymaster->created_by = $updateBy;
                                $markentrymaster->created_at = $created_at;
                                $markentrymaster->updated_by = $updateBy;
                                $markentrymaster->updated_at = $created_at;
                                if($markentrymaster->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymaster);
                            }
                            
                        }
                    } // Student result For Loop Ends Here 
                    if($migrade_status>0)
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Success',"Data Migrated Successfully!!!!");
                      return $this->redirect(['mark-entry/practicalmigrate']);
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error'," Something Wrong With ".$subJecs->subject_code." CODE");
                       return $this->redirect(['mark-entry/practicalmigrate']);
                    }
                    
                }
                else if(!empty($subJecs->ESE_max==0))
                {

                    $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year])->all();
                    
                    $ab_stuMap_ids = [];
                    if(!empty($getAbsentList))
                    {
                        for ($abse=0; $abse <count($getAbsentList) ; $abse++) 
                        { 
                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                           
                           $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                            if(empty($stuCiaMarks))
                            {
                                $absen_model_save_internal = new MarkEntry();
                                $absen_model_save_internal->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $absen_model_save_internal->subject_map_id = $subject_map_id;
                                $absen_model_save_internal->category_type_id =$cia;
                                $absen_model_save_internal->category_type_id_marks =0;
                                $absen_model_save_internal->year = $year;
                                $absen_model_save_internal->month = $month;
                                $absen_model_save_internal->term = $term;
                                $absen_model_save_internal->mark_type = $mark_type;
                                $absen_model_save_internal->created_at = $created_at;
                                $absen_model_save_internal->created_by = $updateBy;
                                $absen_model_save_internal->updated_at = $created_at;
                                $absen_model_save_internal->updated_by = $updateBy;
                                $absen_model_save_internal->save(false);
                                $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$getAbsentList[$abse]['absent_student_reg']])->orderBy('coe_mark_entry_id desc')->one();
                            }

                            $absen_model_save = new MarkEntry();
                            $absen_model_save->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                            $absen_model_save->subject_map_id = $subject_map_id;
                            $absen_model_save->category_type_id =$externAl;
                            $absen_model_save->category_type_id_marks =0;
                            $absen_model_save->year = $year;
                            $absen_model_save->month = $month;
                            $absen_model_save->term = $term;
                            $absen_model_save->mark_type = $mark_type;
                            $absen_model_save->created_at = $created_at;
                            $absen_model_save->created_by = $updateBy;
                            $absen_model_save->updated_at = $created_at;
                            $absen_model_save->updated_by = $updateBy;

                             $check_mark_entry_master = MarkEntryMaster::find()->where(['student_map_id'=>$getAbsentList[$abse]['absent_student_reg'],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();


                            if(empty($check_mark_entry_master) && empty($check_mark_entry) && $absen_model_save->save(false))
                            {
                                $ab_stuMap_ids[$getAbsentList[$abse]['absent_student_reg']] = $getAbsentList[$abse]['absent_student_reg'];
                                unset($absen_model_save);
                                $ab_MarkEntryMaster = new MarkEntryMaster();
                                $ab_MarkEntryMaster->student_map_id = $getAbsentList[$abse]['absent_student_reg'];
                                $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                                $ab_MarkEntryMaster->CIA = $stuCiaMarks->category_type_id_marks;
                                $ab_MarkEntryMaster->ESE = 0;
                                $ab_MarkEntryMaster->total = $stuCiaMarks->category_type_id_marks;
                                $ab_MarkEntryMaster->result = 'Absent';
                                $ab_MarkEntryMaster->grade_point = 0;
                                $ab_MarkEntryMaster->grade_name = 'AB';
                                $ab_MarkEntryMaster->attempt = 0;
                                $ab_MarkEntryMaster->year = $year;
                                $ab_MarkEntryMaster->month = $month;
                                $ab_MarkEntryMaster->term = $term;
                                $ab_MarkEntryMaster->mark_type = $mark_type;
                                $ab_MarkEntryMaster->year_of_passing = '';
                                $ab_MarkEntryMaster->status_id = 0;
                                $ab_MarkEntryMaster->created_by = $updateBy;
                                $ab_MarkEntryMaster->created_at = $created_at;
                                $ab_MarkEntryMaster->updated_by = $updateBy;
                                $ab_MarkEntryMaster->updated_at = $created_at;
                                $ab_MarkEntryMaster->save(false);
                                unset($ab_MarkEntryMaster);
                            }

                        }
                    } // Absent Entry result For Loop Ends Here 
                    for ($i=0; $i <count($_POST['stu_map_ids']) ; $i++) 
                    { 
                        $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                        $check_mark_entry = MarkEntry::find()->where(['category_type_id'=>$externAl,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orderBy('coe_mark_entry_id desc')->one();

                        if(empty($stuCiaMarks))
                        {
                            $absen_model_save_internal = new MarkEntry();
                            $absen_model_save_internal->student_map_id = $_POST['stu_map_ids'][$i];
                            $absen_model_save_internal->subject_map_id = $subject_map_id;
                            $absen_model_save_internal->category_type_id =$cia;
                            $absen_model_save_internal->category_type_id_marks =$_POST['stu_marks'][$i];
                            $absen_model_save_internal->year = $year;
                            $absen_model_save_internal->month = $month;
                            $absen_model_save_internal->term = $term;
                            $absen_model_save_internal->mark_type = $mark_type;
                            $absen_model_save_internal->created_at = $created_at;
                            $absen_model_save_internal->created_by = $updateBy;
                            $absen_model_save_internal->updated_at = $created_at;
                            $absen_model_save_internal->updated_by = $updateBy;
                            $absen_model_save_internal->save(false);
                            
                            $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$cia,'subject_map_id'=>$subject_map_id,'student_map_id'=>$_POST['stu_map_ids'][$i]])->orderBy('coe_mark_entry_id desc')->one();
                        }

                        $markEntry = new MarkEntry();
                        $markEntry->student_map_id = $_POST['stu_map_ids'][$i];
                        $markEntry->subject_map_id = $subject_map_id;
                        $markEntry->category_type_id =$externAl;
                        $markEntry->category_type_id_marks =0;
                        $markEntry->year = $year;
                        $markEntry->month = $month;
                        $markEntry->term = $term;
                        $markEntry->mark_type = $mark_type;
                        $markEntry->created_at = $created_at;
                        $markEntry->created_by = $updateBy;
                        $markEntry->updated_at = $created_at;
                        $markEntry->updated_by = $updateBy;

                        if(empty($check_mark_entry) && !in_array($_POST['stu_map_ids'][$i], $ab_stuMap_ids) && $markEntry->save(false))
                        {
                            $stu_result_data = ConfigUtilities::StudentResult($_POST['stu_map_ids'][$i], $subject_map_id, $_POST['stu_marks'][$i], 0,$year,$month);

                            unset($markEntry);
                            $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $month. "-" . $year : '';

                            $getbatch=Yii::$app->db->createCommand("SELECT A.batch_name FROM coe_batch A JOIN coe_bat_deg_reg B ON B.coe_batch_id=A.coe_batch_id JOIN coe_student_mapping C ON C.course_batch_mapping_id=B.coe_bat_deg_reg_id WHERE B.coe_bat_deg_reg_id='".$stu_reg['batch_map_id']."'")->queryone();

                            $batch_name= $getbatch['batch_name']; 

                            $stu_ese_marks_temp = MarkEntryMasterTemp::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();

                            $stu_ese_marks_master = MarkEntryMaster::find()->where(['student_map_id'=>$_POST['stu_map_ids'][$i],'year'=>$year,'month'=>$month,'subject_map_id'=>$subject_map_id])->all();
                
                            if(empty($stu_ese_marks_master) && empty($stu_ese_marks_temp) && $batch_name>=2021 && $subMapping->paper_type_id!=10)
                            {
                                $markentrymastertemp = new MarkEntryMasterTemp();
                                $markentrymastertemp->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymastertemp->subject_map_id =$subject_map_id;
                                $markentrymastertemp->CIA = $_POST['stu_marks'][$i];
                                $markentrymastertemp->ESE = 0;
                                $markentrymastertemp->total = $stu_result_data['total_marks'];
                                $markentrymastertemp->result = $stu_result_data['result'];
                                $markentrymastertemp->grade_point = $stu_result_data['grade_point'];
                                $markentrymastertemp->grade_name = $stu_result_data['grade_name'];
                                $markentrymastertemp->attempt = $stu_result_data['attempt'];
                                $markentrymastertemp->year = $year;
                                $markentrymastertemp->month = $month;
                                $markentrymastertemp->term = $term;
                                $markentrymastertemp->mark_type = $mark_type;
                                $markentrymastertemp->year_of_passing = $year_of_passing;
                                $markentrymastertemp->status_id = 0;
                                $markentrymastertemp->created_by = $updateBy;
                                $markentrymastertemp->created_at = $created_at;
                                $markentrymastertemp->updated_by = $updateBy;
                                $markentrymastertemp->updated_at = $created_at;
                                if($markentrymastertemp->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymastertemp);
                            }
                            else if(empty($stu_ese_marks_master) && $batch_name>=2021 && $subMapping->paper_type_id==10)
                            {

                                $markentrymaster = new MarkEntryMaster();
                                $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymaster->subject_map_id =$subject_map_id;
                                $markentrymaster->CIA = $_POST['stu_marks'][$i];
                                $markentrymaster->ESE = 0;
                                $markentrymaster->total = $_POST['stu_marks'][$i];
                                $markentrymaster->result = $stu_result_data['result'];
                                $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                $markentrymaster->attempt = $stu_result_data['attempt'];
                                $markentrymaster->year = $year;
                                $markentrymaster->month = $month;
                                $markentrymaster->term = $term;
                                $markentrymaster->mark_type = $mark_type;
                                $markentrymaster->year_of_passing = $year_of_passing;
                                $markentrymaster->status_id = 0;
                                $markentrymaster->created_by = $updateBy;
                                $markentrymaster->created_at = $created_at;
                                $markentrymaster->updated_by = $updateBy;
                                $markentrymaster->updated_at = $created_at;
                                if($markentrymaster->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymaster);
                            }
                            else if(empty($stu_ese_marks_master) && $batch_name<2021)
                            {
                                $markentrymaster = new MarkEntryMaster();
                                $markentrymaster->student_map_id = $_POST['stu_map_ids'][$i];
                                $markentrymaster->subject_map_id =$subject_map_id;
                                $markentrymaster->CIA = $_POST['stu_marks'][$i];
                                $markentrymaster->ESE = 0;
                                $markentrymaster->total = $_POST['stu_marks'][$i];
                                $markentrymaster->result = $stu_result_data['result'];
                                $markentrymaster->grade_point = $stu_result_data['grade_point'];
                                $markentrymaster->grade_name = $stu_result_data['grade_name'];
                                $markentrymaster->attempt = $stu_result_data['attempt'];
                                $markentrymaster->year = $year;
                                $markentrymaster->month = $month;
                                $markentrymaster->term = $term;
                                $markentrymaster->mark_type = $mark_type;
                                $markentrymaster->year_of_passing = $year_of_passing;
                                $markentrymaster->status_id = 0;
                                $markentrymaster->created_by = $updateBy;
                                $markentrymaster->created_at = $created_at;
                                $markentrymaster->updated_by = $updateBy;
                                $markentrymaster->updated_at = $created_at;
                                if($markentrymaster->save(false))
                                {
                                    $connection = Yii::$app->db;
                                    $update_status = $command = $connection->createCommand('UPDATE coe_practical_entry SET updated_by="'.$updateBy.'",updated_at="'.$created_at.'", approve_status="YES" WHERE subject_map_id="'.$subject_map_id.'" AND student_map_id="'.$_POST['stu_map_ids'][$i].'" and year="'.$year.'" and month="'.$month.'" ');
                                    $command->execute();
                                    $migrade_status++;
                                }
                                unset($markentrymaster);
                            }    
                        }
                    } // Student result For Loop Ends Here 
                    if($migrade_status>0)
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Success',"Data Migrated Successfully!!!!");
                         return $this->redirect(['mark-entry/practicalmigrate']);
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('Error'," Something Wrong With ".$subJecs->subject_code." CODE OR ALREADY MIGRATED");
                         return $this->redirect(['mark-entry/practicalmigrate']);
                    }
                    
                }
                else
                {
                    Yii::$app->ShowFlashMessages->setMsg('Error',"Kindly Enter the CIA Marks for ".$subJecs->subject_code." CODE");
                    return $this->redirect(['mark-entry/practicalmigrate']);
                }  
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error',"Nothing Success!!");
                return $this->redirect(['mark-entry/practicalmigrate']);
            }
        }
        else
        {
              Yii::$app->ShowFlashMessages->setMsg('Welcome',"Welcome to practical MarkEntry Migration");               
              return $this->render('practicalmigrate', [
                    'model' => $model,
              ]);  
        }


        
    }

    public function actionCgpaStudent()
    {
        $model = new MarkEntry();

              Yii::$app->ShowFlashMessages->setMsg('Welcome',"Welcome to CGPA Student Report");               
              return $this->render('cgpa-student', [
                    'model' => $model,
              ]);  
        
    }

    public function actionCgpaStudentdata()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
         
        $query_cr = new Query();
        $query_cr->select('*')
            ->from('coe_programme a')
            ->join('JOIN', 'coe_bat_deg_reg b', 'a.coe_programme_id=b.coe_programme_id')
            ->join('JOIN', 'coe_degree c', 'c.coe_degree_id=b.coe_degree_id')
            ->where(['b.coe_bat_deg_reg_id' => $_POST['batch_map_id']])
            ->andWhere(['<>','c.degree_code','Ph.D']);
        $prog_list = $query_cr->createCommand()->queryOne();

        $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $prog_list['coe_bat_deg_reg_id']);

        $content_reval= Yii::$app->db->createCommand("select count(*) from coe_revaluation A JOIN coe_subjects_mapping B ON B.coe_subjects_mapping_id=A.subject_map_id where A.year=".$_POST['year']." and A.month=".$_POST['month']." AND B.semester=".$sem)->queryScalar();

        $course_result_table = '';
        if (count($prog_list) > 0) 
        { 
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            

            $pass_min=0;
            if($_POST['batch']>11)
            {
                $pass_min=45;
            }
            else
            {
                $pass_min=50;
            }
            
            $query_fail = new Query();
            $query_fail->select('DISTINCT (student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.year_of_passing'=>'','b.mark_type'=>27,'c.semester'=>$sem]);
            //echo $query_fail->createCommand()->getRawSql(); exit;
            $failed_stus = $query_fail->createCommand()->queryAll();

            $stud_failcount = count($failed_stus);

            $notIn = array_filter(['']);
            foreach ($failed_stus as $key => $fails) {
                
                    $notIn[$fails['student_map_id']]=$fails['student_map_id'];
            }

            $query_abs = new Query();
            $query_abs->select('DISTINCT (M.student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN','coe_mark_entry_master M', 'M.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=M.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['M.result'=>'Absent','a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'M.year' => $_POST['year'], 'M.month' => $_POST['month'],'M.mark_type'=>27,'c.semester'=>$sem]);
            //echo $query_fail->createCommand()->getRawSql(); exit;
            $failed_abs = $query_abs->createCommand()->queryAll();

            $notIn_abs = array_filter(['']);
            foreach ($failed_abs as $key => $abs) {
                
                    $notIn_abs[$abs['student_map_id']]=$abs['student_map_id'];
            }

            if($content_reval==0)
            {
            
                Yii::$app->db->createCommand('DELETE FROM coe_cgpa_student where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and batch_mapping_id="'.$prog_list['coe_bat_deg_reg_id'].'" ')->execute();

                $query_map_id = new Query();
                $query_map_id->select('DISTINCT (student_map_id),c.batch_mapping_id,b.year,b.month')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                            ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$sem])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                       //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
                $students_map_id_pass = $query_map_id->createCommand()->queryAll();

                $update=0; $insert=0;$error=0;
                $login_user_id=Yii::$app->user->getId();
                foreach ($students_map_id_pass as $svalue) 
                {
                    $check_Cgpa = Yii::$app->db->createCommand('SELECT * FROM coe_cgpa_student where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and student_map_id="'.$svalue['student_map_id'].'" and batch_mapping_id="'.$svalue['batch_mapping_id'].'" ')->queryOne();

                    $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($_POST['year'], $_POST['month'], $svalue['batch_mapping_id'],$svalue['student_map_id']);

                    if(empty($check_Cgpa))
                    {
                        $inserted = Yii::$app->db->createCommand('INSERT into coe_cgpa_student(student_map_id, batch_mapping_id, year, month,cgpa, created_at, created_by) values("'.$svalue['student_map_id'].'","'.$svalue['batch_mapping_id'].'", "'.$_POST['year'].'", "'.$_POST['month'].'" , "'.$cgpa_calculation['cgpa'].'","'.date('Y-m-d H:i:s').'","'.$login_user_id.'") ')->execute();
                        if($inserted)
                        {
                            $insert=$insert+1;
                        }
                        
                    }
                    else
                    {
                        $error=$error+1;
                    }
                   
                }
            }

            $query_map = new Query();
            $query_map->select('DISTINCT (b.student_map_id),s.register_number,c.batch_mapping_id,b.year,b.month')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN','coe_mark_entry M', 'M.student_map_id=b.student_map_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$sem])->andWhere(['NOT IN', 'b.student_map_id', $notIn])->andWhere(['NOT IN', 'b.student_map_id', $notIn_abs])->andWhere(['!=', 'b.year_of_passing', '']);
                  // echo "<br>".$query_map->createCommand()->getRawSql(); exit;
            $students_map = $query_map->createCommand()->queryAll();
            $sn = 1; 
            if(!empty($students_map))
            {
             $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
            
            $course_result_table .= '<tr>
                                        <td colspan=3 align="center"> 
                                            <center><b><font size="6px">' . $org_name . '</font></b></center>
                                            <center>' . $org_address . '</center>
                                            <center>' . $org_tagline . '</center> 
                                        </td>
                                       
                                    </tr>';
            $course_result_table .= '<tr><td colspan=3 align="center"><b>Batch - ' . $batch_name . '</b><b> CGPA STUDENT REPORT ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';

             $student_pass = isset($students_map)?$students_map:'0';
           
            $course_result_table .= '<tr><td colspan=3 align="center"><b>PROGRAMME - ' . $prog_list['programme_code'] ." - " . $prog_list['programme_name'] . '</b><b>    OVERALL PASS STUDENT: ' . count($student_pass) . '</td></tr>';
            
             $course_result_table .= '<tr><th> S. NO </th> 
                            <th>REGISTER NUMBER</th> 
                            <th>CGPA</th> </tr>';
            $total_cgpa=0;
            foreach ($students_map as $svalue) 
            {

                $check_Cgpa = Yii::$app->db->createCommand('SELECT cgpa FROM coe_cgpa_student where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and student_map_id="'.$svalue['student_map_id'].'" and batch_mapping_id="'.$svalue['batch_mapping_id'].'" ')->queryOne();
               $course_result_table .= '<tr><td>'.$sn.'</td><td>'.$svalue['register_number'].'</td><td>'.$check_Cgpa['cgpa'].'</td></tr>';
             $sn++;   
            }

            $sum_Cgpa = Yii::$app->db->createCommand('SELECT sum(cgpa) as sum,count(cgpa) as count FROM coe_cgpa_student where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and batch_mapping_id="'.$_POST['batch_map_id'].'" ')->queryOne();
            
            $total_enroll_stu=$sum_Cgpa['count'];
            
            $course_result_table .= '<tr><td colspan="2" style="text-align:right;">Average CGPA</td><td>'.round(($sum_Cgpa['sum']/$total_enroll_stu),2).'</td></tr>';
            $course_result_table .= '</table>';

            }
            if (isset($_SESSION['cgpa_student_printtemp'])) {
                unset($_SESSION['cgpa_student_printtemp']);
            }
            $_SESSION['cgpa_student_printtemp'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

     public function actionCgpaStudentAfterReval()
    {
        $model = new MarkEntry();

              Yii::$app->ShowFlashMessages->setMsg('Welcome',"Welcome to Revalution CGPA Student Report");               
              return $this->render('cgpa-student-af-reval', [
                    'model' => $model,
              ]);  
        
    }

     public function actionCgpaStudentAfterRevaldata()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
         
        $query_cr = new Query();
        $query_cr->select('*')
            ->from('coe_programme a')
            ->join('JOIN', 'coe_bat_deg_reg b', 'a.coe_programme_id=b.coe_programme_id')
            ->join('JOIN', 'coe_degree c', 'c.coe_degree_id=b.coe_degree_id')
            ->where(['b.coe_bat_deg_reg_id' => $_POST['batch_map_id']])
            ->andWhere(['<>','c.degree_code','Ph.D']);
        $prog_list = $query_cr->createCommand()->queryOne();

        $course_result_table = '';
        if (count($prog_list) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            
            $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $prog_list['coe_bat_deg_reg_id']);

            Yii::$app->db->createCommand('DELETE FROM coe_cgpa_stu_af_reval where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and batch_mapping_id="'.$prog_list['coe_bat_deg_reg_id'].'" ')->execute();

             $query_fail = new Query();
            $query_fail->select('DISTINCT (student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.year_of_passing'=>'','b.mark_type'=>27,'c.semester'=>$sem]);

           $failed_stus = $query_fail->createCommand()->queryAll();

            $stud_failcount = count($failed_stus);

            $notIn = array_filter(['']);
            foreach ($failed_stus as $key => $fails) {
                
                    $notIn[$fails['student_map_id']]=$fails['student_map_id'];
            }

            $query_map_id = new Query();
            $query_map_id->select('DISTINCT (student_map_id),c.batch_mapping_id,b.year,b.month')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$sem])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
            $students_map_id_pass = $query_map_id->createCommand()->queryAll();

            $update=0; $insert=0;$error=0;
            $login_user_id=Yii::$app->user->getId();
            foreach ($students_map_id_pass as $svalue) 
            {
                $check_Cgpa = Yii::$app->db->createCommand('SELECT * FROM coe_cgpa_stu_af_reval where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and student_map_id="'.$svalue['student_map_id'].'" and batch_mapping_id="'.$svalue['batch_mapping_id'].'" ')->queryOne();

                $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($_POST['year'], $_POST['month'], $svalue['batch_mapping_id'],$svalue['student_map_id']);

                if(empty($check_Cgpa))
                {
                    $inserted = Yii::$app->db->createCommand('INSERT into coe_cgpa_stu_af_reval(student_map_id, batch_mapping_id, year, month,cgpa, created_at, created_by) values("'.$svalue['student_map_id'].'","'.$svalue['batch_mapping_id'].'", "'.$_POST['year'].'", "'.$_POST['month'].'" , "'.$cgpa_calculation['cgpa'].'","'.date('Y-m-d H:i:s').'","'.$login_user_id.'") ')->execute();
                    if($inserted)
                    {
                        $insert=$insert+1;
                    }
                    
                }
                else
                {
                    $error=$error+1;
                }
               
            }
             

            $query_map = new Query();
            $query_map->select('DISTINCT (student_map_id),s.register_number,c.batch_mapping_id,b.year,b.month')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as s', 'a.student_rel_id=s.coe_student_id ')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $prog_list['coe_bat_deg_reg_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$sem])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
            $students_map = $query_map->createCommand()->queryAll();
            $sn = 1; 
            if(!empty($students_map))
            {
             $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
            
            $course_result_table .= '<tr>
                                        <td colspan=3 align="center"> 
                                            <center><b><font size="6px">' . $org_name . '</font></b></center>
                                            <center>' . $org_address . '</center>
                                            <center>' . $org_tagline . '</center> 
                                        </td>
                                       
                                    </tr>';
            $course_result_table .= '<tr><td colspan=3 align="center"><b>Batch - ' . $batch_name . '</b><b> CGPA STUDENT AFTER REVALUTION REPORT ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';

             $student_pass = isset($students_map_id_pass)?$students_map_id_pass:'0';
           
            $course_result_table .= '<tr><td colspan=3 align="center"><b>PROGRAMME - ' . $prog_list['programme_code'] ." - " . $prog_list['programme_name'] . '</b><b>    OVERALL PASS STUDENT: ' . count($student_pass) . '</td></tr>';
            
             $course_result_table .= '<tr><th> S. NO </th> 
                            <th>REGISTER NUMBER</th> 
                            <th>CGPA</th> </tr>';
            $total_cgpa=0;
            foreach ($students_map as $svalue) 
            {

                $check_Cgpa = Yii::$app->db->createCommand('SELECT cgpa FROM coe_cgpa_stu_af_reval where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and student_map_id="'.$svalue['student_map_id'].'" and batch_mapping_id="'.$svalue['batch_mapping_id'].'" ')->queryOne();
               $course_result_table .= '<tr><td>'.$sn.'</td><td>'.$svalue['register_number'].'</td><td>'.$check_Cgpa['cgpa'].'</td></tr>';
             $sn++;   
            }

            $sum_Cgpa = Yii::$app->db->createCommand('SELECT sum(cgpa) as sum,count(cgpa) as count FROM coe_cgpa_stu_af_reval where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and batch_mapping_id="'.$_POST['batch_map_id'].'" ')->queryOne();
            
            $total_enroll_stu=$sum_Cgpa['count'];
            
            $course_result_table .= '<tr><td colspan="2" style="text-align:right;">Average CGPA</td><td>'.round(($sum_Cgpa['sum']/$total_enroll_stu),2).'</td></tr>';
            $course_result_table .= '</table>';

            }
            if (isset($_SESSION['cgpa_student_printtemp'])) {
                unset($_SESSION['cgpa_student_printtemp']);
            }
            $_SESSION['cgpa_student_printtemp'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

    public function actionCgpaStudentPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['cgpa_student_printtemp'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Student CGPA Average.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'Student CGPA Average'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Student CGPA Average' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelCgpaStudent()
    {
        
        $content = $_SESSION['cgpa_student_printtemp'];
           
        $fileName = "Student CGPA Average" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionCgpaAverage()
    {
        $model = new MarkEntry();
        
        $month = $_POST['month'];
        $Year = $_POST['year'];
        $semester='';
          $content_data=array();
        if(Yii::$app->request->post())
        {
            $batch = $_POST['bat_val'];
            $month = $_POST['month'];
            $Year = $_POST['year'];
            $semester=1;
            if($month==29){$Year=$Year;$semester=2;}
            if($month==30){$Year=$Year;$semester=1;}

            $content_data=array();
            if($batch!='')
            {
                $yrs=$Year;
                $content_1= Yii::$app->db->createCommand("select d.coe_batch_id, d.coe_bat_deg_reg_id, degree_code, degree_type, programme_name, semester, degree_total_semesters from coe_cgpa_student a 
                            JOIN coe_subjects_mapping c on c.batch_mapping_id=a.batch_mapping_id 
                            JOIN coe_bat_deg_reg d on d.coe_bat_deg_reg_id=a.batch_mapping_id 
                            JOIN coe_programme e on e.coe_programme_id=d.coe_programme_id 
                            JOIN coe_degree as f ON f.coe_degree_id=d.coe_degree_id 
                            where d.coe_bat_deg_reg_id!=151 AND d.coe_batch_id='" . $batch . "' and a.year=".$Year." and a.month=".$month." group by d.coe_bat_deg_reg_id")->queryAll(); //c.batch_mapping_id =137 and
                                
                if(!empty($content_1))
                {
                        
                    $content_data[$yrs]=array("year"=>$yrs,"batch"=>$batch);
                }
               
            }
            else
            {
                for($i=0;$i<4;$i++)
                {
                    if($i==0){$yrs=$Year;}else{$yrs=$yrs-1;}

                   $batch_id_value = Yii::$app->db->createCommand("select coe_batch_id from coe_batch where batch_name like '%".$yrs."%'")->queryScalar(); 
                    if(!empty($batch_id_value))
                    {

                        $content_1= Yii::$app->db->createCommand("select d.coe_batch_id, d.coe_bat_deg_reg_id, degree_code, degree_type, programme_name, semester, degree_total_semesters from coe_cgpa_student a 
                            JOIN coe_subjects_mapping c on c.batch_mapping_id=a.batch_mapping_id 
                            JOIN coe_bat_deg_reg d on d.coe_bat_deg_reg_id=a.batch_mapping_id 
                            JOIN coe_programme e on e.coe_programme_id=d.coe_programme_id 
                            JOIN coe_degree as f ON f.coe_degree_id=d.coe_degree_id 
                            where d.coe_bat_deg_reg_id!=151 AND d.coe_batch_id='" . $batch_id_value . "' and a.year=".$Year." and a.month=".$month." group by d.coe_bat_deg_reg_id")->queryAll(); //c.batch_mapping_id =137 and
                                
                        if(!empty($content_1))
                        {
                        
                            $content_data[$yrs]=array("year"=>$yrs,"batch"=>$batch_id_value);
                        }
                        
                    }
                } 
            }
            if(!empty($content_data))
            {
                return $this->render('cgpa-average', [
                        'model' => $model,
                        'content_data' =>$content_data,
                        'batch_id_value'=>$batch_id_value,
                        'month1'=>$_POST['month'],
                        'Year1'=>$_POST['year'],
                        'semester'=>$semester
                    ]);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error','NO DATA FOUND');
                return $this->redirect(['mark-entry/cgpa-average']);
            }
        }
        else
        {
            Yii::$app->ShowFlashMessages->setMsg('Welcome',"Welcome to CGPA Average Report");               
            return $this->render('cgpa-average', [
                        'model' => $model,
                        'content_data' =>$content_data,
                        'batch_id_value'=>$batch_id_value,
                        'month1'=>$month,
                        'Year1'=>$Year,
                        'semester'=>$semester
                    ]);
        } 
       
    }

    public function actionCgpaAverageAfterReval()
    {
        $model = new MarkEntry();
        
        $month = $_POST['month'];
        $Year = $_POST['year'];
       $sub_list= $semester='';
          $content_data=array();
        if(Yii::$app->request->post())
        {
            $batch = $_POST['bat_val'];
            $month = $_POST['month'];
            $Year = $_POST['year'];
            $semester=1;
            if($month==29){$Year=$Year;$semester=2;}
            if($month==30){$Year=$Year;$semester=1;}

            $content_data=array();
            if($batch!='')
            {
                $yrs=$Year;
                $content_1= Yii::$app->db->createCommand("select d.coe_batch_id, d.coe_bat_deg_reg_id, degree_code, degree_type, programme_name, semester, degree_total_semesters from coe_cgpa_stu_af_reval a 
                            JOIN coe_subjects_mapping c on c.batch_mapping_id=a.batch_mapping_id 
                            JOIN coe_bat_deg_reg d on d.coe_bat_deg_reg_id=a.batch_mapping_id 
                            JOIN coe_programme e on e.coe_programme_id=d.coe_programme_id 
                            JOIN coe_degree as f ON f.coe_degree_id=d.coe_degree_id 
                            where d.coe_bat_deg_reg_id!=151 AND d.coe_batch_id='" . $batch . "' and a.year=".$Year." and a.month=".$month." group by d.coe_bat_deg_reg_id")->queryAll(); //c.batch_mapping_id =137 and
                                
                if(!empty($content_1))
                {
                     $reval_status_entry = Categorytype::find()->where(['category_type'=>'Revaluation'])->orWhere(['description'=>'Revaluation'])->one();
                         $query_map_id = new Query();
                    $query_map_id->select(['register_number','A.year','H.description as month_name','A.grade_name','degree_code','programme_code','subject_code','subject_name','A.CIA','CIA_max','A.ESE','ESE_max','A.total','A.student_map_id','A.subject_map_id','course_batch_mapping_id','coe_subjects_id','A.mark_type','A.term','A.month','x.batch_name','vm.total as temptotal','vm.grade_name as tempgradename','semester','A.result','programme_name','vm.ESE as tempese','vm.result as tempresult','I.category_type_id_marks'])
                            ->from('coe_mark_entry_master A')
                            ->join('JOIN', 'coe_student_mapping B', 'B.coe_student_mapping_id=A.student_map_id')
                            ->join('JOIN', 'coe_student stu', 'stu.coe_student_id=B.student_rel_id')
                            ->join('JOIN', 'coe_mark_entry_master_temp vm', 'vm.student_map_id=A.student_map_id and vm.subject_map_id=A.subject_map_id')
                            ->join('JOIN', 'coe_subjects_mapping C', 'C.coe_subjects_mapping_id=A.subject_map_id and C.batch_mapping_id=B.course_batch_mapping_id')
                            ->join('JOIN', 'coe_subjects sub', 'sub.coe_subjects_id=C.subject_id')
                            ->join('JOIN', 'coe_bat_deg_reg D', 'D.coe_bat_deg_reg_id=C.batch_mapping_id and D.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                            ->join('JOIN', 'coe_programme E', 'E.coe_programme_id=D.coe_programme_id')
                            ->join('JOIN', 'coe_degree G', ' G.coe_degree_id=D.coe_degree_id ')
                            ->join('JOIN', 'coe_batch x', ' x.coe_batch_id=D.coe_batch_id ')
                            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=A.month')
                            ->join('JOIN', 'coe_mark_entry I', 'I.student_map_id=A.student_map_id and I.subject_map_id=A.subject_map_id and I.month=A.month and I.year=A.year and I.mark_type=A.mark_type')
                            ->where(['D.coe_batch_id'=>$batch, 'student_status' => 'Active','A.year'=>$Year,'A.month'=>$month,'I.year'=>$Year,'I.month'=>$month,'I.category_type_id'=>$reval_status_entry['coe_category_type_id'],'A.result'=>'Pass','I.category_type_id'=>88])
                            //->andWhere(['NOT IN', 'status_category_type_id', $det_disc_type])
                            ->groupBy('A.student_map_id,A.subject_map_id');
                    $query_map_id->orderby('programme_name,register_number');
                    //echo $query_map_id->createCommand()->getRawSql();exit;
                    $sub_list = $query_map_id->createCommand()->queryAll();

                     $query_map_id_1 = new Query();


                     $query_map_id_1->select(['register_number','A.year','H.description as month_name','A.grade_name','degree_code','programme_code','subject_code','subject_name','A.CIA','CIA_max','A.ESE','ESE_max','A.total','A.student_map_id','A.subject_map_id','course_batch_mapping_id','coe_subjects_id','A.mark_type','A.term','A.month','x.batch_name','vm.total as temptotal','vm.grade_name as tempgradename','semester','A.result','programme_name','vm.ESE as tempese','vm.result as tempresult','I.category_type_id_marks as esedummy'])
                            ->from('coe_mark_entry_master A')
                            ->join('JOIN', 'coe_student_mapping B', 'B.coe_student_mapping_id=A.student_map_id')
                            ->join('JOIN', 'coe_student stu', 'stu.coe_student_id=B.student_rel_id')
                            ->join('JOIN', 'coe_mark_entry_master_temp vm', 'vm.student_map_id=A.student_map_id and vm.subject_map_id=A.subject_map_id')
                            ->join('JOIN', 'coe_subjects_mapping C', 'C.coe_subjects_mapping_id=A.subject_map_id and C.batch_mapping_id=B.course_batch_mapping_id')
                            ->join('JOIN', 'coe_subjects sub', 'sub.coe_subjects_id=C.subject_id')
                            ->join('JOIN', 'coe_bat_deg_reg D', 'D.coe_bat_deg_reg_id=C.batch_mapping_id and D.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                            ->join('JOIN', 'coe_programme E', 'E.coe_programme_id=D.coe_programme_id')
                            ->join('JOIN', 'coe_degree G', ' G.coe_degree_id=D.coe_degree_id ')
                            ->join('JOIN', 'coe_batch x', ' x.coe_batch_id=D.coe_batch_id ')
                            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=A.month')
                            ->join('JOIN', 'coe_mark_entry I', 'I.student_map_id=A.student_map_id and I.subject_map_id=A.subject_map_id and I.month=A.month and I.year=A.year and I.mark_type=A.mark_type')
                            ->where(['D.coe_batch_id'=>$batch, 'student_status' => 'Active','A.year'=>$Year,'A.month'=>$month,'I.year'=>$Year,'I.month'=>$month,'I.category_type_id'=>$reval_status_entry['coe_category_type_id'],'A.result'=>'Pass','I.category_type_id'=>89])
                            //->andWhere(['NOT IN', 'status_category_type_id', $det_disc_type])
                            ->groupBy('A.student_map_id,A.subject_map_id');
                    $query_map_id_1->orderby('programme_name,register_number');
                    //echo $query_map_id->createCommand()->getRawSql();exit;
                    $sub_list_1 = $query_map_id_1->createCommand()->queryAll();
                    $content_data[$yrs]=array("year"=>$yrs,"batch"=>$batch,'revaluation_grade'=>$sub_list,'esedummy'=>$sub_list_1);
                }
               
            }
            else
            {
                for($i=0;$i<4;$i++)
                {
                    if($i==0){$yrs=$Year;}else{$yrs=$yrs-1;}

                   $batch_id_value = Yii::$app->db->createCommand("select coe_batch_id from coe_batch where batch_name like '%".$yrs."%'")->queryScalar(); 
                    if(!empty($batch_id_value))
                    {

                        $content_1= Yii::$app->db->createCommand("select d.coe_batch_id, d.coe_bat_deg_reg_id, degree_code, degree_type, programme_name, semester, degree_total_semesters from coe_cgpa_stu_af_reval a 
                            JOIN coe_subjects_mapping c on c.batch_mapping_id=a.batch_mapping_id 
                            JOIN coe_bat_deg_reg d on d.coe_bat_deg_reg_id=a.batch_mapping_id 
                            JOIN coe_programme e on e.coe_programme_id=d.coe_programme_id 
                            JOIN coe_degree as f ON f.coe_degree_id=d.coe_degree_id 
                            where d.coe_bat_deg_reg_id!=151 AND d.coe_batch_id='" . $batch_id_value . "' and a.year=".$Year." and a.month=".$month." group by d.coe_bat_deg_reg_id")->queryAll(); //c.batch_mapping_id =137 and
                                
                        if(!empty($content_1))
                        {
                        
                            $content_data[$yrs]=array("year"=>$yrs,"batch"=>$batch_id_value,'revaluation_grade'=>'','esedummy'=>'');
                        }
                        
                    }
                } 
            }
            if(!empty($content_data))
            {
               // print_r($sub_list);exit;
                return $this->render('cgpa-average-after-reval', [
                        'model' => $model,
                        'content_data' =>$content_data,
                        'batch_id_value'=>$batch_id_value,
                        'month1'=>$_POST['month'],
                        'Year1'=>$_POST['year'],
                        'semester'=>$semester,
                        'revaluation_grade'=>$sub_list,
                        'esedummy'=>$sub_list_1
                    ]);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error','NO DATA FOUND');
                return $this->redirect(['mark-entry/cgpa-average-after-reval']);
            }
        }
        else
        {
            Yii::$app->ShowFlashMessages->setMsg('Welcome',"Welcome to Revalution CGPA Average Report");               
            return $this->render('cgpa-average-after-reval', [
                        'model' => $model,
                        'content_data' =>$content_data,
                        'batch_id_value'=>$batch_id_value,
                        'month1'=>$month,
                        'Year1'=>$Year,
                        'semester'=>$semester,
                        'revaluation_grade'=>$sub_list,
                        'esedummy'=>$sub_list_1
                    ]);
        } 
       
    }

    public function actionCgpaAveragePdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['cgpa_avg_printtemp'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Overall CGPA Average.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'options' => ['title' => 'Overall CGPA Average'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Overall CGPA Average' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelCgpaAverage()
    {
        
        $content = $_SESSION['cgpa_avg_printtemp'];
           
        $fileName = "Overall CGPA Average" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

     public function actionCiaEsemarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $dummy_entry_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       // $ESE = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       
        $Reval = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Revaluation%' OR description like '%Revaluation%'")->queryScalar();
        $Mod = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Moderation%' OR description like '%Moderation%'")->queryScalar();



        $model = new MarkEntry();
        if (Yii::$app->request->post()) {

            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.CIA,F.ESE,F.total as ese_mark, F.subject_map_id, F.student_map_id,F.month')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master_temp as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'],  'A.student_status' => 'Active'])->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);

            $query->orderBy('A.register_number,H.subject_code');
            //echo $query->createCommand()->getrawsql(); exit;
            $ese_list= $query->createCommand()->queryAll();

            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.CIA,F.ESE,F.total as ese_mark, F.subject_map_id, F.student_map_id,F.month')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'],  'A.student_status' => 'Active'])->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);

            $query->orderBy('A.register_number,H.subject_code');
            //echo $query->createCommand()->getrawsql(); exit;
            $ese_list1= $query->createCommand()->queryAll();

            if(!empty($ese_list1))
            {
                $ese_list = array_merge($ese_list,$ese_list1);
            }

            $query_m = new  Query();
            $query_m->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.CIA,F.ESE,F.total, F.subject_map_id, F.student_map_id,F.month,F.result')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_m->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'H.CIA_max'=>'0','H.ESE_max'=>'0','G.paper_type_id'=>'106']);

            $query_m->orderBy('A.register_number,H.subject_code');
            $ese_list4= $query_m->createCommand()->queryAll();

            if(!empty($ese_list4))
            {
                $ese_list = array_merge($ese_list,$ese_list4);
            }

            $sem = ConfigUtilities::semCaluclation($_POST['mark_year'], $_POST['month'], $_POST['bat_map_val']);

            $subject_get_data = new  Query();
           $subject_get_data->select('distinct (H.subject_code) as subject_code,G.coe_subjects_mapping_id as subject_map_id, H.subject_name, H.CIA_min, H.CIA_max, H.ESE_min, H.ESE_max,H.total_minimum_pass,G.paper_type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G',  'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $query->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();

            
            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $countOfSubjects = $countQuery->createCommand()->queryScalar();

            if (!empty($ese_list)) {
                return $this->render('ciaese-esemarklist', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                    'batch_mapping_id'=>$_POST['bat_map_val'],
                    'year'=>$_POST['mark_year'],
                    'month'=>$_POST['month'],
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/ciaese-esemarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Conslidate CIA + ESE Mark List');
            return $this->render('ciaese-esemarklist', [
                'model' => $model,
            ]);
        }
    }

    public function actionCiaEseMarkList1Pdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['cia_ese_mark_list1'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Conslidate CIA+ESE MARK LIST 100.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'Conslidate CIA+ESE MARK LIST'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate CIA+ESE Mark List' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelCiaEseMarkList1()
    {
        
        $content = $_SESSION['cia_ese_mark_list1'];
           
        $fileName = "Conslidate CIA+ESE Mark List 100" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionHodCiaesemarklist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $dummy_entry_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       $ESE = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       
        $Reval = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Revaluation%' OR description like '%Revaluation%'")->queryScalar();
        $Mod = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Moderation%' OR description like '%Moderation%'")->queryScalar();


        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {

            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,((BAR.grand_total/100)*H.ESE_max) as ese, BAR.grand_total, (((BAR.grand_total/100)*H.ESE_max)+F.category_type_id_marks) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_dummy_number as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_val_barcode_verify_details as BAR', 'BAR.dummy_number=DUM.dummy_number')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.category_type_id' => '46'])->andWhere(['<>','G.paper_type_id','137']);

            $query->orderBy('A.register_number,H.subject_code');

            //echo $query->createCommand()->getrawsql(); exit;
            $ese_list= $query->createCommand()->queryAll();

            $query_p = new  Query();
            $query_p->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,DUM.ESE as ese,(F.category_type_id_marks+DUM.ESE) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id AND category_type_id=46')
                ->join('JOIN', 'coe_practical_entry as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_p->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'G.paper_type_id' => '10']);

            $query_p->orderBy('A.register_number,H.subject_code');
            //echo $ese_list2= $query_p->createCommand()->getRawSql();exit;
            $ese_list2= $query_p->createCommand()->queryAll();

            if(!empty($ese_list2))
            {
                $ese_list = array_merge($ese_list,$ese_list2);
            }

            $query_i = new  Query();
            $query_i->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,DUM.year,J.category_type as month,E.programme_name,D.degree_name,DUM.CIA,DUM.ESE as ese,DUM.total, DUM.subject_map_id, DUM.student_map_id,DUM.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_mark_entry_master as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_i->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'],  'H.ESE_max'=>'0',  'G.paper_type_id' => '105'])->andWhere(['<>','G.paper_type_id','10'])->andWhere(['<>','G.paper_type_id','137']);

            $query_i->orderBy('A.register_number,H.subject_code');


            $ese_list3= $query_i->createCommand()->queryAll();

            if(!empty($ese_list3))
            {
                $ese_list = array_merge($ese_list,$ese_list3);
            }

            $query_m = new  Query();
            $query_m->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.CIA,F.ESE,F.total, F.subject_map_id, F.student_map_id,F.month,F.result, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_m->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'H.CIA_max'=>'0','H.ESE_max'=>'0','G.paper_type_id'=>'106']);

            $query_m->orderBy('A.register_number,H.subject_code');


            $ese_list4= $query_m->createCommand()->queryAll();

            if(!empty($ese_list4))
            {
                $ese_list = array_merge($ese_list,$ese_list4);
            }

          /*  $query_sw = new  Query();
            $query_sw->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA, DUM.grand_total, ((DUM.grand_total/100)*H.ESE_max) as ese, (((DUM.grand_total/100)*H.ESE_max)+F.category_type_id_marks) as total, F.subject_map_id, F.student_map_id,F.month,G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_scrtny_sw_based as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_sw->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.category_type_id' => '46'])->andWhere(['=','G.paper_type_id','136']);

            $query_sw->orderBy('A.register_number,H.subject_code');
            //echo $query_sw->createCommand()->getrawsql(); exit;
            $ese_swlist= $query_sw->createCommand()->queryAll();

            if(!empty($ese_swlist))
            {
                $ese_list = array_merge($ese_list,$ese_swlist);
            }*/

            $query_pb = new  Query();
            $query_pb->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,DUM.ESE as ese,(F.category_type_id_marks+DUM.ESE) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id AND category_type_id=46')
                ->join('JOIN', 'coe_practical_entry as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_pb->Where(['F.year' => $_POST['mark_year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'G.paper_type_id' => '137']);

            $query_pb->orderBy('A.register_number,H.subject_code');
            //echo $ese_list2= $query_p->createCommand()->getRawSql();exit;
            $ese_list5= $query_pb->createCommand()->queryAll();

            if(!empty($ese_list5))
            {
                $ese_list = array_merge($ese_list,$ese_list5);
            }

            $sem = ConfigUtilities::semCaluclation($_POST['mark_year'], $_POST['month'], $_POST['bat_map_val']);
            
            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code,G.coe_subjects_mapping_id as subject_map_id, H.subject_name, H.CIA_min, H.CIA_max, H.ESE_min, H.ESE_max,H.total_minimum_pass,G.paper_type_id,G.type_id, J.category_type as subject_type')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=G.type_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $query->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();

            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $countOfSubjects = $countQuery->createCommand()->queryScalar();

            if (!empty($ese_list)) {
                return $this->render('hod-ciaesemarklist', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                    'batch_mapping_id'=>$_POST['bat_map_val'],
                    'year'=>$_POST['mark_year'],
                    'month'=>$_POST['month'],
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/hod-ciaesemarklist']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Conslidate CIA + ESE HOD Copy');
            return $this->render('hod-ciaesemarklist', [
                'model' => $model,
            ]);
        }
    }

    public function actionHodCiaEseMarkList1Pdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['hod_cia_ese_mark_list1'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Conslidate HOD COPY.pdf',
            'format' => Pdf::FORMAT_A3,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',
            'options' => ['title' => 'Conslidate CIA+ESE MARK LIST HOD COPY'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Conslidate CIA+ESE Mark List HOD COPY' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelHodCiaEseMarkList1()
    {
        
        $content = $_SESSION['hod_cia_ese_mark_list1'];
           
        $fileName = "Conslidate HOD COPY" . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    // Reports ends Here
    /**
     * Displays a single MarkEntry model.
     * @param integer $id
     * @return mixed
     */
    public function actionView($id)
    {
        return $this->render('view', [
            'model' => $this->findModel($id),
        ]);
    }
    /**
     * Creates a new MarkEntry model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionCreate()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $student = new StudentMapping();
        $subjects = new SubjectsMapping();
        $updated_by = Yii::$app->user->getId();
        $updated_at = new \yii\db\Expression('NOW()');
        if ($model->load(Yii::$app->request->post())) 
        {
            $sn = Yii::$app->request->post('sn');
            $year = $model->year;
            $month = $model->month;
            
            $exam_data_show_xam_type = Categorytype::find()->where(['category_type'=>'Regular'])->one();
            $mark_type = $exam_data_show_xam_type->coe_category_type_id;
            $exam_data_show_exam_term = Categorytype::find()->where(['category_type'=>'End'])->one();
            $term = $exam_data_show_exam_term->coe_category_type_id;
            $batch_map_id = Yii::$app->request->post('bat_map_val');
            $sub = Yii::$app->request->post('sub_val');
            $internal_type = Yii::$app->request->post('cat_type_val');
            $sub_marks = Subjects::find()->where(['coe_subjects_id' => $sub])->one();
            
            $degree_name_get = Yii::$app->db->createCommand('SELECT CONCAT(degree_code," ",programme_code) FROM coe_bat_deg_reg as A JOIN coe_degree as B ON B.coe_degree_id=A.coe_degree_id JOIN coe_programme as C ON C.coe_programme_id=A.coe_programme_id where coe_bat_deg_reg_id="'.$batch_map_id.'"')->queryScalar();
            
            $sub_map_id = Yii::$app->db->createCommand("select coe_subjects_mapping_id from coe_subjects_mapping where batch_mapping_id='" . $batch_map_id . "' and subject_id='" . $sub . "' AND semester = '".$_POST['exam_semester']."'")->queryScalar();
            for ($i = 1; $i <= $sn; $i++) {
                $reg_no = $_POST["reg$i"];
                $stu_id = Student::find()->where(['register_number' => $reg_no, 'student_status' => 'Active'])->one();
                $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                $mark_entry_check = MarkEntry::find()->where(['student_map_id' => $stu_map_id['coe_student_mapping_id'], 'subject_map_id' => $sub_map_id, 'category_type_id' => $internal_type, 'year' => $year])->one();
                //Mark Entry Table (Internal)
                $model->student_map_id = $stu_map_id['coe_student_mapping_id'];
                $model->subject_map_id = $sub_map_id;
                $model->category_type_id = $internal_type;
                $model->category_type_id_marks = $_POST["mark$i"];
                $model->year = $year;
                $model->month = $month;
                $model->mark_type = $mark_type;
                $model->term = $term;
                $model->status_id = 0;
                $model->attendance_percentage = $_POST["attendance_percentage$i"];
                $model->attendance_remarks = $_POST["attendance_remark$i"];
                $model->created_by = $updated_by;
                $model->created_at = $updated_at;
                $model->updated_by = $updated_by;
                $model->updated_at = $updated_at;
                //Mark Entry Master Table (Internal and External)

                $markentrymaster->student_map_id = $model->student_map_id;
                $markentrymaster->subject_map_id = $model->subject_map_id;
                
                $markentrymaster->CIA = $_POST["mark$i"];
                $exam_term_check = Categorytype::find()->where(['description' => "End"])->one();
                $sem = ConfigUtilities::semCaluclation($year, $month, $batch_map_id);
                $subjectsMapping_data = SubjectsMapping::findOne($sub_map_id);
                $subjectsData = SubjectsMapping::findOne($sub_map_id);
                $categoryTypeFind = $sem == $subjectsData->semester ? 'Regular' : 'Arrear';
                $exam_type_check = Categorytype::find()->where(['description' => $categoryTypeFind])->one();
				if ($sub_marks['ESE_min'] == 0 && $sub_marks['ESE_max'] == 0) 
                {
					
                $stu_result_data = ConfigUtilities::StudentResult($stu_map_id['coe_student_mapping_id'], $sub_map_id, $_POST["mark$i"], 0,$year,$month);

                $markEntryMasterCheck = MarkEntryMaster::find()->where(['student_map_id' => $stu_map_id['coe_student_mapping_id'], 'subject_map_id' => $sub_map_id, 'year' => $year, 'month' => $month, 'mark_type' => $exam_type_check->coe_category_type_id, 'term' => $exam_term_check->coe_category_type_id])->all();
                
                $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $month . "-" . $year : '';
                
                $markentrymaster->ESE = $stu_result_data['ese_marks'];
                $markentrymaster->total = $stu_result_data['total_marks'];
                $markentrymaster->result = $stu_result_data['result'];
                $markentrymaster->grade_point = $stu_result_data['grade_point'];
                $markentrymaster->grade_name = $stu_result_data['grade_name'];
                $markentrymaster->year = $model->year;
                $markentrymaster->month = $month;
                $markentrymaster->term = $term;
                $markentrymaster->mark_type = $mark_type;
                $markentrymaster->status_id = 0;
                $markentrymaster->year_of_passing = $year_of_passing;
                $markentrymaster->attempt = $stu_result_data['attempt'];
                $markentrymaster->created_by = $updated_by;
                $markentrymaster->created_at = $updated_at;
                $markentrymaster->updated_by = $updated_by;
                $markentrymaster->updated_at = $updated_at;
                
                    if (isset($_POST["mark$i"]) && isset($_POST["attendance_percentage$i"]) && isset($_POST["attendance_remark$i"])) {

                        $sem = ConfigUtilities::semCaluclation($year, $month, $batch_map_id);
                        $subjectsMapping_data = SubjectsMapping::findOne($sub_map_id);
                        $subjectsData = SubjectsMapping::findOne($sub_map_id);
                        $categoryTypeFind = $sem == $subjectsData->semester ? 'Regular' : 'Arrear';
                        $exam_type_check = Categorytype::find()->where(['description' => $categoryTypeFind])->one();
                        $exam_term_check = Categorytype::find()->where(['description' => "End"])->one();
                        if (count($mark_entry_check) > 0) {



                            $result = Yii::$app->db->createCommand("update coe_mark_entry set category_type_id_marks ='" . $_POST["mark$i"] . "',updated_by='".$updated_by."',updated_at='".$updated_at."'  where student_map_id='" . $stu_map_id['coe_student_mapping_id'] . "' and subject_map_id='" . $sub_map_id . "' and category_type_id='" . $internal_type . "' and year='" . $year . "'")->query();
                            $stu_result_data = ConfigUtilities::StudentResult($stu_map_id['coe_student_mapping_id'], $sub_map_id, $_POST["mark$i"], 0,$year,$month);
                            $markEntryMasterCheck = MarkEntryMaster::find()->where(['student_map_id' => $stu_map_id['coe_student_mapping_id'], 'subject_map_id' => $sub_map_id, 'year' => $year, 'month' => $month, 'mark_type' => $exam_type_check->coe_category_type_id, 'term' => $exam_term_check->coe_category_type_id])->all();
                            $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? $month . "-" . $year : '';
                            $created_at = date("Y-m-d H:i:s");
                            $updateBy = Yii::$app->user->getId();

                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Prev CIA Out of 100 : '.$mark_entry_check['category_type_id_marks'].' New CIA Out of 100: '.$_POST["mark$i"];

                             $data_array = ['subject_map_id'=>$sub_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id['coe_student_mapping_id'] ];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                           //// TRCKING CODE ENDS //////

                            if (!empty($markEntryMasterCheck)) {

                                //// TRCKING CODE STARTS //////

                                $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                               $data_updated = 'Prev CIA  '.$markEntryMasterCheck['CIA'].' New CIA '.$_POST["mark$i"];
                               $data_array = ['subject_map_id'=>$markEntryMasterCheck['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$markEntryMasterCheck['student_map_id']];            
                               $update_track = ConfigUtilities::updateTracker($data_array);

                                //// TRCKING CODE ENDS //////


                                Yii::$app->db->createCommand("update coe_mark_entry_master set CIA ='" . $_POST["mark$i"] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',ESE=0,total='" . $_POST["mark$i"] . "',result='" . $stu_result_data['result'] . "',grade_point='" . $stu_result_data['grade_point'] . "',grade_name='" . $stu_result_data['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where student_map_id='" . $stu_map_id['coe_student_mapping_id'] . "' and mark_type='" . $exam_type_check->coe_category_type_id . "' and term='" . $exam_term_check->coe_category_type_id . "' and subject_map_id='" . $sub_map_id . "'  and month='" . $month . "' and year='" . $year . "' ")->query();
                            } else {
                                $MarkEntryMasterModel = new MarkEntryMaster();
                                $MarkEntryMasterModel->student_map_id = $stu_map_id['coe_student_mapping_id'];
                                $MarkEntryMasterModel->subject_map_id = $sub_map_id;
                                $MarkEntryMasterModel->CIA = $_POST["mark$i"];
                                $MarkEntryMasterModel->ESE = 0;
                                $MarkEntryMasterModel->total = $_POST["mark$i"];
                                $MarkEntryMasterModel->result = $stu_result_data['result'];
                                $MarkEntryMasterModel->grade_point = $stu_result_data['grade_point'];
                                $MarkEntryMasterModel->grade_name = $stu_result_data['grade_name'];
                                $MarkEntryMasterModel->year = $year;
                                $MarkEntryMasterModel->month = $month;
                                $MarkEntryMasterModel->term = $exam_term_check->coe_category_type_id;
                                $MarkEntryMasterModel->mark_type = $exam_type_check->coe_category_type_id;
                                $MarkEntryMasterModel->year_of_passing = $year_of_passing;
                                $MarkEntryMasterModel->attempt = 0;
                                $MarkEntryMasterModel->status_id = 0;
                                $MarkEntryMasterModel->created_by = $updateBy;
                                $MarkEntryMasterModel->created_at = $created_at;
                                $MarkEntryMasterModel->updated_by = $updateBy;
                                $MarkEntryMasterModel->updated_at = $created_at;
                                $MarkEntryMasterModel->save(false);
                                unset($MarkEntryMasterModel);
                            }
                            Yii::$app->ShowFlashMessages->setMsg('Success', 'Marks updated successfuly');
                        } else if ($model->save()) {
                            $markentrymaster->save();
                            unset($markentrymaster);
                            unset($model);
                            Yii::$app->ShowFlashMessages->setMsg('Success', 'Marks inserted successfuly');
                        } else {
                            Yii::$app->ShowFlashMessages->setMsg('Error', 'Please complete the mark entry for all ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT));
                        }
                    }
                    $markentrymaster = new MarkEntryMaster();
                    $model = new MarkEntry();
                } else {
                    if (isset($_POST["mark$i"]) && isset($_POST["attendance_percentage$i"]) && isset($_POST["attendance_remark$i"])) {
                        if (count($mark_entry_check) > 0) {

                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Prev CIA Out of 100 : '.$mark_entry_check['category_type_id_marks'].' New CIA Out of 100: '.$_POST["mark$i"];

                             $data_array = ['subject_map_id'=>$sub_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id['coe_student_mapping_id'] ];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                           //// TRCKING CODE ENDS //////

                            $result = Yii::$app->db->createCommand("update coe_mark_entry set category_type_id_marks ='" . $_POST["mark$i"] . "',updated_by='".$updated_by."',updated_at='".$updated_at."'  where student_map_id='" . $stu_map_id['coe_student_mapping_id'] . "' and subject_map_id='" . $sub_map_id . "' and category_type_id='" . $internal_type . "' and year='" . $year . "'")->query();
                            Yii::$app->ShowFlashMessages->setMsg('Success', 'Marks updated successfuly');
                        } else if ($model->save()) {
                            unset($model);
                            Yii::$app->ShowFlashMessages->setMsg('Success', 'Marks inserted successfuly');
                        } else {
                            Yii::$app->ShowFlashMessages->setMsg('Error', 'Please complete the mark entry for all ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT));
                        }
                    }
                    $model = new MarkEntry();
                }
            }
            return $this->render('create', [
                'model' => $model,
            ]);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Internal Mark Entry');
            return $this->render('create', [
                'model' => $model,
            ]);
        }
    }
    public function actionPrintApplicationPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['moderation_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Moderation Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse:collapse; border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }td,th{border:1px solid #999}
                    }   
                ',
            'options' => ['title' => 'Moderation Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Moderation' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExternalmarkentry()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $sn = Yii::$app->request->post('sn');
        $batch_id = Yii::$app->request->post('bat_val');
        $batch_map_id = Yii::$app->request->post('bat_map_val');
        $section = Yii::$app->request->post('sec');
        $sem = Yii::$app->request->post('exam_semester');
        $sub = Yii::$app->request->post('sub_val');
        $model_type = Yii::$app->request->post('select_mod_type');

        if(Yii::$app->request->post())
        {
            $exam_month = $_POST['month'];
            $exam_year = $_POST['mark_year'];
        }
        $sub_max = Subjects::find(['ESE_min', 'total_minimum_pass'])->where(['coe_subjects_id' => $sub])->one();
        $sub_map_id = SubjectsMapping::find()->where(['batch_mapping_id' => $batch_map_id, 'subject_id' => $sub])->one();
        $c_paper_type = Categorytype::find()->where(['coe_category_type_id' => $sub_map_id['paper_type_id']])->one();
        $cat_cia_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'internal final%' or category_type like 'cia 1%' or category_type like 'internal 1%'")->queryScalar();
        if (stristr($c_paper_type['category_type'], "Practical")) 
        {
            if ($model_type == "With Model") {
                for ($k = 1; $k <= $sn; $k++) {
                    if (isset($_POST["mark$k"])) {
                        $reg_no = $_POST["reg$k"];
                        $stu_id = Student::find()->where(['register_number' => $reg_no, 'student_status' => 'Active'])->one();
                        $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                        $model->student_map_id = $stu_map_id->coe_student_mapping_id;
                        $model->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                        $cat_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'model 1%' or category_type like 'model1%'")->queryScalar();
                        $model->category_type_id = $cat_ese_val;
                        $model->category_type_id_marks = $_POST["mark$k"];
                        $model->year = Yii::$app->request->post('mark_year');
                        $model->month = Yii::$app->request->post('month');
                        $model->term = Yii::$app->request->post('term');
                        $model->mark_type = Yii::$app->request->post('mark_type');
                        $model->mark_out_of = $_POST['mod_1'];
                        $model->status_id = 0;
                        $model->created_at = new \yii\db\Expression('NOW()');
                        $model->created_by = Yii::$app->user->getId();
                        $model->updated_at = new \yii\db\Expression('NOW()');
                        $model->updated_by = Yii::$app->user->getId();
                        $model->save();
                        unset($model);
                        $model = new MarkEntry();
                    }
                }
                for ($k = 1; $k <= $sn; $k++) {
                    if (isset($_POST["mark1$k"])) {
                        $reg_no = $_POST["reg$k"];
                        $stu_id = Student::find()->where(['register_number' => $reg_no, 'student_status' => 'Active'])->one();
                        $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                        $model->student_map_id = $stu_map_id->coe_student_mapping_id;
                        $model->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                        $cat_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'model 2%' or category_type like 'model2%'")->queryScalar();
                        $model->category_type_id = $cat_ese_val;
                        $model->category_type_id_marks = $_POST["mark1$k"];
                        $model->year = Yii::$app->request->post('mark_year');
                        $model->month = Yii::$app->request->post('month');
                        $model->term = Yii::$app->request->post('term');
                        $model->mark_type = Yii::$app->request->post('mark_type');
                        $model->mark_out_of = $_POST['mod_2'];
                        $model->status_id = 0;
                        $model->created_at = new \yii\db\Expression('NOW()');
                        $model->created_by = Yii::$app->user->getId();
                        $model->updated_at = new \yii\db\Expression('NOW()');
                        $model->updated_by = Yii::$app->user->getId();
                        $model->save();
                        unset($model);
                        $model = new MarkEntry();
                    }
                }
            } else {
                //$model = new MarkEntry();
                $cat_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'ese%' or category_type like 'external%'")->queryScalar();
                for ($k = 1; $k <= $sn; $k++) {
                    //print_r($_POST["mark$k"]);
                    if (isset($_POST["mark$k"])) {
                        $reg_no = $_POST["reg$k"];
                        $cia_mark = $_POST["cia$k"];
                        $total = $_POST["total$k"];
                        $result = $_POST["result$k"];
                        $stu_id = Student::find()->where(['register_number' => $reg_no, 'student_status' => 'Active'])->one();
                        $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                        $model->student_map_id = $stu_map_id->coe_student_mapping_id;
                        $model->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                        $model->category_type_id = $cat_ese_val;
                        $model->category_type_id_marks = $_POST["mark$k"];
                        $model->year = Yii::$app->request->post('mark_year');
                        $model->month = Yii::$app->request->post('month');
                        $model->term = Yii::$app->request->post('term');
                        $model->mark_type = Yii::$app->request->post('mark_type');
                        $model->status_id = 0;
                        $model->created_by = Yii::$app->user->getId();
                        $model->created_at = new \yii\db\Expression('NOW()');
                        $model->updated_by = Yii::$app->user->getId() . " ";
                        $model->updated_at = new \yii\db\Expression('NOW()');
                        $model->save();
                        unset($model);
                        $model = new MarkEntry();
                    }
                }
            }
            for ($k = 1; $k <= $sn; $k++) {
                if (isset($_POST["converted_marks_$k"])) {
                    $stu_id = Student::find()->where(['register_number' => $_POST["reg$k"], 'student_status' => 'Active'])->one();
                    $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                    $cat_model1_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'model 1%' or category_type like 'model1%'")->queryScalar();
                    $model1_mark = Yii::$app->db->createCommand("select category_type_id_marks from coe_mark_entry where student_map_id='" . $stu_map_id->coe_student_mapping_id . "' and subject_map_id='" . $sub_map_id->coe_subjects_mapping_id . "' and category_type_id='" . $cat_model1_ese_val . "'")->queryScalar();
                    $cat_model2_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'model 2%' or category_type like 'model2%'")->queryScalar();
                    $model2_mark = Yii::$app->db->createCommand("select category_type_id_marks from coe_mark_entry where student_map_id='" . $stu_map_id->coe_student_mapping_id . "' and subject_map_id='" . $sub_map_id->coe_subjects_mapping_id . "' and category_type_id='" . $cat_model2_ese_val . "'")->queryScalar();
                    $markentrymaster->student_map_id = $stu_map_id->coe_student_mapping_id;
                    $markentrymaster->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                    $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $sub_map_id->coe_subjects_mapping_id . '" AND student_map_id="' . $stu_map_id->coe_student_mapping_id . '" AND result not like "%pass%"')->queryScalar();
                    $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    if ($check_attempt >= $config_attempt) {
                        $stu_result_data = ConfigUtilities::StudentResult($stu_map_id->coe_student_mapping_id, $sub_map_id->coe_subjects_mapping_id, 0, $_POST["mark$k"],$exam_year,$exam_month);
                        $markentrymaster->CIA = 0;
                    } else {
                        $stu_result_data = ConfigUtilities::StudentResult($stu_map_id->coe_student_mapping_id, $sub_map_id->coe_subjects_mapping_id, $_POST["cia$k"], $_POST["mark$k"],$exam_year,$exam_month);
                        $markentrymaster->CIA = $_POST["cia$k"];
                    }
                    $year_of_passing = $stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS" ? Yii::$app->request->post('month'). "-" . Yii::$app->request->post('mark_year') : '';

                    $markentrymaster->ESE = $stu_result_data['ese_marks'];
                    $markentrymaster->total = $stu_result_data['total_marks'];
                    $markentrymaster->result = $stu_result_data['result'];
                    $markentrymaster->grade_point = $stu_result_data['grade_point'];
                    $markentrymaster->grade_name = $stu_result_data['grade_name'];
                    $markentrymaster->attempt = $stu_result_data['attempt'];
                    $markentrymaster->year = Yii::$app->request->post('mark_year');
                    $markentrymaster->month = Yii::$app->request->post('month');
                    $markentrymaster->term = Yii::$app->request->post('term');
                    $markentrymaster->mark_type = Yii::$app->request->post('mark_type');
                    $markentrymaster->status_id = 0;
                    $markentrymaster->created_by = Yii::$app->user->getId();
                    $markentrymaster->created_at = new \yii\db\Expression('NOW()');
                    $markentrymaster->updated_by = Yii::$app->user->getId();
                    $markentrymaster->updated_at = new \yii\db\Expression('NOW()');
                    $markentrymaster->year_of_passing = $year_of_passing;
                    $markentrymaster->save();
                    unset($markentrymaster);
                    $markentrymaster = new MarkEntryMaster();
                }
            }
        }//practicals
        else {
            $cat_ese_val = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like 'ese%' or category_type like 'external%'")->queryScalar();
            for ($k = 1; $k <= $sn; $k++) {
                if (isset($_POST["mark$k"])) {
                    $reg_no = $_POST["reg$k"];
                    $cia_mark = $_POST["cia$k"];
                    $total = $_POST["total$k"];
                    $result = $_POST["result$k"];
                    $stu_id = Student::find()->where(['register_number' => $reg_no, 'student_status' => 'Active'])->one();
                    $stu_map_id = StudentMapping::find()->where(['student_rel_id' => $stu_id['coe_student_id']])->one();
                    $model->student_map_id = $stu_map_id->coe_student_mapping_id;
                    $model->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                    $model->category_type_id = $cat_ese_val;
                    $model->category_type_id_marks = $_POST["mark$k"];
                    $model->year = Yii::$app->request->post('mark_year');
                    $model->month = Yii::$app->request->post('month');
                    $model->term = Yii::$app->request->post('term');
                    $model->mark_type = Yii::$app->request->post('mark_type');
                    $model->status_id = 0;
                    $model->created_by = Yii::$app->user->getId();
                    $model->created_at = new \yii\db\Expression('NOW()');
                    $model->updated_by = Yii::$app->user->getId() . " ";
                    $model->updated_at = new \yii\db\Expression('NOW()');
                    if ($model->save()) {
                        $markentrymaster->student_map_id = $stu_map_id->coe_student_mapping_id;
                        $markentrymaster->subject_map_id = $sub_map_id->coe_subjects_mapping_id;
                        $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $sub_map_id->coe_subjects_mapping_id . '" AND student_map_id="' . $stu_map_id->coe_student_mapping_id . '" AND result not like "%pass%"')->queryScalar();
                        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                        if ($check_attempt >= $config_attempt) {
                            $stu_result_data = ConfigUtilities::StudentResult($stu_map_id->coe_student_mapping_id, $sub_map_id->coe_subjects_mapping_id, 0, $_POST["mark$k"],$exam_year,$exam_month);
                            $markentrymaster->CIA = 0;
                        } else {
                            $stu_result_data = ConfigUtilities::StudentResult($stu_map_id->coe_student_mapping_id, $sub_map_id->coe_subjects_mapping_id, $_POST["cia$k"], $_POST["mark$k"],$exam_year,$exam_month);
                            $markentrymaster->CIA = $_POST["cia$k"];
                        }
                        $markentrymaster->ESE = $stu_result_data['ese_marks'];
                        $markentrymaster->total = $stu_result_data['total_marks'];
                        $markentrymaster->result = $stu_result_data['result'];
                        $markentrymaster->grade_point = $stu_result_data['grade_point'];
                        $markentrymaster->grade_name = $stu_result_data['grade_name'];
                        $markentrymaster->attempt = $stu_result_data['attempt'];
                        $markentrymaster->year = Yii::$app->request->post('mark_year');
                        $markentrymaster->month = Yii::$app->request->post('month');
                        $markentrymaster->term = Yii::$app->request->post('term');
                        $markentrymaster->mark_type = Yii::$app->request->post('mark_type');
                        $markentrymaster->status_id = 0;
                        $markentrymaster->created_by = Yii::$app->user->getId();
                        $markentrymaster->created_at = new \yii\db\Expression('NOW()');
                        $markentrymaster->updated_by = Yii::$app->user->getId();
                        $markentrymaster->updated_at = new \yii\db\Expression('NOW()');
                        $markentrymaster->year_of_passing = $stu_result_data['year_of_passing'];
                        $markentrymaster->save();
                        unset($markentrymaster);
                        unset($model);
                        $model = new MarkEntry();
                        $markentrymaster = new MarkEntryMaster();
                    }
                }
                $model = new MarkEntry();
                $markentrymaster = new MarkEntryMaster();
            }
        }
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to External Mark Entry');
        return $this->render('externalmarkentry', [
            'model' => $model, 'markentrymaster' => $markentrymaster,
        ]);
    }
  /* public function actionModeration()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        
        if (isset($_POST['mod_submit_btn'])) 
        {
            $sn = Yii::$app->request->post('sn');
            
            $year = $_POST['MarkEntry']['year'];
            $moderation_marks = $_POST['MarkEntry']['marks_out_of'];
            $month = $_POST['MarkEntry']['month'];

            $mod_category_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%Moderation%'")->queryScalar();
            $year_of_passing = $month . "-" . $year;
            $notEligible = '';
            $succesS =0;
            for ($k = 1; $k <= $sn; $k++) 
            {
                if (isset($_POST['mod' . $k])) 
                {
                    $student_map_id = $_POST['student_map_id_' . $k];
                    $subject_map_id = $_POST['subject_map_id_' . $k];
                        
                    if(!empty($student_map_id) && !empty($subject_map_id))
                    {
                        $stu_mapGet = StudentMapping::findOne($student_map_id);
                        $stuDentMark = Student::findOne($stu_mapGet->student_rel_id);
                        $coe_batch_id = CoeBatDegReg::findOne($stu_mapGet['course_batch_mapping_id']);
                        $regulation_year = Regulation::find()->distinct()->where(['regulation_year' => $coe_batch_id->regulation_year])->one();

                        $query_min_pass = new Query();
                        $minimum_pass = $query_min_pass->select('a.ESE_min,a.total_minimum_pass')
                            ->from('coe_subjects a')
                            ->join('JOIN', 'coe_subjects_mapping b', 'b.subject_id=a.coe_subjects_id')
                            ->where(['coe_subjects_mapping_id'=>$subject_map_id])->createCommand()->queryOne();
                        $grade_100 = $minimum_pass['total_minimum_pass'];
                        $grade_10 = ($minimum_pass['total_minimum_pass'] / 100) * 10;

                        $query_exam_map_id = new Query();
                       
                        $max_grade = Yii::$app->db->createCommand("select max(grade_point_to) from coe_regulation where regulation_year='" . $regulation_year->regulation_year . "' and grade_name is not null")->queryScalar();
                        $round_max_grade = round($max_grade);
                        if ($round_max_grade > 10) 
                        {
                            $query_grade = new Query();
                            $min_grade = $query_grade->select('grade_name,grade_point')
                                ->from('coe_regulation')
                                ->where(['grade_point_from' => $grade_100, 'regulation_year' => $regulation_year->regulation_year])->createCommand()->queryOne();
                        } else {
                            
                            $query_grade = new Query();
                            $min_grade = $query_grade->select('grade_name,grade_point')
                                ->from('coe_regulation')
                                ->where(['grade_point_from' => $grade_10, 'regulation_year' => $regulation_year->regulation_year])->createCommand()->queryOne();
                        }
                        $ese_mark = $_POST['ESE_' . $k];
                        $cia = $_POST['CIA_' . $k];
                        $stu_total_mark = $cia + $minimum_pass['ESE_min'];
                        $mod_category_marks = $minimum_pass['ESE_min'] - $ese_mark;

                        $getStuMode = Yii::$app->db->createCommand('SELECT sum(category_type_id_marks) FROM coe_mark_entry WHERE student_map_id="'.$student_map_id.'" and year="'.$year.'" and month="'.$month.'" and category_type_id="'.$mod_category_id.'"')->queryScalar();

                        if($stu_total_mark>=$minimum_pass['total_minimum_pass'] && $getStuMode<=$moderation_marks && (($mod_category_marks+$getStuMode)<=$moderation_marks))
                        {
                            $updated_by = Yii::$app->user->getId();
                            $updated_at = date('Y-m-d-H-i-s');
                            $mark_entry_model = new MarkEntry();
                            $mark_entry_model->student_map_id = $student_map_id;
                            $mark_entry_model->subject_map_id = $subject_map_id;
                            $mark_entry_model->category_type_id = $mod_category_id;
                            $mark_entry_model->category_type_id_marks = $mod_category_marks;
                            $mark_entry_model->year = $year;
                            $mark_entry_model->month = $month;
                            $mark_entry_model->term = $_POST['term' . $k];
                            $mark_entry_model->mark_type = $_POST['mark_type' . $k];
                            $mark_entry_model->status_id = 0;
                            $mark_entry_model->created_by = $updated_by;
                            $mark_entry_model->created_at = $updated_at;
                            $mark_entry_model->updated_by = $updated_by;
                            $mark_entry_model->updated_at = $updated_at;
                            if($mark_entry_model->save(false)) 
                            {
                                
                                //// TRCKING CODE STARTS //////

                                 $getMarksdata = MarkEntryMaster::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$_POST['mark_type' . $k],'term'=>$_POST['term' . $k] ])->one();

                                 $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                                  $data_updated = 'Moderation : Prev ESE Marks : '.$getMarksdata['ESE'].' New ESE Marks : '.$minimum_pass['ESE_min'].' Prev Total Marks : '.$getMarksdata['total'].' New Total Marks: '.$stu_total_mark;

                                 $data_array = ['subject_map_id'=>$subject_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$student_map_id ];            
                                  $update_track = ConfigUtilities::updateTracker($data_array);

                                //// TRCKING CODE ENDS //////

                                $update_stu_mark = Yii::$app->db->createCommand("update coe_mark_entry_master set ESE='" . $minimum_pass['ESE_min'] . "',total='" . $stu_total_mark . "',result='Pass',grade_point='" . $min_grade['grade_point'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',grade_name='" . $min_grade['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where subject_map_id='" . $subject_map_id . "' and student_map_id='" . $student_map_id. "' and year='" . $year . "' and month='" . $month . "' and mark_type='".$_POST['mark_type' . $k]."' and term='".$_POST['term' . $k]."'")->execute();
                                $succesS++;
                            }
                        }
                        else
                        {
                            $subMarp = SubjectsMapping::findOne($subject_map_id);
                            $subjectS = Subjects::findOne($subMarp->subject_id);
                            $notEligible .=$stuDentMark->register_number."-".$subjectS->subject_code."<br />";
                        }
                    }                    
                }
            }
            if($succesS!=0)
            {
                $add_string = !empty($notEligible) ?'<b>Not Eligible For '.$notEligible."</b>":'';
                Yii::$app->ShowFlashMessages->setMsg('Success', 'Moderation Applied Successfully '.$add_string.' !!!');
                return $this->redirect(['moderation']);
            }
            else if($notEligible!='')
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', "<b>".$notEligible.'</b> Not Eligible for Moderation Where Total Minimum Pass Not Secured');
                return $this->redirect(['moderation']);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', 'Nothing Updated');
                return $this->redirect(['moderation']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Moderation Mark Entry');
            return $this->render('moderation', [
                'model' => $model,
            ]);
        }
    }
    */
     public function actionModeration()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $elective=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Elective%'")->queryScalar();


        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        
        if (isset($_POST['mod_submit_btn'])) 
        {
            $sn = Yii::$app->request->post('sn');
            
            $year = $_POST['MarkEntry']['year'];
            $moderation_marks = $_POST['MarkEntry']['marks_out_of'];
            $month = $_POST['MarkEntry']['month'];

            $mod_category_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%Moderation%'")->queryScalar();
            $year_of_passing = $month . "-" . $year;
            $notEligible = '';
            $succesS =0;
            for ($k = 1; $k <= $sn; $k++) 
            {
                if (isset($_POST['mod' . $k])) 
                {
                    $student_map_id = $_POST['student_map_id_' . $k];
                    $subject_map_id = $_POST['subject_map_id_' . $k];
                        
                    if(!empty($student_map_id) && !empty($subject_map_id))
                    {
                        $stu_mapGet = StudentMapping::findOne($student_map_id);
                        $stuDentMark = Student::findOne($stu_mapGet->student_rel_id);
                        $coe_batch_id = CoeBatDegReg::findOne($stu_mapGet['course_batch_mapping_id']);
                        $regulation_year = Regulation::find()->distinct()->where(['regulation_year' => $coe_batch_id->regulation_year])->one();

                        $query_min_pass = new Query();
                        $minimum_pass = $query_min_pass->select('a.ESE_min,a.total_minimum_pass')
                            ->from('coe_subjects a')
                            ->join('JOIN', 'coe_subjects_mapping b', 'b.subject_id=a.coe_subjects_id')
                            ->where(['coe_subjects_mapping_id'=>$subject_map_id])->createCommand()->queryOne();
                        $grade_100 = $minimum_pass['total_minimum_pass'];
                        $grade_10 = ($minimum_pass['total_minimum_pass'] / 100) * 10;

                        $query_exam_map_id = new Query();
                       
                        $max_grade = Yii::$app->db->createCommand("select max(grade_point_to) from coe_regulation where regulation_year='" . $regulation_year->regulation_year . "' and grade_name is not null")->queryScalar();
                        $round_max_grade = round($max_grade);
                        if ($round_max_grade > 10) 
                        {
                            $query_grade = new Query();
                            $min_grade = $query_grade->select('grade_name,grade_point')
                                ->from('coe_regulation')
                                ->where(['grade_point_from' => $grade_100, 'regulation_year' => $regulation_year->regulation_year])->createCommand()->queryOne();
                        } else {
                            
                            $query_grade = new Query();
                            $min_grade = $query_grade->select('grade_name,grade_point')
                                ->from('coe_regulation')
                                ->where(['grade_point_from' => $grade_10, 'regulation_year' => $regulation_year->regulation_year])->createCommand()->queryOne();
                        }
                        $ese_mark = $_POST['ESE_' . $k];
                        $cia = $_POST['CIA_' . $k];
                        $total= $_POST['total' . $k];

                       
                        $mod_category_marks = $minimum_pass['total_minimum_pass'] - $total;
                         $ese_mark = $_POST['ESE_' . $k];
                         //$ese= $_POST['ESE_' . $k]+$mod_category_marks;
                         
                        if($elective){
                            $stu_total_mark =  $total+$mod_category_marks
                         ;
                         $ese=$_POST['ESE_' . $k];
                        
                        }
                        else{

                            $stu_total_mark = $cia + $ese_mark+$mod_category_marks;
                            
                             $ese= $_POST['ESE_' . $k]+$mod_category_marks;


                        }
                        //print_r($stu_total_mark);exit;
                       
                     

                        $getStuMode = Yii::$app->db->createCommand('SELECT sum(category_type_id_marks) FROM coe_mark_entry WHERE student_map_id="'.$student_map_id.'" and year="'.$year.'" and month="'.$month.'" and category_type_id="'.$mod_category_id.'"')->queryScalar();
                        //print_r($getStuMode);exit;


                        if($stu_total_mark>=$minimum_pass['total_minimum_pass'])
                        {
                            $updated_by = Yii::$app->user->getId();
                            $updated_at = date('Y-m-d-H-i-s');
                            $mark_entry_model = new MarkEntry();
                            $mark_entry_model->student_map_id = $student_map_id;
                            $mark_entry_model->subject_map_id = $subject_map_id;
                            $mark_entry_model->category_type_id = $mod_category_id;
                            $mark_entry_model->category_type_id_marks = $mod_category_marks;
                            $mark_entry_model->year = $year;
                            $mark_entry_model->month = $month;
                            $mark_entry_model->term = $_POST['term' . $k];
                            $mark_entry_model->mark_type = $_POST['mark_type' . $k];
                            $mark_entry_model->status_id = 0;
                            $mark_entry_model->created_by = $updated_by;
                            $mark_entry_model->created_at = $updated_at;
                            $mark_entry_model->updated_by = $updated_by;
                            $mark_entry_model->updated_at = $updated_at;
                            if($mark_entry_model->save(false)) 
                            {
                                
                                //// TRCKING CODE STARTS //////

                                 $getMarksdata = MarkEntryMaster::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$_POST['mark_type' . $k],'term'=>$_POST['term' . $k] ])->one();

                                 $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                                  $data_updated = 'Moderation : Prev ESE Marks : '.$getMarksdata['ESE'].' New ESE Marks : '.$minimum_pass['ESE_min'].' Prev Total Marks : '.$getMarksdata['total'].' New Total Marks: '.$stu_total_mark;

                                 $data_array = ['subject_map_id'=>$subject_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$student_map_id ];            
                                  $update_track = ConfigUtilities::updateTracker($data_array);

                                //// TRCKING CODE ENDS //////

                                $update_stu_mark = Yii::$app->db->createCommand("update coe_mark_entry_master set ESE='" .  $ese . "',total='" . $stu_total_mark . "',result='Pass',grade_point='" . $min_grade['grade_point'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',grade_name='" . $min_grade['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where subject_map_id='" . $subject_map_id . "' and student_map_id='" . $student_map_id. "' and year='" . $year . "' and month='" . $month . "' and mark_type='".$_POST['mark_type' . $k]."' and term='".$_POST['term' . $k]."'")->execute();
                                $succesS++;
                            }
                        }
                        else
                        {
                            $subMarp = SubjectsMapping::findOne($subject_map_id);
                            $subjectS = Subjects::findOne($subMarp->subject_id);
                            $notEligible .=$stuDentMark->register_number."-".$subjectS->subject_code."<br />";

                        }
                    }                    
                }
            }
            if($succesS!=0)
            {
                $add_string = !empty($notEligible) ?'<b>Not Eligible For '.$notEligible."</b>":'';
                Yii::$app->ShowFlashMessages->setMsg('Success', 'Moderation Applied Successfully '.$add_string.' !!!');
                return $this->redirect(['moderation']);
            }
            else if($notEligible!='')
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', "<b>".$notEligible.'</b> Not Eligible for Moderation Where Total Minimum Pass Not Secured');
                return $this->redirect(['moderation']);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', 'Nothing Updated');
                return $this->redirect(['moderation']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Moderation Mark Entry');
            return $this->render('moderation', [
                'model' => $model,
            ]);
        }
    }

   

    public function actionViewmoderation()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        if (isset($_POST['view_mod'])) {
            $moderation_category_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%moderation%'")->queryScalar();
            
                $query = new Query();
                $query->select(['concat(i.programme_code," - ",h.degree_code) as degree_name', 'c.subject_code', 'e.register_number', 'b.semester', 'f.CIA', '`f`.`ESE`-`a`.`category_type_id_marks` as `oldESE`', 'a.category_type_id_marks as moderation', 'f.ESE as newESE', 'f.total','f.grade_name', 'f.result', 'k.category_type'])
                    ->from('coe_mark_entry a')
                    ->join('JOIN', 'coe_subjects_mapping b', 'a.subject_map_id=b.coe_subjects_mapping_id')
                    ->join('JOIN', 'coe_subjects c', 'b.subject_id=c.coe_subjects_id')
                    ->join('JOIN', 'coe_student_mapping d', 'a.student_map_id=d.coe_student_mapping_id')
                    ->join('JOIN', 'coe_student e', 'd.student_rel_id=e.coe_student_id')
                    ->join('JOIN', 'coe_mark_entry_master f', 'a.subject_map_id=f.subject_map_id and a.student_map_id=f.student_map_id and a.year=f.year and a.month=f.month and a.mark_type=f.mark_type')
                    ->join('JOIN', 'coe_bat_deg_reg g', 'd.course_batch_mapping_id=g.coe_bat_deg_reg_id')
                    ->join('JOIN', 'coe_degree h', 'g.coe_degree_id=h.coe_degree_id')
                    ->join('JOIN', 'coe_programme i', 'g.coe_programme_id=i.coe_programme_id')
                    ->join('JOIN', 'coe_category_type k', 'k.coe_category_type_id =a.month')
                    ->where(['a.year' => $_POST['view_mod_mark_year'], 'a.month' => $_POST['mod_month'],  'a.category_type_id' => $moderation_category_id, 'e.student_status' => 'Active'])
                    ->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                    ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                    ->orderBy('register_number,category_type_id_marks');
                $view_moderation = $query->createCommand()->queryAll();
            
            if (count($view_moderation) > 0) {
                return $this->render('viewmoderation', [
                    'model' => $model,
                    'view_moderation' => $view_moderation,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Moderation");
                return $this->render('viewmoderation', [
                    'model' => $model,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Moderation ');
            return $this->render('viewmoderation', [
                'model' => $model,
            ]);
        }
    }
    /* Withheld Starts Here */
    public function actionWithheld()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
		
        if (Yii::$app->request->post()) 
		{
            $sn = Yii::$app->request->post('sn');
            $year = Yii::$app->request->post('mark_year');
            $month = Yii::$app->request->post('month');
            $stu_map_id = Yii::$app->request->post('withheld_stu_reg_num');
            $month_year = $month . '-' . $year;
            $updated_at = new \yii\db\Expression('NOW()');
            $updated_by = Yii::$app->user->getId();
            for ($k = 1; $k <= $sn; $k++) 
            {
                $sub_map_id = $_POST['sub_code' . $k];
                if (isset($_POST["withheld" . $k])) 
                {
                    //// TRCKING CODE STARTS //////

                     $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                      $data_updated = 'Marking Withheld for Student Withheld';

                     $data_array = ['subject_map_id'=>$sub_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                      $update_track = ConfigUtilities::updateTracker($data_array);

                    //// TRCKING CODE ENDS //////

                    $RESult_cha = $_POST["result" . $k]=='Absent'?'Absent':'Fail';
                    Yii::$app->db->createCommand("update coe_mark_entry_master set year_of_passing='' ,grade_name='WH',grade_point=0, updated_by='".$updated_by."',result='".$RESult_cha."',updated_at='".$updated_at."', withheld='w',withheld_remarks='".$_POST["remarks" . $k]."' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $sub_map_id . "' and year='" . $year . "' and month='" . $month . "'")->execute();
                } 
                else 
                {   
                    $ciaMArks = $grade_cia_check = $_POST["cia" . $k];
                    $ese_marks = $_POST["ese" . $k];
                    $total_marks = $ese_marks+$ciaMArks;
                    
                    $sub_map_id_mar = SubjectsMapping::findOne($sub_map_id);
                    $batchMapping = CoeBatDegReg::findOne($sub_map_id_mar->batch_mapping_id);
                    $get_sub_info = Subjects::findOne($sub_map_id_mar->subject_id);
                    $grade_details = Regulation::find()->where(['regulation_year'=>$batchMapping->regulation_year])->all();

                    foreach ($grade_details as $value) 
                      {
                          if($value['grade_point_to']!='')
                          {                            
                              if($total_marks >= $value['grade_point_from'] &&  $total_marks <= $value['grade_point_to'] )
                              {

                                  if($grade_cia_check<$get_sub_info['CIA_min'] || $ese_marks<$get_sub_info['ESE_min'] || $total_marks<$get_sub_info['total_minimum_pass'])
                                  {
                                    $result_calc = ['result'=>'Fail','total_marks'=>$total_marks,'grade_name'=>'RA','grade_point'=>0,'year_of_passing'=>'','ese_marks'=>$ese_marks];
                                  }      
                                  else
                                  {
                                    $grade_name_prit = $value['grade_name'];
                                    $grade_point_arts = $value['grade_point'];                                
                                    $result_calc = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                                                    
                                  }
                              } // Grade Point Caluclation
                          } // Not Empty of the Grade Point 
                      }
                    

                     //// TRCKING CODE STARTS //////

                     $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                      $data_updated = 'Marking Withheld for Student Withheld';

                     $data_array = ['subject_map_id'=>$sub_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                      $update_track = ConfigUtilities::updateTracker($data_array);

                    //// TRCKING CODE ENDS //////


                    Yii::$app->db->createCommand("update coe_mark_entry_master set year_of_passing='" . $result_calc['year_of_passing']. "',result='".$result_calc['result']."' ,updated_by='".$updated_by."',grade_point='" . $result_calc['grade_point']. "',updated_at='".$updated_at."', withheld='',withheld_remarks='', grade_name='".$result_calc['grade_name']."' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $sub_map_id . "' and year='" . $year . "' and month='" . $month . "'")->execute();
                }
            }
            Yii::$app->ShowFlashMessages->setMsg('Success', 'Updated Successfully!!!');
            return $this->redirect(['withheld']);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Withheld Entry!!');
            return $this->render('withheld', [
                'model' => $model,
            ]);
        }
    }
    /* Withheld Ends Here */
    /* Revaluation Starts Here */
    public function actionRevaluationentry()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $model = new Revaluation();
        $student = new Student();
        $ab_locking = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REVAL_LOCKING);
        $last_exam_data = ExamTimetable::find()->orderBy('exam_date DESC')->one();
        $today=date('Y-m-d');
        if(!empty($last_exam_data))
        {
            $grace_period = date_add(date_create($last_exam_data->exam_date), date_interval_create_from_date_string($ab_locking.' days'));
            $final_date = date_format($grace_period, 'Y-m-d');
        }
       if(isset($final_date) && !empty($final_date) && $today>$final_date)
        {
             Yii::$app->ShowFlashMessages->setMsg('Error',"Revaluation application Date has been Passed");
            return $this->render('revaluationentry', [
                    'model' => $model,
                    'student'=>$student,
                ]);
        }
        
        if (Yii::$app->request->post()) 
        {           
            $sn = Yii::$app->request->post('sn');
           
            for ($k = 1; $k <= $sn; $k++) 
            {
                if (isset($_POST["transparency" . $k])) 
                {
                    $query = new Query();
                    $query->select(['coe_student_mapping_id'])
                        ->from('coe_student A')
                        ->join('JOIN', 'coe_student_mapping B', 'B.student_rel_id=A.coe_student_id')
                        ->where(['A.register_number' => $_POST['stu_reg_num']])
                        ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $stu_map_id = $query->createCommand()->queryScalar();
                    $check_data = Revaluation::find()->where(['student_map_id' => $stu_map_id, 'subject_map_id' => $_POST['sub_code' . $k]
                        , 'year' => $_POST['reval_entry_year'], 'month' => $_POST['reval_entry_month']])->one();
                    if (empty($check_data)) 
                    {
                        $model->student_map_id = $stu_map_id;
                        $model->subject_map_id = $_POST['sub_code' . $k];
                        $model->year = $_POST['reval_entry_year'];
                        $model->month = $_POST['reval_entry_month'];
                        $model->mark_type = $_POST['mark_type' . $k];
                        if (isset($_POST["transparency" . $k])) {
                            $transparency = "S";
                        } else {
                            $transparency = "NO";
                        }
                        $model->is_transparency = $transparency;
                        $model->created_by = Yii::$app->user->getId();
                        $model->created_at = new \yii\db\Expression('NOW()');
                        $model->updated_by = Yii::$app->user->getId();
                        $model->updated_at = new \yii\db\Expression('NOW()');
                        $model->save();
                        unset($model);
                        $model = new Revaluation();
                    }
                }
                if (isset($_POST["revaluation" . $k])) 
                {
                    $find_stu_data = Revaluation::find()->where(['student_map_id'=>$_POST['stu_map_id'.$k],'subject_map_id'=>$_POST['sub_code' . $k],'year'=>$_POST['reval_entry_year'],'month'=>$_POST['reval_entry_month'],'mark_type'=>$_POST['mark_type' . $k],'is_transparency'=>'S'])->one();
                    
                    $updated_on = date('Y-m-d-H-i-s');
                    if(!empty($find_stu_data))
                    {
                        $command1 = Yii::$app->db->createCommand('UPDATE coe_revaluation SET reval_status="YES",updated_by="'.Yii::$app->user->getId().'",updated_at="'.$updated_on.'" WHERE coe_revaluation_id="'.$find_stu_data->coe_revaluation_id.'"');
                        $command1->execute();
                    }
                }
            }
            $year = $_POST['reval_entry_year'];
            $month = $_POST['reval_entry_month'];
            $stu_reg_num = $_POST['stu_reg_num'];
            $course_batch_mapping_id = Yii::$app->db->createCommand("SELECT course_batch_mapping_id FROM coe_student_mapping as A JOIN coe_student as B ON B.coe_student_id=A.student_rel_id Where B.register_number='" . $stu_reg_num . "' and status_category_type_id NOT IN('".$det_disc_type."') ")->queryScalar();
            $semester_name = ConfigUtilities::getSemesterName($course_batch_mapping_id);
            $query = new Query();
            $query->select('a.coe_student_mapping_id,b.name,b.register_number')
                ->from('coe_student_mapping a')
                ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                ->where(['b.register_number' => $stu_reg_num])
                ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $student_map_id = $query->createCommand()->queryOne();
            $check_trans_done = Yii::$app->db->createCommand("select * from coe_revaluation where student_map_id='" . $student_map_id['coe_student_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and is_transparency='S' ")->queryAll();

            $check_rev_done = Yii::$app->db->createCommand("select * from coe_revaluation where student_map_id='" . $student_map_id['coe_student_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and reval_status='YES' ")->queryAll();

            $month_name = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();
            $cat_paper_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'practical%'")->queryScalar();
            $cat_mod_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'moderation%'")->queryScalar();
            $cat_rev_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'revaluation%'")->queryScalar();
            $subject_result = Yii::$app->db->createCommand("select distinct subject_code as subject_code,subject_fee,subject_name,coe_subjects_id,B.semester,B.coe_subjects_mapping_id,coe_student_mapping_id,F.mark_type,F.grade_name from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry as E,coe_mark_entry_master as F where A.coe_subjects_id=B.subject_id and B.batch_mapping_id=D.course_batch_mapping_id and C.coe_student_id=D.student_rel_id and F.student_map_id=D.coe_student_mapping_id and E.student_map_id=D.coe_student_mapping_id and F.subject_map_id=B.coe_subjects_mapping_id and E.subject_map_id=B.coe_subjects_mapping_id and F.year='" . $year . "' and F.month='" . $month . "' and C.register_number='" . $stu_reg_num . "' and E.category_type_id!='" . $cat_mod_mark_type . "' and C.student_status='Active' and status_category_type_id NOT IN('".$det_disc_type."') and B.paper_type_id!='" . $cat_paper_type . "'")->queryAll();
            $table = "";
            $sn = 1;
            if (count($check_rev_done) > 0) 
            {
                $subject_total = 0;
                foreach ($check_rev_done as $check_rev) 
                {
                    $query_rev = new Query();
                    $query_rev->select('a.description')
                        ->from('coe_category_type a')
                        ->JOIN('JOIN','coe_categories b','b.coe_category_id=a.category_id')
                        ->where(['like','b.category_name','Revaluation Fees']);
                    $stu_reval_subject = $query_rev->createCommand()->queryOne();
                    $subject_total += $stu_reval_subject['description'];
                }
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $table .=
                    '<table border=1 class="table table-responsive table-striped" align="center" ><tbody align="center">     
                        <tr>
                            <td> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </td>
                            <td colspan=10 align="center"> 
                                <center><b><font size="4px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </td>
                            <td>  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </td>
                        </tr>
                        <tr>
                            <td colspan=6 align="right"> END ' . $semester_name . ' EXAMINATIONS </td>
                            <td colspan=6 align="left"> ' . $month_name . '-' . $year . ' </td>
                            
                        </tr>
                        <tr>
                            <td colspan=12 align="center"> APPLICATION FOR REVALUATION</td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Name of the ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' </td>
                            <td colspan=8 align="left"> ' . $student_map_id['name'] . ' </td>
                            
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Register Number </td>
                            <td colspan=8 align="left"> ' . $stu_reg_num . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left">  Month / Year of Examination </td>
                            <td colspan=8 align="left"> ' . strtoupper($month_name) . '-' . $year . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Number of ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . 's Applied for Revaluation </td>
                            <td colspan=8 align="left"> ' . count($check_rev_done) . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Total Amount </td>
                            <td colspan=8 align="left"> ' . $subject_total . ' </td>
                        </tr>
                           
                        <tr>                                                                                                               
                            <th> S.NO </th> 
                            <th colspan=2 align="left"> ' . $semester_name . ' </th>
                            <th colspan=3 align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                            <th colspan=6 align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>';
                /*<th colspan=3 align="center"> Amount </th>*/
                $table .= '</tr>';
                foreach ($check_rev_done as $check_rev) {
                    $query_rev = new Query();
                    $query_rev->select('b.subject_code,b.subject_name,b.subject_fee,a.semester')
                        ->from('coe_subjects_mapping a')
                        ->join('JOIN', 'coe_subjects b', 'a.subject_id=b.coe_subjects_id')
                        ->where(['a.coe_subjects_mapping_id' => $check_rev['subject_map_id']]);
                    $stu_reval_subject = $query_rev->createCommand()->queryOne();
                    $table .= '<tr><td align="left">' . $sn . '</td>
                                <td colspan=2 align="left">' . $stu_reval_subject['semester'] . '</td>
                                <td colspan=3 align="left">' . $stu_reval_subject['subject_code'] . '</td>
                                <td colspan=6 align="left">' . $stu_reval_subject['subject_name'] . '</td>
                            </tr>';                    
                    $sn++;
                }
                $table .= '<tr>
                                <td height="200" colspan="12"> &nbsp; </td>
                            </tr>
                            <tr height="150">
                                <td colspan="4"> Name & Signature of the Candidate </td>
                                <td colspan="4"> Name & Signature of the Tutor </td>
                                <td colspan="4"> Head of the Department </td>
                            </tr>';
                $table .= '</tbody></table>';
                $data = ['table' => $table, 'result' => 50];
                if (isset($_SESSION['revaluation_amount'])) {
                    unset($_SESSION['revaluation_amount']);
                }
                $_SESSION['revaluation_amount'] = $table;
                $content = $_SESSION['revaluation_amount'];
                $pdf = new Pdf([
                    'mode' => Pdf::MODE_CORE,
                    'filename' => "Revaluation Total Amount.pdf",
                    'format' => Pdf::FORMAT_A4,
                    'orientation' => Pdf::ORIENT_PORTRAIT,
                    'content' => $content,
                    'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                    'cssInline' => ' @media all{
                                table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                            }   
                        ',
                    'options' => ['title' => "Revaluation Total Amount"],
                    'methods' => [
                        'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                        'SetFooter' => ["Revaluation Total Amount " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                    ]
                ]);
                Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
                $headers = Yii::$app->response->headers;
                $headers->add('Content-Type', 'application/pdf');
                return $pdf->render();
            }
       
            if (count($check_trans_done) > 0) 
            {
                $subject_total = 0;
                foreach ($check_trans_done as $check_rev) {                    
                    $query_rev = new Query();
                    $query_rev->select('a.description')
                        ->from('coe_category_type a')
                        ->JOIN('JOIN','coe_categories b','b.coe_category_id=a.category_id')
                        ->where(['like','b.category_name','Transparency Fee']);
                    $stu_reval_subject = $query_rev->createCommand()->queryOne();
                    $subject_total += $stu_reval_subject['description']; 
                }
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $table .=
                    '<table border=1 class="table table-responsive table-striped" align="center" ><tbody align="center">     
                        <tr>
                            <td> 
                                <img class="img-responsive" width="80" height="80" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </td>
                            <td colspan=10 align="center"> 
                                <center><b><font size="4px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </td>
                            <td align="center">  
                                <img width="80" height="80" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </td>
                        </tr>
                        <tr>
                            <td colspan=6 align="right"> END ' . $semester_name . ' EXAMINATION </td>
                            <td colspan=6 align="left"> ' . strtoupper($month_name) . '-' . $year . ' </td>
                            
                        </tr>
                        <tr>
                            <td colspan=12 align="center"> APPLICATION FOR TRANSPARANCY</td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Name of the ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' </td>
                            <td colspan=8 align="left"> ' . $student_map_id['name'] . ' </td>
                            
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Register Number </td>
                            <td colspan=8 align="left"> ' . $stu_reg_num . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left">  Month / Year of Examination </td>
                            <td colspan=8 align="left"> ' . strtoupper($month_name) . '-' . $year . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Number of ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Applied for Tranparancy </td>
                            <td colspan=8 align="left"> ' . count($check_trans_done) . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> Total Amount </td>
                            <td colspan=8 align="left"> ' . $subject_total . ' </td>
                        </tr>
                           
                        <tr>                               
                            <th> S.NO </th> 
                            <th colspan=2  align="left"> ' . $semester_name . ' </th>
                            <th colspan=3  align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . 's CODE </th>
                            <th colspan=6 align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>';
                /*<th colspan=3 align="center"> Amount </th>*/
                $table .= '</tr>';
                foreach ($check_trans_done as $check_rev) {
                    $query_rev = new Query();
                    $query_rev->select('b.subject_code,b.subject_name,b.subject_fee,a.semester')
                        ->from('coe_subjects_mapping a')
                        ->join('JOIN', 'coe_subjects b', 'a.subject_id=b.coe_subjects_id')
                        ->where(['a.coe_subjects_mapping_id' => $check_rev['subject_map_id']]);
                    $stu_reval_subject = $query_rev->createCommand()->queryOne();
                    $table .= '<tr><td align="left">' . $sn . '</td>
                                <td colspan=2 align="left">' . $stu_reval_subject['semester'] . '</td>
                                <td colspan=3 align="left">' . $stu_reval_subject['subject_code'] . '</td>
                                <td colspan=6 align="left">' . $stu_reval_subject['subject_name'] . '</td>
                            </tr>';
                    $sn++;
                }
               
                $table .= '<tr>
                                <td height="200" colspan="12"> &nbsp; </td>
                            </tr>
                            <tr height="150">
                                <td colspan="4"> Name & Signature of the Candidate </td>
                                <td colspan="4"> Name & Signature of the Tutor </td>
                                <td colspan="4"> Head of the Department </td>
                            </tr>';
                $table .= '</tbody></table>';
                $data = ['table' => $table, 'result' => 50];
                if (isset($_SESSION['revaluation_amount'])) {
                    unset($_SESSION['revaluation_amount']);
                }
                $_SESSION['revaluation_amount'] = $table;
                $content = $_SESSION['revaluation_amount'];

                $pdf = new Pdf([
                    'mode' => Pdf::MODE_CORE,
                    'filename' => "Tranparancy Total Amount.pdf",
                    'format' => Pdf::FORMAT_A4,
                    'orientation' => Pdf::ORIENT_PORTRAIT,
                    'content' => $content,
                    'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                    'cssInline' => ' @media all{
                                table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                            }   
                        ',
                    'options' => ['title' => "Tranparancy Total Amount"],
                    'methods' => [
                        'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                        'SetFooter' => ["Tranparancy Total Amount " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                    ]
                ]);
                Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
                $headers = Yii::$app->response->headers;
                $headers->add('Content-Type', 'application/pdf');
                return $pdf->render();
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Revaluation Application Entry');
            return $this->render('revaluationentry', ['model' => $model, 'student' => $student,]);
        }
    }
    public function actionRevaluationentrysub()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $stu_reg_num = Yii::$app->request->post('stu_reg_num');

        $course_batch_mapping_id = Yii::$app->db->createCommand("SELECT course_batch_mapping_id FROM coe_student_mapping as A JOIN coe_student as B ON B.coe_student_id=A.student_rel_id Where B.register_number='" . $stu_reg_num . "' and status_category_type_id NOT IN('".$det_disc_type."') ")->queryScalar();
        if (empty($course_batch_mapping_id)) {
            return 0;
        }
        $semester_name = ConfigUtilities::getSemesterName($course_batch_mapping_id);
        $ab_locking = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REVAL_LOCKING);
        $last_exam_data = ExamTimetable::find()->where(['exam_year'=>$year,'exam_month'=>$month])->orderBy('exam_date DESC')->one();
        $today = date('Y-m-d');

        if (!empty($last_exam_data)) 
        {
            $grace_period = date_add(date_create($last_exam_data['exam_date']), date_interval_create_from_date_string($ab_locking . ' days'));
            $final_date = date_format($grace_period, 'Y-m-d');
            if(isset($final_date) && !empty($final_date) && $today>$final_date)
            {
                Yii::$app->ShowFlashMessages->setMsg('Error',"Revaluation application Date has been Passed");
                return $this->redirect(['mark-entry/revaluationentry']);
            }
        }
        
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $check_trans = Yii::$app->db->createCommand("select * from coe_categories where description like '%Transparency Fee%' ")->queryOne();        
        $check_reval= Yii::$app->db->createCommand("select * from coe_categories where description like '%Revaluation Fee%' ")->queryOne();
        $stu_reg_num = Yii::$app->request->post('stu_reg_num');
        $query = new Query();
        $query->select('a.coe_student_mapping_id,b.name,b.register_number')
            ->from('coe_student_mapping a')
            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
            ->where(['b.register_number' => $stu_reg_num])
            ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
        $student_map_id = $query->createCommand()->queryOne();

        $check_rev_done = Yii::$app->db->createCommand("select * from coe_revaluation where student_map_id='" . $student_map_id['coe_student_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and reval_status='YES' ")->queryAll();

        $check_trans_done = Yii::$app->db->createCommand("select * from coe_revaluation where student_map_id='" . $student_map_id['coe_student_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and is_transparency='S' ")->queryAll();
        
        
        $month_name = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();

        $trans_fees = Yii::$app->db->createCommand("select description from coe_category_type where category_id='" . $check_trans['coe_category_id'] . "'")->queryScalar();

        $reval_fees = Yii::$app->db->createCommand("select description from coe_category_type where category_id='" . $check_reval['coe_category_id'] . "'")->queryScalar();

        $cat_paper_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'practical%'")->queryScalar();
        $cat_mod_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'moderation%'")->queryScalar();
        $cat_rev_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'revaluation%'")->queryScalar();

        $subject_result = Yii::$app->db->createCommand("select distinct subject_code as subject_code,subject_fee,subject_name,F.grade_name,coe_subjects_id,B.semester,C.name,B.coe_subjects_mapping_id,coe_student_mapping_id,F.mark_type from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry as E,coe_mark_entry_master as F where A.coe_subjects_id=B.subject_id and B.batch_mapping_id=D.course_batch_mapping_id and C.coe_student_id=D.student_rel_id and F.student_map_id=D.coe_student_mapping_id and E.student_map_id=D.coe_student_mapping_id and F.subject_map_id=B.coe_subjects_mapping_id and E.subject_map_id=B.coe_subjects_mapping_id and F.year='" . $year . "' and F.month='" . $month . "' and C.register_number='" . $stu_reg_num . "' and E.category_type_id!='" . $cat_mod_mark_type . "' and C.student_status='Active' and B.paper_type_id!='" . $cat_paper_type . "' and F.result NOT LIKE '%Absent%' and status_category_type_id NOT IN('".$det_disc_type."') and A.ESE_max!=0 and A.ESE_min!=0  order by B.semester")->queryAll();

        $subject_trans_result = Yii::$app->db->createCommand("select distinct subject_code as subject_code,subject_fee,subject_name,coe_subjects_id,B.semester,B.coe_subjects_mapping_id,coe_student_mapping_id,F.mark_type,C.name,F.grade_name from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry as E,coe_mark_entry_master as F,coe_revaluation as G where G.student_map_id=F.student_map_id and G.subject_map_id=F.subject_map_id and A.coe_subjects_id=B.subject_id and B.batch_mapping_id=D.course_batch_mapping_id and C.coe_student_id=D.student_rel_id and F.student_map_id=D.coe_student_mapping_id and E.student_map_id=D.coe_student_mapping_id and F.subject_map_id=B.coe_subjects_mapping_id and E.subject_map_id=B.coe_subjects_mapping_id and F.year='" . $year . "' and F.month='" . $month . "' and G.month='".$month."' and G.year='".$year."' and C.register_number='" . $stu_reg_num . "' and E.category_type_id!='" . $cat_mod_mark_type . "' and C.student_status='Active' and B.paper_type_id!='" . $cat_paper_type . "' and F.result!='Absent' and status_category_type_id NOT IN('".$det_disc_type."') and A.ESE_max!=0 and A.ESE_min!=0 order by B.semester")->queryAll();
       
        $table = "";
        $sn = 1;
        $a=1;
        if (count($check_rev_done) > 0) {
            $subject_total = 0;
            $reval_fees = Yii::$app->db->createCommand('SELECT description FROM coe_category_type where category_type like "%Revaluation Fees%"')->queryScalar();
            foreach ($check_rev_done as $check_rev) 
            {
                $subject_total += $reval_fees;
            }
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table .=
                '<table border=1 class="table table-responsive table-striped" align="center" ><tbody align="center">     
                        <tr>
                            <td  align="center"> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </td>
                            <td colspan=10 align="center"> 
                                <center><b><font size="4px">' . strtoupper($org_name) . '</font></b></center>
                                <center>' . strtoupper($org_address) . '</center>
                                
                                <center>' . strtoupper($org_tagline) . '</center> 
                            </td>
                            <td  align="center">  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </td>
                        </tr>
                        <tr>
                            <td colspan=12 align="center"> END ' . strtoupper($semester_name) . '  EXAMINATION  ' . strtoupper($month_name) . '-' . $year . ' </td>
                            
                        </tr>
                        <tr>
                            <td colspan=12 align="center"> '.strtoupper("Application for Revaluation").'</td>
                        </tr>
                       
                        <tr>
                            <td colspan=4 align="left"> '.strtoupper("Register Number ").'</td>
                            <td colspan=8 align="left"> ' . $stu_reg_num . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left">  '.strtoupper("Month / Year of Examination").' </td>
                            <td colspan=8 align="left"> ' . strtoupper($month_name) . '-' . $year . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> '.strtoupper("Number of ".ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) ."S Applied for Revaluation ") .' </td>
                            <td colspan=8 align="left"> ' . count($check_rev_done) . ' </td>
                        </tr>
                        <tr>
                            <td colspan=4 align="left"> TOTAL AMOUNT </td>
                            <td colspan=8 align="left"> ' . $subject_total . ' </td>
                        </tr>
                           
                        <tr>                                                                                                               
                            <th> S.NO </th> 
                            <th colspan=2 align="left"> ' . strtoupper($semester_name) . ' </th>
                            <th colspan=3 align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                            <th colspan=6 align="left"> ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>';
            /*<th colspan=3 align="center"> Amount </th>*/
            $table .= '</tr>';
            foreach ($check_rev_done as $check_rev) {
                $query_rev = new Query();
                $query_rev->select('b.subject_code,b.subject_name,b.subject_fee,a.semester')
                    ->from('coe_subjects_mapping a')
                    ->join('JOIN', 'coe_subjects b', 'a.subject_id=b.coe_subjects_id')
                    ->where(['a.coe_subjects_mapping_id' => $check_rev['subject_map_id']]);
                $stu_reval_subject = $query_rev->createCommand()->queryOne();
                $table .= '<tr>
                                <td align="left">' . $sn . '</td>
                                <td colspan=2 align="left">' . $stu_reval_subject['semester'] . '</td>
                                <td colspan=3 align="left">' . $stu_reval_subject['subject_code'] . '</td>
                                <td colspan=6 align="left">' . $stu_reval_subject['subject_name'] . '</td>
                            </tr>';
                
                $sn++;
            }
            
            $table .= '
                     <tr>
                        <td height="200" colspan="12"> &nbsp; </td>
                     </tr>
                     <tr height="150">
                        <td colspan="4"> Name & Signature of the Candidate </td>
                        
                        <td colspan="4"> Name & Signature of the Tutor </td>
                        <td colspan="4"> Head of the Department </td>
                    </tr>';
            $table .= '</tbody></table>';
            $data = ['table' => $table, 'result' => 50];
            if (isset($_SESSION['revaluation_amount'])) {
                unset($_SESSION['revaluation_amount']);
            }
            $_SESSION['revaluation_amount'] = $table;
            return json_encode($data);
        } else if (count($check_trans_done) > 0) {
            $table .=
                '<table border=1 class="table table-striped" align="right" border=1>
                           <thead id="t_head">                                     
                                <th> S.NO </th> 
                                <th> ' . $semester_name . ' </th>
                                <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </th>
                                <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </th> 
                                <th> Grade </th>
                                <th> Transparency </th>
                                <th> Revaluation </th>';
            $table .= '</thead><tbody>';
            
            foreach ($subject_trans_result as $subject_result1) 
            {
                $table .="<tr>" .
                    "<td><input type='hidden' id=sn_" . $sn . " name='sn' value=" . $sn . ">" . $sn . "</td> " .
                    "<td><input type='hidden' name=sem" . $sn . " value='" . $subject_result1['semester'] . "'>" . $subject_result1['semester'] . "</td>" .
                    "<td><input type='hidden' name=sub_code" . $sn . " value='" . $subject_result1['coe_subjects_mapping_id'] . "'>" . $subject_result1['subject_code'] . "</td>" .
                    "<td><input type='hidden' name=sub_name" . $sn . " value='" . $subject_result1['coe_subjects_id'] . "'>" . $subject_result1['subject_name'] . "</td>" .
                    "<input type='hidden' class='reval_fee' id=reval_fee_" . $sn . " name=sub_fee" . $sn . " value='" . $reval_fees . "'>" .
                    "<input type='hidden' name=stu_map_id" . $sn . " value='" . $subject_result1['coe_student_mapping_id'] . "'>" .
                    "<input type='hidden' name=mark_type" . $sn . " value='" . $subject_result1['mark_type'] . "'>"."
                    <td><input type='hidden' name=grade_name" . $sn . " value='" . $subject_result1['grade_name'] . "'>" . $subject_result1['grade_name'] . "</td>";
                $table .= "<td align='center'><input type='checkbox' class='transparency' onchange='revaluationentry_check(this.id)' name=transparency" . $sn . " id=transparency_" . $sn . " value='YES' checked disabled ></td>";

                $table .= "<td align='center'><input type='checkbox' class='revaluation_column' onchange='revaluationentry_checked(this.id)' name=revaluation" . $sn . " id=revaluation_" . $sn . " value='YES'></td>";
                
                $table .= "</tr>";
                $sn++;
            }
            $table .= "<tr><td colspan='6' align='right'><b>Total</b></td><td><b><center><input type='text' id='total' readonly size=4px></center></b></td></tr>";
            
            $table .= '</tbody></table>';
            $data = ['table' => $table, 'result' => 51];
            
                return json_encode($data);
            
        }
        else if (count($subject_result) > 0) {
            $table .=
                '<table border=1 class="table table-striped" align="right" border=1>     
                           <thead id="t_head">                                                                                                               
                                <th> S.NO </th> 
                                <th> ' . $semester_name . ' </th>
                                <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </th>
                                <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </th> 
                                <th> Grade </th>
                                <th> Tranparancy </th>';
            $table .= '</thead><tbody>';
            foreach ($subject_result as $subject_result1) {
               
                $table .=
                    "<tr>" .
                    "<td><input type='hidden' id=sn_" . $sn . " name='sn' value=" . $sn . ">" . $sn . "</td> " .
                    "<td><input type='hidden' name=sem" . $sn . " value='" . $subject_result1['semester'] . "'>" . $subject_result1['semester'] . "</td>" .
                    "<td><input type='hidden' name=sub_code" . $sn . " value='" . $subject_result1['coe_subjects_mapping_id'] . "'>" . $subject_result1['subject_code'] . "</td>" .
                    "<td><input type='hidden' name=sub_name" . $sn . " value='" . $subject_result1['coe_subjects_id'] . "'>" . $subject_result1['subject_name'] . "</td>" .
                    "<input type='hidden' class='fee' id=sub_fee_" . $sn . " name=sub_fee" . $sn . " value='" . $trans_fees . "'>" .
                    "<input type='hidden' name=stu_map_id" . $sn . " value='" . $subject_result1['coe_student_mapping_id'] . "'>" .
                    "<input type='hidden' name=mark_type" . $sn . " value='" . $subject_result1['mark_type'] . "'>".
                    "<td><input type='hidden' name=grade_name" . $sn . " value='" . $subject_result1['grade_name'] . "'>" . $subject_result1['grade_name'] . "</td>";
               
                $table .= "<td align='center'><input type='checkbox' class='transparency' onchange='revaluationentry_check(this.id)' name=transparency" . $sn . " id=transparency_" . $sn . " value='YES'></td>";
                
                $table .= "</tr>";
                $sn++;
            }
            $table .= "<tr><td colspan='5' align='right'><b>Total</b></td><td><b><center><input type='text' id='total' readonly size=4px></center></b></td></tr>";
            
            $table .= '</tbody></table>';
            $data = ['table' => $table, 'result' => 51];

            return json_encode($data);
            
        } else {
            return 0;
        }
        /*}
        else
        {
            return 1;
        }*/
    }
    public function actionRevaluationAmountPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
        $content = $_SESSION['revaluation_amount'];
            
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => "Revaluation Application.pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => "Revaluation Application"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ["Revaluation Application " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelRevaluationamount()
    {
        
        $content = $_SESSION['revaluation_amount'];
            
        $fileName = "Revaluation Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionViewrevaluation()
    {
        $model = new Revaluation();
        $markentry = new MarkEntry();
        if (isset($_POST['view_reval_btn'])) 
        {
            $join_in_query='where';
            $select_column = ',A.subject_code,A.subject_name,B.coe_subjects_mapping_id ';
           
            if(isset($_POST['Revaluation']['is_transparency'][0]) && $_POST['Revaluation']['is_transparency'][0]=='yes')
            {
                $join_in_query = ' JOIN coe_dummy_number as F WHERE F.student_map_id=E.student_map_id and F.subject_map_id=E.subject_map_id and F.year="'.$_POST['mark_year'].'" and F.month="'.$_POST['month'].'" and ';
                $select_column .= ',F.dummy_number ';
            }
            $revaluation = Yii::$app->db->createCommand("select C.register_number,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and G.coe_programme_id='".$_POST['bat_map_val']."' and H.coe_programme_id='".$_POST['bat_map_val']."' and E.reval_status='YES' group by C.register_number,A.subject_code order by C.register_number")->queryAll();
            
            if (count($revaluation) > 0) {
                return $this->render('viewrevaluation', [
                    'model' => $model,
                    'markentry' => $markentry,
                    'revaluation' => $revaluation,
                    'exam_month'=>$_POST['month'],
                    'exam_year'=>$_POST['mark_year']
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Revaluation");
                return $this->render('viewrevaluation', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Revaluation');
            return $this->render('viewrevaluation', [
                'model' => $model,
                'markentry' => $markentry,
            ]);
        }
    }

    public function actionRevaluationViewPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['revaluation_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Revaluation.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => 'Revaluation Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Revaluation Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelRevaluationview()
    {
        
            $content = $_SESSION['revaluation_print'];
           
        $fileName = "Revaluation Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionRevaluationmarkentry()
    {
        $model = new Revaluation();
        $dummynumber = new DummyNumbers();
        $mark = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        if(Yii::$app->request->post())
        {
            $cat_reval_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'revaluation%'")->queryScalar();
            $batch_id = DummyNumbers::find()->where(['dummy_number'=>$_POST['dummy_num']])->One();
            $stu_map_id = $batch_id['student_map_id'];

                $cia = $_POST["cia"];                
                $pre_ese = $_POST["oldese"];
                $reval_ese = $_POST["newese100"];
                //Mark Entry
                
                if (isset($_POST["newese100"]) && $_POST["newese100"] != "" && !empty($_POST["newese100"])) {
                    $reval_ese100 = $_POST["newese100"];
                } else {
                    Yii::$app->ShowFlashMessages->setMsg('Error', 'Please enter revaluation ESE mark');
                    return $this->render('revaluationmarkentry', [
                        'model' => $model,
                        'dummynumber' => $dummynumber,
                    ]);
                }
                $year = Yii::$app->request->post('reval_entry_year');
                $month = Yii::$app->request->post('reval_entry_month');
                $term = Yii::$app->request->post('term');
                $total = $_POST["newtotal"];
                $result = $_POST["newresult"];
                $updated_by = Yii::$app->user->getId();
                $updated_at = new \yii\db\Expression('NOW()');
                $mark->student_map_id = $stu_map_id;
                $mark->subject_map_id = $_POST["sub_code"];
                $mark->category_type_id = $cat_reval_id;
                $mark->category_type_id_marks = $reval_ese;   
                $mark->year = Yii::$app->request->post('reval_entry_year');
                $mark->month = Yii::$app->request->post('reval_entry_month');
                $mark->term = Yii::$app->request->post('term');
                $mark->mark_type = Yii::$app->request->post('marktype');
                $mark->status_id = 0;        
                $mark->created_by = $updated_by;
                $mark->created_at = $updated_at;
                $mark->updated_by = $updated_by;
                $mark->updated_at = $updated_at;

                $get_stu_rev = Revaluation::find()->where(['year'=>$year,'month'=>$month,'student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code'],'reval_status'=>'YES'])->one();

                $stu_mark_data = Yii::$app->db->createCommand("select * from coe_mark_entry_master where student_map_id='".$stu_map_id."' AND subject_map_id='".$_POST['sub_code']."' and year='".$year."' and month='".$month."' and mark_type='".$get_stu_rev['mark_type']."' ")->queryOne();

                $get_sub_info = Yii::$app->db->createCommand('SELECT * FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE coe_subjects_mapping_id="'.$_POST['sub_code'].'"  ')->queryOne();

                    $ese_marks = round($reval_ese*$get_sub_info['ESE_max']/100);
                    $status_check = $ese_marks<=$get_sub_info['ESE_max'] ? 'YES' : 'NO'; 
                    $total_marks = $ese_marks+$stu_mark_data['CIA'];
                    $grade_cia_check = $stu_mark_data['CIA'];
                    $batchMapping = CoeBatDegReg::findOne($get_sub_info['batch_mapping_id']);
                    $grade_details = Regulation::find()->where(['regulation_year'=>$batchMapping['regulation_year']])->all();

                    $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    
                    $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $_POST['sub_code'] . '" AND student_map_id="' . $stu_map_id. '" AND result not like "%pass%" ')->queryScalar();

                        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                      $final_sub_total = $get_sub_info['ESE_max']+$get_sub_info['CIA_max'];
                      $arts_college_grade = 'NO';
                      if($org_email=='coe@skasc.ac.in')
                      {
                        $convert_ese_marks =  $ese_marks;
                        $insert_total = $ese_marks+$grade_cia_check;
                        if($final_sub_total<100)
                        {
                          $total_marks = round(round((($insert_total/$final_sub_total)*10),1)*10);
                        }
                        else
                        {
                          $total_marks = $ese_marks+$grade_cia_check;
                        }
                        $arts_college_grade = round(($insert_total/$final_sub_total)*10,1);

                      }
                      else if ($check_attempt > $config_attempt) {
                          $ese_marks =  $reval_ese100;
                          $total_marks = $reval_ese100;
                      }

                      foreach ($grade_details as $value) 
                      {
                          if($value['grade_point_to']!='')
                          {                            
                              if($total_marks >= $value['grade_point_from'] &&  $total_marks <= $value['grade_point_to'] )
                              {
                                  if($grade_cia_check<$get_sub_info['CIA_min'] || $ese_marks<$get_sub_info['ESE_min'] || $total_marks<$get_sub_info['total_minimum_pass'])
                                  {
                                    $stu_result_data = ['result'=>'Fail','total_marks'=>$total_marks,'grade_name'=>'RA','grade_point'=>0,'year_of_passing'=>'','ese_marks'=>$ese_marks];        
                                  }      
                                  else
                                  {
                                    $grade_name_prit = $value['grade_name'];
                                    $grade_point_arts = $org_email=='coe@skasc.ac.in' ? $arts_college_grade : $value['grade_point'];;
                                    if(!empty($_POST['reval_entry_month']) && !empty($_POST['reval_entry_year']))
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    else
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    
                                  }
                              } // Grade Point Caluclation
                          } // Not Empty of the Grade Point                               
                      }
                
                if ($check_attempt > $config_attempt && $org_email!='coe@skasc.ac.in') {
                          $grade_cia_check =  0;
                      }

                $year_of_passing = ($stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS") ? $_POST['reval_entry_month'] . "-" . $_POST['reval_entry_year']: '';

                $check_exists = MarkEntry::find()->where(['student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST["sub_code"],'category_type_id'=>$cat_reval_id,'year'=>Yii::$app->request->post('reval_entry_year'),'month'=>Yii::$app->request->post('reval_entry_month'),'term'=>Yii::$app->request->post('term'),'mark_type'=>Yii::$app->request->post('marktype')])->all();

                if (empty($check_exists) && $mark->save(false) && $reval_ese > $pre_ese) 
                {
                    //// TRCKING CODE STARTS //////

                     $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                      $data_updated = 'Revaluation Mark Entry';
                     $data_array = ['subject_map_id'=>$_POST['sub_code'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$_POST['reval_entry_month'],'exam_year'=>$_POST['reval_entry_year'],'student_map_id'=>$stu_map_id ];            
                      $update_track = ConfigUtilities::updateTracker($data_array);

                    //// TRCKING CODE ENDS //////

                    Yii::$app->db->createCommand("update coe_mark_entry_master set CIA='".$grade_cia_check."',ESE='" . $stu_result_data['ese_marks'] . "',total='" . $stu_result_data['total_marks'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',result='" . $stu_result_data['result'] . "',grade_point='" . $stu_result_data['grade_point'] . "',grade_name='" . $stu_result_data['grade_name']. "',year_of_passing='" . $year_of_passing . "' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $_POST['sub_code'] . "' and year='" . $_POST['reval_entry_year'] . "' and month='" . $_POST['reval_entry_month'] . "' and mark_type='".Yii::$app->request->post('marktype')."' and term='".Yii::$app->request->post('term')."' ")->execute();
                    Yii::$app->ShowFlashMessages->setMsg('Success', 'Revaluation Details Updated Successfully!!');
                        return $this->render('revaluationmarkentry', [
                            'model' => $model,
                            'dummynumber' => $dummynumber,
                    ]);
                }
                else
                {
                    Yii::$app->ShowFlashMessages->setMsg('Error', 'Nothing has been changed');
                        return $this->render('revaluationmarkentry', [
                            'model' => $model,
                            'dummynumber' => $dummynumber,
                    ]);
                }
              
        }
        else
        {
             Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Revaluation Mark Entry');
                return $this->render('revaluationmarkentry', [
                    'model' => $model,
                    'dummynumber' => $dummynumber,
                ]);
        }
       
    }
    public function actionRevaluationmarkentryview()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $dummy_number = Yii::$app->request->post('dummy_number');
        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
        $cat_mod_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'moderation%'")->queryScalar();
        $cat_rev_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'revaluation%'")->queryScalar();
        $cat_ese_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%ESE'")->queryScalar(); 
        $cat_dummy_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%ESE(Dummy)'")->queryScalar();
        
        $stu_mark = Yii::$app->db->createCommand("select A.subject_code,A.subject_name,E.cia,E.grade_point,E.grade_name,C.student_map_id,B.coe_subjects_mapping_id,A.ESE_max,A.ESE_min,A.total_minimum_pass,A.coe_subjects_id,E.term,E.mark_type from coe_subjects as A,coe_subjects_mapping as B,coe_dummy_number as C,coe_revaluation as D,coe_mark_entry_master as E where A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=C.subject_map_id and C.student_map_id=D.student_map_id and C.subject_map_id=D.subject_map_id and D.subject_map_id=E.subject_map_id and D.student_map_id=E.student_map_id and E.year='" . $year . "' and E.month='" . $month . "' and D.reval_status='YES' and D.is_transparency='S' and C.dummy_number='" . $dummy_number . "'")->queryOne();
        
        $previous_ese_100 = Yii::$app->db->createCommand("select * from coe_mark_entry where student_map_id='" . $stu_mark['student_map_id'] . "' and category_type_id IN ('" . $cat_ese_mark_type . "','".$cat_dummy_mark_type."') and subject_map_id='" . $stu_mark['coe_subjects_mapping_id'] . "'  and year='".$year."' and month='".$month."' ")->queryOne();

        
        $revaluation_ese_100 = Yii::$app->db->createCommand("select * from coe_mark_entry where student_map_id='" . $stu_mark['student_map_id'] . "' and category_type_id='" . $cat_rev_mark_type . "' and subject_map_id='" . $stu_mark['coe_subjects_mapping_id'] . "'  and year='".$year."' and month='".$month."' ")->queryOne();
        $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' .$stu_mark['coe_subjects_mapping_id'] . '" AND student_map_id="' . $stu_mark['student_map_id']. '"  ')->queryScalar(); 
        if ($check_attempt >= $config_attempt) 
        {
            $pre_ese = $previous_ese_100['category_type_id_marks']; 
            $reval_ese = $revaluation_ese_100['category_type_id_marks'];
            $pre_total = $stu_mark['cia'] + $pre_ese;
            if ($pre_ese >= $stu_mark['ESE_min'] && $pre_total >= $stu_mark['total_minimum_pass']) {
                $pre_result = "Pass";
            } else {
                $pre_result = "Fail";
            }
        }
        else {
             
             $pre_ese = round(($previous_ese_100['category_type_id_marks'] / 100) * $stu_mark['ESE_max']);
            
            $pre_total = $stu_mark['cia'] + $pre_ese;
            if ($pre_ese >= $stu_mark['ESE_min'] && $pre_total >= $stu_mark['total_minimum_pass']) {
                $pre_result = "Pass";
            } else {
                $pre_result = "Fail";
            }
            $reval_ese = round(($revaluation_ese_100['category_type_id_marks'] / 100) * $stu_mark['ESE_max']);
        } 
        $reval_total = $stu_mark['cia'] + $reval_ese;
        if ($reval_ese >= $stu_mark['ESE_min'] && $reval_total >= $stu_mark['total_minimum_pass']) {
            $reval_result = "Pass";
        } else {
            $reval_result = "Fail";
        }
        if ($pre_ese >= $reval_ese) {
            $total = $pre_total;
            $result = $pre_result;
        } else {
            $total = $reval_total;
            $result = $reval_result;
        }
        //echo $total;exit;
        $check_rev_done = Yii::$app->db->createCommand("select * from coe_mark_entry where student_map_id='" . $stu_mark['student_map_id'] . "' and subject_map_id='" . $stu_mark['coe_subjects_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and category_type_id='" . $cat_rev_mark_type . "' ")->queryOne();
        $table = '';
        $sn = 1;
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        if (!empty($stu_mark)) {
            $table .= '<table id="checkAllFeat" class="table table-striped" align="right" border=1>     
                       <thead id="t_head">                                                                                                               
                        <th> S.NO </th> 
                        <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </th>
                        <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </th>  
                        <th> CIA </th>
                        <th> Previous ESE </th>
                        <th> Previous Total </th>
                        <th> Previous Result </th>';
            $table .= '   <th> Reval ESE </br> out of 100</th>
                        <th> Reval ESE </th>
                        <th> Reval Total </th>
                        <th> Reval Result </th>
                        <th> Grade </th>
                        </thead><tbody>';
            $table .= "<tr>" .
                "<td><input type='hidden' id=sn name='sn' value=" . $sn . ">" . $sn . "</td> " .
                "<td><input type='hidden' id='sub_map_id_val' name='sub_code' value='" . $stu_mark['coe_subjects_mapping_id'] . "' >" . $stu_mark['subject_code'] . "</td>" .
                "<td><input type='hidden' name='sub_name' value='" . $stu_mark['coe_subjects_id'] . "'>" . $stu_mark['subject_name'] . "</td>" .
                "<td><input type='hidden' id=cia name='cia' value='" . $stu_mark['cia'] . "'>" . $stu_mark['cia'] . "</td>" .
                "<td><input type='hidden' id=oldese name='oldese' value='" . $previous_ese_100['category_type_id_marks'] . "'>" . $pre_ese . "</td>" .
                "<td><input type='hidden' id=oldtotal name='oldtotal' value='" . $pre_total . "' size='2px'>" . $pre_total . "</td>" .
                "<td><input type='hidden' id=oldresult name='oldresult' value='" . $pre_result . "'>" . $pre_result . "</td>";
            $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    
             $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' .$stu_mark['coe_subjects_mapping_id'] . '" AND student_map_id="' . $stu_mark['student_map_id']. '" AND result not like "%pass%" ')->queryScalar();
             
             $change_func = $check_attempt > $config_attempt ? 'reval_mark_eseAllAttempts(this.id)' : 'reval_mark_ese(this.id)' ;

            if (!empty($check_rev_done)) 
            {    
                $table .=
                "<td><input type='text' id=newese100 name=newese100 size='3px' readonly onchange='".$change_func."' value='" . $revaluation_ese_100['category_type_id_marks'] . "'></td>" .
                "<td><input type='text' id=newese name=newese readonly size='3px' value='" . $reval_ese . "'></td>" .
                "<td><input type='text' id=newtotal name=newtotal readonly size='3px' value='" . $total . "'></td>" .
                "<td><input type='text' id=newresult name=newresult readonly size='3px' value='" . $result . "'></td>".
                "<td><input type='text' id=newgrade name='newgrade' size='8px' value=".$stu_mark['grade_name']." readonly></td>";
                           
                
            } else {
               
                $table .=
                    "<td><input type='text' class='newese100' id=newese100 name=newese100 size='3px'  onchange='".$change_func."' title='Enter Numbers only' pattern='\d*'></td>" .
                    "<td><input type='text' id=newese name='newese' size='3px' readonly></td>" .
                    "<td><input type='text' id=newtotal name='newtotal' size='3px' readonly></td>" .
                    "<td><input type='text' id=newresult name='newresult' size='3px' readonly></td>" .
                    "<td><input type='text' id=newgrade name='newgrade' size='8px' readonly></td>";
            }
            $table .= "  <input type='hidden' id=esemin name='esemin' value=" . $stu_mark['ESE_min'] . ">
                        <input type='hidden' id=esemax name='esemax' value=" . $stu_mark['ESE_max'] . ">
                        <input type='hidden' id=totalmin name='totalmin' value=" . $stu_mark['total_minimum_pass'] . ">
                        <input type='hidden' id=term name='term' value=" . $stu_mark['term'] . ">
                        <input type='hidden' id=marktype name='marktype' value=" . $stu_mark['mark_type'] . ">";
            $table .= "</tr>";
            $table .= "</tbody></table>";
            $stu_mark_status = Yii::$app->db->createCommand("select * from coe_student as A,coe_student_mapping as B,coe_mark_entry_master as C  where B.coe_student_mapping_id='" . $stu_mark['student_map_id'] . "' and B.student_rel_id=A.coe_student_id and B.coe_student_mapping_id=C.student_map_id and C.student_map_id='" . $stu_mark['student_map_id'] . "' and C.year='" . $year . "' and C.month='" . $month . "' and A.student_status='Active' and status_category_type_id NOT IN('".$det_disc_type."') ")->queryOne();
            return $table;
        } else {
            return 0;
        }
    }
    //check external mark entered or not
    public function actionRevaluationmarkentrygrade()
    {
        $stu_map_id = DummyNumbers::find()->where(['dummy_number'=>$_POST['dummy_number']])->one();
        $sub_map_id = Yii::$app->request->post('sub_map_id');
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $cia = Yii::$app->request->post('cia');
        $newese = Yii::$app->request->post('newese');
        $oldese = Yii::$app->request->post('oldese');
        
        $result_calc = ConfigUtilities::StudentResult($stu_map_id['student_map_id'],$sub_map_id,$cia,$newese,$year,$month);
        $result_old_calc = ConfigUtilities::StudentResult($stu_map_id['student_map_id'],$sub_map_id,$cia,$oldese,$year,$month);

        if ($result_old_calc['grade_name'] <= $result_calc['grade_name']) {
            return "No Change";
        } else {
            return "Change";
        }
    }
    public function actionRevaluationstumarks()
    {
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $stu_reg_num = Yii::$app->request->post('stu_map_id'); 
        $mark_out_of = Yii::$app->request->post('mark_out_of'); 
        $out_of = $mark_out_of==1?100:'Maximum';
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $stu_map_id = Yii::$app->db->createCommand("select coe_student_mapping_id from coe_student_mapping as A JOIN coe_student as B ON A.student_rel_id=B.coe_student_id where B.register_number='".$stu_reg_num."' and status_category_type_id NOT IN('".$det_disc_type."') ")->queryScalar();

        $cat_mod_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%moderation%'")->queryScalar();
        $cat_rev_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%revaluation%'")->queryScalar();
        $cat_ese_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like 'ese%'")->queryScalar();

        $cat_ese_dum_mark_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%ESE(Dummy)%'")->queryScalar();

        $mod_mark_entry_id = Yii::$app->db->createCommand("select subject_map_id from coe_mark_entry where student_map_id='" . $stu_map_id . "' and category_type_id='" . $cat_mod_mark_type . "'")->queryAll();
        $mod_mark_entry_id_concate = '';
        foreach ($mod_mark_entry_id as $mod_mark_entry_id1) {
            $mod_mark_entry_id_concate .= "'" . $mod_mark_entry_id1['subject_map_id'] . "',";
        }
        $mod_mark_entry_id_concate = trim($mod_mark_entry_id_concate, ",");
        $append_query = isset($mod_mark_entry_id_concate) && !empty($mod_mark_entry_id_concate) ? "and C.subject_map_id not in(" . $mod_mark_entry_id_concate . ") group by C.subject_map_id " : "  group by C.subject_map_id ";

        $stu_mark_id = Yii::$app->db->createCommand("select A.coe_subjects_id,A.subject_code,A.subject_name,C.subject_map_id,A.ESE_min,A.ESE_max,A.total_minimum_pass,C.CIA,C.ESE,C.total,C.result,C.student_map_id,C.grade_point,C.grade_name FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_mark_entry_master as C ON C.subject_map_id=B.coe_subjects_mapping_id JOIN coe_student_mapping as D ON D.coe_student_mapping_id=C.student_map_id and D.course_batch_mapping_id=B.batch_mapping_id JOIN coe_revaluation as E ON E.student_map_id=C.student_map_id and E.subject_map_id=C.subject_map_id where E.student_map_id='" . $stu_map_id . "' and E.reval_status='YES' and status_category_type_id NOT IN('".$det_disc_type."') and E.year='" . $year . "' and E.month='" . $month . "'" . $append_query)->queryAll();
       
        $table = '';
        $sn = 1;
       
            if (count($stu_mark_id) > 0) 
            {
                $table .= '<table id="checkAllFeat" class="table table-striped" align="right" border=1>     
                           <thead id="t_head">                                                                                                               
                            <th> S.NO </th> 
                            <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </th>
                            <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </th>  
                            <th> CIA </th>
                            <th> Previous ESE </th>
                            <th> Previous Total </th>
                            <th> Previous Result </th>';
                $table .= ' <th> Reval ESE </br> out of '.$out_of.'</th>
                            <th> Reval ESE </th>
                            <th> Reval Total </th>
                            <th> Reval Result </th>
                            </thead><tbody>';
                
                $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
                foreach ($stu_mark_id as $stu_mark_id1) 
                {
                    $previous_ese_100 = Yii::$app->db->createCommand("select * from coe_mark_entry where student_map_id='" . $stu_mark_id1['student_map_id'] . "' and category_type_id IN('" . $cat_ese_mark_type . "','" . $cat_ese_dum_mark_type . "') and subject_map_id='" . $stu_mark_id1['subject_map_id'] . "' and year='".$year."' and month='".$month."'")->queryOne();
                    $pre_ese =$previous_ese_100['category_type_id_marks'];

                     $check_rev_done = Yii::$app->db->createCommand("select * from coe_mark_entry where student_map_id='" . $stu_mark_id1['student_map_id'] . "' and subject_map_id='" . $stu_mark_id1['subject_map_id'] . "' and year='" . $year . "' and month='" . $month . "' and category_type_id='" . $cat_rev_mark_type . "' ")->queryOne();

                    $checkGetDum = Yii::$app->db->createCommand("select * from coe_dummy_number where student_map_id='" . $stu_mark_id1['student_map_id'] . "' and subject_map_id='" . $stu_mark_id1['subject_map_id'] . "' and year='" . $year . "' and month='" . $month . "' ")->queryOne();
                    $print_dum = !empty($checkGetDum)?$checkGetDum['dummy_number']:'NO DATA';
                    $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    
                      $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $stu_mark_id1['subject_map_id'] . '" AND student_map_id="' . $stu_mark_id1['student_map_id']. '" AND result not like "%pass%" ')->queryScalar();
                      $get_sub_info = Yii::$app->db->createCommand('SELECT * FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE coe_subjects_mapping_id="'.$stu_mark_id1['subject_map_id'].'"  ')->queryOne();
                    require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                      $final_sub_total = $get_sub_info['ESE_max']+$get_sub_info['CIA_max'];
                      $ese_marks = round($pre_ese*$get_sub_info['ESE_max']/100);
                        $status_check = $ese_marks<=$get_sub_info['ESE_max'] ? 'YES' : 'NO'; 
                        $total_marks = $ese_marks+$stu_mark_id1['CIA'];
                        $grade_cia_check = $stu_mark_id1['CIA'];

                      $arts_college_grade = 'NO';
                      if($org_email=='coe@skasc.ac.in')
                      {
                        $ese_marks =  $pre_ese;
                        $insert_total = $ese_marks+$grade_cia_check;
                        if($final_sub_total<100)
                        {
                          $total_marks = round(round((($insert_total/$final_sub_total)*10),1)*10);
                        }
                        else
                        {
                          $total_marks = $ese_marks+$grade_cia_check;
                        }
                        $arts_college_grade = round(($insert_total/$final_sub_total)*10,1);
                      }
                      else if ($check_attempt > $config_attempt) {
                          $ese_marks =  $pre_ese;
                          $total_marks = $pre_ese;
                      }

                      if ($check_attempt > $config_attempt && $org_email!='coe@skasc.ac.in') {
                          $grade_cia_check =  0;
                      }
                      else
                      {
                        $grade_cia_check = $stu_mark_id1['CIA'];
                      }

                      $pre_total = $grade_cia_check + $ese_marks;
                    
                    if ($ese_marks >= $stu_mark_id1['ESE_min'] && $pre_total >= $stu_mark_id1['total_minimum_pass']) {
                        $pre_result = "Pass";
                    } else {
                        $pre_result = "Fail";
                    }

                    $table .= "<tr>" .
                        "<td><input type='hidden' id=sn_" . $sn . " name='sn' value=" . $sn . ">" . $sn . "</td> " .
                        "<td><input type='hidden' name=sub_code" . $sn . " value='" . $stu_mark_id1['subject_map_id'] . "'>" . $stu_mark_id1['subject_code'] . "</td>" .
                        "<td><input type='hidden' name=sub_name" . $sn . " value='" . $stu_mark_id1['coe_subjects_id'] . "'>" . $stu_mark_id1['subject_name'] . "</td>" .
                        "<td><input type='hidden' id=cia_" . $sn . " name=cia" . $sn . " value='" . $grade_cia_check . "'>" . $grade_cia_check . "</td>" .
                        "<td><input type='hidden' id=oldese_" . $sn . " name=oldese" . $sn . " value='" . $ese_marks . "'>" . $ese_marks . "</td>" .
                        "<td><input type='hidden' id=oldtotal_" . $sn . " name=oldtotal" . $sn . " value='" . $pre_total . "' size='2px'>" . $pre_total . "</td>" .
                        "<td><input type='hidden' id=oldresult_" . $sn . " name=oldresult" . $sn . " value='" . $pre_result . "'>" . $pre_result . "</td>";

                    $change_func = $check_attempt > $config_attempt ? 'revaluation_esetotalAttemptreg(this.id)' : 'revaluation_esereg(this.id)' ;
                    

                    $table .= "<input type='hidden' id=esemin_" . $sn . " value='" . $stu_mark_id1['ESE_min'] . "'>";
                        $table .= "<input type='hidden' id=esemax_" . $sn . " value='" . $stu_mark_id1['ESE_max'] . "'>";
                        $table .= "<input type='hidden' id=totalmin_" . $sn . " value='" . $stu_mark_id1['total_minimum_pass'] . "'>";

                        $table .= "<input type='hidden' name=esemin" . $sn . " value='" . $stu_mark_id1['ESE_min'] . "'>";
                        $table .= "<input type='hidden' name=esemax" . $sn . " value='" . $stu_mark_id1['ESE_max'] . "'>";
                        $table .= "<input type='hidden' name=totalmin" . $sn . " value='" . $stu_mark_id1['total_minimum_pass'] . "'>";
                    if (count($check_rev_done) > 0 && !empty($check_rev_done)) 
                    {
                        $check_rev_master_done = Yii::$app->db->createCommand("select * from coe_mark_entry_master where student_map_id='" . $stu_mark_id1['student_map_id'] . "' and subject_map_id='" . $stu_mark_id1['subject_map_id'] . "' and year='" . $year . "' and month='" . $month . "' and mark_type='" . $check_rev_done['mark_type'] . "' and term='".$check_rev_done['term']."' ")->queryOne();
                        $stu_res_dat = ConfigUtilities::StudentResult($stu_mark_id1['student_map_id'],$stu_mark_id1['subject_map_id'],$stu_mark_id1['CIA'] ,$check_rev_done['category_type_id_marks'],$year,$month );
                        if($checkAccess=='Yes')
                        {
                            $table .=
                            "<td><input type='text' required id=newese100_" . $sn . " name=newese100" . $sn . " size='3px'  onkeypress='numbersOnly(event); autocomplete='off' allowEntr(event,this.id);'  onchange='".$change_func."' value='" . $check_rev_done['category_type_id_marks'] . "'></td>" .
                            "<td><input type='text' required id=newese_" . $sn . " name=newese" . $sn . " readonly size='3px' value='" . $stu_res_dat['ese_marks'] . "' ></td>" .
                            "<td><input type='text' required id=newtotal_" . $sn . " name=newtotal" . $sn . " readonly size='3px' value='" . $stu_res_dat['total_marks'] . "' ></td>" .
                            "<td><input type='text' required id=newresult_" . $sn . " name=newresult" . $sn . " readonly size='3px' value='" . $stu_res_dat['result'] . "' ></td>";
                        }
                        else
                        {
                            $table .=
                            "<td><input type='text' required id=newese100_" . $sn . " name=newese100" . $sn . " size='3px'  readonly  value='" . $check_rev_done['category_type_id_marks'] . "'></td>" .
                            "<td><input type='text' required id=newese_" . $sn . " name=newese" . $sn . " readonly size='3px' value='" . $stu_res_dat['ese_marks'] . "' ></td>" .
                            "<td><input type='text' required id=newtotal_" . $sn . " name=newtotal" . $sn . " readonly size='3px' value='" . $stu_res_dat['total_marks'] . "' ></td>" .
                            "<td><input type='text' required id=newresult_" . $sn . " name=newresult" . $sn . " readonly size='3px' value='" . $stu_res_dat['result'] . "' ></td>";
                        }
                        
                       
                    } else {
                        
                        $table .=
                            "<td><input required type='text' id=newese100_" . $sn . " name=newese100" . $sn . " size='3px' onkeypress='numbersOnly(event); autocomplete='off' allowEntr(event,this.id);'  onchange='".$change_func."' ></td>" .
                            "<td><input type='text' id=newese_" . $sn . " autocomplete='off' name=newese" . $sn . " readonly size='3px' ></td>" .
                            "<td><input type='text' id=newtotal_" . $sn . " autocomplete='off' name=newtotal" . $sn . " readonly size='3px' ></td>" .
                            "<td><input type='text' id=newresult_" . $sn . " autocomplete='off' name=newresult" . $sn . " readonly size='3px' ></td>";
                    }
                    $table .= "</tr>";
                    $sn++;
                } // Foreach Ends Here
                $table .= "</tbody></table>";
                return $table;
            } 
            else 
            {
                return 0;
            }
        //check external mark entered or not
    }
    public function actionRevaluation()
    {
        $model = new MarkEntry();
        $student = new Student();
        $markentrymaster = new MarkEntryMaster();
        if(Yii::$app->request->post())
        {
            $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

            $sn = Yii::$app->request->post('sn');
            $stu_reg_num = Yii::$app->request->post('stu_reg_num');
            $stu_map_id_det = Yii::$app->db->createCommand("select * from coe_student_mapping as A JOIN coe_student as B ON A.student_rel_id=B.coe_student_id where B.register_number='".$stu_reg_num."' and status_category_type_id NOT IN('".$det_disc_type."') ")->queryOne(); 
            $stu_map_id = $stu_map_id_det['coe_student_mapping_id'];
            $batch_id = $stu_map_id_det['course_batch_mapping_id'];
            
            $cat_reval_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%revaluation%'")->queryScalar();

            for ($k = 1; $k <= $sn; $k++) 
            {
                $cia = $_POST['cia' . $k];
                if(isset($_POST['esemin' . $k]))
                {
                    $year = $_POST['reval_entry_year'];
                    $month = $_POST['reval_entry_month'];   
                    $get_stu_rev = Revaluation::find()->where(['year'=>$year,'month'=>$month,'student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code' . $k],'reval_status'=>'YES'])->one();

                    $ese_min = $_POST['esemin' . $k];
                    $pre_ese = $_POST['oldese' . $k];
                    $reval_ese100 = $_POST['newese100' . $k];
                    $reval_ese = $_POST['newese' . $k];
                    $total = $_POST['newtotal' . $k];
                    $result = $_POST['newresult' . $k];
                    $stu_mark_data = Yii::$app->db->createCommand("select * from coe_mark_entry_master where student_map_id='".$stu_map_id."' AND subject_map_id='".$_POST['sub_code' . $k]."' and year='".$year."' and month='".$month."' and mark_type='".$get_stu_rev['mark_type']."' ")->queryOne();                    
                    $updated_by = Yii::$app->user->getId();
                    $updated_at = new \yii\db\Expression('NOW()');
                    $model->student_map_id = $stu_map_id;
                    $model->subject_map_id = $_POST['sub_code' . $k];
                    $model->category_type_id = $cat_reval_id;    
                    $model->category_type_id_marks = $reval_ese100;
                    $model->year = $year;
                    $model->month = $month;
                    $model->term = $stu_mark_data['term'];
                    $model->mark_type = $stu_mark_data['mark_type'];
                    $model->status_id = 0;
                    $model->created_by = $updated_by;
                    $model->created_at = $updated_at;
                    $model->updated_by = $updated_by;
                    $model->updated_at = $updated_at;

                    $get_sub_info = Yii::$app->db->createCommand('SELECT * FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE coe_subjects_mapping_id="'.$_POST['sub_code' . $k].'"  ')->queryOne();

                    $ese_marks = round($reval_ese100*$get_sub_info['ESE_max']/100);
                    $status_check = $ese_marks<=$get_sub_info['ESE_max'] ? 'YES' : 'NO'; 
                    $total_marks = $ese_marks+$stu_mark_data['CIA'];
                    $grade_cia_check = $stu_mark_data['CIA'];
                    $batchMapping = CoeBatDegReg::findOne($get_sub_info['batch_mapping_id']);
                    $grade_details = Regulation::find()->where(['regulation_year'=>$batchMapping['regulation_year']])->all();

                        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                      $final_sub_total = $get_sub_info['ESE_max']+$get_sub_info['CIA_max'];
                      $arts_college_grade = 'NO';

                      $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    
                      $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $_POST['sub_code' . $k] . '" AND student_map_id="' . $stu_map_id. '" AND result not like "%pass%"')->queryScalar();

                      if($org_email=='coe@skasc.ac.in')
                      {
                        $convert_ese_marks =  $ese_marks;
                        $insert_total = $ese_marks+$grade_cia_check;
                        if($final_sub_total<100)
                        {
                          $total_marks = round(round((($insert_total/$final_sub_total)*10),1)*10);
                        }
                        else
                        {
                          $total_marks = $ese_marks+$grade_cia_check;
                        }
                        $arts_college_grade = round(($insert_total/$final_sub_total)*10,1);

                      }
                      else if ($check_attempt > $config_attempt) {
                          $ese_marks =  $reval_ese100;
                          $total_marks = $reval_ese100;
                      }

                      foreach ($grade_details as $value) 
                      {
                          if($value['grade_point_to']!='')
                          {                            
                              if($total_marks >= $value['grade_point_from'] &&  $total_marks <= $value['grade_point_to'] )
                              {
                                  if($grade_cia_check<$get_sub_info['CIA_min'] || $ese_marks<$get_sub_info['ESE_min'] || $total_marks<$get_sub_info['total_minimum_pass'])
                                  {
                                    $stu_result_data = ['result'=>'Fail','total_marks'=>$total_marks,'grade_name'=>'RA','grade_point'=>0,'year_of_passing'=>'','ese_marks'=>$ese_marks];        
                                  }      
                                  else
                                  {
                                    $grade_name_prit = $value['grade_name'];
                                    $grade_point_arts = $org_email=='coe@skasc.ac.in' ? $arts_college_grade : $value['grade_point'];;
                                    if(!empty($_POST['reval_entry_month']) && !empty($_POST['reval_entry_year']))
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    else
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    
                                  }
                              } // Grade Point Caluclation
                          } // Not Empty of the Grade Point                               
                      }
                     if ($check_attempt > $config_attempt && $org_email!='coe@skasc.ac.in') {
                          $grade_cia_check =  0;
                      }         
                    $year_of_passing = ($stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS") ? $_POST['reval_entry_month'] . "-" . $_POST['reval_entry_year']: '';

                    $checkMasrksAvail = MarkEntry::find()->where(['student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code' . $k],'year'=>$year,'month'=>$month,'category_type_id'=>$cat_reval_id,'mark_type'=>$stu_mark_data['mark_type']])->one();

                    if( empty($checkMasrksAvail) && $status_check=='YES' && $model->save(false) && $reval_ese100>$pre_ese)
                    {
                       //// TRCKING CODE STARTS //////

                         $getMarksdata = MarkEntryMaster::find()->where(['subject_map_id'=>$_POST['sub_code' . $k],'student_map_id'=>$stu_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$stu_mark_data['mark_type'],'term'=>$stu_mark_data['term'] ])->one();

                     $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                      $data_updated = 'Revaluation Mark Entry Prev ESE : '.$getMarksdata['ESE'].' NEW ESE '.$stu_result_data['ese_marks'];
                     $data_array = ['subject_map_id'=>$_POST['sub_code' . $k],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                      $update_track = ConfigUtilities::updateTracker($data_array);

                    //// TRCKING CODE ENDS //////

                        Yii::$app->db->createCommand("update coe_mark_entry_master set CIA='".$grade_cia_check."', ESE='" . $stu_result_data['ese_marks'] . "',total='" . $stu_result_data['total_marks'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',result='" . $stu_result_data['result'] . "',grade_point='" . $stu_result_data['grade_point'] . "',grade_name='" . $stu_result_data['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $year . "' and month='" . $month . "' and term='".$stu_mark_data['term']."' and mark_type='".$stu_mark_data['mark_type']."'")->execute();                        
                    }
                    else if(!empty($checkMasrksAvail))
                    {

                        //// TRCKING CODE STARTS //////

                         $getMarksEntdata = MarkEntry::find()->where(['subject_map_id'=>$_POST['sub_code' . $k],'student_map_id'=>$stu_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$stu_mark_data['mark_type'],'term'=>$stu_mark_data['term'] ])->andWHere(['IN','category_type_id',[49,67]])->one();

                     $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                      $data_updated = 'Revaluation Mark Entry Prev ESE OUT OF 100 : '.$getMarksEntdata['category_type_id_marks'].' NEW ESE ESE OUT OF 100  '.$reval_ese100;
                     $data_array = ['subject_map_id'=>$_POST['sub_code' . $k],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                      $update_track = ConfigUtilities::updateTracker($data_array);

                    //// TRCKING CODE ENDS //////

                        $mark_entry_update = Yii::$app->db->createCommand("update coe_mark_entry set category_type_id_marks='".$reval_ese100."' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $year . "' and month='" . $month . "' and term='".$stu_mark_data['term']."' and mark_type='".$stu_mark_data['mark_type']."' and category_type_id ='".$cat_reval_id."' ")->execute();   

                        //// TRCKING CODE STARTS //////

                         $getMarksdata = MarkEntryMaster::find()->where(['subject_map_id'=>$_POST['sub_code' . $k],'student_map_id'=>$stu_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$stu_mark_data['mark_type'],'term'=>$stu_mark_data['term'] ])->one();

                         $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                          $data_updated = 'Revaluation Mark Entry Prev ESE : '.$getMarksdata['ESE'].' NEW ESE '.$stu_result_data['ese_marks'];
                         $data_array = ['subject_map_id'=>$_POST['sub_code' . $k],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                          $update_track = ConfigUtilities::updateTracker($data_array);

                        //// TRCKING CODE ENDS //////

                        Yii::$app->db->createCommand("update coe_mark_entry_master set CIA='".$grade_cia_check."', ESE='" . $stu_result_data['ese_marks'] . "',total='" . $stu_result_data['total_marks'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',result='" . $stu_result_data['result'] . "',grade_point='" . $stu_result_data['grade_point'] . "',grade_name='" . $stu_result_data['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $year . "' and month='" . $month . "' and term='".$stu_mark_data['term']."' and mark_type='".$stu_mark_data['mark_type']."'")->execute();   
                    }
                    else{
                        Yii::$app->ShowFlashMessages->setMsg('ERROR', 'NO DATA FOUND'); 
                    }    
                    unset($model);
                    $model = new MarkEntry();                    
                    
                }                
                
            } // For Loop Ends Here
            Yii::$app->ShowFlashMessages->setMsg('Success', 'Revaluation Marks Updated Successfully!!'); 
            return $this->render('revaluation', [
                'model' => $model,
                'student'=>$student,
            ]);
        }
        else
        {
            return $this->render('revaluation', [
                'model' => $model,
                'student'=>$student,
            ]);
        }
}

public function actionRevaluationSubjectEntry()
    {
        $model = new MarkEntry();
        $student = new Student();
        $markentrymaster = new MarkEntryMaster();
        if(Yii::$app->request->post())
        {
            $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $sn = Yii::$app->request->post('sn');
            $cat_reval_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where description like '%revaluation%'")->queryScalar();

            for ($k = 1; $k <= $sn; $k++) 
            {
                if(isset($_POST['reg_nu' . $k]) && isset($_POST['esemin' . $k]))
                {
                    $stu_reg_num = $_POST['reg_nu' . $k];
                    $stu_map_id_det = StudentMapping::findOne($stu_reg_num); 
                    $stu_map_id = $stu_map_id_det['coe_student_mapping_id'];
                    $batch_id = $stu_map_id_det['course_batch_mapping_id'];
                    $cia = $_POST['cia' . $k];
                    $year = $_POST['reval_entry_year'];
                    $month = $_POST['reval_entry_month'];   
                    $get_stu_rev = Revaluation::find()->where(['year'=>$year,'month'=>$month,'student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code' . $k],'reval_status'=>'YES'])->one();

                    $ese_min = $_POST['esemin' . $k];
                    $pre_ese = $_POST['oldese' . $k];
                    $reval_ese100 = $_POST['newese100' . $k];
                    $reval_ese = $_POST['newese' . $k];
                    $total = $_POST['newtotal' . $k];
                    $result = $_POST['newresult' . $k];
                   
                    if(!empty($get_stu_rev))
                    {
                        $checkAlreadyUpdated = MarkEntryMaster::find()->where(['student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code' . $k],'year'=>$year,'month'=>$month,'mark_type'=>$get_stu_rev['mark_type']])->one();
                        
                        $updated_by = Yii::$app->user->getId();
                        $updated_at = new \yii\db\Expression('NOW()');
                        $model->student_map_id = $stu_map_id;
                        $model->subject_map_id = $_POST['sub_code' . $k];
                        $model->category_type_id = $cat_reval_id;    
                        $model->category_type_id_marks = $reval_ese100;
                        $model->year = $year;
                        $model->month = $month;
                        $model->term = $checkAlreadyUpdated['term'];
                        $model->mark_type = $checkAlreadyUpdated['mark_type'];
                        $model->status_id = 0;
                        $model->created_by = $updated_by;
                        $model->created_at = $updated_at;
                        $model->updated_by = $updated_by;
                        $model->updated_at = $updated_at;

                        $get_sub_info = Yii::$app->db->createCommand('SELECT * FROM coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id WHERE coe_subjects_mapping_id="'.$_POST['sub_code' . $k].'"  ')->queryOne();
                        $ese_marks = round($reval_ese100*$get_sub_info['ESE_max']/100);


                        $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
                    
                        $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $_POST['sub_code' . $k] . '" AND student_map_id="' . $stu_map_id. '" AND result not like "%pass%" ')->queryScalar();

                        $status_check = $ese_marks<=$get_sub_info['ESE_max'] ? 'YES' : 'NO'; 
                        $total_marks = $ese_marks+$checkAlreadyUpdated['CIA'];
                        $grade_cia_check = $checkAlreadyUpdated['CIA'];
                        $batchMapping = CoeBatDegReg::findOne($get_sub_info['batch_mapping_id']);
                        $grade_details = Regulation::find()->where(['regulation_year'=>$batchMapping['regulation_year']])->all();

                        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                      $final_sub_total = $get_sub_info['ESE_max']+$get_sub_info['CIA_max'];
                      $arts_college_grade = 'NO';

                      if ($check_attempt > $config_attempt) {
                          $ese_marks =  $reval_ese100;
                          $total_marks = $reval_ese100;
                      }
                      foreach ($grade_details as $value) 
                      {
                          if($value['grade_point_to']!='')
                          {                            
                              if($total_marks >= $value['grade_point_from'] &&  $total_marks <= $value['grade_point_to'] )
                              {
                                  if($grade_cia_check<$get_sub_info['CIA_min'] || $ese_marks<$get_sub_info['ESE_min'] || $total_marks<$get_sub_info['total_minimum_pass'])
                                  {
                                    $stu_result_data = ['result'=>'Fail','total_marks'=>$total_marks,'grade_name'=>'RA','grade_point'=>0,'year_of_passing'=>'','ese_marks'=>$ese_marks];        
                                  }      
                                  else
                                  {
                                    $grade_name_prit = $value['grade_name'];
                                    $grade_point_arts = $org_email=='coe@skasc.ac.in' ? $arts_college_grade : $value['grade_point'];;
                                    if(!empty($_POST['reval_entry_month']) && !empty($_POST['reval_entry_year']))
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    else
                                    {
                                        $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$month."-".$year];
                                    }
                                    
                                  }
                              } // Grade Point Caluclation
                          } // Not Empty of the Grade Point                               
                      }

                             
                        $year_of_passing = ($stu_result_data['result'] == "Pass" || $stu_result_data['result'] == "pass" || $stu_result_data['result'] == "PASS") ? $_POST['reval_entry_month'] . "-" . $_POST['reval_entry_year']: '';
                        $checkMasrksAvail = MarkEntry::find()->where(['student_map_id'=>$stu_map_id,'subject_map_id'=>$_POST['sub_code' . $k],'year'=>$year,'month'=>$month,'category_type_id'=>$cat_reval_id,'mark_type'=>$checkAlreadyUpdated['mark_type']])->one();
                        if( empty($checkMasrksAvail) && $status_check=='YES' && $model->save(false) && $reval_ese100>$pre_ese)
                        {
                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );

                              $data_updated = 'Revaluation : Prev ESE Marks : '.$checkAlreadyUpdated['ESE'].' New ESE Marks : '.$stu_result_data['ese_marks'].' Prev Total Marks : '.$checkAlreadyUpdated['total'].' New Total Marks: '.$stu_result_data['total_marks'];

                             $data_array = ['subject_map_id'=>$_POST['sub_code' . $k],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$stu_map_id ];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                            //// TRCKING CODE ENDS //////

                            Yii::$app->db->createCommand("update coe_mark_entry_master set CIA='".$grade_cia_check."', ESE='" . $stu_result_data['ese_marks'] . "',total='" . $stu_result_data['total_marks'] . "',updated_by='".$updated_by."',updated_at='".$updated_at."',result='" . $stu_result_data['result'] . "',grade_point='" . $stu_result_data['grade_point'] . "',grade_name='" . $stu_result_data['grade_name'] . "',year_of_passing='" . $year_of_passing . "' where student_map_id='" . $stu_map_id . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $year . "' and month='" . $month . "' and term='".$checkAlreadyUpdated['term']."' and mark_type='".$checkAlreadyUpdated['mark_type']."'")->execute();                        
                        }    
                        unset($model);
                        $model = new MarkEntry(); 
                    }
                    else
                    {
                        Yii::$app->ShowFlashMessages->setMsg('ERROR', 'NO DATA FOUND'); 
                    }
                }                
                
            } // For Loop Ends Here
            Yii::$app->ShowFlashMessages->setMsg('Success', 'Revaluation Marks Updated Successfully!!'); 
            return $this->render('revaluation-subject-entry', [
                'model' => $model,
                'student'=>$student,
            ]);
        }
        else
        {
            return $this->render('revaluation-subject-entry', [
                'model' => $model,
                'student'=>$student,
            ]);
        }
}
    /* Revaluation Ends Here */
    /**
     * Updates an existing MarkEntry model.
     * If update is successful, the browser will be redirected to the 'view' page.
     * @param integer $id
     * @return mixed
     */
    public function actionUpdate($id)
    {
        $model = $this->findModel($id);
        if ($model->load(Yii::$app->request->post()) && $model->save()) {
            return $this->redirect(['view', 'id' => $model->coe_mark_entry_id]);
        } else {
            return $this->render('update', [
                'model' => $model,
            ]);
        }
    }
    /**
     * Deletes an existing MarkEntry model.
     * If deletion is successful, the browser will be redirected to the 'index' page.
     * @param integer $id
     * @return mixed
     */
    public function actionDelete($id)
    {
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        if($checkAccess=='Yes')
        {
            $ese_cat_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR category_type like '%External%'")->queryScalar();
            
            $dummy_cat = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE(Dummy)%'")->queryScalar();

            $cia = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Internal%' OR category_type like '%CIA%' ")->queryScalar();
            $details = $this->findModel($id);   

            $getMArkentry = MarkEntryMaster::find()->where(['student_map_id'=>$details['student_map_id'],'subject_map_id'=>$details['subject_map_id']])->one();
            $getExtMArkentry = MarkEntryMaster::find()->where(['student_map_id'=>$details['student_map_id'],'subject_map_id'=>$details['subject_map_id'],'year'=>$details['year'],'month'=>$details['month'],'mark_type'=>$details['mark_type'],])->one();

            if($details['category_type_id']==$ese_cat_id)
            {
                Yii::$app->ShowFlashMessages->setMsg('Error','Use External Mark Entry Deletion to delete the Marks');
                return $this->redirect(['index']);
            }
            else
            {
                //// TRCKING CODE STARTS //////

                 $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );

                  $data_updated = 'Delete CIA Marks : '.$details['category_type_id_marks'];

                 $data_array = ['subject_map_id'=>$details['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$details['month'],'exam_year'=>$details['year'],'student_map_id'=>$details['student_map_id'] ];            
                  $update_track = ConfigUtilities::updateTracker($data_array);

                //// TRCKING CODE ENDS //////
                $this->findModel($id)->delete();
            }
            Yii::$app->ShowFlashMessages->setMsg('Success','Record Deleted Successfully!!!');
            return $this->redirect(['index']);
        }
        else
        {
            $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;

            //print_r(parse_url($url)); // This will returns the parts of the URL
            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
        $this->findModel($id)->delete();
        return $this->redirect(['index']);
    }
    /**
     * Finds the MarkEntry model based on its primary key value.
     * If the model is not found, a 404 HTTP exception will be thrown.
     * @param integer $id
     * @return MarkEntry the loaded model
     * @throws NotFoundHttpException if the model cannot be found
     */
    protected function findModel($id)
    {
        if (($model = MarkEntry::findOne($id)) !== null) {
            return $model;
        } else {
            throw new NotFoundHttpException('The requested page does not exist.');
        }
    }
    // Result Publish Starts here
    public function actionResultPublish()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $model = new MarkEntry();
        if ($model->load(Yii::$app->request->post())) {
            if (empty($_POST['bat_map_val']) && empty($model->month) && empty($model->year) && empty($_POST['exam_semester'])) {
                Yii::$app->ShowFlashMessages->setMsg('Error', 'Select the required Information');
                return $this->redirect(['mark-entry/result-publish']);
            }
            $sem = ConfigUtilities::semCaluclation($model->year, $model->month, $_POST['bat_map_val']);
            $exam_type = $sem == $_POST['exam_semester'] ? 'Regular' : 'Arrear';
            $cat_id = Categorytype::find()->where(['category_type' => $exam_type])->one();
            $section = $_POST['sec'] != 'All' ? $_POST['sec'] : '';
            $query = new Query();
            $query->select(['q.subject_map_id', 'q.student_map_id', 'a.name', 'a.register_number', 'concat(h.degree_code,".",h.degree_name) as degree_name', 'g.programme_code', 'k.semester', 'l.subject_name', 'l.subject_code', 'l.CIA_max', 'l.ESE_max', 'l.total_minimum_pass', 'l.end_semester_exam_value_mark', 'm.batch_name', 'q.year', 'q.CIA', 'q.ESE', 'q.total','q.withheld' ,'q.grade_point', 'q.grade_name', 'n.description as month', 'q.result'])
                ->from('coe_student a')
                ->join('JOIN', 'coe_student_mapping c', 'c.student_rel_id = a.coe_student_id')
                ->join('JOIN', 'coe_bat_deg_reg d', 'd.coe_bat_deg_reg_id = c.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree h', 'h.coe_degree_id = d.coe_degree_id')
                ->join('JOIN', 'coe_programme g', 'g.coe_programme_id = d.coe_programme_id')
                ->join('JOIN', 'coe_batch m', 'm.coe_batch_id = d.coe_batch_id')
                ->join('JOIN', 'coe_subjects_mapping k', 'k.batch_mapping_id = d.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_subjects l', 'l.coe_subjects_id = k.subject_id')
                ->join('JOIN', 'coe_mark_entry_master q', 'q.subject_map_id = k.coe_subjects_mapping_id and q.student_map_id=c.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type n', 'n.coe_category_type_id = q.month')
				->join('JOIN','coe_category_type xyz','xyz.coe_category_type_id = status_category_type_id')
                ->where(['c.course_batch_mapping_id' => $_POST['bat_map_val'], 'k.batch_mapping_id' => $_POST['bat_map_val'], 'k.semester' => $_POST['exam_semester'], 'q.year' => $model->year, 'q.month' => $model->month, 'q.mark_type' => $cat_id->coe_category_type_id, 'a.student_status' => 'Active']);
    //             ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
    //             ->andWhere(['<>', 'status_category_type_id', $det_disc_type])
				// ->andWhere(['NOT LIKE','xyz.description', 'Detain'])
    //             ->andWhere(['NOT LIKE','xyz.description', 'Discontinued']);
            if ($section != "") {
                $query->andWhere(['c.section_name' => $_POST['sec']]);
            }
            $query->groupBy('q.subject_map_id,q.student_map_id')
                ->orderBy('a.register_number,l.subject_code');
                //echo $query->createCommand()->getrawsql(); exit;
            $send_result = $query->createCommand()->queryAll();


            $query_man = new  Query();
            $query_man->select(['F.student_map_id','H.subject_code',  'A.name', 'A.register_number', 'H.subject_name','H.ESE_max', 'H.CIA_max', 'H.end_semester_exam_value_mark', 'K.description as month',  'F.year','F.subject_map_id','F.student_map_id', 'F.ESE','F.CIA', 'F.total','F.result','F.semester' ,'F.withheld','F.grade_name', 'F.grade_point', 'concat(degree_code,".",degree_name) as degree_name','E.programme_code','total_minimum_pass','batch_name'])
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], "F.semester" => $_POST['exam_semester'], 'F.year' => $model->year, 'F.month' => $model->month,'F.mark_type' => $cat_id->coe_category_type_id, 'A.student_status' => 'Active','is_additional'=>'NO']);
                // ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                // ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            if ($section != "") {
                $query_man->andWhere(['section_name' => $_POST['sec']]);
            }
            $query_man->groupBy('F.subject_map_id,F.student_map_id')
                ->orderBy('A.register_number,subject_code');               
            $mandatory_statement = $query_man->createCommand()->queryAll();

            if(!empty($mandatory_statement))
            {
                $send_result = array_merge($send_result,$mandatory_statement);
            }
            
            array_multisort(array_column($send_result, 'subject_code'),  SORT_ASC, $send_result);
            array_multisort(array_column($send_result, 'register_number'),  SORT_ASC, $send_result);

            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max, H.end_semester_exam_value_mark as total')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id')
				->join('JOIN','coe_category_type xyz','xyz.coe_category_type_id = status_category_type_id');
            $subject_get_data->Where(['F.year' => $model->year, 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'G.batch_mapping_id' => $_POST['bat_map_val'], 'G.semester' => $_POST['exam_semester'], 'F.month' => $model->month]);
							// ->andWhere(['NOT LIKE','xyz.description', 'Detain']);
            if ($section != "") {
                $subject_get_data->andWhere(['B.section_name' => $_POST['sec']]);
            }
            $subject_get_data->orderBy('H.subject_code');
            //echo $subject_get_data->createCommand()->getrawsql(); exit;
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();


            $query_man_subs = new  Query();
            $query_man_subs->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_max, H.end_semester_exam_value_mark as total')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man_subs->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.year' => $model->year, 'F.month' =>$model->month, 'A.student_status' => 'Active','F.semester'=>$_POST['exam_semester'],'is_additional'=>'NO']);
                //->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                //->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            if ($section != "") {
                $query_man_subs->andWhere(['section_name' => $_POST['sec']]);
            }
            $query_man_subs->orderBy('H.subject_code');
               
            $mandatory_subjects = $query_man_subs->createCommand()->queryAll();
            if(!empty($mandatory_subjects))
            {
                $subjectsInfo = array_merge($subjectsInfo,$mandatory_subjects);
            }            
            array_multisort(array_column($subjectsInfo, 'subject_code'),  SORT_ASC, $subjectsInfo);


            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['F.year' => $model->year, 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $model->month,'G.semester'=>$_POST['exam_semester']]);
            //->andWhere(['<>', 'status_category_type_id', $det_cat_type])
            //    ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            if ($section != "") {
                $countQuery->andWhere(['B.section_name' => $_POST['sec']]);
            }
            $countOfSubjects = $countQuery->createCommand()->queryAll();


            $query_man_count = new  Query();
            $query_man_count->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man_count->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.year' => $model->year, 'F.month' => $model->month, 'A.student_status' => 'Active','F.semester'=>$_POST['exam_semester'],'H.semester'=>$_POST['exam_semester']]);
                //->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                //->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            if ($section != "") 
            {
                $query_man_count->andWhere(['B.section_name' => $_POST['sec']]);
            }
            $query_man_count->groupBy('F.student_map_id,F.subject_map_id');
            $countOfManSubjects = $query_man_count->createCommand()->queryAll();
            if(!empty($countOfManSubjects))
            {
                $countOfSubjects = array_merge($countOfSubjects,$countOfManSubjects);
            }
            if (empty($send_result)) {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/result-publish']);
            }
            return $this->render('result-publish', [
                'model' => $model,
                'send_result' => $send_result,
                'countOfSubjects' => $countOfSubjects,
                'subjectsInfo' => $subjectsInfo,
                'sem'=>$sem,
            ]);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Result Publish');
            return $this->render('result-publish', [
                'model' => $model,
            ]);
        }
    }
    public function actionResultPublishPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        
      $content = $_SESSION['result_publish'];
          
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Result Publish.pdf',
            'format' => Pdf::FORMAT_LEGAL,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            //'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse; font-family:Helvetica Neue, Helvetica, Arial, sans-serif; width:100%; font-size: 16px !important;  }

                        table td table{border: none !important;}
                        table td{
                            white-space: nowrap;
                            font-size: 12px !important; 
                            border: 2px solid #CCC;
                            overflow: hidden;
                            text-overflow: ellipsis;
                             text-align: center;
                            
                           

                        }
                        table th{                           
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: left;
                        }
                       
                    }   
                ', 
            'options' => ['title' => 'Result Publish'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                
            ]
        ]);
        $pdf->marginTop = "6";
        $pdf->marginLeft = "16";
        $pdf->marginRight = "2";
        $pdf->marginBottom = "2";
        $pdf->marginHeader = "2";
        $pdf->marginFooter = "4";
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelResultPublish()
    {
        
            $content = $_SESSION['result_publish'];
            
        $fileName = "Result Publish " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    // Result Publish Ends Here
    public function actionNoticeboard()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reval_status_entry = Categorytype::find()->where(['category_type'=>'Revaluation'])->orWhere(['description'=>'Revaluation'])->one();
       
        if (isset($_POST['noticeboardbutton'])) 
        {
            $reval_status = isset($_POST['MarkEntry']['mark_type'][0])?$_POST['MarkEntry']['mark_type'][0]:'';
            $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['bat_val'] . "'")->queryScalar();
            $degree_name = Yii::$app->db->createCommand("select concat(degree_name,' -  ',programme_name) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['bat_map_val'] . "'")->queryScalar();
            $year = $_POST['year'];
            $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();

            $withheld_list = Yii::$app->db->createCommand('SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master WHERE month="'.$_POST['month'].'" AND year="'.$_POST['year'].'" AND withheld="w" ')->queryAll();
            $withheld = [];
            foreach ($withheld_list as $key => $value) {
                $withheld[$value['id']]=$value['id'];
            }
            $whereCondition = [                        
                        'b.course_batch_mapping_id' => $_POST['bat_map_val'], 'c.year' => $year, 'c.month' => $_POST['month']
                    ];
            $query_n = new Query();
            $query_n->select('a.register_number,a.name,d.semester,e.subject_code,e.subject_name,c.CIA,c.ESE,e.CIA_max,e.ESE_max,c.total,c.result,c.grade_name,c.withheld,c.grade_point,c.subject_map_id,c.student_map_id,c.mark_type,paper_no')
                ->from('coe_student a')
                ->join('JOIN', 'coe_student_mapping b', 'a.coe_student_id=b.student_rel_id')
                ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_student_mapping_id=c.student_map_id')
                ->join('JOIN', 'coe_subjects_mapping d', 'c.subject_map_id=d.coe_subjects_mapping_id and d.batch_mapping_id=b.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects e', 'd.subject_id=e.coe_subjects_id');
                if(!empty($reval_status) && $reval_status=='yes')
                {
                    $query_n->join('JOIN', 'coe_mark_entry f', 'f.student_map_id=c.student_map_id and f.subject_map_id=c.subject_map_id and f.year=c.year and f.mark_type=c.mark_type and f.term=c.term and f.month=c.month and f.student_map_id=b.coe_student_mapping_id and f.subject_map_id=d.coe_subjects_mapping_id');
                    $whereCondition_12 = [                        
                            'f.category_type_id'=>$reval_status_entry['coe_category_type_id'],'f.year'=>$_POST['year'],'f.month' => $_POST['month'],
                        ];
                    $whereCondition = array_merge($whereCondition,$whereCondition_12);
                }
                $query_n->where($whereCondition);
               // ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
               // ->andWhere(['NOT IN', 'c.student_map_id', $withheld]);
                $query_n->groupBy('a.register_number,e.subject_code')
                ->orderBy('a.register_number,d.semester');
            $noticeboard_copy = $query_n->createCommand()->queryAll();

            if($org_email!='coe@skcet.ac.in' && $reval_status=='')
            {
                $query_man = new  Query();
                $query_man->select('A.register_number,a.name,F.semester,H.subject_code,H.subject_name,F.CIA,F.ESE,H.CIA_max,H.ESE_max, F.total,F.result, F.grade_name,F.withheld, F.grade_point,F.subject_map_id,F.student_map_id,mark_type,paper_no')
                    ->from('coe_student as A')
                    ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                    ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                    ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                    ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                    ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                    ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                    ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
                $query_man->Where(['B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.year' => $year, 'F.month' => $_POST['month'], 'A.student_status' => 'Active','G.is_additional'=>'NO'])
                    //->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                    ->andWhere(['NOT IN', 'student_map_id', $withheld]);
                $query_man->groupBy('register_number,subject_code')
                    ->orderBy('register_number,semester');
                   
                $mandatory_statement = $query_man->createCommand()->queryAll();
                if(!empty($mandatory_statement))
                {
                    $noticeboard_copy = array_merge($noticeboard_copy,$mandatory_statement);
                }
            }            
            array_multisort(array_column($noticeboard_copy, 'semester'),  SORT_ASC, $noticeboard_copy);
            array_multisort(array_column($noticeboard_copy, 'paper_no'),  SORT_ASC, $noticeboard_copy);
            array_multisort(array_column($noticeboard_copy, 'register_number'),  SORT_ASC, $noticeboard_copy);            
            if (count($noticeboard_copy) > 0) 
            {
                return $this->render('noticeboard', [
                    'model' => $model,
                    'noticeboard_copy' => $noticeboard_copy,
                    'year' => $year, 'month' => $month, 'batch_name' => $batch_name, 'degree_name' => $degree_name,'reval_status'=>$reval_status,

                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Notice Board Copy");
                return $this->render('noticeboard', [
                    'model' => $model,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Noticeboard Copy');
            return $this->render('noticeboard', [
                'model' => $model,
            ]);
        }
    }
    public function actionNoticeboardCopyPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['noticeboard_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Noticeboard Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => 'Noticeboard Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
               // 'SetFooter' => ['Noticeboard Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelNoticeboardcopy()
    {
        
            $content = $_SESSION['noticeboard_print'];
            
        $fileName = "Noticeboard Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionProgrammeanalysis()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('programmeanalysis', [
            'model' => $model,
        ]);
    }
    public function actionProgrammeresultanalysisold()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();
        
                $year=$_POST['year'];
                $month=$_POST['month'];
                $bat_map_val=$_POST['batch_map_id'];
                
              $sem_calc = ConfigUtilities::SemCaluclation($year,$month,$bat_map_val);



        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => '']])->groupBy('grade_name')->orderBy('grade_point DESC');
        $grade_name = $query_gr->createCommand()->queryAll();
        $query_cr = new Query();
        $query_cr->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max,ESE_min,ESE_max,credit_points')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->andWhere(['<>', 'paper_type_id', 122]);
        $subject_list = $query_cr->createCommand()->queryAll();
        if (count($subject_list) > 0) 
        {
             $batch_enroll=0; $total_enroll=0;
            if($batch_name<2021)
            {
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=47 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 12); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>

                                <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                <th>ENR</th>
                                <th>APP</th>
                                <th>ABS</th>
                                <th>WIT</th>
                                <th>PA</th>
                                <th>FA</th>
                                <th>PA%</th>
                                <th>FA%</th>
                                <th>MEAN CIA(out of max)</th>
                                <th>MEAN ESE(out of max)</th>
                                <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>';
                $old_grade = '';
                foreach ($grade_name as $grade) {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }
                $course_result_table .= '<th>49-45 (ESE)</th><th>44-40 (ESE)</th><th>39-0 (ESE)</th>
                <th>(CIA)</th>';
                $course_result_table .= '</tr>';
                //return $course_result_table;exit;
                $sn = 1;

                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {



                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   

                  

                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                    $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                    //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }

                    if($subject['ESE_max']!=0)
                    {
                        $m45=((45/100)*$subject['ESE_max']);
                        $m49=((49/100)*$subject['ESE_max']);
                        $m40=((40/100)*$subject['ESE_max']);
                        $m44=((44/100)*$subject['ESE_max']);
                        $m39=((39/100)*$subject['ESE_max']);

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m45."' AND b.ESE <= '".$m49."') AND year_of_passing='' AND b.result!='Absent'"; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m40."' AND b.ESE <= '".$m44."') AND year_of_passing='' AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= 0 AND b.ESE <= '".$m39."') AND year_of_passing='' AND b.result!='Absent'"; //exit;
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; 
                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        
                        $course_result_table .= '<td>'.(count($student_borderCIA)).'</td>';
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }

                    $course_result_table .= '</tr>';
                    $sn++;
                }

                $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }
               

            }
            else
            {

                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=47 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 11); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>

                                <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                <th>ENR</th>
                                <th>APP</th>
                                <th>ABS</th>
                                <th>WIT</th>
                                <th>PA</th>
                                <th>FA</th>
                                <th>PA%</th>
                                <th>FA%</th>
                                <th>MEAN CIA(out of max)</th>
                                <th>MEAN ESE(out of max)</th>
                                <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>
                                ';
                $old_grade = '';
                foreach ($grade_name as $grade) {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }
                $course_result_table .= '<th>45-49 (ESE)</th>
                                <th>40-44 (ESE)</th>
                                <th>0-39 (ESE)</th>
                                <th>(CIA)</th></tr>';
                //return $course_result_table;exit;
                $sn = 1;
                
                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                   
                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                    
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {



                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   

                  

                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                    $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                    //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }
                    if($subject['ESE_max']!=0)
                    {
                        $m45=((45/100)*$subject['ESE_max']);
                        $m49=((49/100)*$subject['ESE_max']);
                        $m40=((40/100)*$subject['ESE_max']);
                        $m44=((44/100)*$subject['ESE_max']);
                        $m39=((39/100)*$subject['ESE_max']);

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m45."' AND b.ESE <= '".$m49."') AND year_of_passing='' AND b.result!='Absent'"; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m40."' AND b.ESE <= '".$m44."') AND year_of_passing='' AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= 0 AND b.ESE <= '".$m39."') AND year_of_passing='' AND b.result!='Absent'"; //exit;
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; //exit;
                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        $course_result_table .= '<td>'.count($student_borderCIA).'</td>';
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }
                    $course_result_table .= '</tr>';
                    $sn++;
                }

                $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }
                
               
            }


             $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('coe_subjects_mapping_id,ESE_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']])->andWhere(['<>', 'paper_type_id', 122]);

            //echo $query_cr1->createCommand()->getRawSql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail1 = array_filter(['']);
            
            if (count($subject_list1) > 0) 
            {   
                
                foreach ($subject_list1 as $subject) 
                {
                     $total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='') "; //exit;

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='')";

                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                    
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail1))
                            {
                              //$notIn_fail1[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }
                       
                       
                }

            }

            $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

            $total_enrollquery = "SELECT distinct b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE student_status='Active' AND b.year='".$_POST['year']."' and c.batch_mapping_id='".$_POST['batch_map_id']."' and b.month='".$_POST['month']."' $section and b.student_map_id NOT IN ( SELECT distinct bb.student_map_id FROM coe_student_mapping aa JOIN coe_mark_entry_master as bb ON bb.student_map_id=aa.coe_student_mapping_id WHERE student_status='Active' AND bb.year='".$_POST['year']."' and aa.course_batch_mapping_id='".$_POST['batch_map_id']."' and bb.month='".$_POST['month']."' $section and aa.semester_detain='".$sem."') ";

            $total_enroll =Yii::$app->db->createCommand($total_enrollquery)->queryAll();

            //print_r(count($total_enroll)); exit;
            $tt=count($total_enroll);
            $tot=($tt)-(count($notIn_fail1));

            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $tt) * 100),2).'% </b></td></tr>';
             $course_result_table .= '</table>';
        
            if (isset($_SESSION['programme_analysis_print'])) {
                unset($_SESSION['programme_analysis_print']);
            }
            $_SESSION['programme_analysis_print'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

    public function actionProgrammeresultanalysis1()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $monthname = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();
        
                $year=$_POST['year'];
                $month=$_POST['month'];
                $bat_map_val=$_POST['batch_map_id'];
                
              $sem_calc = ConfigUtilities::SemCaluclation($year,$month,$bat_map_val);



        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => '']])->groupBy('grade_name')->orderBy('grade_point DESC');
        $grade_name = $query_gr->createCommand()->queryAll();
        $query_cr = new Query();
        $query_cr->select('distinct(subject_code), b.semester, subject_name, coe_subjects_mapping_id, description, coe_subjects_id, batch_mapping_id, CIA_max, ESE_min, ESE_max, credit_points, b.paper_type_id')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27]);
        $subject_list = $query_cr->createCommand()->queryAll();
        if (count($subject_list) > 0) 
        {
             $batch_enroll=0; $total_enroll=0;
            if($batch_name<2021)
            {
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=47 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($monthname . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 12); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>

                                <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                <th>ENR</th>
                                <th>APP</th>
                                <th>ABS</th>
                                <th>WIT</th>
                                <th>PA</th>
                                <th>FA</th>
                                <th>PA%</th>
                                <th>FA%</th>
                                <th>MEAN CIA(out of max)</th>
                                <th>MEAN ESE(out of max)</th>
                                <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>';
                $old_grade = '';
                foreach ($grade_name as $grade) {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }
                $course_result_table .= '<th>49-45 (ESE)</th><th>44-40 (ESE)</th><th>39-0 (ESE)</th>
                <th>(CIA)</th>';
                $course_result_table .= '</tr>';
                //return $course_result_table;exit;
                $sn = 1;

                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_absent->andWhere(['withheld' => null]);
                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' AND withheld is NULL) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {



                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   

                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                    $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                    //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }

                    if($subject['ESE_max']!=0)
                    {
                        $addquery='';
                        if($subject['paper_type_id']==10)
                        {
                            $addquery=' AND category_type_id=49';
                        }
                        else
                        {
                            $addquery=' AND category_type_id=89';
                        }

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 45 AND b.category_type_id_marks <= 49)".$addquery; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44)".$addquery; 
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 39)".$addquery; 
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; 


                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        
                        $course_result_table .= '<td>'.(count($student_borderCIA)).'</td>';
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 45 AND b.category_type_id_marks <= 49) AND b.category_type_id='46'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44) AND b.category_type_id='46'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 39) AND b.category_type_id='46'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }

                    $course_result_table .= '</tr>';
                    $sn++;
                }

                $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }
               

            }
            else
            {

                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=47 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($monthname . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 11); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>

                                <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                <th>ENR</th>
                                <th>APP</th>
                                <th>ABS</th>
                                <th>WIT</th>
                                <th>PA</th>
                                <th>FA</th>
                                <th>PA%</th>
                                <th>FA%</th>
                                <th>MEAN CIA(out of max)</th>
                                <th>MEAN ESE(out of max)</th>
                                <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>
                                ';
                $old_grade = '';
                foreach ($grade_name as $grade) {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }
                $course_result_table .= '<th>40-44 (ESE)</th>
                                <th>35-30 (ESE)</th>
                                <th>0-34 (ESE)</th>
                                <th>(CIA)</th></tr>';
                //return $course_result_table;exit;
                $sn = 1;
                
                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                   
                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                    
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_absent->andWhere(['withheld' => null]);

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' AND withheld is NULL) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {

                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   
                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                    $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                    //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }
                    if($subject['ESE_max']!=0)
                    {
                        $addquery='';
                        if($subject['paper_type_id']==10 || $subject['paper_type_id']==136)
                        {
                            $addquery=' AND category_type_id=49';
                        }
                        else
                        {
                            $addquery=' AND category_type_id=89';
                        }

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44)".$addquery; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 35 AND b.category_type_id_marks <= 39)".$addquery; 
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 34)".$addquery; 
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; 
                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        
                        $course_result_table .= '<td>'.(count($student_borderCIA)).'</td>';
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44) AND b.category_type_id='46'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 35 AND b.category_type_id_marks <= 39) AND b.category_type_id='46'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 34) AND b.category_type_id='46'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }
                    $course_result_table .= '</tr>';
                    $sn++;
                }

                $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }
                
               
            }


             $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('coe_subjects_mapping_id,ESE_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']]);

            //echo $query_cr1->createCommand()->getRawSql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail1 = array_filter(['']);
            
            if (count($subject_list1) > 0) 
            {   
                
                foreach ($subject_list1 as $subject) 
                {
                     $total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='') "; //exit;

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='')";

                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                    
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail1))
                            {
                              //$notIn_fail1[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }
                       
                       
                }

            }

            $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

             $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

             $query_stu_wd = new Query();
            $query_stu_wd->select(['distinct (student_map_id)'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.year'=>$_POST['year'],'sub.semester'=>$sem])
                              ->andWhere(['=', 'e.withdraw', 'wd']);
                              
            //echo "<br>".$query_stu_wd->createCommand()->getRawSql(); exit;
            $wd_stu_details = $query_stu_wd->createCommand()->queryAll();
            $tot_wd_count=count($wd_stu_details); 

            $k=0;$partical_wd_count=0; $full_wd_count=0;
            foreach ($wd_stu_details as $wd_stu_list) 
            {
                $query_subject = new Query();
                    $query_subject->select(['count(distinct subject_map_id) as count'])
                                    ->from('coe_student_mapping a')
                                    ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                                     ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                                    ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id'],'sub.semester'=>$sem])
                                    ->andwhere(['a.course_batch_mapping_id'=> $_POST['batch_map_id']]);
                   // echo "<br>".$query_subject->createCommand()->getRawSql(); exit;
                
                $sub_count = $query_subject->createCommand()->queryAll();
                $subject_count=$sub_count[0]['count']; 

                 $query_stu_subject = new Query();
                 $query_stu_subject->select(['count(distinct subject_map_id) as count'])
                            ->from('coe_student_mapping a')
                             ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id']])
                            ->andwhere(['a.course_batch_mapping_id'=> $_POST['batch_map_id']])
                            ->andWhere(['=', 'e.withdraw', 'wd']);
                $sub_stu_count = $query_stu_subject->createCommand()->queryAll();
                $subject_stu_count=$sub_stu_count[0]['count']; 

                $query_fail = new Query();
                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE student_map_id='".$wd_stu_list['student_map_id']."' AND year='".$_POST['year']."' and mark_type=27 and month='".$_POST['month']."' and result  not like '%Absent%' AND a.course_batch_mapping_id='".$_POST['batch_map_id']."' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();

                if($subject_count==$subject_stu_count && $subject_stu_count!=0)
                {
                    $full_wd_count=$full_wd_count+1;
                }
                elseif($subject_count>$subject_stu_count && $subject_stu_count!=0 && $student_fail==0)
                {
                    $partical_wd_count=$partical_wd_count+1;
                }
                $k++;
            }
                //echo $partical_wd_count; exit;
             $query_strength = new Query();
            $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $_POST['batch_map_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem]);
                   
            $STRENGHT = $query_strength->createCommand()->queryScalar();

            /*if($_POST['batch_map_id']==116)
            {
                echo $total_enrollquery; exit;
            }*/

            $tt=$STRENGHT+$partical_wd_count; //count($total_enroll);
            $tot=($tt)-(count($notIn_fail1));

            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $tt) * 100),2).'% </b></td></tr>';
             $course_result_table .= '</table>';
        
            if (isset($_SESSION['programme_analysis_print'])) {
                unset($_SESSION['programme_analysis_print']);
            }
            $_SESSION['programme_analysis_print'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

     public function actionProgrammeresultanalysis()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $monthname = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();
        
        $year=$_POST['year'];
        $month=$_POST['month'];
        $bat_map_val=$_POST['batch_map_id'];
        
        $sem_calc = ConfigUtilities::SemCaluclation($year,$month,$bat_map_val);

        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => '']])->groupBy('grade_name')->orderBy('grade_point DESC');
        $grade_name = $query_gr->createCommand()->queryAll();
        $query_cr = new Query();
        $query_cr->select('distinct(subject_code), b.semester, subject_name, coe_subjects_mapping_id, description, coe_subjects_id, batch_mapping_id, CIA_max, ESE_min, ESE_max, credit_points, b.paper_type_id')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27]);
        $subject_list = $query_cr->createCommand()->queryAll();
        if (count($subject_list) > 0) 
        {
             $batch_enroll=0; $total_enroll=0;
            if($batch_name<2021)
            {
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=48 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=48 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($monthname . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=48 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 12); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>                                
                                <th>ENR</th>
                                <th>PA</th>
                                 <th>PA%</th>
                                 <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>
                                
                                ';
                $old_grade = '';
                foreach ($grade_name as $grade) {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }

                
                $course_result_table .= '<th>49-45 (ESE)</th><th>44-40 (ESE)</th><th>39-0 (ESE)</th> 
                <th>WIT</th>
                <th>(CIA)</th>
                <th>ABS</th>
                <th>WD</th>';

                $course_result_table .= '<th>APP</th>
                                            
                                            
                                            <th>MEAN CIA(out of max)</th>
                                            <th>MEAN ESE(out of max)</th>';
                $course_result_table .= '</tr>'; //<th>FA</th> <th>FA%</th>
                //return $course_result_table;exit;
                $sn = 1;

                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td>
                    <td align="left">' . $subject['subject_code'] . '</td>
                    <td align="left">' . $subject['subject_name'] . '</td> 
                    <td align="left">' . $subject['CIA_max'] . '</td>
                    <td align="left">' . $subject['ESE_max'] . '</td>
                    <td align="left">' . $subject['credit_points'] . '</td>';

                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    //$query_enroll->andWhere(['!=', 'grade_name', 'WD']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_absent->andWhere(['withheld' => null]);
                    
                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                   
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();

                    $query_wd = new Query();
                    $query_wd->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    $query_wd->andWhere(['=', 'grade_name', 'WD']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_wd->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $student_wd = $query_wd->createCommand()->queryScalar();

                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (year_of_passing is NULL or year_of_passing='') "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $student_enrol1 =$student_enrol -$student_wd;
                    $pass_percent = ($student_pass / $student_enrol1) * 100;
                    $fail_percent = ($student_fail / $student_enrol1) * 100;
                   

                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {

                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   

                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                   $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                   $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                   $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';
                     $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';  


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        if($grade['grade_name']=='RA')
                        {
                            $course_result_table .= '<td>' . ($student_75+$student_withheld+$student_absent) . '</td>';
                        }
                        else
                        {
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        
                    }

                   

                    if($subject['ESE_max']!=0)
                    {
                        $addquery='';
                        if($subject['paper_type_id']==10)
                        {
                            $addquery=' AND category_type_id=49';
                        }
                        else
                        {
                            $addquery=' AND category_type_id=89';
                        }

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 45 AND b.category_type_id_marks <= 49) AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w') AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld is NULL and result='Pass')".$addquery; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44) AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')".$addquery; 
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        
                       /* if($subject['coe_subjects_mapping_id']==7330)
                        {
                          echo $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 39) AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')".$addquery; exit;
                        }*/

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 39) AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')".$addquery; 
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; 
                       

                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                        $course_result_table .= '<td>'.count($student_border44).'</td>';
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $course_result_table .= '<td>'.(count($student_borderCIA)).'</td>';
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $course_result_table .= '<td align="center">' . $student_wd . '</td>';
                         $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        
                        //$course_result_table .= '<td align="center">' . ($student_fail) . '</td>';
                        // $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                         $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                    
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 45 AND b.category_type_id_marks <= 49) AND b.category_type_id='46'  AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44) AND b.category_type_id='46'  AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();


                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 39) AND b.category_type_id='46' AND b.student_map_id NOT IN (SELECT m.student_map_id FROM coe_mark_entry_master m WHERE m.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND m.year='".$_POST['year']."' AND m.month='".$_POST['month']."' AND withheld='w')";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();

                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                        $course_result_table .= '<td>'.count($student_border44).'</td>';
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>' . $student_withheld . '</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>' . $student_withheld . '</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>';
                    }

                    $course_result_table .= '</tr>';
                    $sn++;
                }

               /* $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }*/
               

            }
            else
            {

                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                $course_result_table = '';
                $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
                $course_result_table .= '<tr>
                                            <td colspan=47 align="center"> 
                                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                                <center>' . $org_address . '</center>
                                                <center>' . $org_tagline . '</center> 
                                            </td>
                                           
                                        </tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($monthname . ' ' . $_POST['year']) . '</td></tr>';
                $course_result_table .= '<tr><td colspan=47 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
                $colspan = 30 - (count($grade_name) + 11); // is the number of columns
                $course_result_table .= '<tr>                                                                                                                                
                                <th> S. NO </th> 
                                <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                                <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                                   <th>CIA_MAX</th>
                                    <th>ESE_MAX</th>
                                    <th>CREDITS</th>                                
                                <th>ENR</th>
                                <th>PA</th>
                                <th>PA%</th>
                                <th>MEAN CIA(out of 100)</th>
                                 <th>MEAN ESE(out of 100)</th>
                                <th>MEAN(out of 100)</th>
                                <th>SD</th>';

                 $old_grade = '';
                foreach ($grade_name as $grade) 
                {
                    if (!empty($grade['grade_name']) && $old_grade != $grade['grade_name']) {
                        $old_grade = $grade['grade_name'];
                        $course_result_table .= '<th>' . strtoupper($grade['grade_name']) . '</th>';
                    }
                }           
               
                $course_result_table .= '<th>40-44 (ESE)</th>
                                <th>35-30 (ESE)</th>
                                <th>0-34 (ESE)</th>
                                <th>WIT</th>
                                <th>(CIA)</th></tr>
                                <th>ABS</th>
                                <th>WD</th>
                                ';
                //return $course_result_table;exit;
                $sn = 1;
                
                foreach ($subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                   
                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                    
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($sn == 1){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    //$course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    //$course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    //$course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    //$course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                }
                else
                {
                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                }
                 if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
             
             else
             {
                          $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);



             }

             if(!empty($_POST['section']) && $_POST['section']!='All')
             {

                     $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);
                }
                else
                {
                   $query_meanese = new Query();
                    $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                    $MEANESE = round(($student_meanese/$student_appeared),2);



                }
                   
                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                }

                if($MEANESE==0)
                {
                    $MEANESE100=0;

                }
                else{

                      $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                     // print_r($MEANCIA100);exit;
                          }                       

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                   $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                    $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                    $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                    //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                    //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                    $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                            ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }
                    if($subject['ESE_max']!=0)
                    {
                        $addquery='';
                        if($subject['paper_type_id']==10 || $subject['paper_type_id']==136)
                        {
                            $addquery=' AND category_type_id=49';
                        }
                        else
                        {
                            $addquery=' AND category_type_id=89';
                        }

                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44)".$addquery; 
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 35 AND b.category_type_id_marks <= 39)".$addquery; 
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                        $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 34)".$addquery; 
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';

                        $query_borderCIA = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'AND (b.total >= 0 AND b.total <= 49) AND (b.ESE >= '".$subject['ESE_min']."') AND year_of_passing='' AND b.result!='Absent'"; 
                        $student_borderCIA = Yii::$app->db->createCommand($query_borderCIA)->queryAll();
                        
                        $course_result_table .= '<td>'.(count($student_borderCIA)).'</td>';
                    }
                    else  if($subject['CIA_max']!=0 && $subject['ESE_max']==0)
                    {
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 40 AND b.category_type_id_marks <= 44) AND b.category_type_id='46'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 35 AND b.category_type_id_marks <= 39) AND b.category_type_id='46'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.category_type_id_marks >= 0 AND b.category_type_id_marks <= 34) AND b.category_type_id='46'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                    }
                    else
                    {
                         $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td>';
                    }
                    $course_result_table .= '</tr>';
                    $sn++;
                }

                $man_query_cr = new Query();
                $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                    ->from('coe_mandatory_subjects a')
                    ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                    ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
                $man_subject_list = $man_query_cr->createCommand()->queryAll();
                
                if(!empty($man_subject_list))
                {
                    foreach ($man_subject_list as $subject) {
                        $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                        $query_enroll = new Query();
                        $query_enroll->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_enrol = $query_enroll->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                        $query_appeared = new Query();
                        $query_appeared->select('count(DISTINCT student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                            ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_appeared = $query_appeared->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                        $query_absent = new Query();
                        $query_absent->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_absent = $query_absent->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                        $query_withheld = new Query();
                        $query_withheld->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_withheld = $query_withheld->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                        $query_pass = new Query();
                        $query_pass->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                            ->andWhere(['NOT', ['year_of_passing' => '']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_pass = $query_pass->createCommand()->queryScalar();
                        $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                        $query_fail = new Query();
                        $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                        $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                        $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                        $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                        $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                        if ($mark_type_name == "Regular") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            $pass_percent = ($student_pass / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                        }
                        if ($mark_type_name == "Regular") {
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        } else if ($mark_type_name == "Arrear") {
                            
                            $fail_percent = ($student_fail / $student_enrol) * 100;
                            $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                        }
                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                                ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                        $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                        $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                        
                        $course_result_table .= '<td>'.count($student_border49).'</td>';
                         
                        $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                        $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                        $course_result_table .= '<td>'.count($student_border44).'</td>';

                         $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 39) AND b.result!='Absent'";
                        $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                        $course_result_table .= '<td>'.count($student_border39).'</td>';
                        $course_result_table .= '<td>0</td>';
                        $course_result_table .= '</tr>';
                        $sn++;
                    }
                }
                
               
            }


             $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('coe_subjects_mapping_id,ESE_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']]);

            //echo $query_cr1->createCommand()->getRawSql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail1 = array_filter(['']);
            
            if (count($subject_list1) > 0) 
            {   
                
                foreach ($subject_list1 as $subject) 
                {
                     $total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='') "; //exit;

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.year_of_passing='')";

                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                    
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail1))
                            {
                              //$notIn_fail1[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }
                       
                       
                }

            }

            $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

             $query_stu_wd = new Query();
            $query_stu_wd->select(['distinct (student_map_id)'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.year'=>$_POST['year'],'sub.semester'=>$sem])
                              ->andWhere(['=', 'e.withdraw', 'wd']);
                              
            //echo "<br>".$query_stu_wd->createCommand()->getRawSql(); exit;
            $wd_stu_details = $query_stu_wd->createCommand()->queryAll();
            $tot_wd_count=count($wd_stu_details); 

            $k=0;$partical_wd_count=0; $full_wd_count=0;
            foreach ($wd_stu_details as $wd_stu_list) 
            {
                $query_subject = new Query();
                    $query_subject->select(['count(distinct subject_map_id) as count'])
                                    ->from('coe_student_mapping a')
                                    ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                                     ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                                    ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id'],'sub.semester'=>$sem])
                                    ->andwhere(['a.course_batch_mapping_id'=> $_POST['batch_map_id']]);
                   // echo "<br>".$query_subject->createCommand()->getRawSql(); exit;
                
                $sub_count = $query_subject->createCommand()->queryAll();
                $subject_count=$sub_count[0]['count']; 

                 $query_stu_subject = new Query();
                 $query_stu_subject->select(['count(distinct subject_map_id) as count'])
                            ->from('coe_student_mapping a')
                             ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id']])
                            ->andwhere(['a.course_batch_mapping_id'=> $_POST['batch_map_id']])
                            ->andWhere(['=', 'e.withdraw', 'wd']);
                $sub_stu_count = $query_stu_subject->createCommand()->queryAll();
                $subject_stu_count=$sub_stu_count[0]['count']; 

                $query_fail = new Query();
                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE student_map_id='".$wd_stu_list['student_map_id']."' AND year='".$_POST['year']."' and mark_type=27 and month='".$_POST['month']."' and result  not like '%Absent%' AND a.course_batch_mapping_id='".$_POST['batch_map_id']."' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();

                if($subject_count==$subject_stu_count && $subject_stu_count!=0)
                {
                    $full_wd_count=$full_wd_count+1;
                }
                elseif($subject_count>$subject_stu_count && $subject_stu_count!=0 && $student_fail==0)
                {
                    $partical_wd_count=$partical_wd_count+1;
                }
                $k++;
            }
                //echo $partical_wd_count; exit;
             $query_strength = new Query();
            $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $_POST['batch_map_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem]);
                   
            $STRENGHT = $query_strength->createCommand()->queryScalar();

            /*if($_POST['batch_map_id']==116)
            {
                echo $total_enrollquery; exit;
            }*/

            $tt=$STRENGHT+$partical_wd_count; //count($total_enroll);
            $tot=($tt)-(count($notIn_fail1));

            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $tt) * 100),2).'% </b></td></tr>';
             $course_result_table .= '</table>';
        
            if (isset($_SESSION['programme_analysis_print'])) {
                unset($_SESSION['programme_analysis_print']);
            }
            $_SESSION['programme_analysis_print'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

    public function actionProgrammeAnalysisPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['programme_analysis_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                        table th{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
       
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelProgrammeanalysis()
    {
       
        $content = $_SESSION['programme_analysis_print'];
          
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionCrseanalysissubcode()
    {

        
        $subject_query = new Query();
        $subject_query->select('c.subject_code,c.coe_subjects_id')
            ->from('coe_mark_entry_master a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.subject_map_id=b.coe_subjects_mapping_id')
            ->join('JOIN', 'coe_subjects c', 'b.subject_id=c.coe_subjects_id')
            ->join('JOIN', 'coe_bat_deg_reg d', 'd.coe_bat_deg_reg_id=b.batch_mapping_id')
            ->join('JOIN', 'coe_batch e', 'd.coe_batch_id=e.coe_batch_id')
            ->where(['a.year' => $_POST['year'], 'a.month' => $_POST['month'], 'a.mark_type' => $_POST['mark_type'], 'e.coe_batch_id' => $_POST['batch_id'],'d.coe_batch_id'=>$_POST['batch_id']])->groupBy('subject_code')->orderBy('subject_code');
        $subject_list = $subject_query->createCommand()->queryAll();
        return json_encode($subject_list);
    }
    public function actionCourseanalysis()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $galley = new HallAllocate();
        $subject = new Subjects();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Result Analysis ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('courseanalysis', [
            'model' => $model, 'galley' => $galley, 'subject' => $subject,
        ]);
    }
    public function actionCourseresultanalysis()
    {
       

        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $getBatchDetails = CoeBatDegReg::find()->where(['coe_batch_id'=>$_POST['batch']])->all();
        $getBTDe = array_filter(['']);
        foreach ($getBatchDetails as $key => $bat_de) {
           $getBTDe[$bat_de['coe_bat_deg_reg_id']] = $bat_de['coe_bat_deg_reg_id'];
        }
        $sub_id_get = SubjectsMapping::find()->where(['subject_id'=>$_POST['sub_id']])->andWhere(['IN','batch_mapping_id',$getBTDe])->one();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $subject_details = Yii::$app->db->createCommand("select subject_code,subject_name from coe_subjects where coe_subjects_id='" . $_POST['sub_id'] . "'")->queryAll();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['mark_type'] . "'")->queryScalar();

        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where  coe_bat_deg_reg_id='".$sub_id_get['batch_mapping_id']."' ")->queryScalar();
        $year_exam = $_POST['year'];
        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => '']])->groupBy('grade_name');
        $grade_name = $query_gr->createCommand()->queryAll();
        $count = count($grade_name);
        $crse_analysis_query = new Query();
        $crse_analysis_query->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,degree_code,programme_name')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->join('JOIN', 'coe_bat_deg_reg e', 'b.batch_mapping_id=e.coe_bat_deg_reg_id')
            ->join('JOIN', 'coe_degree f', 'e.coe_degree_id=f.coe_degree_id')
            ->join('JOIN', 'coe_programme g', 'e.coe_programme_id=g.coe_programme_id')
            ->where(['c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => $_POST['mark_type'], 'a.coe_subjects_id' =>$_POST['sub_id'],'b.subject_id'=>$_POST['sub_id']]);
        $courseanalysis = $crse_analysis_query->createCommand()->queryAll();
        $colspan = 20-$count;
        if (count($courseanalysis) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $data = '<table id="checkAllFeet" class="table table-responsive table-striped" align="center" ><tbody align="center">';
            $data .= '<tr>
                        <td colspan=2> 
                            <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                        </td>
                        <td colspan="'.$colspan.'" align="center"> 
                            <center><b><font size="4px">' . $org_name . '</font></b></center>
                            <center>' . $org_address . '</center>
                            
                            <center>' . $org_tagline . '</center> 
                        </td>
                        <td  colspan=2>  
                            <img width="100" height="100" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                        </td>
                    </tr>';
            $data .= '<tr>
                        <td colspan=17 align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Result Analysis - ' . $month . ' ' . $_POST['year'] . '
                        </b></td>
                    </tr>';
            $data .= '<tr><td colspan=17 align="center">';
            foreach ($subject_details as $sub) {
                $data .= '<b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE  </b> = ' . $sub['subject_code'] . '&nbsp;&nbsp;&nbsp;<b>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </b> = ' . $sub['subject_name'];
            }
            $data .= '</td></tr>';
            $data .= '<tr>                                                                                                                                
                    <th> S.NO </th> 
                    <th>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Code</th>                    
                    <th>Enrolled</th>
                    <th>Appeared</th>
                    <th>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_ABSENT) . '</th>
                    <th>Withheld</th>
                    <th>Pass</th>
                    <th>Fail</th>
                    <th>Pass %</th>
                    <th>Fail %</th>';
            foreach ($grade_name as $grade) {
                $data .= '<th>' . $grade['grade_name'] . '</th>';
            }
            $data .= '</tr>';
            $sn = 1;
            foreach ($courseanalysis as $crse) {
                $degree_name_l = strstr($crse['degree_code'], "MBATRISEM") ? "MBA" : $crse['degree_code'];
                $data .= '<tr><td>' . $sn . '</td><td>' . $degree_name_l . ' ' . $crse['programme_name'] . '</td>';
                if ($crse['description'] != 'Elective') {
                    $query_enroll = new Query();
                    if ($mark_type_name == "Regular") {
                        $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $crse['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$crse['semester']]);
                        // echo "<br>".$query_enroll->createCommand()->getRawSql();
                    } else {
                        $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $crse['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$crse['semester']]);
                    }
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $data .= '<td align="center">' . $student_enrol . '</td>';
                } else if ($crse['description'] == 'Elective') {
                    $query_enroll = new Query();
                    if ($mark_type_name == "Regular") {
                         $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $crse['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$crse['semester']]);
                    } else {
                         $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $crse['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$crse['semester']]);
                    }
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $data .= '<td align="center">' . $student_enrol . '</td>';
                }
                $query_appeared = new Query();
                $query_appeared->select('count(student_map_id)')
                    ->from('coe_mark_entry_master')
                    ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'],'mark_type'=>$_POST['mark_type']])
                    ->andWhere(['NOT', ['result' => 'Absent']]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
                $data .= '<td align="center">' . $student_appeared . '</td>';

                $query_absent = new Query();
                $query_absent->select('count(student_map_id)')
                    ->from('coe_mark_entry_master')
                    ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'],'mark_type'=>$_POST['mark_type']])->andWhere(['LIKE','grade_name','AB']);
                $student_absent = $query_absent->createCommand()->queryScalar();
                $data .= '<td align="center">' . $student_absent . '</td>';

                $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_mark_entry_master')
                    ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w','mark_type'=>$_POST['mark_type']]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();
                $data .= '<td align="center">' . $student_withheld . '</td>';

                $query_pass = new Query();
                $query_pass->select('count(student_map_id)')
                    ->from('coe_mark_entry_master')
                    ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'],'mark_type'=>$_POST['mark_type']])
                    ->andWhere(['NOT', ['year_of_passing' => '']]);
                $student_pass = $query_pass->createCommand()->queryScalar();
                $data .= '<td align="center">' . $student_pass . '</td>';

                $query_fail = new Query();
                $query_fail->select('count(student_map_id)')
                    ->from('coe_mark_entry_master')
                    ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'year_of_passing' => '','mark_type'=>$_POST['mark_type']])
                    ->andWhere(['NOT', ['result' => 'Absent']]);
                $student_fail = $query_fail->createCommand()->queryScalar();
                $data .= '<td align="center">' . $student_fail . '</td>';
                $student_enrol = $student_enrol==0?1:$student_enrol;
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $data .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $data .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $data .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $data .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                }
                foreach ($grade_name as $grade) {
                    $query_75 = new Query();
                    $query_75->select('count(student_map_id)')
                        ->from('coe_mark_entry_master')
                        ->where(['subject_map_id' => $crse['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name'],'mark_type'=>$_POST['mark_type']]);
                    $student_75 = $query_75->createCommand()->queryScalar();
                    $data .= '<td align="center">' . $student_75 . '</td>';
                }
                $data .= '</tr>';
                $sn++;
            }
            $data .= '</tbody></table>';
            if (isset($_SESSION['course_analysis_print'])) {
                unset($_SESSION['course_analysis_print']);
            }
            $_SESSION['course_analysis_print'] = $data;
            return $data;
        } else {
            return 0;
        }
    }
    public function actionCourseAnalysisPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['course_analysis_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Result Analysis Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 16px; }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Result Analysis Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Result Analysis Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelCourseanalysis()
    {
        
            $content = $_SESSION['course_analysis_print'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data' . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionStudentmarkView()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        if (isset($_POST['markviewbutton'])) {
            $stu_general_query = new Query();
            $reg_num = strtoupper($_POST['mark_view_reg_no']);
            $stu_general_query->select('a.register_number,a.name,d.batch_name, b.previous_reg_number,e.degree_code,f.programme_code,g.description as student_status,b.coe_student_mapping_id as stu_map_id,semester_detain')
                ->from('coe_student a')
                ->join('JOIN', 'coe_student_mapping b', 'a.coe_student_id=b.student_rel_id')
                ->join('JOIN', 'coe_category_type as g', 'g.coe_category_type_id=b.status_category_type_id')
                ->join('JOIN', 'coe_bat_deg_reg c', 'b.course_batch_mapping_id=c.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_batch d', 'c.coe_batch_id=d.coe_batch_id')
                ->join('JOIN', 'coe_degree e', 'c.coe_degree_id=e.coe_degree_id')
                ->join('JOIN', 'coe_programme f', 'c.coe_programme_id=f.coe_programme_id')
                ->where(['a.register_number' => $reg_num]);
            $student_detail = $stu_general_query->createCommand()->queryOne();
            if (count($student_detail) > 0) 
            {
                $stu_mark_query = new Query();
                $stu_mark_query->select('b.course_batch_mapping_id as bat_map_val,e.student_map_id, c.subject_code,c.subject_name,d.semester,e.CIA, e.ESE,e.total,e.result, e.grade_name,e.grade_point,e.mark_type, f.coe_category_type_id, e.year_of_passing,e.withheld,e.month,e.year, f.description,c.CIA_max, c.credit_points,c.ESE_max, c.total_minimum_pass as min_pass,semester_detain')
                    ->from('coe_student a')
                    ->join('JOIN', 'coe_student_mapping b', 'a.coe_student_id = b.student_rel_id')
                    ->join('JOIN', 'coe_subjects_mapping d', 'b.course_batch_mapping_id=d.batch_mapping_id')
                    ->join('JOIN', 'coe_subjects c', 'c.coe_subjects_id=d.subject_id')
                    ->join('JOIN', 'coe_mark_entry_master e', 'd.coe_subjects_mapping_id=e.subject_map_id and b.coe_student_mapping_id=e.student_map_id')
                    ->join('JOIN', 'coe_category_type f', 'e.month=f.coe_category_type_id')
                    ->where(['a.register_number' => $reg_num])
                    ->orderBy('e.year,e.month,d.semester,e.mark_type,d.paper_type_id')
                    ->groupBy('e.year,e.month,c.subject_code');
                $student_mark = $stu_mark_query->createCommand()->queryAll();

                $stu_transfer_query=new Query();
             $stu_transfer_query->select('a.register_number,a.name,d.batch_name,TR.old_clg_reg_no,e.degree_code,f.programme_code,g.description as student_status,b.coe_student_mapping_id as stu_map_id,semester_detain')
                ->from('coe_student a')
                ->join('JOIN', 'coe_student_mapping b', 'a.coe_student_id=b.student_rel_id')
                ->join('JOIN', 'coe_category_type as g', 'g.coe_category_type_id=b.status_category_type_id')
                ->join('JOIN', 'coe_bat_deg_reg c', 'b.course_batch_mapping_id=c.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_batch d', 'c.coe_batch_id=d.coe_batch_id')
                ->join('JOIN', 'coe_degree e', 'c.coe_degree_id=e.coe_degree_id')
                ->join('JOIN', 'coe_programme f', 'c.coe_programme_id=f.coe_programme_id')
                ->join('JOIN', 'coe_student_category_details TR', 'b.coe_student_mapping_id=TR.student_map_id')
               ->where(['a.register_number' => $_POST['mark_view_reg_no']]);
            
            $stu_transfer_query=new Query();
             $stu_transfer_query->select('a.register_number,a.name,d.batch_name,TR.old_clg_reg_no,e.degree_code,f.programme_code,g.description as student_status,b.coe_student_mapping_id as stu_map_id,semester_detain')
                ->from('coe_student a')
                ->join('JOIN', 'coe_student_mapping b', 'a.coe_student_id=b.student_rel_id')
                ->join('JOIN', 'coe_category_type as g', 'g.coe_category_type_id=b.status_category_type_id')
                ->join('JOIN', 'coe_bat_deg_reg c', 'b.course_batch_mapping_id=c.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_batch d', 'c.coe_batch_id=d.coe_batch_id')
                ->join('JOIN', 'coe_degree e', 'c.coe_degree_id=e.coe_degree_id')
                ->join('JOIN', 'coe_programme f', 'c.coe_programme_id=f.coe_programme_id')
                ->join('JOIN', 'coe_student_category_details TR', 'b.coe_student_mapping_id=TR.student_map_id')
               ->where(['a.register_number' => $_POST['mark_view_reg_no']]);

               
            $student_transfer_detail = $stu_transfer_query->createCommand()->queryOne();

                if (count($student_mark) > 0) {
                    return $this->render('studentmark-view', [
                        'model' => $model, 'student_detail' => $student_detail, 'student_mark' => $student_mark,
                        'reg_num'=>$reg_num,'student_transfer_detail'=> $student_transfer_detail,
                    ]);
                } else {
                    Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available");
                    return $this->render('studentmark-view', [
                        'model' => $model,
                    ]);
                }
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available");
                return $this->render('studentmark-view', [
                    'model' => $model,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Mark View');
            return $this->render('studentmark-view', [
                'model' => $model,
            ]);
        }
    }
    public function actionStudentmarkViewPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $content = $_SESSION['studentmarkview_print'];
            ob_clean();
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Mark View Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                        
                        .maroon_identification
                        {   
                            padding: 5px !important;
                            color: #FFF; 
                            height: 10px; 
                            width: 100px; 
                            background: #890c01;     
                        }
                        .withheld_iden
                        {   
                            padding: 5px !important;
                            color: #FFF; 
                            height: 10px; 
                            width: 100px; 
                            background: #c14603;     
                        }
                        .moderation_IDEN
                        {   
                            padding: 5px !important;
                            color: #FFF; 
                            height: 10px; 
                            width: 100px; 
                            background: #cc00ff;     
                        }
                        .withdraw_IDEN
                        {   
                            padding: 5px !important;
                            color: #FFF; 
                            height: 10px; 
                            width: 100px; 
                            background: #38007a;     
                        }
                        .reval_drwaw
                        {   
                            padding: 5px !important;
                            color: #FFF; 
                            height: 10px; 
                            width: 100px; 
                            background: #0182a3;     
                        }
                        .color_identification td:nth-child(2) 
                        {
                            padding-left: 25px;
                            font-size: 16px;
                        }
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                        }
                    }   
                ',       
            'options' => ['title' => strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)).' SEMESTER WISE PERFORMANCE '],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT).' SEMESTER WISE PERFORMANCE ' . strtoupper(' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}')],
            ],
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;

        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelStudentmarkview()
    {
        
            $content = $_SESSION['studentmarkview_print'];
           
        $fileName = "Mark View Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionMarkPercent()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Mark Percent ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('mark-percent', [
            'model' => $model,
            'markentrymaster' =>$markentrymaster,
        ]);
    }
   
   public function actionMarkpercentreport()
    {

        $semester= $_POST['semester'];
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_long_absent = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Long Absent%'")->queryScalar();
        
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $failed_stus = Yii::$app->db->createCommand('SELECT student_map_id,withdraw FROM coe_mark_entry_master where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and mark_type="27" and year_of_passing="" ')->queryAll();

        $stud_count = count($failed_stus);

        $notIn = array_filter(['']);
        foreach ($failed_stus as $key => $fails) {
            if($fails['withdraw']!='wd')
            {
                $notIn[$fails['student_map_id']]=$fails['student_map_id'];
            }
        }
        $BAT_name = Batch::findOne($_POST['batch']);
        $MON_name = Categorytype::findOne($_POST['month']);
         $notIn = array_filter($notIn);
           
            $query_stu_tot = new Query();
                        $query_stu_tot->select(['count(distinct student_map_id) as count','course_batch_mapping_id','programme_code','degree_code','batch_name','degree_type'])
                            ->from('coe_student_mapping a')
                             ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                        ->join('JOIN', 'coe_bat_deg_reg c', 'c.coe_bat_deg_reg_id=a.course_batch_mapping_id')
                        ->join('JOIN', 'coe_batch d', 'd.coe_batch_id=c.coe_batch_id')
                        ->join('JOIN', 'coe_degree f', 'f.coe_degree_id=c.coe_degree_id')
                        ->join('JOIN', 'coe_programme g', 'g.coe_programme_id=c.coe_programme_id')
                        ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['d.coe_batch_id' => $_POST['batch'],'c.coe_batch_id' => $_POST['batch'],'e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester, 'b.student_status' => 'Active'])
                            ->andWhere(['<>', 'status_category_type_id', $det_long_absent])
                            ->andWhere(['<>', 'programme_code', 'PHD'])
                        ->andWhere(['<>', 'status_category_type_id', $det_long_absent])
                        ->groupBy('course_batch_mapping_id')
                        ->orderBy('degree_code,programme_code');
        //echo "<br>".$query_stu_tot->createCommand()->getRawSql(); exit;

           $stu_tot_value = $query_stu_tot->createCommand()->queryAll();
        if (count($stu_tot_value) > 0) 
        {

            $query_stu_wd = new Query();
            $query_stu_wd->select(['distinct (student_map_id)'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                              ->andWhere(['=', 'e.withdraw', 'wd']);
                              
            //echo "<br>".$query_stu_wd->createCommand()->getRawSql(); exit;
                     $wd_stu_details = $query_stu_wd->createCommand()->queryAll();
                      $tot_wd_count=count($wd_stu_details); 


              
            $fail_array = array();
           
            if($tot_wd_count>0)
            {

                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                
                $data = '<table width="100%" id="checkAllFeet" border=1  align="center" ><tbody align="center">';
                $data .= '<tr>
                            <td colspan=10 align="center"> 
                                <center><b><font size="4px">'.$org_name.'</font></b></center>
                                <center><b><font size="4px">Office of the Controller of the Examinations</font></b></center>
                                <center>Consolidated Results '.$MON_name->description."-".$BAT_name->batch_name.' Examinations</center>
                                <center>' . $BAT_name->batch_name . ' BATCH</center> 
                            </td>
                        </tr>';
                $data .= '<tr>
                            <td colspan=10 align="center"><b>Mark Percent : ' . $_POST['year'] . ' ' . $month . ' SEM : '.$semester.'
                            </b></td>
                        </tr>';
               

                $data .= '<tr>
                            <td align="center"><b>SNO</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH) . '</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . '</b></td>
                            
                            <td align="center">REGISTERED</td>
                            <td align="center">TOTAL PARTIAL WD</td>
                            <td align="center">TOTAL WD ALL</td>
                            <td align="center">ACTIVE REGISTERED</td>
                            <td align="center">PASS COUNT</td>
                            <td align="center">PASS %</td>
                        </tr>';//<td align="center">TOTAL STRENGTH</td>

                $var_change = $stu_tot_value;
                $sn_no = 1;
                $i = $total_pass = $total_strength_active = $ug_strength = $ug_reg = $ug_pass = $pg_strength = $pg_reg = $pg_pass_count =  $total_strength = $total_fail =0;

                $total_pass_wd = $total_strength_active_wd = $ug_strength_wd = $ug_reg_wd = $ug_pass_wd = $pg_strength_wd = $pg_reg_wd = $pg_pass_count_wd =  $total_strength_wd = $STRENGHT_NOT_wd = $pass_count_disp_wd = $total_fail_wd =0;

                $prev_deg_name = '';
               
                $ug_p_wd_count=0;
                $pg_p_wd_count=0;
                
                $ug_f_wd_count=0;
                $pg_f_wd_count=0;
                
                $tot_p_wd_count=0;
                $tot_wd_full_count=0;
                foreach ($var_change as $key => $deg) 
                {               
                    
                    $batch_anme = $deg['batch_name']; 
                    if($i!=0)
                    {
                        $batch_anme = ',,';
                    }
                    
                     if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        $data .='<tr><td colspan=3 align="center"> <b>TOTAL UG</b></td>';
                    }
                    else
                    {
                        $data .='<tr><td>'.$sn_no.'</td>';
                        $data .='<td>'.$batch_anme.'</td>'; 
                        $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                    }
                   
                      $query_map_id = new Query();
                    $query_map_id->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$semester])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
                    $students_map_id_pass = $query_map_id->createCommand()->queryScalar();

                    $pass_count_disp = isset($students_map_id_pass)?$students_map_id_pass:'0';
                  

                   $query_strength = new Query();
                    $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$semester]);
                   
                    $STRENGHT = $query_strength->createCommand()->queryScalar();

                       $query_stu = new Query();
                        $query_stu->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                              ->andWhere(['OR',['!=', 'a.status_category_type_id', $det_cat_type],
                                   ['!=', 'a.status_category_type_id', $det_disc_type],
                                   ['!=', 'a.status_category_type_id', $det_long_absent]]);
                       //echo "<br>".$query_stu->createCommand()->getRawSql(); exit;
                              $stu_count = $query_stu->createCommand()->queryAll();
                               $STRENGHT_NOT=$stu_count[0]['count']; 

                           

                        $k=0;$partical_wd_count=0; $full_wd_count=0;
                        foreach ($wd_stu_details as $wd_stu_list) 
                        {
                             $query_subject = new Query();
                                $query_subject->select(['count(distinct subject_map_id) as count'])
                                                ->from('coe_student_mapping a')
                                                ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                                                 ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                                                ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id'],'sub.semester'=>$semester])
                                                ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']]);
                               // echo "<br>".$query_subject->createCommand()->getRawSql(); exit;
                            
                                 $sub_count = $query_subject->createCommand()->queryAll();
                                  $subject_count=$sub_count[0]['count']; 

                             $query_stu_subject = new Query();
                             $query_stu_subject->select(['count(distinct subject_map_id) as count'])
                                        ->from('coe_student_mapping a')
                                         ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                                        ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id']])
                                        ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                                        ->andWhere(['=', 'e.withdraw', 'wd']);
                            // if($k==0)
                            // {
                            //     echo "<br>".$query_stu_subject->createCommand()->getRawSql(); 
                            // }
                            // echo "<br>".$wd_stu_list['student_map_id'];
                            $sub_stu_count = $query_stu_subject->createCommand()->queryAll();
                            $subject_stu_count=$sub_stu_count[0]['count']; 

                            if($subject_count==$subject_stu_count && $subject_stu_count!=0)
                            {
                                $full_wd_count=$full_wd_count+1;
                            }
                            elseif($subject_count>$subject_stu_count && $subject_stu_count!=0)
                            {
                                $partical_wd_count=$partical_wd_count+1;
                            }
                        $k++;}
                        //exit;


                    if($full_wd_count>0)
                    {
                        $STRENGHT_NOT_wd = $STRENGHT_NOT-$full_wd_count;
                        
                    }
                    else
                    {
                        $STRENGHT_NOT_wd=$STRENGHT_NOT;
                       
                    }
                    $pass_count_disp_wd = $pass_count_disp;//-$full_wd_count;

                    $total_strength_active +=$STRENGHT_NOT;
                    $total_strength +=$STRENGHT;

                    $total_strength_active_wd +=$STRENGHT_NOT_wd;

                    if($deg['degree_type']=='UG')
                    {
                        
                        $ug_strength += $STRENGHT;
                        $ug_reg += $STRENGHT_NOT;
                        $ug_pass += $pass_count_disp;

                        $ug_reg_wd+=$STRENGHT_NOT_wd;
                        $ug_pass_wd += $pass_count_disp_wd;
                       
                        $ug_p_wd_count=$ug_p_wd_count+$partical_wd_count;
                        $ug_f_wd_count=$ug_f_wd_count+$full_wd_count;
                    }
                    else
                    {

                        $pg_strength +=  $STRENGHT;
                        $pg_reg += $STRENGHT_NOT;
                        $pg_pass_count += $pass_count_disp;

                        $pg_reg_wd += $STRENGHT_NOT_wd;
                        $pg_pass_count_wd += $pass_count_disp_wd;

                        $pg_p_wd_count=$pg_p_wd_count+$partical_wd_count;
                        $pg_f_wd_count=$pg_f_wd_count+$full_wd_count;

                    }
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        
                         //$data .='<td align="center"><b>'.$ug_strength.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_p_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_f_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg_wd.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_pass_wd.'</b></td>';
                         
                         $data .='<td align="center"><b>'.round( (($ug_pass_wd / $ug_reg_wd) * 100),2).'</b></td></tr>';

                         $data .='<tr><td>'.$sn_no.'</td>';
                         $data .='<td>'.$batch_anme.'</td>'; 
                         $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                         //$data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center"><b>'.$partical_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$full_wd_count.'</b></td>';
                         $data .='<td align="center">'.$STRENGHT_NOT_wd.'</td>';
                         $data .='<td align="center">'.$pass_count_disp_wd.'</td>';
                         $pass_percent = ($pass_count_disp_wd / $STRENGHT_NOT_wd) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                         
                    }
                    else 
                    {
                        // $data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center"><b>'.$partical_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$full_wd_count.'</b></td>';
                          $data .='<td align="center">'.$STRENGHT_NOT_wd.'</td>';
                         $data .='<td align="center">'.$pass_count_disp_wd.'</td>';
                         $pass_percent = ($pass_count_disp_wd / $STRENGHT_NOT_wd) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                    }
                    $sn_no++;$i++;
                    if($pass_count_disp_wd!='--')
                    {
                        $total_pass_wd +=$pass_count_disp_wd;
                    }
                    $prev_deg_name = $deg['degree_type'];  
                }
               
                // Display PG Data
                $pg_reg = $pg_reg==0 ? 0: $pg_reg;
                 $data .='<tr><td colspan=3 align="center"> <b> TOTAL PG</b></td>';
                // $data .='<td align="center"><b>'.$pg_strength.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_p_wd_count.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_f_wd_count.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg_wd.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_pass_count_wd.'</b></td>';
                  $pg_reg_wd = $pg_reg_wd==0 ? 1: $pg_reg_wd;
                 $data .='<td align="center"><b>'.round( (($pg_pass_count_wd / $pg_reg_wd) * 100),2).'</b></td></tr>';
                
                 $tot_p_wd_count=$pg_p_wd_count+$ug_p_wd_count;
                $tot_wd_full_count=$pg_f_wd_count+$ug_f_wd_count;

                $data .='
                <tr>
                    <td colspan=3><b> TOTAL UG & PG </b></td>
                    
                    <td align="center"><b>'.$total_strength_active.'</b></td>
                     <td align="center"><b>'.$tot_p_wd_count.'</b></td>
                    <td align="center"><b>'.$tot_wd_full_count.'</b></td>
                    <td align="center"><b>'.$total_strength_active_wd.'</b></td>
                    <td align="center"><b>'.$total_pass_wd.'</b></td>
                    <td><b>'.round((($total_pass_wd/$total_strength_active_wd)*100),2).'</b></td>
                </tr>';//<td align="center"><b>'.$total_strength.'</b></td>
               
                $data .= '</tbody></table>';
                if (isset($_SESSION['mark_percent_print'])) {
                    unset($_SESSION['mark_percent_print']);
                }
                $_SESSION['mark_percent_print'] = $data;
                return $data;
            }
            else
            {
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                
                $data = '<table width="100%" id="checkAllFeet" border=1  align="center" ><tbody align="center">';
                $data .= '<tr>
                            <td colspan=7 align="center"> 
                                <center><b><font size="4px">'.$org_name.'</font></b></center>
                                <center><b><font size="4px">Office of the Controller of the Examinations</font></b></center>
                                <center>Consolidated Results '.$MON_name->description."-".$BAT_name->batch_name.' Examinations</center>
                                <center>' . $BAT_name->batch_name . ' BATCH</center> 
                            </td>
                        </tr>';
                $data .= '<tr>
                            <td colspan=7 align="center"><b>Mark Percent : ' . $_POST['year'] . ' ' . $month . '
                            SEM : '.$semester.'</b></td>
                        </tr>';
               

                $data .= '<tr>
                            <td align="center"><b>SNO</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH) . '</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . '</b></td>
                            
                            <td align="center">REGISTERED</td>
                            <td align="center">PASS COUNT</td>
                            <td align="center">PASS %</td>
                        </tr>';//<td align="center">TOTAL STRENGTH</td>

                $var_change = $stu_tot_value;
                $sn_no = 1;
                $i = $total_pass = $total_strength_active = $ug_strength = $ug_reg = $ug_pass = $pg_strength = $pg_reg = $pg_pass_count =  $total_strength = $total_fail =0;

                $prev_deg_name = '';
              
                foreach ($var_change as $key => $deg) 
                {               
                    
                    $batch_anme = $deg['batch_name']; 
                    if($i!=0)
                    {
                        $batch_anme = ',,';
                    }


                  
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        $data .='<tr><td colspan=3 align="center"> <b>TOTAL UG</b></td>';
                    }
                    else
                    {
                        $data .='<tr><td>'.$sn_no.'</td>';
                        $data .='<td>'.$batch_anme.'</td>'; 
                        $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                    }
                    

                    $query_map_id = new Query();
                    $query_map_id->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','c.semester'=>$semester])
                         ->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
                    $students_map_id_pass = $query_map_id->createCommand()->queryScalar();

                    $pass_count_disp = isset($students_map_id_pass)?$students_map_id_pass:'0';
            

                    $query_strength = new Query();
                    $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$semester]);
                   
                    $STRENGHT = $query_strength->createCommand()->queryScalar();

                       $query_stu = new Query();
                        $query_stu->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                              ->andWhere(['OR',['!=', 'a.status_category_type_id', $det_cat_type],
                                   ['!=', 'a.status_category_type_id', $det_disc_type],
                                   ['!=', 'a.status_category_type_id', $det_long_absent]]);
                       //echo "<br>".$query_stu->createCommand()->getRawSql(); exit;
                              $stu_count = $query_stu->createCommand()->queryAll();
                               $STRENGHT_NOT=$stu_count[0]['count']; 

                   


                    $total_strength_active +=$STRENGHT_NOT;
                    $total_strength +=$STRENGHT;

                    if($deg['degree_type']=='UG')
                    {
                        
                        $ug_strength += $STRENGHT;
                        $ug_reg += $STRENGHT_NOT;
                        $ug_pass += $pass_count_disp;
                       
                    }
                    else
                    {

                        $pg_strength +=  $STRENGHT;
                        $pg_reg += $STRENGHT_NOT;
                        $pg_pass_count += $pass_count_disp;

                    }
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        
                       //  $data .='<td align="center"><b>'.$ug_strength.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_pass.'</b></td>';
                         
                         $data .='<td align="center"><b>'.round( (($ug_pass / $ug_reg) * 100),2).'</b></td></tr>';

                         $data .='<tr><td>'.$sn_no.'</td>';
                         $data .='<td>'.$batch_anme.'</td>'; 
                         $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                         //$data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center">'.$pass_count_disp.'</td>';
                         $pass_percent = ($pass_count_disp / $STRENGHT_NOT) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                         
                    }
                    else 
                    {
                        // $data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center">'.$pass_count_disp.'</td>';
                         $pass_percent = ($pass_count_disp / $STRENGHT_NOT) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                    }
                    $sn_no++;$i++;
                    if($pass_count_disp!='--')
                    {
                        $total_pass +=$pass_count_disp;
                    }
                    $prev_deg_name = $deg['degree_type'];  
                }
               
                // Display PG Data
                $pg_reg = $pg_reg==0 ? 0: $pg_reg;
                 $data .='<tr><td colspan=3 align="center"> <b> TOTAL PG</b></td>';
                 //$data .='<td align="center"><b>'.$pg_strength.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_pass_count.'</b></td>';
                  $pg_reg = $pg_reg==0 ? 1: $pg_reg;
                 $data .='<td align="center"><b>'.round( (($pg_pass_count / $pg_reg) * 100),2).'</b></td></tr>';
                

                $data .='
                <tr>
                    <td colspan=3><b> TOTAL UG & PG </b></td>
                   
                    <td align="center"><b>'.$total_strength_active.'</b></td>
                    <td align="center"><b>'.$total_pass.'</b></td>
                    <td><b>'.round((($total_pass/$total_strength_active)*100),2).'</b></td>
                </tr>';// <td align="center"><b>'.$total_strength.'</b></td>
               
                $data .= '</tbody></table>';
                if (isset($_SESSION['mark_percent_print'])) {
                    unset($_SESSION['mark_percent_print']);
                }
                $_SESSION['mark_percent_print'] = $data;
                return $data;
            }
        } else 
        {
            return 0;
        }
    }
    
    public function actionMarkPercentPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_percent_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Mark Percent Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }',
            'options' => ['title' => 'Mark Percent Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Mark Percent Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelMarkpercent()
    {
        
            $content = $_SESSION['mark_percent_print'];
            
        $fileName = "Mark Percent Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }



    public function actionMarkPercenttemp()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Mark Percent ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('mark-percenttemp', [
            'model' => $model,
            'markentrymaster' =>$markentrymaster,
        ]);
    }

    public function actionMarkpercenttempreport()
    {

        $semester= $_POST['semester'];
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_long_absent = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Long Absent%'")->queryScalar();
        
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $failed_stus = Yii::$app->db->createCommand('SELECT student_map_id,withdraw FROM coe_mark_entry_master_temp where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and mark_type="27" and year_of_passing="" ')->queryAll();

        $stud_count = count($failed_stus);

        $notIn = array_filter(['']);
        foreach ($failed_stus as $key => $fails) {
            if($fails['withdraw']!='wd')
            {
                $notIn[$fails['student_map_id']]=$fails['student_map_id'];
            }
        }
        $BAT_name = Batch::findOne($_POST['batch']);
        $MON_name = Categorytype::findOne($_POST['month']);
         $notIn = array_filter($notIn);
           
            $query_stu_tot = new Query();
                        $query_stu_tot->select(['count(distinct student_map_id) as count','course_batch_mapping_id','programme_code','degree_code','batch_name','degree_type'])
                            ->from('coe_student_mapping a')
                             ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                        ->join('JOIN', 'coe_bat_deg_reg c', 'c.coe_bat_deg_reg_id=a.course_batch_mapping_id')
                        ->join('JOIN', 'coe_batch d', 'd.coe_batch_id=c.coe_batch_id')
                        ->join('JOIN', 'coe_degree f', 'f.coe_degree_id=c.coe_degree_id')
                        ->join('JOIN', 'coe_programme g', 'g.coe_programme_id=c.coe_programme_id')
                        ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['d.coe_batch_id' => $_POST['batch'],'c.coe_batch_id' => $_POST['batch'],'e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester, 'b.student_status' => 'Active'])
                            ->andWhere(['<>', 'status_category_type_id', $det_long_absent])
                            ->andWhere(['<>', 'programme_code', 'PHD'])
                        ->andWhere(['<>', 'status_category_type_id', $det_long_absent])
                        ->groupBy('course_batch_mapping_id')
                        ->orderBy('degree_code,programme_code');
        //echo "<br>".$query_stu_tot->createCommand()->getRawSql(); exit;

           $stu_tot_value = $query_stu_tot->createCommand()->queryAll();
        if (count($stu_tot_value) > 0) 
        {

            $query_stu_wd = new Query();
            $query_stu_wd->select(['distinct (student_map_id)'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                            ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                              ->andWhere(['=', 'e.withdraw', 'wd']);
                              
            //echo "<br>".$query_stu_wd->createCommand()->getRawSql(); exit;
                     $wd_stu_details = $query_stu_wd->createCommand()->queryAll();
                      $tot_wd_count=count($wd_stu_details); 


              
            $fail_array = array();
           
            if($tot_wd_count>0)
            {

                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                
                $data = '<table width="100%" id="checkAllFeet" border=1  align="center" ><tbody align="center">';
                $data .= '<tr>
                            <td colspan=10 align="center"> 
                                <center><b><font size="4px">'.$org_name.'</font></b></center>
                                <center><b><font size="4px">Office of the Controller of the Examinations</font></b></center>
                                <center>Consolidated Results '.$MON_name->description."-".$BAT_name->batch_name.' Examinations</center>
                                <center>' . $BAT_name->batch_name . ' BATCH</center> 
                            </td>
                        </tr>';
                $data .= '<tr>
                            <td colspan=10 align="center"><b>Mark Percent : ' . $_POST['year'] . ' ' . $month . ' SEM : '.$semester.'
                            </b></td>
                        </tr>';
               

                $data .= '<tr>
                            <td align="center"><b>SNO</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH) . '</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . '</b></td>
                            
                            <td align="center">REGISTERED</td>
                            <td align="center">TOTAL PARTIAL WD</td>
                            <td align="center">TOTAL WD ALL</td>
                            <td align="center">ACTIVE REGISTERED</td>
                            <td align="center">PASS COUNT</td>
                            <td align="center">PASS %</td>
                        </tr>';//<td align="center">TOTAL STRENGTH</td>

                $var_change = $stu_tot_value;
                $sn_no = 1;
                $i = $total_pass = $total_strength_active = $ug_strength = $ug_reg = $ug_pass = $pg_strength = $pg_reg = $pg_pass_count =  $total_strength = $total_fail =0;

                $total_pass_wd = $total_strength_active_wd = $ug_strength_wd = $ug_reg_wd = $ug_pass_wd = $pg_strength_wd = $pg_reg_wd = $pg_pass_count_wd =  $total_strength_wd = $STRENGHT_NOT_wd = $pass_count_disp_wd = $total_fail_wd =0;

                $prev_deg_name = '';
               
                $ug_p_wd_count=0;
                $pg_p_wd_count=0;
                
                $ug_f_wd_count=0;
                $pg_f_wd_count=0;
                
                $tot_p_wd_count=0;
                $tot_wd_full_count=0;
                foreach ($var_change as $key => $deg) 
                {               
                    
                    $batch_anme = $deg['batch_name']; 
                    if($i!=0)
                    {
                        $batch_anme = ',,';
                    }
                    
                     if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        $data .='<tr><td colspan=3 align="center"> <b>TOTAL UG</b></td>';
                    }
                    else
                    {
                        $data .='<tr><td>'.$sn_no.'</td>';
                        $data .='<td>'.$batch_anme.'</td>'; 
                        $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                    }
                   
                      $query_map_id = new Query();
                    $query_map_id->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$semester])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
                    $students_map_id_pass = $query_map_id->createCommand()->queryScalar();

                    $pass_count_disp = isset($students_map_id_pass)?$students_map_id_pass:'0';
                  

                   $query_strength = new Query();
                    $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$semester]);
                   
                    $STRENGHT = $query_strength->createCommand()->queryScalar();

                       $query_stu = new Query();
                        $query_stu->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                              ->andWhere(['OR',['!=', 'a.status_category_type_id', $det_cat_type],
                                   ['!=', 'a.status_category_type_id', $det_disc_type],
                                   ['!=', 'a.status_category_type_id', $det_long_absent]]);
                       //echo "<br>".$query_stu->createCommand()->getRawSql(); exit;
                              $stu_count = $query_stu->createCommand()->queryAll();
                               $STRENGHT_NOT=$stu_count[0]['count']; 

                           

                        $k=0;$partical_wd_count=0; $full_wd_count=0;
                        foreach ($wd_stu_details as $wd_stu_list) 
                        {
                             $query_subject = new Query();
                                $query_subject->select(['count(distinct subject_map_id) as count'])
                                                ->from('coe_student_mapping a')
                                                ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                                                 ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                                                ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id'],'sub.semester'=>$semester])
                                                ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']]);
                               // echo "<br>".$query_subject->createCommand()->getRawSql(); exit;
                            
                                 $sub_count = $query_subject->createCommand()->queryAll();
                                  $subject_count=$sub_count[0]['count']; 

                             $query_stu_subject = new Query();
                             $query_stu_subject->select(['count(distinct subject_map_id) as count'])
                                        ->from('coe_student_mapping a')
                                         ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                                        ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'e.student_map_id'=>$wd_stu_list['student_map_id']])
                                        ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                                        ->andWhere(['=', 'e.withdraw', 'wd']);
                            // if($k==0)
                            // {
                            //     echo "<br>".$query_stu_subject->createCommand()->getRawSql(); 
                            // }
                            // echo "<br>".$wd_stu_list['student_map_id'];
                            $sub_stu_count = $query_stu_subject->createCommand()->queryAll();
                            $subject_stu_count=$sub_stu_count[0]['count']; 

                            if($subject_count==$subject_stu_count && $subject_stu_count!=0)
                            {
                                $full_wd_count=$full_wd_count+1;
                            }
                            elseif($subject_count>$subject_stu_count && $subject_stu_count!=0)
                            {
                                $partical_wd_count=$partical_wd_count+1;
                            }
                        $k++;}
                        //exit;


                    if($full_wd_count>0)
                    {
                        $STRENGHT_NOT_wd = $STRENGHT_NOT-$full_wd_count;
                        
                    }
                    else
                    {
                        $STRENGHT_NOT_wd=$STRENGHT_NOT;
                       
                    }
                    $pass_count_disp_wd = $pass_count_disp;//-$full_wd_count;

                    $total_strength_active +=$STRENGHT_NOT;
                    $total_strength +=$STRENGHT;

                    $total_strength_active_wd +=$STRENGHT_NOT_wd;

                    if($deg['degree_type']=='UG')
                    {
                        
                        $ug_strength += $STRENGHT;
                        $ug_reg += $STRENGHT_NOT;
                        $ug_pass += $pass_count_disp;

                        $ug_reg_wd+=$STRENGHT_NOT_wd;
                        $ug_pass_wd += $pass_count_disp_wd;
                       
                        $ug_p_wd_count=$ug_p_wd_count+$partical_wd_count;
                        $ug_f_wd_count=$ug_f_wd_count+$full_wd_count;
                    }
                    else
                    {

                        $pg_strength +=  $STRENGHT;
                        $pg_reg += $STRENGHT_NOT;
                        $pg_pass_count += $pass_count_disp;

                        $pg_reg_wd += $STRENGHT_NOT_wd;
                        $pg_pass_count_wd += $pass_count_disp_wd;

                        $pg_p_wd_count=$pg_p_wd_count+$partical_wd_count;
                        $pg_f_wd_count=$pg_f_wd_count+$full_wd_count;

                    }
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        
                         //$data .='<td align="center"><b>'.$ug_strength.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_p_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_f_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg_wd.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_pass_wd.'</b></td>';
                         
                         $data .='<td align="center"><b>'.round( (($ug_pass_wd / $ug_reg_wd) * 100),2).'</b></td></tr>';

                         $data .='<tr><td>'.$sn_no.'</td>';
                         $data .='<td>'.$batch_anme.'</td>'; 
                         $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                         //$data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center"><b>'.$partical_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$full_wd_count.'</b></td>';
                         $data .='<td align="center">'.$STRENGHT_NOT_wd.'</td>';
                         $data .='<td align="center">'.$pass_count_disp_wd.'</td>';
                         $pass_percent = ($pass_count_disp_wd / $STRENGHT_NOT_wd) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                         
                    }
                    else 
                    {
                        // $data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center"><b>'.$partical_wd_count.'</b></td>';
                         $data .='<td align="center"><b>'.$full_wd_count.'</b></td>';
                          $data .='<td align="center">'.$STRENGHT_NOT_wd.'</td>';
                         $data .='<td align="center">'.$pass_count_disp_wd.'</td>';
                         $pass_percent = ($pass_count_disp_wd / $STRENGHT_NOT_wd) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                    }
                    $sn_no++;$i++;
                    if($pass_count_disp_wd!='--')
                    {
                        $total_pass_wd +=$pass_count_disp_wd;
                    }
                    $prev_deg_name = $deg['degree_type'];  
                }
               
                // Display PG Data
                $pg_reg = $pg_reg==0 ? 0: $pg_reg;
                 $data .='<tr><td colspan=3 align="center"> <b> TOTAL PG</b></td>';
                // $data .='<td align="center"><b>'.$pg_strength.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_p_wd_count.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_f_wd_count.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg_wd.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_pass_count_wd.'</b></td>';
                  $pg_reg_wd = $pg_reg_wd==0 ? 1: $pg_reg_wd;
                 $data .='<td align="center"><b>'.round( (($pg_pass_count_wd / $pg_reg_wd) * 100),2).'</b></td></tr>';
                
                 $tot_p_wd_count=$pg_p_wd_count+$ug_p_wd_count;
                $tot_wd_full_count=$pg_f_wd_count+$ug_f_wd_count;

                $data .='
                <tr>
                    <td colspan=3><b> TOTAL UG & PG </b></td>
                    
                    <td align="center"><b>'.$total_strength_active.'</b></td>
                     <td align="center"><b>'.$tot_p_wd_count.'</b></td>
                    <td align="center"><b>'.$tot_wd_full_count.'</b></td>
                    <td align="center"><b>'.$total_strength_active_wd.'</b></td>
                    <td align="center"><b>'.$total_pass_wd.'</b></td>
                    <td><b>'.round((($total_pass_wd/$total_strength_active_wd)*100),2).'</b></td>
                </tr>';//<td align="center"><b>'.$total_strength.'</b></td>
               
                $data .= '</tbody></table>';
                if (isset($_SESSION['mark_percent_print'])) {
                    unset($_SESSION['mark_percent_print']);
                }
                $_SESSION['mark_percent_print'] = $data;
                return $data;
            }
            else
            {
                require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                
                $data = '<table width="100%" id="checkAllFeet" border=1  align="center" ><tbody align="center">';
                $data .= '<tr>
                            <td colspan=7 align="center"> 
                                <center><b><font size="4px">'.$org_name.'</font></b></center>
                                <center><b><font size="4px">Office of the Controller of the Examinations</font></b></center>
                                <center>Consolidated Results '.$MON_name->description."-".$BAT_name->batch_name.' Examinations</center>
                                <center>' . $BAT_name->batch_name . ' BATCH</center> 
                            </td>
                        </tr>';
                $data .= '<tr>
                            <td colspan=7 align="center"><b>Mark Percent : ' . $_POST['year'] . ' ' . $month . '
                            SEM : '.$semester.'</b></td>
                        </tr>';
               

                $data .= '<tr>
                            <td align="center"><b>SNO</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_BATCH) . '</b></td>
                            <td align="center"><b>' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . '</b></td>
                            
                            <td align="center">REGISTERED</td>
                            <td align="center">PASS COUNT</td>
                            <td align="center">PASS %</td>
                        </tr>';//<td align="center">TOTAL STRENGTH</td>

                $var_change = $stu_tot_value;
                $sn_no = 1;
                $i = $total_pass = $total_strength_active = $ug_strength = $ug_reg = $ug_pass = $pg_strength = $pg_reg = $pg_pass_count =  $total_strength = $total_fail =0;

                $prev_deg_name = '';
              
                foreach ($var_change as $key => $deg) 
                {               
                    
                    $batch_anme = $deg['batch_name']; 
                    if($i!=0)
                    {
                        $batch_anme = ',,';
                    }


                  
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        $data .='<tr><td colspan=3 align="center"> <b>TOTAL UG</b></td>';
                    }
                    else
                    {
                        $data .='<tr><td>'.$sn_no.'</td>';
                        $data .='<td>'.$batch_anme.'</td>'; 
                        $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                    }
                    

                    $query_map_id = new Query();
                    $query_map_id->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','c.semester'=>$semester])
                         ->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
                    $students_map_id_pass = $query_map_id->createCommand()->queryScalar();

                    $pass_count_disp = isset($students_map_id_pass)?$students_map_id_pass:'0';
            

                    $query_strength = new Query();
                    $query_strength->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $deg['course_batch_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$semester]);
                   
                    $STRENGHT = $query_strength->createCommand()->queryScalar();

                       $query_stu = new Query();
                        $query_stu->select(['count(distinct student_map_id) as count'])
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_mark_entry_master_temp e', 'e.student_map_id=a.coe_student_mapping_id')
                             ->join('JOIN', 'coe_subjects_mapping sub', 'sub.coe_subjects_mapping_id=e.subject_map_id')
                            ->where(['e.month'=>$_POST['month'],'e.mark_type'=>27,'e.year'=>$_POST['year'],'sub.semester'=>$semester])
                            ->andwhere(['a.course_batch_mapping_id'=>$deg['course_batch_mapping_id']])
                              ->andWhere(['OR',['!=', 'a.status_category_type_id', $det_cat_type],
                                   ['!=', 'a.status_category_type_id', $det_disc_type],
                                   ['!=', 'a.status_category_type_id', $det_long_absent]]);
                       //echo "<br>".$query_stu->createCommand()->getRawSql(); exit;
                              $stu_count = $query_stu->createCommand()->queryAll();
                               $STRENGHT_NOT=$stu_count[0]['count']; 

                   


                    $total_strength_active +=$STRENGHT_NOT;
                    $total_strength +=$STRENGHT;

                    if($deg['degree_type']=='UG')
                    {
                        
                        $ug_strength += $STRENGHT;
                        $ug_reg += $STRENGHT_NOT;
                        $ug_pass += $pass_count_disp;
                       
                    }
                    else
                    {

                        $pg_strength +=  $STRENGHT;
                        $pg_reg += $STRENGHT_NOT;
                        $pg_pass_count += $pass_count_disp;

                    }
                    if($prev_deg_name!='' && $prev_deg_name!=$deg['degree_type'])
                    {   
                        
                       //  $data .='<td align="center"><b>'.$ug_strength.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_reg.'</b></td>';
                         $data .='<td align="center"><b>'.$ug_pass.'</b></td>';
                         
                         $data .='<td align="center"><b>'.round( (($ug_pass / $ug_reg) * 100),2).'</b></td></tr>';

                         $data .='<tr><td>'.$sn_no.'</td>';
                         $data .='<td>'.$batch_anme.'</td>'; 
                         $data .='<td align="center">'.$deg['degree_code']."-".$deg['programme_code'].'</td>';
                         //$data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center">'.$pass_count_disp.'</td>';
                         $pass_percent = ($pass_count_disp / $STRENGHT_NOT) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                         
                    }
                    else 
                    {
                        // $data .='<td align="center">'.$STRENGHT.'</td>';
                         $data .='<td align="center">'.$STRENGHT_NOT.'</td>';
                         $data .='<td align="center">'.$pass_count_disp.'</td>';
                         $pass_percent = ($pass_count_disp / $STRENGHT_NOT) * 100;
                         $data .='<td align="center">'.round($pass_percent,2).'</td></tr>';
                    }
                    $sn_no++;$i++;
                    if($pass_count_disp!='--')
                    {
                        $total_pass +=$pass_count_disp;
                    }
                    $prev_deg_name = $deg['degree_type'];  
                }
               
                // Display PG Data
                $pg_reg = $pg_reg==0 ? 0: $pg_reg;
                 $data .='<tr><td colspan=3 align="center"> <b> TOTAL PG</b></td>';
                 //$data .='<td align="center"><b>'.$pg_strength.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_reg.'</b></td>';
                 $data .='<td align="center"><b>'.$pg_pass_count.'</b></td>';
                  $pg_reg = $pg_reg==0 ? 1: $pg_reg;
                 $data .='<td align="center"><b>'.round( (($pg_pass_count / $pg_reg) * 100),2).'</b></td></tr>';
                

                $data .='
                <tr>
                    <td colspan=3><b> TOTAL UG & PG </b></td>
                   
                    <td align="center"><b>'.$total_strength_active.'</b></td>
                    <td align="center"><b>'.$total_pass.'</b></td>
                    <td><b>'.round((($total_pass/$total_strength_active)*100),2).'</b></td>
                </tr>';// <td align="center"><b>'.$total_strength.'</b></td>
               
                $data .= '</tbody></table>';
                if (isset($_SESSION['mark_percenttemp_print'])) {
                    unset($_SESSION['mark_percenttemp_print']);
                }
                $_SESSION['mark_percenttemp_print'] = $data;
                return $data;
            }
        } else 
        {
            return 0;
        }
    }

    public function actionMarkPercenttempPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['mark_percenttemp_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Mark Percent Temp.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }',
            'options' => ['title' => 'Mark Percent Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Mark Percent Temp' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelMarkpercenttemp()
    {
        
            $content = $_SESSION['mark_percenttemp_print'];
            
        $fileName = "Mark Percent Temp " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionStudentResultExporttemp()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $galley = new HallAllocate();
        Yii::$app->ShowFlashMessages->setMsg('Welcome','Welcome to Sudent Result Export');
        return $this->render('student-result-exporttemp', [
        'model' => $model,'galley' => $galley,
           ]);
    }

    public function actionGetstudentresultexporttemp() 
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
         $year = Yii::$app->request->post('year');
         $month = Yii::$app->request->post('month');

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
            $withheld_list = Yii::$app->db->createCommand('SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master_temp WHERE month="'.$month.'" AND year="'.$year.'" AND withheld="w" ')->queryAll();
            $withheld = [];
            foreach ($withheld_list as $key => $value) {
                $withheld[$value['id']]=$value['id'];
            }

            $internet_copy_query = new Query();

            $internet_copy_query->select('c.register_number,c.name,c.dob,e.subject_code,e.ESE_max,e.credit_points,e.ESE_min,e.CIA_max,e.CIA_min,a.subject_map_id,student_map_id,d.semester,a.CIA,a.ESE,a.total,a.grade_point,a.result,a.withheld,a.grade_name,d.paper_type_id,a.mark_type,g.batch_name,h.programme_code, b.status_category_type_id, x.grade_point_to, x.grade_point_from,f.coe_bat_deg_reg_id')
            ->from('coe_mark_entry_master_temp a')
            ->join('JOIN','coe_student_mapping b','a.student_map_id=b.coe_student_mapping_id')
            ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
            ->join('JOIN','coe_subjects_mapping d','a.subject_map_id=d.coe_subjects_mapping_id')
            ->join('JOIN','coe_subjects e','d.subject_id=e.coe_subjects_id')
             ->join('JOIN','coe_bat_deg_reg f','f.coe_bat_deg_reg_id=d.batch_mapping_id')
              ->join('JOIN','coe_batch g','g.coe_batch_id=f.coe_batch_id')
               ->join('JOIN', 'coe_regulation as x', 'x.coe_batch_id=g.coe_batch_id')
               ->join('JOIN','coe_programme  h','h.coe_programme_id=f.coe_programme_id')
                ->join('JOIN','coe_degree i','i.coe_degree_id=f.coe_degree_id')

            ->join('JOIN','coe_category_type xyz','xyz.coe_category_type_id = status_category_type_id')
            ->where(['a.year'=>$year,'a.month'=>$month,'a.mark_type'=>27])            
            //->andWhere(['NOT IN', "a.student_map_id", $withheld])
            ->andWhere(['<>', 'd.paper_type_id', 105])
            ->andWhere(['<>', 'd.paper_type_id', 106])
            ->andWhere(['<>', 'status_category_type_id', $det_disc_type])
            ->groupBy('a.student_map_id,a.subject_map_id')
            ->orderBy('f.coe_programme_id,c.register_number'); 
            $internet_copy = $internet_copy_query->createCommand()->queryAll();

            //print_r($internet_copy);exit;

           /* $query_man = new  Query();
              $query_man->select(['CONCAT(H.subject_code,"-",G.sub_cat_code) as subject_code','A.name','A.register_number','A.dob','credit_points','H.ESE_min','H.ESE_max','H.CIA_max','H.CIA_min','F.subject_map_id','student_map_id','F.ESE','F.CIA','F.total','F.result','F.semester','F.withheld','F.grade_name','F.grade_point','G.paper_type_id','F.mark_type','I.batch_name','E.programme_code','B.status_category_type_id','x.grade_point_to','x.grade_point_from','C.coe_bat_deg_reg_id'])
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                 ->join('JOIN', 'coe_regulation as x', 'x.coe_batch_id=x.coe_batch_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man->Where(['F.year' => $year, 'F.month' => $month, 'A.student_status' => 'Active','G.is_additional'=>'NO','F.mark_type'=>27])
                ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                //->andWhere(['NOT IN', "F.student_map_id", $withheld]);
            $query_man->groupBy('F.student_map_id,F.subject_map_id')
                ->orderBy('A.register_number');
               
            $mandatory_statement = $query_man->createCommand()->queryAll();
            //print_r($mandatory_statement );exit;
            if(!empty($mandatory_statement))
            {
                $internet_copy = array_merge($internet_copy,$mandatory_statement);
            }*/
            
            //array_multisort(array_column($internet_copy, 'semester'),  SORT_ASC, $internet_copy);
            //array_multisort(array_column($internet_copy, 'coe_bat_deg_reg_id,register_number'),  SORT_ASC, $internet_copy);

            if(isset($internet_copy) && !empty($internet_copy))
            {
               
                  $data ='<table border=1 width="100%" class="table table-responsive table-striped" align="center" ><tbody align="center">'; 
    
                    $data.='<tr>
                                 <th><center>Sno</center></th>
                                         <th><center>Batch</center></th>
                                         <th><center>Programme</center></th>                       
                               <th><center>RegisterNo</center></th>
                               <th><center>Status</center></th>
                               <th><center>Semester</center></th>
                               <th><center>'.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT).'Code</center></th>
                               <th><center>CIA Marks</center></th>
                               <th><center>ESE Marks</center></th>
                               <th><center>Total</center></th>
                               <th><center>Result</center></th>
                               <th><center>Credit Points</center></th>
                               <th><center>Grade Range</center></th>
                               <th><center>Grade Point</center></th>
                                <th><center>Subject Type</center></th>                                    
                                  <th><center>Boolet No.</center></th>
                                <th><center>AV No.</center></th>  
                                 <th><center>ESE 100</center></th>                     
                            </tr>';    

                    $prev_value="";
                    $prev_value_br="";
                    $sn=1;
                    foreach($internet_copy as $markdetails)
                    {
                        $curr_value=$markdetails['register_number'];
                        $curr_value_br=$markdetails['register_number'];
                         $subject_type = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id =".$markdetails['paper_type_id']."")->queryScalar();
                         $exam_type = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id =".$markdetails['mark_type']."")->queryScalar();
                          $sudent_type = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id =".$markdetails['status_category_type_id']."")->queryScalar();
                         $rejoin="Detain/Rejoin";

                        $stu_withheld = 1;
                        $withheld_list = MarkEntryMaster::findOne(['month'=>$_POST['month'],'year'=>$_POST['year'],'student_map_id'=>$markdetails['student_map_id'],'withheld'=>'w']);
                        $stu_withheld = !empty($withheld_list)?2:1;
                        $ese100 = MarkEntry::findOne(['month'=>$_POST['month'],'year'=>$_POST['year'],'student_map_id'=>$markdetails['student_map_id'],'subject_map_id'=>$markdetails['subject_map_id'],'category_type_id'=>89]);
                        $data.='<tr>';
                        $data.='<td>'.$sn.'</td>';
                        $data.='<td>'.$markdetails['batch_name'].'</td>';
                        $data.='<td>'.$markdetails['programme_code'].'</td>';
                                                    
                                                    

                        $data.='<td>'.$markdetails['register_number'].'</td>';
                        
                        $stu_map = StuInfo::findOne(['prev_reg'=>$markdetails['register_number']]);
                         
                         if(!empty($stu_map))
                         {
                         
                         $sudent_type ="Detain/Rejoin";
                        
                         $data.='<td>'.$sudent_type.'</td>';


                         }
                         else
                         {
                        
                        $data.='<td>'.$sudent_type.'</td>';
                         
                         }
                        $data.='<td>'.$markdetails['semester'].'</td>';
                        $data.='<td>'.$markdetails['subject_code'].'</td>';
                        /*$data.='<td>'.$markdetails['CIA'].'</td>';
                        $data.='<td>'.$markdetails['ESE'].'</td>';
                        $data.='<td>'.$markdetails['total'].'</td>';
                        $data.='<td>'.$markdetails['result'].'</td>';*/
                        

                        if($markdetails['ESE_max']==0 && $markdetails['CIA_max']==0 && $markdetails['ESE_min']==0 && $markdetails['CIA_min']==0)
                        {

                            if($markdetails['result']=="Pass")
                           {
                            $data.='<td colspan=3>COMPLETED</td>';
                            $data.='<td>'.strtoupper($markdetails['result']).'</td>';
                            $data.='<td colspan=3>COMPLETED</td>';
                            $data.='<td>'.$subject_type.'</td>';
                               $data.='<td></td><td></td><td></td>';
                         }

                         else
                         {
                             
                            $data.='<td colspan=3> NOT COMPLETED</td>';
                            $data.='<td>'.strtoupper($markdetails['result']).'</td>';
                            $data.='<td colspan=3> NOT COMPLETED</td>';
                            $data.='<td>'.$subject_type.'</td>';                          
                              $data.='<td></td><td></td><td></td>';


                         }
                            
                        }
                        else
                        {
                            if($stu_withheld==2)
                            {
                                $ese_disp='-';
                                $res_dip='WITHHELD';
                                $grade_name='WH';
                                $grade_point = '0';
                                $total_disp=$markdetails['CIA'];
                            }
                            else
                            {
                                $ese_disp=$markdetails['ESE'];
                                $res_dip=strtoupper($markdetails['result']);
                                 if($markdetails['grade_name']=="O")
                                {

                                $temp='91-100';

                                }
                                elseif ($markdetails['grade_name']=="A+") 
                                {
                                   $temp='81-90';

                                }
                                elseif($markdetails['grade_name']=="A")
                                {

                                 $temp='71-80';

                                }
                                elseif ($markdetails['grade_name']=="B+") 
                                {
                                    $temp='61-70';
                                }
                                elseif ($markdetails['grade_name']=="B")
                                 {
                                    $temp='50-60';
                                }
                                else
                                {
                                $temp='0-49';

                                }




                                $grade_name = $markdetails['result']=='Absent' || $markdetails['result']=='ABSENT' || $markdetails['result']=='absent' ? 'AB' : strtoupper($temp);
                                $grade_point = $markdetails['grade_point'];
                                $total_disp=$markdetails['total'];
                                $paper_type_id=$subject_type;
                                $mark_type=$exam_type;
                            }
                            $data.='<td>'.$markdetails['CIA'].'</td>';
                            $data.='<td>'.$ese_disp.'</td>';
                            $data.='<td>'.$total_disp.'</td>';
                            $data.='<td>'.$res_dip.'</td>';
                            $data.='<td>'.$markdetails['credit_points'].'</td>';
                            $data.='<td>'.$grade_name.'</td>';
                            $data.='<td>'.$grade_point.'</td>';
                            $data.='<td>'.$paper_type_id.'</td>';

                            $get_dummyno = Yii::$app->db->createCommand("SELECT dummy_number FROM coe_dummy_number 
                            WHERE student_map_id=".$markdetails['student_map_id']." AND subject_map_id=".$markdetails['subject_map_id']." AND year=".$_POST['year']." AND month=".$_POST['month'])->queryone();

                            if(!empty($get_dummyno))
                            {
                                $get_avdetails = Yii::$app->db->createCommand("SELECT B.grand_total, B.booklet_sno,D.vanswer_packet_no FROM coe_val_barcode_verify_details B 
                                JOIN coe_val_barcode_verify C ON C.val_barecode_id=B.val_barecode_id 
                                JOIN coe_vanswer_packet D ON D.val_faculty_all_id=C.val_faculty_all_id 
                                WHERE B.dummy_number=".$get_dummyno['dummy_number'])->queryone();
                                if(!empty($get_avdetails))
                                {
                                    $data.='<td>'.$get_avdetails['booklet_sno'].'</td>';
                                    $data.='<td>AV-'.$get_avdetails['vanswer_packet_no'].'</td>';
                                    $data.='<td>'.$get_avdetails['grand_total'].'</td>';
                                }
                                else
                                {
                                    $data.='<td></td><td></td><td></td>';
                                }
                            }

                        }

                        
                        $data.='</tr>';  
                        $prev_value=$markdetails['register_number'];
                        $sn++;                    
                        
                    }
                    $data.='</tbody>';        
                    $data.='</table>';
                    if(isset($_SESSION['student_res_exporttemp'])){ unset($_SESSION['student_res_exporttemp']);}
                    $_SESSION['student_res_exporttemp'] = $data;
                    return $data;
            }   
            else
            {
                return 0;
            }

    }

    public function actionExcelExportStudentResulttemp()
    {
        
        $content = $_SESSION['student_res_exporttemp'];         
        $fileName =ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT).' RESULT TEMP'.date('y-M').'.xls';        
        $options = ['mimeType'=>'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
           
    }

    
     public function actionProgrammeanalysistemp()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('programmeanalysistemp', [
            'model' => $model,
        ]);
    }
    public function actionProgrammeresultanalysistemp()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $monthname = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();
        
                $year=$_POST['year'];
                $month=$_POST['month'];
                $bat_map_val=$_POST['batch_map_id'];
                
              $sem_calc = ConfigUtilities::SemCaluclation($year,$month,$bat_map_val);

              $failed_stus = Yii::$app->db->createCommand('SELECT student_map_id,withdraw FROM coe_mark_entry_master_temp where year="'.$_POST['year'].'" and month="'.$_POST['month'].'" and mark_type="27" and year_of_passing="" ')->queryAll();

        $stud_count = count($failed_stus);

        $notIn = array_filter(['']);
        foreach ($failed_stus as $key => $fails) {
            if($fails['withdraw']!='wd')
            {
                $notIn[$fails['student_map_id']]=$fails['student_map_id'];
            }
        }

        $notIn = array_filter($notIn);

        $semester = ConfigUtilities::SemCaluclation( $_POST['year'],$_POST['month'],$_POST['batch_map_id']);
        $query_map_id = new Query();
        $query_map_id->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['a.course_batch_mapping_id' => $_POST['batch_map_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'b.result'=>'Pass','b.mark_type'=>27,'c.semester'=>$sem_calc])->andWhere(['NOT IN', 'student_map_id', $notIn]);
                   //echo "<br>".$query_map_id->createCommand()->getRawSql(); exit;
        $students_map_id_pass = $query_map_id->createCommand()->queryScalar();

        $pass_count_disp = isset($students_map_id_pass)?$students_map_id_pass:'0';

        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => 'C']])
            ->andWhere(['NOT', ['grade_name' => 'U']])
            ->groupBy('grade_name')->orderBy('grade_point DESC');
        $grade_name = $query_gr->createCommand()->queryAll();
        $query_cr = new Query();
        $query_cr->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max,ESE_max,credit_points, paper_type_id')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master_temp c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->andWhere(['<>', 'paper_type_id', 122]);
        $subject_list = $query_cr->createCommand()->queryAll();
        $total_pass_stu=0; $total_enroll_stu=0;
        if (count($subject_list) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $course_result_table = '';
            $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
            $course_result_table .= '<tr>
                                        <td colspan=45 align="center"> 
                                            <center><b><font size="6px">' . $org_name . '</font></b></center>
                                            <center>' . $org_address . '</center>
                                            <center>' . $org_tagline . '</center> 
                                        </td>
                                       
                                    </tr>';
            $course_result_table .= '<tr><td colspan=45 align="center"><b> Temp ' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME)) . ' Result Analysis</b> - ' . strtoupper($monthname . ' ' . $_POST['year']) . '</td></tr>';
            $course_result_table .= '<tr><td colspan=45 align="center"><b>Batch - ' . strtoupper($batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name) . '</td></tr>';
            $colspan = 30 - (count($grade_name) + 11); // is the number of columns
            $course_result_table .= '<tr>                                                                                                                                
                            <th> S. NO </th> 
                            <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th>
                               <th>CIA_MAX</th>
                                <th>ESE_MAX</th>
                                <th>CREDITS</th>

                            <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                            <th>ENR</th>
                            <th>APP</th>
                            <th>ABS</th>
                            <th>WIT</th>
                            <th>PA</th>
                            <th>FA</th>
                            <th>PA%</th>
                            <th>FA%</th>
                            <th>MEAN CIA(out of max)</th>
                            <th>MEAN ESE(out of max)</th>
                            <th>MEAN CIA(out of 100)</th>
                             <th>MEAN ESE(out of 100)</th>
                            <th>MEAN(out of 100)</th>
                            <th>SD</th>
                             <th>91-100</th>
                              <th>81-90</th>
                              <th>71-80</th>
                               <th>61-70</th>
                                <th>50-60</th>
                                 <th>45-49 (ESE)</th>
                                  <th>40-44 (ESE)</th>
                                   <th>35-39 (ESE)</th>
                                   <th>30-34 (ESE)</th>
                                   <th>0-29 (ESE)</th>
                              ';
          
            $course_result_table .= '</tr>';
            //return $course_result_table;exit;
            $sn = 1;
             $batch_enroll=0; $i=0;$total_enroll_stu=0;
            foreach ($subject_list as $subject) 
            {
                if($subject['paper_type_id']!=106)
                {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                    $query_absent = new Query();
                    $query_absent->select('distinct (absent_student_reg)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                        ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                        ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryAll();

                    $notIn = array_filter(['']);
                    foreach ($student_absent as $key => $bvalue) {
                            $notIn[$bvalue['absent_student_reg']]=$bvalue['absent_student_reg'];
                    }
                    $notIn = array_filter($notIn);
                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_enroll->andWhere(['NOT IN', 'student_map_id', $notIn]);
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();

                    $student_enrol=$student_enrol+count($student_absent);
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($i==0){ $batch_enroll=$student_enrol; }

                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_appeared->andWhere(['NOT IN', 'student_map_id', $notIn]);
                      //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                     
                    $course_result_table .= '<td align="center">' . count($student_absent) . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';

                    $total_pass_stu=$total_pass_stu+$student_pass;
                    $total_enroll_stu=$total_enroll_stu+$student_enrol;
                     
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                        }
                    else
                    {
                        $query_mean = new Query();
                        $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                        $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                        $MEAN = round(($student_mean/$student_appeared),2);

                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);
                       // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                    }         
                     else
                     {
                                  $query_meancia = new Query();
                            $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                            $MEANCIA = round(($student_meancia/$student_appeared),2);



                     }

                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {



                             $query_meanese = new Query();
                            $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                            $MEANESE = round(($student_meanese/$student_appeared),2);
                        }
                        else
                        {
                           $query_meanese = new Query();
                            $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                            $MEANESE = round(($student_meanese/$student_appeared),2);



                        }

                      if($MEANCIA==0)
                      {
                            $MEANCIA100=0;
                      }
                      else
                      {
                        $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                    if($MEANESE==0)
                    {
                        $MEANESE100=0;

                    }
                    else{

                    $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                    // print_r($MEANCIA100);exit;
                      }                       

                        $query_SSD = new Query();
                        $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                        $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                        $ssd_calc = 0;
                        foreach ($student_ssd as $key => $ssd_val) 
                        {
                            $ssd_calc +=$ssd_val['ssd'];
                        }
                        $variance = round(($ssd_calc/$student_appeared),2);

                        $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                        $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                        //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                        //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                        $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                                ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                                ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                                ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                
                        if($subject['ESE_max']!=0)
                        {
                            $m45=((45/100)*$subject['ESE_max']);
                            $m49=((49/100)*$subject['ESE_max']);
                            $m40=((40/100)*$subject['ESE_max']);
                            $m44=((44/100)*$subject['ESE_max']);
                            $m39=((39/100)*$subject['ESE_max']);
                            $m35=((35/100)*$subject['ESE_max']);
                            $m34=((34/100)*$subject['ESE_max']);
                            $m30=((30/100)*$subject['ESE_max']);
                            $m29=((29/100)*$subject['ESE_max']);

                            $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m45."' AND b.ESE <= '".$m49."') AND year_of_passing='' AND b.result!='Absent'"; 
                            $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                            
                            $course_result_table .= '<td>'.count($student_border49).'</td>';
                             
                            $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m40."' AND b.ESE <= '".$m44."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                            $course_result_table .= '<td>'.count($student_border44).'</td>';

                             $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m35."' AND b.ESE <= '".$m39."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                            $course_result_table .= '<td>'.count($student_border39).'</td>';

                            $query_border34 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m30."' AND b.ESE <= '".$m34."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border34 = Yii::$app->db->createCommand($query_border34)->queryAll();
                            $course_result_table .= '<td>'.count($student_border34).'</td>';

                             $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= 0 AND b.ESE <= '".$m29."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                            $course_result_table .= '<td>'.count($student_border29).'</td>';

                        }
                        else  if($subject['ESE_max']==0)
                        {
                            $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                            $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                            
                            $course_result_table .= '<td>'.count($student_border49).'</td>';
                             
                            $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                            $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                            $course_result_table .= '<td>'.count($student_border44).'</td>';

                             $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 35 AND b.total <= 39) AND b.result!='Absent'";
                            $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                            $course_result_table .= '<td>'.count($student_border39).'</td>';

                            $query_border34 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 30 AND b.total <= 34) AND b.result!='Absent'"; 
                            $student_border34 = Yii::$app->db->createCommand($query_border34)->queryAll();
                            $course_result_table .= '<td>'.count($student_border34).'</td>';

                            $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 29) AND b.result!='Absent'";
                            $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                            $course_result_table .= '<td>'.count($student_border29).'</td>';
                        }
                        else
                        {
                             $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>';
                        }
                    $course_result_table .= '</tr>';
                }
                else
                {                    
                
                     $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td>' . $student_enrol . '</td>';
                    if($i==0){ $batch_enroll=$student_enrol; }
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                    //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                   
                    
                      $query_absent = new Query();
                    $query_absent->select('count(absent_student_reg)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                        ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                        ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                    //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();

                    $student_appeared=$student_appeared;
                    $course_result_table .= '<td>' . $student_appeared . '</td>';
                    $course_result_table .= '<td>' . $student_absent . '</td>';
                    $course_result_table .= '<td>0</td>';
                    $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result = 'Pass' )"; 

                    $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                    $course_result_table .= '<td>' . $student_pass . '</td>';

                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.result = 'Fail' )";
                    $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td>' . $student_fail . '</td>';
                    
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                    }

                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';

                   $course_result_table .= '<td>0</td>';

                    $course_result_table .= '<td>0</td>';

                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td>';

                    
                    $course_result_table .= '<td>0</td>';

                    
                    $course_result_table .= '<td>0</td>';

                   
                    $course_result_table .= '<td>0</td>';

                    
                    $course_result_table .= '<td>0</td>';
                    $course_result_table .= '<td>0</td><td>0</td>';

                    $course_result_table .= '</tr>';
                    
                }
                $sn++;
                $i++;

            }

            $man_query_cr = new Query();
            $man_query_cr->select('subject_code,sub_cat_code,sub_cat_name,a.semester,subject_name, coe_mandatory_subcat_subjects_id , description, coe_mandatory_subjects_id, batch_mapping_id')
                ->from('coe_mandatory_subjects a')
                ->join('JOIN', 'coe_mandatory_subcat_subjects b', 'b.man_subject_id=a.coe_mandatory_subjects_id and b.batch_map_id=a.batch_mapping_id')
                ->join('JOIN', 'coe_mandatory_stu_marks c', 'c.subject_map_id=b.coe_mandatory_subcat_subjects_id')
                ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                ->where(['b.batch_map_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->groupBy('subject_code');
            $man_subject_list = $man_query_cr->createCommand()->queryAll();
            
            if(!empty($man_subject_list))
            {
                foreach ($man_subject_list as $subject) {
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code']."-".$subject['sub_cat_code'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name']."-".$subject['sub_cat_name'] . '</td>';
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        $query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        $query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                    $query_absent = new Query();
                    $query_absent->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'], 'b.result' => 'Absent']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_absent . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                        ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        $query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                        ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        $query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mandatory_stu_marks as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_mandatory_subcat_subjects c ON c.coe_mandatory_subcat_subjects_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_mandatory_subcat_subjects_id']."' AND year='".$_POST['year']."' $section and month='".$_POST['month']."' and result  not like '%Absent%' AND status_category_type_id NOT IN('".$det_disc_type."') and (year_of_passing is NULL or year_of_passing='' ) ";
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                    foreach ($grade_name as $grade) {
                        $query_75 = new Query();
                        $query_75->select('count(student_map_id)')
                            ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mandatory_stu_marks b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_mandatory_subcat_subjects c', 'c.coe_mandatory_subcat_subjects_id=b.subject_map_id and c.batch_map_id=a.course_batch_mapping_id')
                            ->where(['subject_map_id' => $subject['coe_mandatory_subcat_subjects_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                        if(!empty($_POST['section']) && $_POST['section']!='All')
                        {
                             $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                        }
                            $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_75 = $query_75->createCommand()->queryScalar();
                        $course_result_table .= '<td>' . $student_75 . '</td>';
                    }
                     $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>';
                    $course_result_table .= '</tr>';
                    $sn++;
                }
            }

             $query_cr = new Query();
            $query_cr->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max,ESE_max,credit_points, paper_type_id')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'], 'c.mark_type' => 27])->andWhere(['OR',['=','B.paper_type_id','10'],['=','B.paper_type_id','123']]);
            $subject_list = $query_cr->createCommand()->queryAll();            

            foreach ($subject_list as $subject) 
            {
                
                    $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">' . $subject['CIA_max'] . '</td><td align="left">' . $subject['ESE_max'] . '</td><td align="left">' . $subject['credit_points'] . '</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td> ';

                    $query_absent = new Query();
                    $query_absent->select('absent_student_reg')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                        ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                        ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                   // $query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_absent = $query_absent->createCommand()->queryAll();

                    $notIn = array_filter(['']);
                    foreach ($student_absent as $key => $bvalue) {
                            $notIn[$bvalue['absent_student_reg']]=$bvalue['absent_student_reg'];
                    }
                    $notIn = array_filter($notIn);
                    
                    $query_enroll = new Query();
                    $query_enroll->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'c.semester'=>$sem_calc]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_enroll->andWhere(['NOT IN', 'student_map_id', $notIn]);
                    //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type ]);
                    
                    //$query_enroll->andWhere(['<>', 'semester_discontinue', $sem_calc]);
                    $student_enrol = $query_enroll->createCommand()->queryScalar();

                    $student_enrol=$student_enrol+count($student_absent);
                    $course_result_table .= '<td align="center">' . $student_enrol . '</td>';
                    if($i==0){ $batch_enroll=$student_enrol; }

                    $query_appeared = new Query();
                    $query_appeared->select('count(DISTINCT student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month']])
                        ->andWhere(['NOT LIKE', 'b.result', 'Absent']);

                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                    $query_appeared->andWhere(['NOT IN', 'student_map_id', $notIn]);
                      //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_appeared = $query_appeared->createCommand()->queryScalar();
                    
                    $course_result_table .= '<td align="center">' . $student_appeared . '</td>';
                     
                    $course_result_table .= '<td align="center">' . count($student_absent) . '</td>';
                    $query_withheld = new Query();
                    $query_withheld->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                    }
                        //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_withheld = $query_withheld->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                    $query_pass = new Query();
                    $query_pass->select('count(student_map_id)')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                        ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                        ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['NOT', ['year_of_passing' => '']]);
                    if(!empty($_POST['section']) && $_POST['section']!='All')
                    {
                         $query_pass->andWhere(['=', 'section_name', $_POST['section']]);
                    }

                        //$query_pass->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_pass = $query_pass->createCommand()->queryScalar();
                    $course_result_table .= '<td align="center">' . $student_pass . '</td>';

                    $total_pass_stu=$total_pass_stu+$student_pass;
                    $total_enroll_stu=$total_enroll_stu+$student_enrol;
                     
                    $query_fail = new Query();
                    $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' and result  not like '%Absent%' $section and (year_of_passing is NULL or year_of_passing='' ) "; //AND status_category_type_id NOT IN('".$det_disc_type."')
                    $student_fail = Yii::$app->db->createCommand($select_query)->queryScalar();
                    $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                    $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                    $course_result_table .= '<td align="center">' . $student_fail . '</td>';
                    if ($mark_type_name == "Regular") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        $pass_percent = ($student_pass / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($pass_percent, 1) . '</td>';
                    }
                    if ($mark_type_name == "Regular") {

                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    } else if ($mark_type_name == "Arrear") {
                        
                        $fail_percent = ($student_fail / $student_enrol) * 100;
                        $course_result_table .= '<td align="center">' . round($fail_percent, 1) . '</td>';
                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                    $query_mean = new Query();
                    $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  AND  a.section_name='".$_POST['section']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);
                        }
                    else
                    {
                        $query_mean = new Query();
                        $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."'  and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') ";
                        $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                        $MEAN = round(($student_mean/$student_appeared),2);

                    }
                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'AND status_category_type_id NOT IN('".$det_disc_type."') ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);
                       // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                    }         
                     else
                     {
                                  $query_meancia = new Query();
                            $query_meancia = "SELECT sum(b.CIA) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                            $MEANCIA = round(($student_meancia/$student_appeared),2);



                     }

                     if(!empty($_POST['section']) && $_POST['section']!='All')
                     {

                             $query_meanese = new Query();
                            $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."'  AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                            $MEANESE = round(($student_meanese/$student_appeared),2);
                        }
                        else
                        {
                           $query_meanese = new Query();
                            $query_meanese = "SELECT sum(b.ESE) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'   AND status_category_type_id NOT IN('".$det_disc_type."') ";
                            $student_meanese = Yii::$app->db->createCommand($query_meanese)->queryScalar();

                            $MEANESE = round(($student_meanese/$student_appeared),2);



                        }

                      if($MEANCIA==0)
                      {
                            $MEANCIA100=0;
                      }
                      else
                      {
                        $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                    if($MEANESE==0)
                    {
                        $MEANESE100=0;

                    }
                    else{

                    $MEANESE100 = round((($MEANESE/$subject['ESE_max'])*100),2);
                    // print_r($MEANCIA100);exit;
                      }                       

                        $query_SSD = new Query();
                        $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') group by student_map_id";
                        $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                        $ssd_calc = 0;
                        foreach ($student_ssd as $key => $ssd_val) 
                        {
                            $ssd_calc +=$ssd_val['ssd'];
                        }
                        $variance = round(($ssd_calc/$student_appeared),2);

                        $course_result_table .= '<td align="center">' . $MEANCIA . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANESE . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANCIA100 . '</td>';
                        $course_result_table .= '<td align="center">' . $MEANESE100 . '</td>';

                        $course_result_table .= '<td align="center">' . $MEAN . '</td>';
                        //$course_result_table .= '<td align="center">' . $ssd_calc . '</td>';
                        //$course_result_table .= '<td align="center">' .  $variance. '</td>';
                        $course_result_table .= '<td align="center">' . round(sqrt($variance),2) . '</td>';


                        foreach ($grade_name as $grade) {
                            $query_75 = new Query();
                            $query_75->select('count(student_map_id)')
                                ->from('coe_student_mapping a')
                                ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                                ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                                ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'grade_name' => $grade['grade_name']]);
                            if(!empty($_POST['section']) && $_POST['section']!='All')
                            {
                                 $query_75->andWhere(['=', 'section_name', $_POST['section']]);
                            }
                                $query_75->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                            $student_75 = $query_75->createCommand()->queryScalar();
                            $course_result_table .= '<td>' . $student_75 . '</td>';
                        }
                
                        if($subject['ESE_max']!=0)
                        {
                            $m45=((45/100)*$subject['ESE_max']);
                            $m49=((49/100)*$subject['ESE_max']);
                            $m40=((40/100)*$subject['ESE_max']);
                            $m44=((44/100)*$subject['ESE_max']);
                            $m39=((39/100)*$subject['ESE_max']);
                            $m35=((35/100)*$subject['ESE_max']);
                            $m34=((34/100)*$subject['ESE_max']);
                            $m30=((30/100)*$subject['ESE_max']);
                            $m29=((29/100)*$subject['ESE_max']);

                            $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m45."' AND b.ESE <= '".$m49."') AND year_of_passing='' AND b.result!='Absent'"; 
                            $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                            
                            $course_result_table .= '<td>'.count($student_border49).'</td>';
                             
                            $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m40."' AND b.ESE <= '".$m44."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                            $course_result_table .= '<td>'.count($student_border44).'</td>';

                             $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m35."' AND b.ESE <= '".$m39."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                            $course_result_table .= '<td>'.count($student_border39).'</td>';

                            $query_border34 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= '".$m30."' AND b.ESE <= '".$m34."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border34 = Yii::$app->db->createCommand($query_border34)->queryAll();
                            $course_result_table .= '<td>'.count($student_border34).'</td>';

                             $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.ESE >= 0 AND b.ESE <= '".$m29."') AND year_of_passing='' AND b.result!='Absent'";
                            $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                            $course_result_table .= '<td>'.count($student_border29).'</td>';

                        }
                        else  if($subject['ESE_max']==0)
                        {
                            $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49) AND b.result!='Absent'";
                            $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                            
                            $course_result_table .= '<td>'.count($student_border49).'</td>';
                             
                            $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44) AND b.result!='Absent'";
                            $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                            $course_result_table .= '<td>'.count($student_border44).'</td>';

                             $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 35 AND b.total <= 39) AND b.result!='Absent'";
                            $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                            $course_result_table .= '<td>'.count($student_border39).'</td>';

                            $query_border34 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 30 AND b.total <= 34) AND b.result!='Absent'"; 
                            $student_border34 = Yii::$app->db->createCommand($query_border34)->queryAll();
                            $course_result_table .= '<td>'.count($student_border34).'</td>';

                            $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 29) AND b.result!='Absent'";
                            $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                            $course_result_table .= '<td>'.count($student_border29).'</td>';
                        }
                        else
                        {
                             $course_result_table .= '<td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>';
                        }
                    $course_result_table .= '</tr>';
               
                $sn++;
                $i++;

            }

             $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('coe_subjects_mapping_id,ESE_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']])->andWhere(['<>', 'paper_type_id', 106]);

            //echo $query_cr1->createCommand()->getRawSql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail1 = array_filter(['']);
            
            if (count($subject_list1) > 0) 
            {   
                
                foreach ($subject_list1 as $subject) 
                {
                     $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                    
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail1))
                            {
                              $notIn_fail1[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }

                        $total_tpquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' AND (b.result='Fail') "; //exit;

                        $tot_student_tp =Yii::$app->db->createCommand($total_tpquery)->queryAll();
                       
                        foreach ($tot_student_tp as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                     /*$total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result='Fail') "; //exit;

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }*/

                    $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' and (b.result = 'Fail')";

                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail1))
                            {
                                $notIn_fail1[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                   
                       
                       
                }

            }

            //print_r($notIn_fail1);
            //$tot=(count($notIn_fail1));
             $tot=$batch_enroll-(count($notIn_fail1));

            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $batch_enroll) * 100),2).'% </b></td></tr>';

            $course_result_table .= '</table>';
            if (isset($_SESSION['programme_analysistemp_print'])) {
                unset($_SESSION['programme_analysistemp_print']);
            }
            $_SESSION['programme_analysistemp_print'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }
    public function actionProgrammeAnalysistempPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['programme_analysistemp_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Temp.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                        table th{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Temp'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Temp' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
       
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelProgrammeanalysistemp()
    {
       
        $content = $_SESSION['programme_analysistemp_print'];
          
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis Data.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionModerationreport()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMasterTemp();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ESE Moderation Report');
        return $this->render('moderation_report', [
            'model' => $model,
        ]);
    }

    public function actionModerationreportdata() 
    {
        $exam_year = Yii::$app->request->post('year');
        $exam_month = Yii::$app->request->post('month');
        $batch = Yii::$app->request->post('batch');

        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $batch . "'")->queryScalar();

        $monthname = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $exam_month . "'")->queryScalar();

        $moderation_passquery = "SELECT a.student_map_id,a.subject_map_id,e.register_number,f.subject_code,c.paper_type_id,a.mark,a.additional_mark FROM coe_vmoderation_normalization a 
        JOIN coe_student_mapping b ON b.coe_student_mapping_id=a.student_map_id 
        JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=a.subject_map_id 
        JOIN coe_bat_deg_reg d ON d.coe_bat_deg_reg_id=b.course_batch_mapping_id 
        JOIN coe_student e ON e.coe_student_id=b.student_rel_id 
        JOIN coe_subjects f ON f.coe_subjects_id= c.subject_id
        WHERE d.coe_batch_id='".$batch."' AND a.year='".$exam_year."' and a.month='".$exam_month."' order by e.register_number";

        $mod_student_pass =Yii::$app->db->createCommand($moderation_passquery)->queryAll();                

       
            if(!empty($mod_student_pass))
            {
            $body = $header ='';
             require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                    $header.= '<table border=1  width="100%"  cellspacing="0" cellpadding="0" border="0" id="student_bulk_edit">
                <tr>
                    
                    <td colspan=5 align="center"><h3> 
                          <center><b><font size="5px">' . $org_name . '</font></b></center>
                          <center> <font size="3px">' . $org_address . '</font></center>
                          <center class="tag_line"><b>' . $org_tagline . '</b></center> 
                          </h3>
                     </td>
                      
                 </tr>';
                
               $header .= '<tr>
                    <td align="center" colspan=5 ><h4>  MODERATION REPORT - '.strtoupper($monthname).' - '.$exam_year.'  </h4> </td>
                        </tr>';
                 

                    $header .= '<tr>
                        <th>REGISTER NUMBER </th>
                        <th>SUBJECT CODE </th>
                        <th>BEFORE MODERATION ESE MARK</th>
                        <th>AFTER MODERATION ESE MARK</th>
                        <th>ADDITIONAL MARK</th>
                    </tr>                     
                 '; 

                foreach($mod_student_pass as $value)
                {
                    if($value['paper_type_id']==136)
                    {
                        $beforemodemark = "SELECT grand_total FROM coe_scrtny_sw_based  
                        WHERE student_map_id='".$value['student_map_id']."' AND subject_map_id='".$value['subject_map_id']."' AND year='".$exam_year."' and month='".$exam_month."'";
                    }
                    else
                    {
                        $beforemodemark = "SELECT b.grand_total FROM coe_dummy_number a 
                        JOIN coe_val_barcode_verify_details b ON b.dummy_number=a.dummy_number WHERE a.student_map_id='".$value['student_map_id']."' AND a.subject_map_id='".$value['subject_map_id']."' AND a.year='".$exam_year."' and a.month='".$exam_month."'";
                    }
                    

                    $beforemodemarkda =Yii::$app->db->createCommand($beforemodemark)->queryScalar();

                        $body .='<tr>';
                        $body .='<td>'.$value['register_number'].'</td>';
                        $body .='<td>'.$value['subject_code'].'</td>';
                        $body .='<td>'.$beforemodemarkda.'</td>';
                        $body .='<td>'.$value['mark'].'</td>';
                        $body .='<td>'.$value['additional_mark'].'</td>';

                     
                        $body .='</tr>';

                }
                
                $send_results = $header.$body."</table>";
            }
            else 
            {
                $send_results = 0;
            }
        
       
        if (isset($_SESSION['programme_analysis_printtemp1'])) {
            unset($_SESSION['programme_analysis_printtemp1']);
            
        }
        $_SESSION['programme_analysis_printtemp1'] = $send_results;
        return $send_results;
    }

    public function actionEsemoderation1()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMasterTemp();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ESE Moderation');
        return $this->render('esemoderation1', [
            'model' => $model,
        ]);
    }

     public function actionEsemoderation()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $dummy_entry_id = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       $ESE = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%ESE%' OR description like '%ESE%'")->queryScalar();
       
        $Reval = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Revaluation%' OR description like '%Revaluation%'")->queryScalar();
        $Mod = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Moderation%' OR description like '%Moderation%'")->queryScalar();


        $model = new MarkEntry();
        if (Yii::$app->request->post()) 
        {

            $query = new  Query();
            $query->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,((BAR.grand_total/100)*H.ESE_max) as ese, BAR.grand_total, (((BAR.grand_total/100)*H.ESE_max)+F.category_type_id_marks) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_dummy_number as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_val_barcode_verify_details as BAR', 'BAR.dummy_number=DUM.dummy_number')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query->Where(['F.year' => $_POST['year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'F.category_type_id' => '46'])->andWhere(['<>','G.paper_type_id','137']);

            $query->orderBy('A.register_number,H.subject_code');

            //echo $query->createCommand()->getrawsql(); exit;
            $ese_list= $query->createCommand()->queryAll();

            $query_p = new  Query();
            $query_p->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,DUM.ESE as ese,(F.category_type_id_marks+DUM.ESE) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id AND category_type_id=46')
                ->join('JOIN', 'coe_practical_entry as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_p->Where(['F.year' => $_POST['year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'G.paper_type_id' => '10']);

            $query_p->orderBy('A.register_number,H.subject_code');
            //echo $ese_list2= $query_p->createCommand()->getRawSql();exit;
            $ese_list2= $query_p->createCommand()->queryAll();

            if(!empty($ese_list2))
            {
                $ese_list = array_merge($ese_list,$ese_list2);
            }

            $query_i = new  Query();
            $query_i->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,DUM.year,J.category_type as month,E.programme_name,D.degree_name,DUM.CIA,DUM.ESE as ese,DUM.total, DUM.subject_map_id, DUM.student_map_id,DUM.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_mark_entry_master as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_i->Where(['F.year' => $_POST['year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'],  'H.ESE_max'=>'0',  'G.paper_type_id' => '105'])->andWhere(['<>','G.paper_type_id','10'])->andWhere(['<>','G.paper_type_id','137']);

            $query_i->orderBy('A.register_number,H.subject_code');


            $ese_list3= $query_i->createCommand()->queryAll();

            if(!empty($ese_list3))
            {
                $ese_list = array_merge($ese_list,$ese_list3);
            }

            $query_m = new  Query();
            $query_m->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.CIA,F.ESE,F.total, F.subject_map_id, F.student_map_id,F.month,F.result, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_m->Where(['F.year' => $_POST['year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'H.CIA_max'=>'0','H.ESE_max'=>'0','G.paper_type_id'=>'106']);

            $query_m->orderBy('A.register_number,H.subject_code');


            $ese_list4= $query_m->createCommand()->queryAll();

            if(!empty($ese_list4))
            {
                $ese_list = array_merge($ese_list,$ese_list4);
            }
        
            $query_pb = new  Query();
            $query_pb->select('distinct (H.subject_code) as subject_code, H.subject_name, H.CIA_max, H.ESE_min,H.ESE_max,A.register_number,F.year,J.category_type as month,E.programme_name,D.degree_name,F.category_type_id_marks as CIA,DUM.ESE as ese,(F.category_type_id_marks+DUM.ESE) as total, F.subject_map_id, F.student_map_id,F.month, G.type_id')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_mark_entry as F', 'F.student_map_id=B.coe_student_mapping_id AND category_type_id=46')
                ->join('JOIN', 'coe_practical_entry as DUM','DUM.student_map_id=F.student_map_id AND DUM.subject_map_id=F.subject_map_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=DUM.subject_map_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $query_pb->Where(['F.year' => $_POST['year'], 'B.course_batch_mapping_id' => $_POST['bat_map_val'], 'F.month' => $_POST['month'], 'G.paper_type_id' => '137']);

            $query_pb->orderBy('A.register_number,H.subject_code');
            //echo $ese_list2= $query_p->createCommand()->getRawSql();exit;
            $ese_list5= $query_pb->createCommand()->queryAll();

            if(!empty($ese_list5))
            {
                $ese_list = array_merge($ese_list,$ese_list5);
            }

            $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['bat_map_val']);
            
            $subject_get_data = new  Query();
            $subject_get_data->select('distinct (H.subject_code) as subject_code,G.coe_subjects_mapping_id as subject_map_id, H.subject_name, H.CIA_min, H.CIA_max, H.ESE_min, H.ESE_max,H.total_minimum_pass,G.paper_type_id,G.type_id, J.category_type as subject_type')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_category_type as J', 'J.coe_category_type_id=G.type_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $subject_get_data->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $query->orderBy('H.subject_code');
            $subjectsInfo = $subject_get_data->createCommand()->queryAll();

            $countQuery = new  Query();
            $countQuery->select('count( distinct H.subject_code) as count')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_subjects_mapping as G', 'G.batch_mapping_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
            $countQuery->Where(['G.semester' => $sem, 'B.course_batch_mapping_id' => $_POST['bat_map_val']]);
            $countOfSubjects = $countQuery->createCommand()->queryScalar();

            if (!empty($ese_list)) {//exit;

                $query_cr = new Query();
                $query_cr->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
                    ->from('coe_subjects a')
                    ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
                    ->join('JOIN', 'coe_dummy_number c', 'b.coe_subjects_mapping_id=c.subject_map_id')
                    ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
                    ->where(['b.batch_mapping_id' => $_POST['bat_map_val'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem])->andWhere(['<>','b.paper_type_id','137']);
                $subject_list = $query_cr->createCommand()->queryAll();

                return $this->render('esemoderation', [
                    'model' => $model,
                    'ese_list' => $ese_list,
                    'subjectsInfo' => $subjectsInfo,
                    'countOfSubjects' => $countOfSubjects,
                    'subject_list'=>$subject_list,
                    'year'=>$_POST['year'],
                    'month'=>$_POST['month'],
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Found");
                return $this->redirect(['mark-entry/esemoderation']);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Conslidate CIA + ESE HOD Copy');
            return $this->render('esemoderation', [
                'model' => $model,
            ]);
        }
    }

     public function actionEsemoderationdata()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();

         $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

        $query_cr = new Query();
        $query_cr->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_dummy_number c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem])->andWhere(['<>','b.paper_type_id','137']);
        $subject_list = $query_cr->createCommand()->queryAll();
        if (count($subject_list) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $course_result_table = '';
            $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
            $course_result_table .= '<tr>
                                        <td colspan=29 align="center"> 
                                            <center><b><font size="6px">' . $org_name . '</font></b></center>
                                            <center>' . $org_address . '</center>
                                            <center>' . $org_tagline . '</center> 
                                        </td>
                                       
                                    </tr>';
            $course_result_table .= '<tr><td colspan=29 align="center"><b>' .  "ESE ".ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis</b> - ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';
            $course_result_table .= '<tr><td colspan=29 align="center"><b>Batch - ' . $batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name . '</td></tr>';
            $colspan = 0; // is the number of columns
             $course_result_table .= '<tr>                                                                                                                                
                            <th> S. NO </th> 
                            <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th> 
                            <th>CIA Max</th> 
                            <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                            <th>ENR</th>
                            <th>APP</th>
                            <th>ABS</th>
                            <th>WH</th>
                            <th>PA</th>
                            <th>FA</th>
                            <th>PA%</th>
                            <th>FA%</th>
                            <th>MEAN CIA (out of Max)</th>
                            <th>MEAN CIA 100</th>
                            <th>MEAN ESE (out of 100)</th>
                            <th>SD</th>
                            <th>91-100</th>
                            <th>81-90</th>
                            <th>71-80</th>
                            <th>61-70</th>
                            <th>50-60</th>
                            <th>45-49</th>
                            <th>40-44</th>
                            <th>35-39</th>
                            <th>30-34</th>
                            <th>0-29</th>
                            <th>Common Sub Pass Stu/App Stu</th>
                            <th>Common Sub Stu Pass Percent</th>
                            <th>Moderation</th>';
            $old_grade = '';
            
            $course_result_table .= '</tr>';
            //return $course_result_table;exit;
            $sn = 1; $total_appered_stu=0; $total_pass_stu=0; $total_enroll_stu=0; $tot_stu ='';
            foreach ($subject_list as $subject) {
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_dummy_number b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $student_enrol . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_dummy_number b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared-$student_absent;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';

                $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                }
                    //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();
                $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (d.grand_total >= 45)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (d.grand_total < 45 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $query_mean = new Query();
                $query_mean = "SELECT sum(d.grand_total) FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                $MEAN = round(($student_mean/$student_appeared),2);

                $query_SSD = new Query();
                $query_SSD = "SELECT power(sum($MEAN-d.grand_total),2) as ssd FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                $ssd_calc = 0;
                foreach ($student_ssd as $key => $ssd_val) 
                {
                    $ssd_calc +=$ssd_val['ssd'];
                }
                $variance = round(($ssd_calc/$student_appeared),2);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }

                  if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA100 . '</td>';
                $course_result_table .= '<td>' . $MEAN . '</td>';
                $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';

                $query_border100 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 91 AND d.grand_total <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 81 AND d.grand_total <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 71 AND d.grand_total <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 61 AND d.grand_total <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 50 AND d.grand_total <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                 $query_border49 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 45 AND d.grand_total <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.count($student_border49).'</td>';

               $query_border44 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 40 AND d.grand_total <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border35 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 35 AND d.grand_total <= 39)";
                $student_border35 = Yii::$app->db->createCommand($query_border35)->queryAll();
                $course_result_table .= '<td>'.count($student_border35).'</td>';

                $query_border30 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 30 AND d.grand_total <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 0 AND d.grand_total <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                $commonsubq = "SELECT coe_subjects_mapping_id FROM coe_subjects_mapping WHERE semester='".$sem."' AND subject_id=(SELECT subject_id FROM coe_subjects_mapping WHERE coe_subjects_mapping_id='".$subject['coe_subjects_mapping_id']."')";
                $commonsubq = Yii::$app->db->createCommand($commonsubq)->queryAll();

                $comIn = array_filter(['']);
                foreach ($commonsubq as $key => $bvalue) {
                            $comIn[$bvalue['coe_subjects_mapping_id']]=$bvalue['coe_subjects_mapping_id'];
                }
                $comIn = array_filter($comIn);

                $query_comsub = new Query();
                $query_comsub->select('count(a.student_map_id)')
                    ->from('coe_dummy_number a')
                    ->join('JOIN', 'coe_val_barcode_verify_details b', 'b.dummy_number=a.dummy_number')
                    ->where(['year' => $_POST['year'], 'month' => $_POST['month']])
                    ->andWhere(['>=', 'b.grand_total', 45])
                    ->andWhere(['IN', 'a.subject_map_id', $comIn]);
               // echo $query_comsub->createCommand()->getRawSql();exit;
               $pass_comsub = $query_comsub->createCommand()->queryScalar(); // common subject pass student count

               $a_comsub = new Query();
                $a_comsub->select('count(a.student_map_id)')
                    ->from('coe_dummy_number a')
                    ->join('JOIN', 'coe_val_barcode_verify_details b', 'b.dummy_number=a.dummy_number')
                    ->where(['year' => $_POST['year'], 'month' => $_POST['month']])
                    ->andWhere(['IN', 'a.subject_map_id', $comIn]);
               $appered_comsub = $a_comsub->createCommand()->queryScalar(); // common subject appeared student count

               $course_result_table .= '<td>'.$pass_comsub."/".$appered_comsub.'</td>';
               $course_result_table .= '<td>'.round(($pass_comsub/$appered_comsub)*100,2).'</td>';

                if(count($commonsubq)>1)
                {
                    $commpercent=round(($pass_comsub/$appered_comsub)*100,2);

                    $less45_comsub = new Query();
                    $less45_comsub->select('a.dummy_number')
                        ->from('coe_dummy_number a')
                        ->join('JOIN', 'coe_val_barcode_verify_details b', 'b.dummy_number=a.dummy_number')
                        ->where(['year' => $_POST['year'], 'month' => $_POST['month']])
                        ->andWhere(['and',['>=', 'b.grand_total', 40],['<=', 'b.grand_total', 44]])
                        ->andWhere(['IN', 'a.subject_map_id', $comIn]);
                    $fail44_comsub = $less45_comsub->createCommand()->queryAll(); // common subject fail 44-45 student count

                    if($commpercent<65 && count($student_border44)>0)
                    {
                   
                        $notIn = array_filter(['']);
                        foreach ($fail44_comsub as $key => $bvalue) {
                                $notIn[$bvalue['dummy_number']]=$bvalue['dummy_number'];
                        }
                        $notIn = array_filter($notIn);
                        $notIn = implode(",",$notIn);
                        $url=Yii::$app->urlManager->baseUrl;
                        $check_student_border = Yii::$app->db->createCommand("SELECT count(dummy_number) FROM coe_vmoderation_normalization WHERE dummy_number IN('".$notIn."')  AND mark_type=1 AND subject_map_id = '".$subject['coe_subjects_mapping_id']."'")->queryScalar();
                        if($check_student_border==0)
                        {
                            $course_result_table .= '<td><input type="button" id="border_'.$subject['coe_subjects_mapping_id'].'" onclick="moderation_esemark('.$subject['coe_subjects_mapping_id'].','.$_POST['year'].','.$_POST['month'].',0)" value="Moderation"></td>';
                        }
                        else
                        {
                            $course_result_table .= '<td>Moderated</td>';
                        }
                    }
                    else if($commpercent>=65 && count($student_border44)>0)
                    {
                        $course_result_table .= '<td>N/A</td>';
                    }
                    else
                    {
                        $course_result_table .= '<td></td>';
                    }
                    
                }
                else if($pass_percent<65 && count($student_border44)>0)
                {
                    $notIn = array_filter(['']);
                    foreach ($student_border44 as $key => $bvalue) {
                            $notIn[$bvalue['dummy_number']]=$bvalue['dummy_number'];
                    }
                    $notIn = array_filter($notIn);
                    $notIn = implode(",",$notIn);
                    $url=Yii::$app->urlManager->baseUrl;
                    $check_student_border = Yii::$app->db->createCommand("SELECT count(dummy_number) FROM coe_vmoderation_normalization WHERE dummy_number IN('".$notIn."')  AND mark_type=1 AND subject_map_id = '".$subject['coe_subjects_mapping_id']."'")->queryScalar();
                    if($check_student_border==0)
                    {
                        $course_result_table .= '<td><input type="button" id="border_'.$subject['coe_subjects_mapping_id'].'" onclick="moderation_esemark('.$subject['coe_subjects_mapping_id'].','.$_POST['year'].','.$_POST['month'].',0)" value="Moderation"></td>';
                    }
                    else
                    {
                        $course_result_table .= '<td>Moderated</td>';
                    }
                    
                }
                else if($pass_percent>=65 && count($student_border44)>0)
                {
                    $course_result_table .= '<td>N/A</td>';
                }
                else
                {
                    $course_result_table .= '<td></td>';
                }
                

                $course_result_table .= '</tr>';
                
                
                if($sn==1)
                {
                    $total_enroll_stu=$student_enrol;
                    $total_appered_stu=$student_appeared;
                }
                
                $sn++;
            }
            
            //practical
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_practical_entry c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.paper_type_id'=>'10','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_practical_entry b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_practical_entry b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                 $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                }
                    //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();
                

                $student_appeared=$student_appeared-$student_withheld;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';

                $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.out_of_100 >= 45)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.out_of_100 < 45 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $query_mean = new Query();
                $query_mean = "SELECT sum(b.out_of_100) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                $MEAN = round(($student_mean/$student_appeared),2);

                $query_SSD = new Query();
                $query_SSD = "SELECT power(sum($MEAN-b.out_of_100),2) as ssd FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                $ssd_calc = 0;
                foreach ($student_ssd as $key => $ssd_val) 
                {
                    $ssd_calc +=$ssd_val['ssd'];
                }
                $variance = round(($ssd_calc/$student_appeared),2);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }

                 if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA100 . '</td>';
                $course_result_table .= '<td>' . $MEAN . '</td>';
                $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';

                $query_border100 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 91 AND b.out_of_100 <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 81 AND b.out_of_100 <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 71 AND b.out_of_100 <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 61 AND b.out_of_100 <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 50 AND b.out_of_100 <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                 $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 45 AND b.out_of_100 <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.count($student_border49).'</td>';

               $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 40 AND b.out_of_100 <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 35 AND b.out_of_100 <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 30 AND b.out_of_100 <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 0 AND b.out_of_100 <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                $course_result_table .= '<td></td>';
                $course_result_table .= '<td></td>';
                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
         
                $sn=$sn+1;
            }
            }

            
            // internal mode subject
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master_temp c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['a.ESE_max'=>'0','b.paper_type_id'=>'105','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared-$student_absent;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';
                $course_result_table .= '<td>0</td>';//with held
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.total >= 50)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.total < 50 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $query_mean = new Query();
                $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                $MEAN = round(($student_mean/$student_appeared),2);

                $query_SSD = new Query();
                $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                $ssd_calc = 0;
                foreach ($student_ssd as $key => $ssd_val) 
                {
                    $ssd_calc +=$ssd_val['ssd'];
                }
                $variance = round(($ssd_calc/$student_appeared),2);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }


                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEAN . '</td>';
                $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';

                $query_border100 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 91 AND b.total <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 81 AND b.total <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 71 AND b.total <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 61 AND b.total <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 50 AND b.total <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                 $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.count($student_border49).'</td>';

               $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 35 AND b.total <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 30 AND b.total <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';
                

                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
                
                $sn=$sn+1;
            }
            }

            //man course start
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['a.CIA_max'=>'0','a.ESE_max'=>'0','b.paper_type_id'=>'106','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';
                $course_result_table .= '<td>0</td>';
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result = 'Pass' )"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.result = 'Fail' )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';

               $course_result_table .= '<td>0</td>';

                $course_result_table .= '<td>0</td>';

                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';

               
                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
                
                $sn=$sn+1;
            }
            }

            $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('distinct(coe_subjects_mapping_id)')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']]);

            //echo $query_cr1->createCommand()->getRawSql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail = array_filter(['']);
            $notIn_absent=array_filter(['']);
            $student_ababsent=0; $testsub='';
            if (count($subject_list1) > 0) 
            {   
                
                foreach ($subject_list1 as $subject) 
                {
                    $total_failquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' AND (d.grand_total< 45)"; 

                    $tot_student_fail =Yii::$app->db->createCommand($total_failquery)->queryAll();
                       
                         foreach ($tot_student_fail as $key => $fails) 
                         {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                        }

                    $total_pracquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.out_of_100 < 45)"; 

                        $tot_student_prac =Yii::$app->db->createCommand($total_pracquery)->queryAll();
                       
                        foreach ($tot_student_prac as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                   
                    $total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' AND (b.result = 'Fail') "; 

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result = 'Fail')";

                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                    
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail))
                            {
                              $notIn_fail[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }
                       
                       
                }

            }

                //print_r($notIn_fail); exit;
             $tot=$total_enroll_stu-(count($notIn_fail));

            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $total_enroll_stu) * 100),2).'% </b></td></tr>';
            $course_result_table .= '</table>';
            if (isset($_SESSION['programme_analysis_printtemp1'])) {
                unset($_SESSION['programme_analysis_printtemp1']);
            }
            $_SESSION['programme_analysis_printtemp1'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

    public function actionModerationmark()
    {
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $success=0;
        if($_POST['swbased']==0)
        {
            $query_border = "SELECT b.student_map_id,b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark, REJ.register_number FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$_POST['subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND status_category_type_id NOT IN('".$det_disc_type."') AND (d.grand_total >= 40 AND d.grand_total <= 44)";
            $border_student = Yii::$app->db->createCommand($query_border)->queryAll();
            $created_at = date("Y-m-d H:i:s");
            $createdBy = Yii::$app->user->getId();
            $success=0;
            if(!empty($border_student))
            {
                foreach ($border_student as $value) 
                {
                    
                    $max_stu = Yii::$app->db->createCommand("select sum(additional_mark) from coe_vmoderation_normalization where student_map_id='".$value['student_map_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'")->queryScalar(); //student moderated marks sum
                     $moderate_mark=0;
                    if($max_stu==0)
                    {                        
                         $additional_mark=45-$value['mark'];
                         $moderate_mark=$value['mark']+$additional_mark;
                    }
                    else
                    {
                         $additional_mark=5-$max_stu;
                         $moderate_mark=$value['mark']+$additional_mark;
                    }

                    $ciamark = Yii::$app->db->createCommand("select category_type_id_marks from coe_vmoderation_normalization where category_type_id=46 AND student_map_id='".$value['student_map_id']."' AND subject_map_id='".$value['subject_map_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'")->queryScalar();

                    $esemax= Yii::$app->db->createCommand("select ESE_max,total_minimum_pass from coe_subjects_mapping a JOIN coe_subjects b ON coe_subjects_id=.subject_id where coe_subjects_mapping_id='".$value['student_map_id']."'")->queryone();

                    $ese=round(($moderate_mark/100)*$esemax['ESE_max']);

                    $cia_ese=$ciamark+$ese;

                    if($additional_mark>0 && ($max_stu>=0 && $max_stu<=5) && $cia_ese>=$esemax['total_minimum_pass'])
                    {
                        $insert = Yii::$app->db->createCommand("INSERT INTO coe_vmoderation_normalization(student_map_id, dummy_number, mark, additional_mark, mark_type, year,month,subject_map_id,created_at,created_by) VALUES('".$value['student_map_id']."','".$value['dummy_number']."','".$moderate_mark."','".$additional_mark."',1,'".$value['year']."','".$value['month']."','".$value['subject_map_id']."','".$created_at."','".$createdBy."')")->execute();
                        if($insert)
                        {
                            $success++;
                        }
                    }
                }
            }
        }
        else if($_POST['swbased']==1)
        {
            $query_border44 = "SELECT  b.student_map_id,b.subject_map_id,REJ.register_number,b.month,b.year,b.grand_total as mark FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$_POST['subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 40 AND b.grand_total <= 44)";
            $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
            $created_at = date("Y-m-d H:i:s");
            $createdBy = Yii::$app->user->getId();
            $success=0;
            if(!empty($student_border44))
            {
                foreach ($student_border44 as $value) 
                {
                    $max_stu = Yii::$app->db->createCommand("select sum(additional_mark) from coe_vmoderation_normalization where student_map_id='".$value['student_map_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'")->queryScalar(); //student moderated marks sum
                     $moderate_mark=0;
                    if($max_stu==0)
                    {                        
                         $additional_mark=45-$value['mark'];
                         $moderate_mark=$value['mark']+$additional_mark;
                    }
                    else
                    {
                         $additional_mark=5-$max_stu;
                         $moderate_mark=$value['mark']+$additional_mark;
                    }

                    $ciamark = Yii::$app->db->createCommand("select category_type_id_marks from coe_vmoderation_normalization where category_type_id=46 AND student_map_id='".$value['student_map_id']."' AND subject_map_id='".$value['subject_map_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'")->queryScalar();

                    $esemax= Yii::$app->db->createCommand("select ESE_max,total_minimum_pass from coe_subjects_mapping a JOIN coe_subjects b ON coe_subjects_id=.subject_id where coe_subjects_mapping_id='".$value['student_map_id']."'")->queryone();

                    $ese=round(($moderate_mark/100)*$esemax['ESE_max']);

                    $cia_ese=$ciamark+$ese;
                    
                    if($additional_mark>0 && ($max_stu>=0 && $max_stu<=5) && $cia_ese>=$esemax['total_minimum_pass'])
                    {
                        $insert = Yii::$app->db->createCommand("INSERT INTO coe_vmoderation_normalization(student_map_id, dummy_number,mark,additional_mark,mark_type,year,month,subject_map_id,created_at,created_by) VALUES('".$value['student_map_id']."','".$value['register_number']."','".$moderate_mark."','".$additional_mark."',1,'".$value['year']."','".$value['month']."','".$value['subject_map_id']."','".$created_at."','".$createdBy."')")->execute();
                        if($insert)
                        {
                            $success++;
                        }
                    }
                }
            }
        }
        return $success; 
    }

     public function actionNormalizationEse()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMasterTemp();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Normalization For ESE');
        return $this->render('normalization-ese', [
            'model' => $model,
        ]);
    }

     public function actionNormalizationesedata()
    {
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $_POST['batch'] . "'")->queryScalar();
        $section = !empty($_POST['section']) && $_POST['section']!='All'?' and section_name="'.$_POST['section'].'" ':'';
        $degree_name = Yii::$app->db->createCommand("select concat(degree_code,'  ',programme_code) as degree_name from coe_degree a,coe_programme b,coe_bat_deg_reg c where a.coe_degree_id=c.coe_degree_id and b.coe_programme_id=c.coe_programme_id and c.coe_bat_deg_reg_id='" . $_POST['batch_map_id'] . "'")->queryScalar();
        $month = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $_POST['month'] . "'")->queryScalar();
        $mark_type_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='27' ")->queryScalar();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reg_year = Yii::$app->db->createCommand("select regulation_year from coe_bat_deg_reg where coe_batch_id='" . $_POST['batch'] . "' and coe_bat_deg_reg_id='". $_POST['batch_map_id']."'   ")->queryScalar();

         $sem = ConfigUtilities::semCaluclation($_POST['year'], $_POST['month'], $_POST['batch_map_id']);

        $query_gr = new Query();
        $query_gr->select('grade_name')
            ->from('coe_regulation')
            ->where(['regulation_year' => $reg_year])
            ->andWhere(['NOT', ['grade_name' => '']])->groupBy('grade_name');
        $grade_name = $query_gr->createCommand()->queryAll();
        $query_cr = new Query();
        $query_cr->select('distinct(subject_code), b.semester, subject_name, coe_subjects_mapping_id, description, coe_subjects_id, batch_mapping_id, CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_dummy_number c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month'],'b.semester'=>$sem])->andWhere(['<>','b.paper_type_id','136']);
        $subject_list = $query_cr->createCommand()->queryAll();
        if (count($subject_list) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $course_result_table = '';
            $course_result_table .= '<table border=1  width="100%" class="table table-striped table-responsive table-hover table-bordered"  align="center">';
            $course_result_table .= '<tr>
                                        <td colspan=27 align="center"> 
                                            <center><b><font size="6px">' . $org_name . '</font></b></center>
                                            <center>' . $org_address . '</center>
                                            <center>' . $org_tagline . '</center> 
                                        </td>
                                       
                                    </tr>';
            $course_result_table .= '<tr><td colspan=27 align="center"><b>' .  "Moderation ".ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' Result Analysis</b> - ' . strtoupper($month . ' ' . $_POST['year']) . '</td></tr>';
            $course_result_table .= '<tr><td colspan=27 align="center"><b>Batch - ' . $batch_name . ' ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . '</b> - ' . $degree_name . '</td></tr>';
            $colspan = 0; // is the number of columns
             $course_result_table .= '<tr>                                                                                                                                
                            <th> S. NO </th> 
                            <th>' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' CODE </th> 
                            <th>CIA Max</th> 
                            <th colspan="' . $colspan . '" >' . strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)) . ' NAME </th>
                            <th>ENR</th>
                            <th>APP</th>
                            <th>ABS</th>
                            <th>WH</th>
                            <th>PA</th>
                            <th>FA</th>
                            <th>PA%</th>
                            <th>FA%</th>
                            <th>MEAN CIA (Out of Max)</th>
                            <th>MEAN CIA 100</th>
                            <th>MEAN ESE (Out of 100)</th>
                            <th>SD</th>
                            <th>91-100</th>
                            <th>81-90</th>
                            <th>71-80</th>
                            <th>61-70</th>
                            <th>50-60</th>
                            <th>45-49</th>
                            <th>40-44</th>
                            <th>35-39</th>
                            <th>30-34</th>
                            <th>0-29</th>
                            <th>Moderated</th>';
            $old_grade = '';
            
            $course_result_table .= '</tr>';
            //return $course_result_table;exit;
            $sn = 1; $total_appered_stu=0; $total_pass_stu=0; $total_enroll_stu=0; $tot_stu ='';
            foreach ($subject_list as $subject) {
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_dummy_number b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $student_enrol . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_dummy_number b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared-$student_absent;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';

                $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                }
                    //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();
                $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (d.grand_total >= 45)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();

                $moderation_passquery = "SELECT count(DISTINCT b.student_map_id) FROM coe_dummy_number a 
                JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section";

                $mod_student_pass =Yii::$app->db->createCommand($moderation_passquery)->queryScalar();

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (d.grand_total < 45 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;

                if($mod_student_pass>0)
                {
                    $student_pass=($student_pass + $mod_student_pass);
                    $student_fail=($student_fail - $mod_student_pass);
                    $course_result_table .= '<td>' . $student_pass. '</td>';
                    $course_result_table .= '<td>' . $student_fail . '</td>';
                }
                else
                {
                    $course_result_table .= '<td>' . $student_pass. '</td>';
                    $course_result_table .= '<td>' . $student_fail . '</td>';
                }
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }

                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                
                if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }
                $course_result_table .= '<td>' . $MEANCIA100 . '</td>';

                //$moderation_markquery = "SELECT sum(d.mark) as mark, count(d.mark) as count FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization d ON d.dummy_number=b.dummy_number AND d.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section "; 

                $moderation_markquery = "SELECT sum(b.mark) as mark, count(b.mark) as count FROM coe_dummy_number a 
                JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 

                $mod_student_mark =Yii::$app->db->createCommand($moderation_markquery)->queryone();
                //print_r($mod_student_mark);
                $query_mean = new Query();
                 $query_SSD = new Query();
                if($mod_student_mark['count']!='0')
                {
                    $query_mean = "SELECT (sum(d.grand_total)) as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number JOIN coe_vmoderation_normalization e ON e.dummy_number!=b.dummy_number AND e.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND b.year='".$_POST['year']."' and student_status='Active' and b.month='".$_POST['month']."'";

                     $student_mean = Yii::$app->db->createCommand($query_mean)->queryone();
                     
                     $temp_mean=round(($student_mean['mark']/$student_appeared),2);
                     $mod_mean=round(($mod_student_mark['mark']/$student_appeared),2);
                    $MEAN = round($temp_mean+$mod_mean,2);

                    $query_SSD = "SELECT power(sum($temp_mean-(d.grand_total)),2) as ssd FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number JOIN coe_vmoderation_normalization e ON e.dummy_number!=b.dummy_number AND e.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' group by b.student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }

                    $moderation_SSDquery = "SELECT power(sum($mod_mean-(d.mark)),2) as ssd FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization d ON d.dummy_number=b.dummy_number AND d.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section group by b.student_map_id";

                    $mod_student_SSD =Yii::$app->db->createCommand($moderation_SSDquery)->queryAll();

                    $ssd_calc1 = 0;
                    foreach ($mod_student_SSD as $key => $ssd_val) 
                    {
                        $ssd_calc1 +=$ssd_val['ssd'];
                    }

                    $variance1 = round(($ssd_calc/$student_appeared),2);
                    $variance2 = round(($ssd_calc1/$student_appeared),2);
                    $variance=$variance1+$variance2;

                    $course_result_table .= '<td>' . $MEAN . '</td>';
                    $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';
                }
                else
                {
                    $query_mean = "SELECT (sum(d.grand_total)) as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryone();

                    $MEAN = round(($student_mean['mark']/$student_appeared),2);

                     $query_SSD = "SELECT power(sum($MEAN-d.grand_total),2) as ssd FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                     $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);

                    $course_result_table .= '<td>' . $MEAN . '</td>';
                    $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';
                }

                 $query_border100 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 91 AND d.grand_total <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 81 AND d.grand_total <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 71 AND d.grand_total <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 61 AND d.grand_total <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 50 AND d.grand_total <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                $query_mode = "SELECT d.dummy_number FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization d ON d.dummy_number=b.dummy_number WHERE d.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND d.year='".$_POST['year']."' and student_status='Active' and d.month='".$_POST['month']."'";
                $student_mod = Yii::$app->db->createCommand($query_mode)->queryAll();

                $query_border49 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 45 AND d.grand_total <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.(count($student_border49)+count($student_mod)).'</td>';

               $query_border44 = "SELECT d.dummy_number FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number JOIN coe_vmoderation_normalization e ON e.dummy_number!=d.dummy_number AND e.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND b.year='".$_POST['year']."' and student_status='Active' and b.month='".$_POST['month']."' AND (d.grand_total >= 40 AND d.grand_total <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border39 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 35 AND d.grand_total <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 30 AND d.grand_total <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id,d.dummy_number,b.month,b.year,d.grand_total as mark FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (d.grand_total >= 0 AND d.grand_total <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                
                if(count($student_mod)>0)
                {
                    $course_result_table .= '<td>'.count($student_mod).'</td>';
                    
                }
                else
                {
                    $course_result_table .= '<td></td>';
                }
               

                $course_result_table .= '</tr>';
                
                if($sn==1)
                {
                    $total_enroll_stu=$student_enrol;
                    $total_appered_stu=$student_appeared;
                }
                
                $sn++;
            }
           
            //practical
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_practical_entry c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.paper_type_id'=>'10','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month']]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {$notIn1 = array_filter(['']);
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_practical_entry b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_practical_entry b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                }
                    //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();

                $student_appeared=$student_appeared-$student_withheld;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';

                
                $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.out_of_100 >= 45)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.out_of_100 < 45 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $query_mean = new Query();
                $query_mean = "SELECT sum(b.out_of_100) FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                $MEAN = round(($student_mean/$student_appeared),2);

                $query_SSD = new Query();
                $query_SSD = "SELECT power(sum($MEAN-b.out_of_100),2) as ssd FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                $ssd_calc = 0;
                foreach ($student_ssd as $key => $ssd_val) 
                {
                    $ssd_calc +=$ssd_val['ssd'];
                }
                $variance = round(($ssd_calc/$student_appeared),2);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }

                 if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA100 . '</td>';
                $course_result_table .= '<td>' . $MEAN . '</td>';
                $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';

                $query_border100 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 91 AND b.out_of_100 <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 81 AND b.out_of_100 <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 71 AND b.out_of_100 <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 61 AND b.out_of_100 <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 50 AND b.out_of_100 <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                 $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 45 AND b.out_of_100 <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.count($student_border49).'</td>';

               $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 40 AND b.out_of_100 <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 35 AND b.out_of_100 <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 30 AND b.out_of_100 <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.out_of_100 >= 0 AND b.out_of_100 <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
                
                $sn=$sn+1;
            }
            }

            //softwre based
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_scrtny_sw_based c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['b.paper_type_id'=>'136','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month']]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_scrtny_sw_based b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_scrtny_sw_based b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                 $query_withheld = new Query();
                $query_withheld->select('count(student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['subject_map_id' => $subject['coe_subjects_mapping_id'], 'year' => $_POST['year'], 'month' => $_POST['month'], 'withheld' => 'w']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_withheld->andWhere(['=', 'section_name', $_POST['section']]);
                }
                    //$query_withheld->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_withheld = $query_withheld->createCommand()->queryScalar();
                

                $student_appeared=$student_appeared-$student_withheld;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';

                $course_result_table .= '<td align="center">' . $student_withheld . '</td>';
                
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.grand_total >= 45)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();

                $moderation_passquery = "SELECT count(DISTINCT b.student_map_id) FROM coe_scrtny_sw_based a 
                JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 

                $mod_student_pass =Yii::$app->db->createCommand($moderation_passquery)->queryScalar();

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.grand_total < 45 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;                

                if($mod_student_pass>0)
                {
                   // echo $moderation_passquery;
                    $student_pass=($student_pass + $mod_student_pass);
                    $student_fail=($student_fail - $mod_student_pass);
                    $course_result_table .= '<td>' . $student_pass. '</td>';
                    $course_result_table .= '<td>' . $student_fail . '</td>';
                }
                else
                {
                    $course_result_table .= '<td>' . $student_pass. '</td>';
                    $course_result_table .= '<td>' . $student_fail . '</td>';
                }
                
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }

                 if($MEANCIA==0)
                  {
                        $MEANCIA100=0;
                  }
                  else
                  {
                    $MEANCIA100 = round((($MEANCIA/$subject['CIA_max'])*100),2);
                    }

                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA100 . '</td>';
              
               $moderation_markquery = "SELECT sum(b.mark) as mark, count(b.mark) as count FROM coe_scrtny_sw_based a 
                JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 

                $mod_student_mark =Yii::$app->db->createCommand($moderation_markquery)->queryone();
                //print_r($mod_student_mark);
                $query_mean = new Query();
                 $query_SSD = new Query();
                if($mod_student_mark['count']!='0')
                {
                    $query_mode = "SELECT b.dummy_number FROM coe_scrtny_sw_based a 
                    JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 

                    $student_mod = Yii::$app->db->createCommand($query_mode)->queryAll();

                    $notIn_mod = ''; $m=1;
                    foreach ($student_mod as $key => $fails) 
                    {
                        if($m<count($student_mod))
                        {
                             $notIn_mod.="'".$fails['dummy_number']."',";
                        }
                        else
                        {
                             $notIn_mod.="'".$fails['dummy_number']."'";
                        }
                       
                        $m++; 
                    }

                    $query_mean = "SELECT (sum(b.grand_total)) as mark FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."'  AND REJ.register_number NOT IN (".$notIn_mod.")";

                     $student_mean = Yii::$app->db->createCommand($query_mean)->queryone();
                     
                     $temp_mean=round(($student_mean['mark']/$student_appeared),2);
                     $mod_mean=round(($mod_student_mark['mark']/$student_appeared),2);
                    $MEAN = round($temp_mean+$mod_mean,2);

                    $query_SSD = "SELECT power(sum($temp_mean-(b.grand_total)),2) as ssd FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND REJ.register_number NOT IN (".$notIn_mod.") $section group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }

                    $moderation_SSDquery = "SELECT power(sum($mod_mean-(d.mark)),2) as ssd FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization d ON d.dummy_number=REJ.register_number AND d.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section group by b.student_map_id";

                    $mod_student_SSD =Yii::$app->db->createCommand($moderation_SSDquery)->queryAll();

                    $ssd_calc1 = 0;
                    foreach ($mod_student_SSD as $key => $ssd_val) 
                    {
                        $ssd_calc1 +=$ssd_val['ssd'];
                    }

                    $variance1 = round(($ssd_calc/$student_appeared),2);
                    $variance2 = round(($ssd_calc1/$student_appeared),2);
                    $variance=$variance1+$variance2;

                    $course_result_table .= '<td>' . $MEAN . '</td>';
                    $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';
                }
                else
                {
                   $query_mean = new Query();
                    $query_mean = "SELECT sum(b.grand_total) FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                    $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                    $MEAN = round(($student_mean/$student_appeared),2);

                    $query_SSD = new Query();
                    $query_SSD = "SELECT power(sum($MEAN-b.grand_total),2) as ssd FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                    $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                    $ssd_calc = 0;
                    foreach ($student_ssd as $key => $ssd_val) 
                    {
                        $ssd_calc +=$ssd_val['ssd'];
                    }
                    $variance = round(($ssd_calc/$student_appeared),2);
                     $course_result_table .= '<td>' . $MEAN . '</td>';
                    $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';
                }

                $query_border100 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 91 AND b.grand_total <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 81 AND b.grand_total <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 71 AND b.grand_total <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 61 AND b.grand_total <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 50 AND b.grand_total <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                $query_mode = "SELECT distinct b.dummy_number FROM coe_scrtny_sw_based a 
                    JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 
                $student_mod = Yii::$app->db->createCommand($query_mode)->queryAll();

                $notIn_mod = '';$m=1;
                foreach ($student_mod as $key => $fails) 
                {
                    if($m<count($student_mod))
                    {
                         $notIn_mod.="'".$fails['dummy_number']."',";
                    }
                    else
                    {
                         $notIn_mod.="'".$fails['dummy_number']."'";
                    }
                   
                $m++; 
                }

                $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 45 AND b.grand_total <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.(count($student_border49)+count($student_mod)).'</td>';

                $dummy_num='';
                if(!empty($student_mod))
                {
                    $dummy_num=" AND e.dummy_number NOT IN (".$notIn_mod.")";
                    $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization e ON e.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND b.year='".$_POST['year']."' and student_status='Active' and b.month='".$_POST['month']."' AND (b.grand_total >= 40 AND b.grand_total <= 44) ".$dummy_num;

                    $query_border44_before = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND b.year='".$_POST['year']."' and student_status='Active' and b.month='".$_POST['month']."' AND (b.grand_total >= 40 AND b.grand_total <= 44) ";
                }
                else
                {
                    $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND b.year='".$_POST['year']."' and student_status='Active' and b.month='".$_POST['month']."' AND (b.grand_total >= 40 AND b.grand_total <= 44) ";
                }
                
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                
                if(count($student_mod)>0)
                {
                    $student_border44_before = Yii::$app->db->createCommand($query_border44_before)->queryAll();
                    $notmod=count($student_border44_before)-count($student_mod);
                    $course_result_table .= '<td>'.$notmod.'</td>';
                }
                else
                {
                    $course_result_table .= '<td>'.count($student_border44).'</td>';
                }
                


                $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 35 AND b.grand_total <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 30 AND b.grand_total <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.grand_total >= 0 AND b.grand_total <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                if(count($student_mod)>0)
                {
                    $course_result_table .= '<td>'.count($student_mod).'</td>';
                    
                }
                else
                {
                    $course_result_table .= '<td></td>';
                }

                $course_result_table .= '</tr>';
         
                $sn=$sn+1;
            }
            }
            
            // internal mode
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master_temp c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['a.ESE_max'=>'0','b.paper_type_id'=>'105','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month']]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
           
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master_temp b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';
                $course_result_table .= '<td>0</td>'; //with held
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.total >= 50)"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.total < 50 )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $query_mean = new Query();
                $query_mean = "SELECT sum(b.total) FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' ";
                $student_mean = Yii::$app->db->createCommand($query_mean)->queryScalar();

                $MEAN = round(($student_mean/$student_appeared),2);

                $query_SSD = new Query();
                $query_SSD = "SELECT power(sum($MEAN-b.total),2) as ssd FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' group by student_map_id";
                $student_ssd = Yii::$app->db->createCommand($query_SSD)->queryAll();
                $ssd_calc = 0;
                foreach ($student_ssd as $key => $ssd_val) 
                {
                    $ssd_calc +=$ssd_val['ssd'];
                }
                $variance = round(($ssd_calc/$student_appeared),2);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                 {

                    $query_meancia = new Query();
                    $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."'  AND  a.section_name='".$_POST['section']."' AND b.category_type_id=46";
                    $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                    $MEANCIA = round(($student_meancia/$student_appeared),2);
                   // $MEANCIA = empty($MEANCIA_1 )?"0":$MEANCIA_1 ;
                }
                 else
                 {
                        $query_meancia = new Query();
                        $query_meancia = "SELECT sum(b.category_type_id_marks) FROM coe_student_mapping a JOIN coe_mark_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and month='".$_POST['month']."' AND b.category_type_id=46 ";
                        $student_meancia = Yii::$app->db->createCommand($query_meancia)->queryScalar();

                        $MEANCIA = round(($student_meancia/$student_appeared),2);



                 }


                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEANCIA . '</td>';
                $course_result_table .= '<td>' . $MEAN . '</td>';
                $course_result_table .= '<td>' . round(sqrt($variance),2) . '</td>';

                $query_border100 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 91 AND b.total <= 100)";
                $student_border100 = Yii::$app->db->createCommand($query_border100)->queryAll();
                $course_result_table .= '<td>'.count($student_border100).'</td>';

                $query_border90 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 81 AND b.total <= 90)";
                $student_border90 = Yii::$app->db->createCommand($query_border90)->queryAll();
                $course_result_table .= '<td>'.count($student_border90).'</td>';

                $query_border80 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 71 AND b.total <= 80)";
                $student_border80 = Yii::$app->db->createCommand($query_border80)->queryAll();
                $course_result_table .= '<td>'.count($student_border80).'</td>';

                $query_border70 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 61 AND b.total <= 70)";
                $student_border70 = Yii::$app->db->createCommand($query_border70)->queryAll();
                $course_result_table .= '<td>'.count($student_border70).'</td>';

                $query_border60 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 50 AND b.total <= 60)";
                $student_border60 = Yii::$app->db->createCommand($query_border60)->queryAll();
                $course_result_table .= '<td>'.count($student_border60).'</td>';

                 $query_border49 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 45 AND b.total <= 49)";
                $student_border49 = Yii::$app->db->createCommand($query_border49)->queryAll();
                $course_result_table .= '<td>'.count($student_border49).'</td>';

               $query_border44 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 40 AND b.total <= 44)";
                $student_border44 = Yii::$app->db->createCommand($query_border44)->queryAll();
                $course_result_table .= '<td>'.count($student_border44).'</td>';

                $query_border39 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 35 AND b.total <= 39)";
                $student_border39 = Yii::$app->db->createCommand($query_border39)->queryAll();
                $course_result_table .= '<td>'.count($student_border39).'</td>';

                $query_border30 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 30 AND b.total <= 34)";
                $student_border30 = Yii::$app->db->createCommand($query_border30)->queryAll();
                $course_result_table .= '<td>'.count($student_border30).'</td>';

                $query_border29 = "SELECT b.subject_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' AND year='".$_POST['year']."' and student_status='Active' and month='".$_POST['month']."' AND (b.total >= 0 AND b.total <= 29)";
                $student_border29 = Yii::$app->db->createCommand($query_border29)->queryAll();
                $course_result_table .= '<td>'.count($student_border29).'</td>';

                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
                
                $sn=$sn+1;
            }
            }

            //man course start
            $query_cr1 = new Query();
            $query_cr1->select('distinct(subject_code),b.semester,subject_name,coe_subjects_mapping_id,description,coe_subjects_id,batch_mapping_id,CIA_max')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->join('JOIN', 'coe_mark_entry_master c', 'b.coe_subjects_mapping_id=c.subject_map_id')
            ->join('JOIN', 'coe_category_type d', 'b.subject_type_id=d.coe_category_type_id')
            ->where(['a.CIA_max'=>'0','a.ESE_max'=>'0','b.paper_type_id'=>'106','b.batch_mapping_id' => $_POST['batch_map_id'], 'c.year' => $_POST['year'], 'c.month' => $_POST['month']]);
            //echo $query_cr1->createCommand()->getrawsql(); exit;
            $subject_list1 = $query_cr1->createCommand()->queryAll();
            $tot_stu1='';
            if(!empty($subject_list1))
            {
            foreach ($subject_list1 as $subject) 
            {
                
                $course_result_table .= '<tr><td align="left">' . $sn . '</td><td align="left">' . $subject['subject_code'] . '</td><td align="left">'.$subject['CIA_max'].'</td><td colspan="' . $colspan . '"  align="left">' . $subject['subject_name'] . '</td>';
                $query_enroll = new Query();
                $query_enroll->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id and c.batch_mapping_id=a.course_batch_mapping_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'],'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_enroll->andWhere(['=', 'section_name', $_POST['section']]);
                }
                //$query_enroll->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_enrol = $query_enroll->createCommand()->queryScalar();
                $course_result_table .= '<td>' . $total_enroll_stu . '</td>';

                $query_appeared = new Query();
                $query_appeared->select('count(DISTINCT student_map_id)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_mark_entry_master b', 'b.student_map_id=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.subject_map_id')
                    ->where(['b.subject_map_id' => $subject['coe_subjects_mapping_id'], 'b.year' => $_POST['year'], 'b.month' => $_POST['month'],'student_status'=>'Active']);

                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_appeared->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_appeared->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_appeared = $query_appeared->createCommand()->queryScalar();
               
                
                  $query_absent = new Query();
                $query_absent->select('count(absent_student_reg)')
                    ->from('coe_student_mapping a')
                    ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                    ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                    ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                    ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                if(!empty($_POST['section']) && $_POST['section']!='All')
                {
                     $query_absent->andWhere(['=', 'section_name', $_POST['section']]);
                }

                //$query_absent->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $student_absent = $query_absent->createCommand()->queryScalar();

                $student_appeared=$student_appeared;
                $course_result_table .= '<td>' . $student_appeared . '</td>';
                $course_result_table .= '<td>' . $student_absent . '</td>';
                $course_result_table .= '<td>0</td>';
                $select_passquery = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result = 'Pass' )"; 

                $student_pass =Yii::$app->db->createCommand($select_passquery)->queryScalar();
                $course_result_table .= '<td>' . $student_pass . '</td>';

                $select_query = "SELECT count(student_map_id) FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND year='".$_POST['year']."' and month='".$_POST['month']."' $section and (b.result = 'Fail' )";
                $student_fail =Yii::$app->db->createCommand($select_query)->queryScalar();
                $student_appeared = $student_appeared==0 ? 1: $student_appeared;
                $student_enrol = $student_enrol==0 ? 1: $student_enrol;
                $course_result_table .= '<td>' . $student_fail . '</td>';
                
                if ($mark_type_name == "Regular") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    $pass_percent = ($student_pass / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($pass_percent, 1) . '</td>';
                }
                if ($mark_type_name == "Regular") {

                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                } else if ($mark_type_name == "Arrear") {
                    
                    $fail_percent = ($student_fail / $student_enrol) * 100;
                    $course_result_table .= '<td>' . round($fail_percent, 1) . '</td>';
                }

                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';

               $course_result_table .= '<td>0</td>';

                $course_result_table .= '<td>0</td>';

                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';

                
                $course_result_table .= '<td>0</td>';

               $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td>0</td>';
                
                $course_result_table .= '<td>0</td>';
                $course_result_table .= '<td></td>';

                $course_result_table .= '</tr>';
                
                $sn=$sn+1;
            }
            }

           

           $sem_count = ConfigUtilities::SemCaluclation($_POST['year'],$_POST['month'],$_POST['batch_map_id']);
            $query_cr1 = new Query();
            $query_cr1->select('distinct(coe_subjects_mapping_id)')
            ->from('coe_subjects a')
            ->join('JOIN', 'coe_subjects_mapping b', 'a.coe_subjects_id=b.subject_id')
            ->where(['b.semester' => $sem_count,'b.batch_mapping_id' => $_POST['batch_map_id']]);
            $subject_list1 = $query_cr1->createCommand()->queryAll();

            $notIn_fail = array_filter(['']);
            $notIn_absent = array_filter(['']);
            $student_ababsent=0;
            if (count($subject_list1) > 0) 
            {
                foreach ($subject_list1 as $subject) 
                {
                    
                    $moderation_markquery = "SELECT sum(b.mark) as mark, count(b.mark) as count FROM coe_dummy_number a 
                    JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section"; 

                    $mod_student_mark =Yii::$app->db->createCommand($moderation_markquery)->queryone();

                    if($mod_student_mark['count']!='0')
                    {
                         $total_failquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number JOIN coe_vmoderation_normalization e ON e.dummy_number!=b.dummy_number AND e.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (d.grand_total < 45)";
                    }
                    else
                    {
                        $total_failquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_dummy_number as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_val_barcode_verify_details d ON d.dummy_number=b.dummy_number WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (d.grand_total< 45)"; 
                    }
                    $tot_student_fail =Yii::$app->db->createCommand($total_failquery)->queryAll();
                       
                         foreach ($tot_student_fail as $key => $fails) 
                         {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                        }


                    //$moderation_swquery = "SELECT d.dummy_number FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id JOIN coe_vmoderation_normalization d ON d.dummy_number=REJ.register_number AND d.subject_map_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section "; 

                    $moderation_swquery = "SELECT b.dummy_number FROM coe_scrtny_sw_based a 
                    JOIN coe_vmoderation_normalization b ON b.student_map_id=a.student_map_id and b.subject_map_id=a.subject_map_id WHERE a.subject_map_id='".$subject['coe_subjects_mapping_id']."' AND a.year='".$_POST['year']."' and a.month='".$_POST['month']."' $section";

                    $mod_student_sw =Yii::$app->db->createCommand($moderation_swquery)->queryAll();

                    if(count($mod_student_sw)>0)
                    {
                        $notIn_mod = '';$m=1;
                        foreach ($mod_student_sw as $key => $fails) 
                        {
                            if($m<count($mod_student_sw))
                            {
                                 $notIn_mod.="'".$fails['dummy_number']."',";
                            }
                            else
                            {
                                 $notIn_mod.="'".$fails['dummy_number']."'";
                            }
                           
                        $m++; 
                        }

                         $total_failquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.grand_total < 45) AND REJ.register_number NOT IN (".$notIn_mod.")";
                    }
                    else
                    {
                        $total_failquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_scrtny_sw_based as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.grand_total< 45)"; 
                    }
                    $tot_student_fail =Yii::$app->db->createCommand($total_failquery)->queryAll();
                       
                         foreach ($tot_student_fail as $key => $fails) 
                         {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                        }


                    $total_pracquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_practical_entry as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.out_of_100 < 45)"; 

                        $tot_student_prac =Yii::$app->db->createCommand($total_pracquery)->queryAll();
                       
                        foreach ($tot_student_prac as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }
                   
                    $total_interquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master_temp as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.total < 50)"; 

                        $tot_student_intermode =Yii::$app->db->createCommand($total_interquery)->queryAll();
                       
                        foreach ($tot_student_intermode as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                    
                        $total_manquery = "SELECT b.student_map_id FROM coe_student_mapping a JOIN coe_mark_entry_master as b ON b.student_map_id=a.coe_student_mapping_id JOIN coe_student as REJ ON REJ.coe_student_id=a.student_rel_id  JOIN coe_subjects_mapping c ON c.coe_subjects_mapping_id=b.subject_map_id WHERE b.subject_map_id='".$subject['coe_subjects_mapping_id']."' and student_status='Active' AND b.year='".$_POST['year']."' and b.month='".$_POST['month']."' $section and (b.result = 'Fail')";
                    
                        $tot_student_man =Yii::$app->db->createCommand($total_manquery)->queryAll();
                       
                        foreach ($tot_student_man as $key => $fails) 
                        {
                            if(!in_array($fails['student_map_id'],$notIn_fail))
                            {
                                $notIn_fail[$fails['student_map_id']]=$fails['student_map_id'];
                            }
                            
                        }

                        $query_mabsent = new Query();
                        $query_mabsent->select('absent_student_reg')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student as REJ', 'REJ.coe_student_id=a.student_rel_id')
                            ->join('JOIN', 'coe_absent_entry b', 'b.absent_student_reg=a.coe_student_mapping_id')
                            ->join('JOIN', 'coe_subjects_mapping c', 'c.coe_subjects_mapping_id=b.exam_subject_id')
                            ->where(['b.exam_subject_id' => $subject['coe_subjects_mapping_id'], 'b.exam_year' => $_POST['year'],'student_status'=>'Active', 'b.exam_month' => $_POST['month']]);
                        $student_aabsent = $query_mabsent->createCommand()->queryAll();
                        //print_r($student_aabsent);
                        foreach ($student_aabsent as $key => $absent) 
                         {
                            if(!in_array($absent['absent_student_reg'],$notIn_fail))
                            {
                              $notIn_fail[$absent['absent_student_reg']]=$absent['absent_student_reg'];
                            }
                        }
                }

            }
            $tot=$total_enroll_stu-(count($notIn_fail));


            $course_result_table .= '<tr><td colspan="13" style="text-align:center;"><b>Over All Pass: '.$tot.' &nbsp; Over All Pass Percent: '.round((($tot / $total_appered_stu) * 100),2).'% </b></td></tr>';
            $course_result_table .= '</table>';
            if (isset($_SESSION['programme_analysis_printtemp1'])) {
                unset($_SESSION['programme_analysis_printtemp1']);
            }
            $_SESSION['programme_analysis_printtemp1'] = $course_result_table;
            return $course_result_table;
        } else {
            return 0;
        }
    }

    public function actionProgrammeAnalysistempPdf1()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['programme_analysis_printtemp1'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Moderation Report Data.pdf',
            'format' => Pdf::FORMAT_A3,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                        table th{
                            border: 1px solid #000;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            padding: 5px;
                        }
                    }   
                ',
            'options' => ['title' => ' Moderation Report Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [' Moderation Report Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
       
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelProgrammeanalysistemp1()
    {
       
        $content = $_SESSION['programme_analysis_printtemp1'];
          
        $fileName = 'Moderation Report Data.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    //Subject Information starts here
    public function actionSubjectinformation()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $galley = new HallAllocate();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Information');
        return $this->render('subjectinformation', [
            'model' => $model, 'galley' => $galley,
        ]);
    }


     public function actionSub()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $galley = new HallAllocate();
        $subject=new SubjectsMapping();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Information');
        return $this->render('sub', [
            'model' => $model, 'galley' => $galley,'subject'=>$subject
        ]);
    }
    //old function 
    public function actionSubjectinformationdata()
    {
        $year = Yii::$app->request->post('year');
        $batch = Yii::$app->request->post('batch');
        $batch_mapping_id = Yii::$app->request->post('batch_mapping_id');
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $batch . "'")->queryScalar();
        $month = Yii::$app->request->post('month');
        $month_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();
        $sem_count = ConfigUtilities::SemCaluclation($year,$month,$batch_mapping_id);

        /*$man_query = new Query();
        $man_query->select('F.batch_name,C.degree_code,B.programme_name,D.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_mandatory_subcat_subjects E', 'A.coe_bat_deg_reg_id=E.batch_map_id')
            ->join('JOIN', 'coe_mandatory_subjects D', 'D.coe_mandatory_subjects_id=E.man_subject_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where([ 'D.batch_mapping_id' => $batch_mapping_id, 'D.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $man_subjects = $man_query->createCommand()->queryAll();*/
        
        $table = "";
        $sn = 1;

        $query = new Query();
        $query->select('F.batch_name,C.degree_code,B.programme_name,E.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,D.credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no,j.description as theoryprac_type')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_subjects_mapping E', 'A.coe_bat_deg_reg_id=E.batch_mapping_id')
            ->join('JOIN', 'coe_subjects D', 'E.subject_id=D.coe_subjects_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
             ->join('JOIN', 'coe_category_type j', 'j.coe_category_type_id=E.type_id')

            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where(['E.batch_mapping_id' => $batch_mapping_id, 'E.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $subject = $query->createCommand()->queryAll();

        //print_r($subject);exit;

        if(!empty($subject))
        {
            $subject =array_merge($subject);
            array_multisort(array_column($subject, 'paper_no'),  SORT_ASC, $subject);
        }

        if (count($subject) > 0) {

            foreach ($subject as $subject12) 
            {
                $prg_name =  $subject12['programme_name'];     
            }

            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table id="checkAllFeet" class="table table-responsive table-striped" align="center" ><tbody align="center">';
            $table .= '
                        <tr>
                            <th colspan=2> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </th>
                            <th colspan=9 align="center"> 
                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </th>
                            <th  colspan=2 align="center">  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </th>
                            
                        </tr>
                        <tr>
                        <td colspan=13> <b>'.strtoupper($prg_name).' '.$year.'-'.strtoupper($month_name).' SEMESTER - '.$sem_count.' '. strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' INFORMATION </b> </td>
                        </tr>';


            $table .= '<tr>
                        <td><b> S.NO </b></td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </td>
                        <td><b> Paper No </td>
                       
                        <td><b> CIA Min </td>
                        <td><b> CIA Max </td>
                        <td><b> ESE Min </td>
                        <td><b> ESE Max </td>
                        <td><b> Total Min </td>
                        <td><b> Credits </td>
                        
                        <td><b> Paper Type </td>
                        <td><b> Course Type </td>
                           <td><b> Theory with practical </td>
                    </tr>';
            foreach ($subject as $subject1) {
                $table .= '
                    <tr>
                        <td> ' . $sn . ' </td>
                       
                        <td> ' . $subject1['subject_code'] . ' </td>
                        <td> ' . $subject1['subject_name'] . ' </td>
                        <td> ' . $subject1['paper_no'] . ' </td>
                       
                        <td> ' . $subject1['CIA_min'] . ' </td>
                        <td> ' . $subject1['CIA_max'] . ' </td>
                        <td> ' . $subject1['ESE_min'] . ' </td>
                        <td> ' . $subject1['ESE_max'] . ' </td>
                        <td> ' . $subject1['total_minimum_pass'] . ' </td>
                        <td> ' . $subject1['credit_points'] . ' </td>
                        <td> ' . $subject1['paper_type'] . ' </td>
                        <td> ' . $subject1['subject_type'] . ' </td>
                          <td> ' . $subject1['theoryprac_type'] . ' </td>
                    </tr>';
                $sn++;
            }
            $table .= '</table>';
        } else {
            $table .= 0;
        }
        if (isset($_SESSION['subject_information_print'])) {
            unset($_SESSION['subject_information_print']);
        }
        $_SESSION['subject_information_print'] = $table;
        return $table;
    }


     public function actionSubdata()
    {
        $year = Yii::$app->request->post('year');
        $batch = Yii::$app->request->post('batch');
        $sem= Yii::$app->request->post('sem');

       // print_r($sem);exit;
        
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $batch . "'")->queryScalar();
        $month = Yii::$app->request->post('month');
        $month_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();
       // $sem_count = ConfigUtilities::SemCaluclation($year,$month,$batch_mapping_id);

        /*$man_query = new Query();
        $man_query->select('F.batch_name,C.degree_code,B.programme_name,D.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_mandatory_subcat_subjects E', 'A.coe_bat_deg_reg_id=E.batch_map_id')
            ->join('JOIN', 'coe_mandatory_subjects D', 'D.coe_mandatory_subjects_id=E.man_subject_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where([ 'D.batch_mapping_id' => $batch_mapping_id, 'D.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $man_subjects = $man_query->createCommand()->queryAll();*/
        
        $table = "";
        $sn = 1;

        $query = new Query();
        $query->select('F.batch_name,C.degree_code,B.programme_name,B.programme_code,E.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,D.credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no,j.description as theoryprac_type')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_subjects_mapping E', 'A.coe_bat_deg_reg_id=E.batch_mapping_id')
            ->join('JOIN', 'coe_subjects D', 'E.subject_id=D.coe_subjects_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
             ->join('JOIN', 'coe_category_type j', 'j.coe_category_type_id=E.type_id')

            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where([ 'E.semester' => $sem,'A.coe_batch_id'=>$batch])->groupBy('C.degree_code,B.programme_code,D.subject_code')->orderBy('C.degree_code,B.programme_code,E.semester');
        $subject = $query->createCommand()->queryAll();

        //print_r($subject);exit;

        if(!empty($subject))
        {
            $subject =array_merge($subject);
            array_multisort(array_column($subject, 'paper_no'),  SORT_ASC, $subject);
        }

        if (count($subject) > 0) {

            foreach ($subject as $subject12) 
            {
                $prg_name =  $subject12['programme_name'];     
            }

            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table id="checkAllFeet" class="table table-responsive table-striped" align="center" ><tbody align="center">';
            $table .= '
                        <tr>
                            <th colspan=2> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </th>
                            <th colspan=9 align="center"> 
                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </th>
                            <th  colspan=2 align="center">  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </th>
                            
                        </tr>
                        <tr>
                        <td colspan=13> <b>'.strtoupper($prg_name).' '.$year.'-'.strtoupper($month_name).' SEMESTER - '.$sem.' '. strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' INFORMATION </b> </td>
                        </tr>';


            $table .= '<tr>
                        <td><b> S.NO </b></td>
                        \<td><b> Prograame Code </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </td>
                        <td><b> Paper No </td>
                       
                        <td><b> CIA Min </td>
                        <td><b> CIA Max </td>
                        <td><b> ESE Min </td>
                        <td><b> ESE Max </td>
                        <td><b> Total Min </td>
                        <td><b> Credits </td>
                        
                        <td><b> Paper Type </td>
                        <td><b> Course Type </td>
                           <td><b> Theory with practical </td>
                    </tr>';
            foreach ($subject as $subject1) {
                $table .= '
                    <tr>
                        <td> ' . $sn . ' </td>
                         <td> ' . $subject1['programme_code'] . ' </td>
                       
                        <td> ' . $subject1['subject_code'] . ' </td>
                        <td> ' . $subject1['subject_name'] . ' </td>
                        <td> ' . $subject1['paper_no'] . ' </td>
                       
                        <td> ' . $subject1['CIA_min'] . ' </td>
                        <td> ' . $subject1['CIA_max'] . ' </td>
                        <td> ' . $subject1['ESE_min'] . ' </td>
                        <td> ' . $subject1['ESE_max'] . ' </td>
                        <td> ' . $subject1['total_minimum_pass'] . ' </td>
                        <td> ' . $subject1['credit_points'] . ' </td>
                        <td> ' . $subject1['paper_type'] . ' </td>
                        <td> ' . $subject1['subject_type'] . ' </td>
                          <td> ' . $subject1['theoryprac_type'] . ' </td>
                    </tr>';
                $sn++;
            }
            $table .= '</table>';
        } else {
            $table .= 0;
        }
        if (isset($_SESSION['subject_information_print'])) {
            unset($_SESSION['subject_information_print']);
        }
        $_SESSION['subject_information_print'] = $table;
        return $table;
    }
    

   /* public function actionSubjectinformationdata()
    {
        $year = Yii::$app->request->post('year');
        $batch = Yii::$app->request->post('batch');

        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $batch_mapping_id = Yii::$app->request->post('batch_mapping_id');
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $batch . "'")->queryScalar();
        $month = Yii::$app->request->post('month');
        $month_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();
        $sem_count = ConfigUtilities::SemCaluclation($year,$month,$batch_mapping_id);

        $man_query = new Query();
        $man_query->select('F.batch_name,C.degree_code,B.programme_name,D.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no, batch_mapping_id as bat_map_id')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_mandatory_subcat_subjects E', 'A.coe_bat_deg_reg_id=E.batch_map_id')
            ->join('JOIN', 'coe_mandatory_subjects D', 'D.coe_mandatory_subjects_id=E.man_subject_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where([ 'D.batch_mapping_id' => $batch_mapping_id, 'D.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $man_subjects = $man_query->createCommand()->queryAll();
        
        $table = "";
        $sn = 1;
        $query = new Query();
        $query->select('F.batch_name,D.coe_subjects_id,C.degree_code,B.programme_name,E.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,D.credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no, batch_mapping_id as bat_map_id')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_subjects_mapping E', 'A.coe_bat_deg_reg_id=E.batch_mapping_id')
            ->join('JOIN', 'coe_subjects D', 'E.subject_id=D.coe_subjects_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where(['E.batch_mapping_id' => $batch_mapping_id, 'E.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $subject = $query->createCommand()->queryAll();

        if(!empty($man_subjects))
        {
            $subject =array_merge($subject,$man_subjects);
            array_multisort(array_column($subject, 'paper_no'),  SORT_ASC, $subject);
        }

        if (count($subject) > 0) {

            foreach ($subject as $subject12) 
            {
                $prg_name =  $subject12['programme_name'];     
            }

            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table id="checkAllFeet" class="table table-responsive table-striped" align="center" ><tbody align="center">';
            $table .= '
                        <tr>
                            <th colspan=3> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </th>
                            <th colspan=13 align="center"> 
                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </th>
                            <th  colspan=4 align="center">  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </th>
                        </tr>
                        <tr>
                        <td colspan=14 align="right"> <b>'.strtoupper($prg_name).' '.$year.'-'.strtoupper($month_name).' '. strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' INFORMATION </b> </td>
                        </tr>';
            $table .= '<tr>
                        <td><b> S.NO </b></td>
                        <td><b> Year </td>
                        
                        <td><b> Semester </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </td>
                        <td><b> Paper No </td>
                        <td><b> Part No </td>
                        <td><b> CIA Min </td>
                        <td><b> CIA Max </td>
                        <td><b> ESE Min </td>
                        <td><b> ESE Max </td>
                        <td><b> Total Min </td>
                        <td><b> Credits </td>
                        <td><b> Paper Type </td>
                        <td><b> Course Type </td>
                        <td><b> No Of ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . 's Registered </td>
                        <td><b> Register Numbers Range </td>
                    </tr>';
            foreach ($subject as $subject1) 
            {
               $subject_query1 = new Query();
                $subject_query1->select('count(c.coe_student_id) as count,min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                    ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
               
                $getDetails = $subject_query1->createCommand()->queryone();
                 $reg_nums =  $getDetails['start_number']== $getDetails['end_number'] ? $getDetails['start_number']:( $getDetails['start_number'].'-'. $getDetails['end_number']);
                
                 $subject_query2 = new Query();
                $subject_query2->select('register_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                 ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
                  $subject_query2->groupBy('register_number')->orderby('register_number');   
                  $getDetails_1 = $subject_query2->createCommand()->queryAll();

                 $reg_nums =  $getDetails['start_number']== $getDetails['end_number'] ? $getDetails['start_number']:( $getDetails['start_number'].'-'. $getDetails['end_number']);


               
                 if(empty($getDetails))
                        {
                            $reg_nums= '';
                            foreach ($getDetails_1 as $key => $regNums)
                             {
                               $reg_nums .=$regNums['register_number'].'-';
                            
                            }

                         $reg_nums = trim($reg_nums,'-');

                    }




                if($subject1['subject_type']=='Elective')
                {
                    $subject_query1 = new Query();
                    $subject_query1->select('count(a.coe_student_id) as count,min(register_number) as start_number,max(register_number) as end_number')
                    ->from('coe_nominal a')
                    ->join('JOIN','coe_student_mapping b','b.course_batch_mapping_id=a.course_batch_mapping_id and b.student_rel_id=a.coe_student_id')
                    ->join('JOIN','coe_student c','c.coe_student_id=a.coe_student_id and b.student_rel_id=c.coe_student_id')
                    ->where(["a.course_batch_mapping_id"=>$subject1['bat_map_id'],'a.semester'=>$subject1['semester'],'student_status'=>'Active','coe_subjects_id'=>$subject1['coe_subjects_id']])
                      ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
                      
                   
                    $getDetails = $subject_query1->createCommand()->queryOne();


                     

                   
                    $subject_query2 = new Query();
                     $subject_query2->select('register_number')
                    ->from('coe_nominal a')
                    ->join('JOIN','coe_student_mapping b','b.course_batch_mapping_id=a.course_batch_mapping_id and b.student_rel_id=a.coe_student_id')
                    ->join('JOIN','coe_student c','c.coe_student_id=a.coe_student_id and b.student_rel_id=c.coe_student_id')
                    ->where(["a.course_batch_mapping_id"=>$subject1['bat_map_id'],'a.semester'=>$subject1['semester'],'student_status'=>'Active','coe_subjects_id'=>$subject1['coe_subjects_id']]);
                     

                     
                     $subject_query2->groupBy('register_number')->orderby('register_number');   
                    $getDetails_1 = $subject_query2->createCommand()->queryAll();



                     $reg_nums =  $getDetails['start_number']== $getDetails['end_number'] ? $getDetails['start_number']:( $getDetails['start_number'].'-'. $getDetails['end_number']);
                      //print_r($reg_nums);exit;
                    

                     if(!empty($getDetails_1))
                        {
                            $reg_nums= '';
                            foreach ($getDetails_1 as $key => $regNums) 
                            {
                                $reg_nums .=$regNums['register_number'].'-';

                            
                            
                            
                        }
                        $reg_nums = trim($reg_nums,'-');

                         


                      


                    
                }
            }

                $table .= '
                    <tr>
                        <td> ' . $sn . ' </td>
                        <td> ' . $year . ' </td>
                        <td> ' . $sem_count . ' </td>
                        <td> ' . $subject1['subject_code'] . ' </td>
                        <td> ' . $subject1['subject_name'] . ' </td>
                        <td> ' . $subject1['paper_no'] . ' </td>
                        <td> ' . $subject1['part_no'] . ' </td>
                        <td> ' . $subject1['CIA_min'] . ' </td>
                        <td> ' . $subject1['CIA_max'] . ' </td>
                        <td> ' . $subject1['ESE_min'] . ' </td>
                        <td> ' . $subject1['ESE_max'] . ' </td>
                        <td> ' . $subject1['total_minimum_pass'] . ' </td>
                        <td> ' . $subject1['credit_points'] . ' </td>
                        <td> ' . $subject1['paper_type'] . ' </td>
                        <td> ' . $subject1['subject_type'] . ' </td>
                        <td> ' . $getDetails['count'] . ' </td>
                         <td> ' . $reg_nums. ' </td>
                    </tr>';
                $sn++;
            }
            $table .= '</table>';
        } else {
            $table .= 0;
        }
        if (isset($_SESSION['subject_information_print'])) {
            unset($_SESSION['subject_information_print']);
        }
        $_SESSION['subject_information_print'] = $table;
        return $table;
    }*/
    /* public function actionSubjectinformationdata()
    {
         $year = Yii::$app->request->post('year');
        $batch = Yii::$app->request->post('batch');

        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_general=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%General%'")->queryScalar();
        $det_rejoin=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Rejoin%'")->queryScalar();
        $det_lateral=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Lateral Entry%'")->queryScalar();
        $det_transfer=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();


        $batch_mapping_id = Yii::$app->request->post('batch_mapping_id');
        $batch_name = Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id='" . $batch . "'")->queryScalar();

        $batch_name_1 = substr( $batch_name, -2);

        
        $month = Yii::$app->request->post('month');
        $month_name = Yii::$app->db->createCommand("select description from coe_category_type where coe_category_type_id='" . $month . "'")->queryScalar();
        $sem_count = ConfigUtilities::SemCaluclation($year,$month,$batch_mapping_id);

        $man_query = new Query();
        $man_query->select('F.batch_name,C.degree_code,B.programme_name,D.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no, batch_mapping_id as bat_map_id')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_mandatory_subcat_subjects E', 'A.coe_bat_deg_reg_id=E.batch_map_id')
            ->join('JOIN', 'coe_mandatory_subjects D', 'D.coe_mandatory_subjects_id=E.man_subject_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where([ 'D.batch_mapping_id' => $batch_mapping_id, 'D.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $man_subjects = $man_query->createCommand()->queryAll();
        
        $table = "";
        $sn = 1;
        $query = new Query();
        $query->select('F.batch_name,D.coe_subjects_id,C.degree_code,B.programme_name,E.semester,D.subject_code,D.subject_name,D.CIA_max,D.ESE_max,D.total_minimum_pass,D.credit_points,D.CIA_min,D.ESE_min,G.description as paper_type,H.description as subject_type,I.description as course_type,paper_no,part_no, batch_mapping_id as bat_map_id')
            ->from('coe_bat_deg_reg A')
            ->join('JOIN', 'coe_programme B', 'A.coe_programme_id=B.coe_programme_id')
            ->join('JOIN', 'coe_degree C', 'A.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_subjects_mapping E', 'A.coe_bat_deg_reg_id=E.batch_mapping_id')
            ->join('JOIN', 'coe_subjects D', 'E.subject_id=D.coe_subjects_id')
            ->join('JOIN', 'coe_category_type G', 'G.coe_category_type_id=E.paper_type_id')
            ->join('JOIN', 'coe_category_type H', 'H.coe_category_type_id=E.subject_type_id')
            ->join('JOIN', 'coe_category_type I', 'I.coe_category_type_id=E.course_type_id')
            ->join('JOIN', 'coe_batch F', 'A.coe_batch_id=F.coe_batch_id')
            ->where(['E.batch_mapping_id' => $batch_mapping_id, 'E.semester' => $sem_count])->groupBy('subject_code')->orderBy('paper_no');
        $subject = $query->createCommand()->queryAll();

        if(!empty($man_subjects))
        {
            $subject =array_merge($subject,$man_subjects);
            array_multisort(array_column($subject, 'paper_no'),  SORT_ASC, $subject);
        }

        if (count($subject) > 0) {

            foreach ($subject as $subject12) 
            {
                $prg_name =  $subject12['programme_name'];     
            }

            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table id="checkAllFeet" class="table table-responsive table-striped" align="center" ><tbody align="center">';
            $table .= '
                        <tr>
                            <th colspan=3> 
                                <img class="img-responsive" width="100" height="100" src="' . Yii::getAlias("@web") . '/images/main_logo.png" alt="College Logo">
                            </th>
                            <th colspan=12 align="center"> 
                                <center><b><font size="6px">' . $org_name . '</font></b></center>
                                <center>' . $org_address . '</center>
                                
                                <center>' . $org_tagline . '</center> 
                            </th>
                            <th  colspan=4 align="center">  
                                <img width="100" height="100" class="img-responsive" src="' . Yii::getAlias("@web") . '/images/skacas.png" alt="College Logo 2">
                            </th>
                        </tr>
                        <tr>
                        <td colspan=14> <b>'.strtoupper($prg_name).' '.$year.'-'.strtoupper($month_name).' '. strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' INFORMATION </b> </td>
                        </tr>';
            $table .= '<tr>
                        <td><b> S.NO </b></td>
                        <td><b> Year </td>
                        
                        <td><b> Semester </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </td>
                        <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </td>
                        <td><b> Paper No </td>
                        <td><b> Part No </td>
                        <td><b> CIA Min </td>
                        <td><b> CIA Max </td>
                        <td><b> ESE Min </td>
                        <td><b> ESE Max </td>
                        <td><b> Total Min </td>
                        <td><b> Credits </td>
                        <td><b> Paper Type </td>
                        <td><b> Course Type </td>
                        <td><b> No Of ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . 's Registered </td>
                        <td><b> Register Numbers Range </td>
                    </tr>';
            foreach ($subject as $subject1) 
            {
                $subject_query1 = new Query();
                $subject_query1->select('count(c.coe_student_id) as count,min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
                $getDetails = $subject_query1->createCommand()->queryone();
                $subject_query1_general = new Query();
                $subject_query1_general->select('count(c.coe_student_id) as count,min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active','status_category_type_id'=>'3'])
                ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
               
                $getDetails_gen = $subject_query1_general->createCommand()->queryone();
                 $reg_nums =  $getDetails_gen['start_number']== $getDetails_gen['end_number'] ? $getDetails_gen['start_number']:( $getDetails_gen['start_number'].'-'. $getDetails_gen['end_number']);

                  $subject_query1_second = new Query();
                $subject_query1_second->select('min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                 ->andWhere(['IN','status_category_type_id',[$det_lateral]]);
               
                $getDetails_second = $subject_query1_second->createCommand()->queryone();
                $reg_nums_1 =  $getDetails_second['start_number']== $getDetails_second['end_number'] ? $getDetails_second['start_number']:( $getDetails_second['start_number'].'-'. $getDetails_second['end_number']);

                 $subject_query1_third = new Query();
                $subject_query1_third->select('min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                 ->andWhere(['IN','status_category_type_id',[$det_transfer]]);
               
                $getDetails_third = $subject_query1_third->createCommand()->queryone();
                $reg_nums_2 =  $getDetails_third['start_number']== $getDetails_third['end_number'] ? $getDetails_third['start_number']:( $getDetails_third['start_number'].'-'. $getDetails_third['end_number']);

                 $subject_query1_fourth = new Query();
                $subject_query1_fourth->select('min(register_number) as start_number,max(register_number) as end_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id'],'student_status'=>'Active'])
                 ->andWhere(['IN','status_category_type_id',[$det_rejoin]]);
               
                $getDetails_fourth = $subject_query1_fourth->createCommand()->queryone();
                $reg_nums_3 =  $getDetails_fourth['start_number']== $getDetails_fourth['end_number'] ? $getDetails_fourth['start_number']:( $getDetails_fourth['start_number'].'-'. $getDetails_fourth['end_number']);

                $subject_query2 = new Query();
                $subject_query2->select('register_number')
                ->from('coe_student_mapping b')
                ->join('JOIN','coe_student c','b.student_rel_id=c.coe_student_id')
                ->where(["b.course_batch_mapping_id"=>$subject1['bat_map_id']]);
                 
                  $subject_query2->groupBy('register_number')->orderby('register_number');   
                  $getDetails_1 = $subject_query2->createCommand()->queryAll();   
                
               // $reg_nums =  $getDetails['start_number']== $getDetails['end_number'] ? $getDetails['start_number']:( $getDetails['start_number'].'-'. $getDetails['end_number']);
                if(empty($getDetails_1) )
                        {
                            $reg_nums= '';
                            $reg_nums_1 ='';
                            $reg_nums_2 ='';
                            $reg_nums_3='';
                            foreach ($getDetails_gen as $key => $regNums)
                             {
                               $reg_nums .=$regNums['register_number'].'-';
                            
                              }
                              foreach ($getDetails_second as $key => $regNums1) {

                                 $reg_nums_1 .=$regNums['register_number'].'-';
                                  # code...
                              }
                              foreach ($getDetails_third as $key => $regNums2) {

                                 $reg_nums_2 .=$regNums['register_number'].'-';
                                  # code...
                              }
                               foreach ($getDetails_fourth as $key => $regNums3) {

                                 $reg_nums_3 .=$regNums['register_number'].'-';
                                  # code...
                              }


                         $reg_nums = trim($reg_nums,'-');
                         $reg_nums_1=trim($reg_nums_1,'-');
                         $reg_nums_2=trim($reg_nums_2,'-');
                         $reg_nums_3=trim($reg_nums_3,'-');



                         }
                if($subject1['subject_type']=='Elective')
                {
                    $subject_query1 = new Query();
                    $subject_query1->select('count(a.coe_student_id) as count,min(register_number) as start_number,max(register_number) as end_number')
                    ->from('coe_nominal a')
                    ->join('JOIN','coe_student_mapping b','b.course_batch_mapping_id=a.course_batch_mapping_id and b.student_rel_id=a.coe_student_id')
                    ->join('JOIN','coe_student c','c.coe_student_id=a.coe_student_id and b.student_rel_id=c.coe_student_id')
                    ->where(["a.course_batch_mapping_id"=>$subject1['bat_map_id'],'a.semester'=>$subject1['semester'],'student_status'=>'Active','coe_subjects_id'=>$subject1['coe_subjects_id']])
                      ->andWhere(['NOT IN','status_category_type_id',[$det_disc_type,$det_cat_type]]);
                      
                   
                    $getDetails = $subject_query1->createCommand()->queryOne();


                     

                   
                    $subject_query2 = new Query();
                     $subject_query2->select('register_number')
                    ->from('coe_nominal a')
                    ->join('JOIN','coe_student_mapping b','b.course_batch_mapping_id=a.course_batch_mapping_id and b.student_rel_id=a.coe_student_id')
                    ->join('JOIN','coe_student c','c.coe_student_id=a.coe_student_id and b.student_rel_id=c.coe_student_id')
                    ->where(["a.course_batch_mapping_id"=>$subject1['bat_map_id'],'a.semester'=>$subject1['semester'],'student_status'=>'Active','coe_subjects_id'=>$subject1['coe_subjects_id']]);
                     

                     
                     $subject_query2->groupBy('register_number')->orderby('register_number');   
                    $getDetails_1 = $subject_query2->createCommand()->queryAll();



                     
                      //print_r($reg_nums);exit;
                    

                     if(!empty($getDetails_1))
                        {
                            $reg_nums= '';
                            foreach ($getDetails_1 as $key => $regNums) 
                            {

                               
                                $reg_nums .=$regNums['register_number'].'-';



                            
                        }
                      }
                 $reg_nums = trim($reg_nums,'-');

                 
            }

                
            


                $table .= '
                    <tr>
                        <td> ' . $sn . ' </td>
                        <td> ' . $year . ' </td>
                        <td> ' . $sem_count . ' </td>
                        <td> ' . $subject1['subject_code'] . ' </td>
                        <td> ' . $subject1['subject_name'] . ' </td>
                        <td> ' . $subject1['paper_no'] . ' </td>
                        <td> ' . $subject1['part_no'] . ' </td>
                        <td> ' . $subject1['CIA_min'] . ' </td>
                        <td> ' . $subject1['CIA_max'] . ' </td>
                        <td> ' . $subject1['ESE_min'] . ' </td>
                        <td> ' . $subject1['ESE_max'] . ' </td>
                        <td> ' . $subject1['total_minimum_pass'] . ' </td>
                        <td> ' . $subject1['credit_points'] . ' </td>
                        <td> ' . $subject1['paper_type'] . ' </td>
                        <td> ' . $subject1['subject_type'] . ' </td>
                        <td> ' . $getDetails['count'] . ' </td>

                        
                        <td> ' . $reg_nums. ',' . $reg_nums_1. ','.$reg_nums_2.' ,' . $reg_nums_3. '</td>  
                        

                    </tr>';
                $sn++;
            
        }
            $table .= '</table>';
        } else {
            $table .= 0;
        }
        if (isset($_SESSION['subject_information_print'])) {
            unset($_SESSION['subject_information_print']);
        }
        $_SESSION['subject_information_print'] = $table;
        return $table;
    }*/
    public function actionSubjectinformationPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['subject_information_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " Information .pdf",
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 13px; } 
                        
                        table td{
                            border: 1px solid #000;                            
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            
                        }
                        table th{
                            border: 1px solid #000;
                           
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                           
                        }
                    }   
                ',
            'options' => ['title' => ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " Information"],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => [ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " Information " . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelSubjectinformation()
    {
        
            $content = $_SESSION['subject_information_print'];
            
        $fileName = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . " Information " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    //Subject Information Ends here
    public function actionInternetCopy()
    {
        $model = new MarkEntry();
        $markentrymaster = new MarkEntryMaster();
        $galley = new HallAllocate();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $reval_status_entry = Categorytype::find()->where(['category_type'=>'Revaluation'])->orWhere(['description'=>'Revaluation'])->one();

        if (isset($_POST['internetcopybutton'])) 
        {
            $internLa = Categorytype::find()->where(['category_type'=>'Internal Final'])->orWhere(['category_type'=>'CIA'])->one();
            $disc_stu = Categorytype::find()->where(['category_type'=>'Discontinued'])->orWhere(['description'=>'Discontinued'])->one();
            $externAl = Categorytype::find()->where(['category_type'=>'ESE'])->orWhere(['category_type'=>'External'])->one();
            $dummy_entry = Categorytype::find()->where(['category_type'=>'ESE(Dummy)'])->orWhere(['category_type'=>'ESE(Dummy)'])->one();
            $absent_term = Categorytype::find()->where(['category_type'=>'end'])->orWhere(['category_type'=>'End'])->one();
            $exam_type = Categorytype::find()->where(['category_type'=>'Regular'])->orWhere(['category_type'=>'Regular'])->one();
            
            $getAbsentList = Yii::$app->db->createCommand("SELECT A.* FROM `coe_absent_entry` as A JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.absent_student_reg JOIN coe_subjects_mapping as C ON C.coe_subjects_mapping_id=A.exam_subject_id and C.batch_mapping_id=B.course_batch_mapping_id where absent_student_reg NOT IN (SELECT student_map_id FROM coe_mark_entry_master where year='".$_POST['year']."' and month='".$_POST['month']."' and student_map_id=A.absent_student_reg and subject_map_id=A.exam_subject_id) and exam_subject_id NOT IN (SELECT subject_map_id FROM coe_mark_entry_master where year='".$_POST['year']."' and month='".$_POST['month']."' and student_map_id=A.absent_student_reg and subject_map_id=A.exam_subject_id) and exam_year='".$_POST['year']."' and exam_month='".$_POST['month']."' and status_category_type_id!='".$disc_stu['coe_category_type_id']."' group by absent_student_reg,exam_subject_id")->queryAll();

            //print_r($getAbsentList);exit;
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId();
            $config_attempt = ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_CIA_ZEO);
            $has_absent = 0; $missing_records = '';

            if(!empty($getAbsentList))
            {
                foreach ($getAbsentList as $key => $absentList) 
                {         
                    $subject_map_id =   $absentList['exam_subject_id'];
                    $student_map_id =   $absentList['absent_student_reg']; 
                    $year = $absentList['exam_year']=='' ? $_POST['year']:$absentList['exam_year'];
                    $month = $absentList['exam_month']=='' ? $_POST['month']:$absentList['exam_month'];
                    $term = $absentList['absent_term']=='' ? $absent_term->coe_category_type_id:$absentList['absent_term'];
                    $mark_type = $absentList['exam_type']=='' ? $exam_type->coe_category_type_id:$absentList['exam_type'];

                    $stuCiaMarks = MarkEntry::find()->where(['category_type_id'=>$internLa->coe_category_type_id,'subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id])->orderBy('coe_mark_entry_id desc')->one();

                    $check_attempt = Yii::$app->db->createCommand('SELECT count(*) FROM coe_mark_entry_master WHERE subject_map_id="' . $subject_map_id . '" AND student_map_id="' . $student_map_id . '" AND result not like "%pass%"')->queryScalar();

                   $check_mark_entry = MarkEntry::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->orWhere(['IN','category_type_id',$dummy_entry->coe_category_type_id,$externAl->coe_category_type_id])->one();

                   $stuCiaMarksMaster = MarkEntryMaster::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id])->orderBy('coe_mark_entry_master_id desc')->one();

                    $absen_model_save = new MarkEntry();
                    $absen_model_save->student_map_id = $student_map_id;
                    $absen_model_save->subject_map_id = $subject_map_id;
                    $absen_model_save->category_type_id =$externAl->coe_category_type_id;
                    $absen_model_save->category_type_id_marks =0;
                    $absen_model_save->year = $year;
                    $absen_model_save->month = $month;
                    $absen_model_save->term = $term;
                    $absen_model_save->attendance_remarks = 'NOT ALLOWED';
                    $absen_model_save->mark_type = $mark_type;
                    $absen_model_save->created_at = $created_at;
                    $absen_model_save->created_by = $updateBy;
                    $absen_model_save->updated_at = $created_at;
                    $absen_model_save->updated_by = $updateBy;
                    $student_cia_marks = 0;
                    $status_insert = 0;
                    if(empty($stuCiaMarks) && empty($stuCiaMarksMaster))
                    {                      
                        $status_insert = 0;
                    }
                    if(empty($stuCiaMarks) && !empty($stuCiaMarksMaster))
                    {          
                        $student_cia_marks = $stuCiaMarksMaster['CIA'];          
                        $status_insert = 1;
                    }
                    else if($check_attempt>$config_attempt)
                    {
                        $status_insert = 1;
                        $student_cia_marks = 0;
                    }
                    else if(!empty($stuCiaMarks))
                    {
                        $status_insert = 1;
                        $student_cia_marks = $stuCiaMarks['category_type_id_marks'];
                    }
                    else
                     {
                        /*$has_absent = 1;
                        $stuMap = StudentMapping::findOne($student_map_id);
                        $stuMapDe = Student::findOne($stuMap['student_rel_id']);
                        $subMap = SubjectsMapping::findOne($subject_map_id);
                        $subMapId = Subjects::findOne($subMap['subject_id']);
                        $missing_records .=$stuMapDe['register_number']."-".$subMapId['subject_code']."<br />";

                        Yii::$app->ShowFlashMessages->setMsg('Error','NO CIA MARKS FOUND KINDLY CHECK THE PENDING STATUS AND RE-GENRATE THE INTERNET COPY!!!');*/

                        
                    }
                    $check_mark_entry_master = MarkEntryMaster::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->one();

                    $check_mark_entry_ab = MarkEntry::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$mark_type,'category_type_id'=>$externAl->coe_category_type_id])->all();

                    if(empty($check_mark_entry_ab) && $status_insert==1)
                    {
                        if($absen_model_save->save(false))
                        {
                            unset($absen_model_save);
                        }    
                    }

                    if(empty($check_mark_entry) && $status_insert==1)
                    {
                        $ab_MarkEntryMaster = new MarkEntryMaster();
                        $ab_MarkEntryMaster->student_map_id = $student_map_id;
                        $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                        $ab_MarkEntryMaster->CIA = $student_cia_marks;
                        $ab_MarkEntryMaster->ESE = 0;
                        $ab_MarkEntryMaster->total = $student_cia_marks;
                        $ab_MarkEntryMaster->result = 'Absent';
                        $ab_MarkEntryMaster->grade_point = 0;
                        $ab_MarkEntryMaster->grade_name = 'AB';
                        $ab_MarkEntryMaster->attempt = 0;
                        $ab_MarkEntryMaster->year = $year;
                        $ab_MarkEntryMaster->month = $month;
                        $ab_MarkEntryMaster->term = $term;
                        $ab_MarkEntryMaster->mark_type = $mark_type;
                        $ab_MarkEntryMaster->year_of_passing = '';
                        $ab_MarkEntryMaster->status_id = 0;
                        $ab_MarkEntryMaster->created_by = $updateBy;
                        $ab_MarkEntryMaster->created_at = $created_at;
                        $ab_MarkEntryMaster->updated_by = $updateBy;
                        $ab_MarkEntryMaster->updated_at = $created_at;
                        $check_mark_entry_master = MarkEntryMaster::find()->where(['subject_map_id'=>$subject_map_id,'student_map_id'=>$student_map_id,'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])->one();

                        if(empty($check_mark_entry_master) && $absen_model_save->save(false))
                        {
                            unset($absen_model_save);
                            $ab_MarkEntryMaster->save(false);
                        }
                        unset($ab_MarkEntryMaster);    
                    }
                    else if(!empty($check_mark_entry) && empty($check_mark_entry_master) && $status_insert==1)
                    {
                        unset($absen_model_save);
                        $ab_MarkEntryMaster = new MarkEntryMaster();
                        $ab_MarkEntryMaster->student_map_id = $student_map_id;
                        $ab_MarkEntryMaster->subject_map_id =$subject_map_id;
                        $ab_MarkEntryMaster->CIA = $student_cia_marks;
                        $ab_MarkEntryMaster->ESE = 0;
                        $ab_MarkEntryMaster->total = $student_cia_marks;
                        $ab_MarkEntryMaster->result = 'Absent';
                        $ab_MarkEntryMaster->grade_point = 0;
                        $ab_MarkEntryMaster->grade_name = 'AB';
                        $ab_MarkEntryMaster->attempt = 0;
                        $ab_MarkEntryMaster->year = $year;
                        $ab_MarkEntryMaster->month = $month;
                        $ab_MarkEntryMaster->term = $term;
                        $ab_MarkEntryMaster->mark_type = $mark_type;
                        $ab_MarkEntryMaster->year_of_passing = '';
                        $ab_MarkEntryMaster->status_id = 0;
                        $ab_MarkEntryMaster->created_by = $updateBy;
                        $ab_MarkEntryMaster->created_at = $created_at;
                        $ab_MarkEntryMaster->updated_by = $updateBy;
                        $ab_MarkEntryMaster->updated_at = $created_at;  
                        $ab_MarkEntryMaster->save(false);
                        unset($ab_MarkEntryMaster);    
                    }

                }
            }
          if($has_absent==1)
          {
                Yii::$app->ShowFlashMessages->setMsg('Error','NO CIA MARKS FOUND FOR '.$missing_records.' KINDLY CHECK THE PENDING STATUS AND RE-GENRATE THE INTERNET COPY!!!');
                return $this->redirect(['mark-entry/internet-copy']);
            }
            $reval_status = isset($_POST['MarkEntry']['mark_type'][0])?$_POST['MarkEntry']['mark_type'][0]:'';
            $internet_copy_query = new Query();
            $withheld_list = Yii::$app->db->createCommand('SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master WHERE month="'.$_POST['month'].'" AND year="'.$_POST['year'].'" AND withheld="w" ')->queryAll();
            $withheld = [];
            foreach ($withheld_list as $key => $value) {
                $withheld[$value['id']]=$value['id'];
            }

            $whereCondition = [                        
                        'a.year' => $_POST['year'], 'a.month' => $_POST['month']
                    ];
            $internet_copy_query->select('d.batch_mapping_id,c.register_number,paper_no,c.name,c.dob,e.subject_code,e.ESE_max,e.ESE_min,e.CIA_max,e.CIA_min,a.subject_map_id,a.CIA,a.ESE,a.result,a.withheld,a.grade_name,a.student_map_id,a.year,a.month,degree_code,programme_name,d.semester,b.status_category_type_id,x.batch_name, a.mark_type, b.semester_detain')
                ->from('coe_mark_entry_master a')
                ->join('JOIN', 'coe_student_mapping b', 'a.student_map_id=b.coe_student_mapping_id')
                ->join('JOIN', 'coe_student c', 'b.student_rel_id=c.coe_student_id')
                ->join('JOIN', 'coe_subjects_mapping d', 'a.subject_map_id=d.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_subjects e', 'd.subject_id=e.coe_subjects_id')
                ->join('JOIN', 'coe_bat_deg_reg g','g.coe_bat_deg_reg_id = d.batch_mapping_id and g.coe_bat_deg_reg_id=b.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree h','h.coe_degree_id=g.coe_degree_id')
                   ->join('JOIN', 'coe_batch as x', 'x.coe_batch_id=g.coe_batch_id')
                ->join('JOIN', 'coe_programme i','i.coe_programme_id=g.coe_programme_id');

            if(!empty($reval_status) && $reval_status=='yes')
            {
                $internet_copy_query->join('JOIN', 'coe_mark_entry f', 'f.student_map_id=a.student_map_id and f.subject_map_id=a.subject_map_id and f.year=a.year and f.month=a.month and f.mark_type=a.mark_type and f.term=a.term');
                $whereCondition_12 = [                        
                        'f.category_type_id'=>$reval_status_entry['coe_category_type_id'],'f.year'=>$_POST['year'],'f.month' => $_POST['month'],
                    ];
                $whereCondition = array_merge($whereCondition,$whereCondition_12); 
            }
			$internet_copy_query->where($whereCondition);           
           // $internet_copy_query->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                $internet_copy_query->orderBy('c.register_number,paper_no');
            $internet_copy = $internet_copy_query->createCommand()->queryAll();

            $query_man = new  Query();
            $query_man->select('B.course_batch_mapping_id as batch_mapping_id,H.subject_code,paper_no,  A.name, A.register_number, A.dob,  H.ESE_min,H.ESE_max, H.CIA_max,H.CIA_min, F.subject_map_id, F.ESE,F.CIA, F.result,F.withheld,F.grade_name,F.student_map_id,F.year, F.month,D.degree_code,E.programme_name, F.semester, B.status_category_type_id, I.batch_name, F.student_map_id, B.semester_detain, F.mark_type,')
                ->from('coe_student as A')
                ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
                ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
                ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
                ->join('JOIN', 'coe_mandatory_stu_marks as F', 'F.student_map_id=B.coe_student_mapping_id')
                ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
                ->join('JOIN', 'coe_mandatory_subcat_subjects as G', 'G.coe_mandatory_subcat_subjects_id=F.subject_map_id')
                ->join('JOIN', 'coe_mandatory_subjects H', 'H.coe_mandatory_subjects_id=G.man_subject_id');
            $query_man->Where(['F.year' => $_POST['year'], 'F.month' =>  $_POST['month'], 'A.student_status' => 'Active','G.is_additional'=>'NO']);
               // ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
            $query_man->orderBy('A.register_number,paper_no');
               
            $mandatory_statement = $query_man->createCommand()->queryAll();
            if(!empty($mandatory_statement))
            {
                $internet_copy = array_merge($internet_copy,$mandatory_statement);
            }
            array_multisort(array_column($internet_copy, 'paper_no'),  SORT_ASC, $internet_copy);
            array_multisort(array_column($internet_copy, 'register_number'),  SORT_ASC, $internet_copy);

            if (count($internet_copy) > 0) {
                return $this->render('internet-copy', [
                    'model' => $model, 'galley' => $galley, 'internet_copy' => $internet_copy,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available");
                return $this->render('internet-copy', [
                    'model' => $model, 'galley' => $galley,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Internet Copy');
            return $this->render('internet-copy', [
                'model' => $model, 'galley' => $galley,
            ]);
        }
    }
    public function actionInternetCopyPdf()
    {
        $updated_at = date("Y-m-d H:i:s");
        $updated_by = Yii::$app->user->getId();
        $publish_date = date('Y-m-d');
        $check_data = Yii::$app->db->createCommand("SELECT * FROM coe_mark_entry_master where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "' and status_id=1")->queryScalar();
        if(empty($check_data))
        {
            Yii::$app->db->createCommand("update coe_mark_entry_master set result_published_date='".$publish_date."',status_id=1,updated_by='".$updated_by."',updated_at='".$updated_at."' where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "'")->execute();
            Yii::$app->db->createCommand("update coe_mark_entry set status_id=1,updated_by='".$updated_by."',updated_at='".$updated_at."' where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "'")->execute();    
        }        
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['internetcopy_print'];
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Mark Data.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            
                        }
                        table th{
                            border: 1px solid #000;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                           
                        }
                    }   
                ',
            'options' => ['title' => 'Mark Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Mark Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelInternetCopyPdf()
    {
        $updated_at = date("Y-m-d H:i:s");
        $updated_by = Yii::$app->user->getId();

        $publish_date = date('Y-m-d');
        $check_data = Yii::$app->db->createCommand("SELECT * FROM coe_mark_entry_master where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "' and status_id=1")->queryScalar();
        if(empty($check_data))
        {
            Yii::$app->db->createCommand("update coe_mark_entry_master set result_published_date='".$publish_date."',status_id=1,updated_by='".$updated_by."',updated_at='".$updated_at."' where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "'")->execute();
            Yii::$app->db->createCommand("update coe_mark_entry set status_id=1,updated_by='".$updated_by."',updated_at='".$updated_at."' where year='" . $_SESSION['mark_year'] . "' and month='" . $_SESSION['mark_month'] . "'")->execute();    
        }
        
        $content = $_SESSION['internetcopy_print'];           
        $fileName = "INTERNET COPY - " . $_SESSION['mark_year'] . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    //Hallticket export starts here
    public function actionHallticketexport()
    {
        $model = new MarkEntry();
        $galley = new HallAllocate();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Hallticket Export');
        return $this->render('hallticketexport', [
            'model' => $model, 'galley' => $galley,
        ]);
    }
    public function actionHallticketexportdata()
    {
        
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        
        $stu_elective = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Elective%'")->queryScalar();

        $practical_check = Yii::$app->request->post('check_val');
        $year = Yii::$app->request->post('year');
        $batch_id = Yii::$app->request->post('batch_id');
        $semester = Yii::$app->request->post('semester');
        if(isset($semester) && !empty($semester))
        {
            $semester = $semester+1;
        }
        $month = Yii::$app->request->post('month');
        $table = "";
        $a="400";
        $pract="Practical";
        $sn = 1;
        if(isset($batch_id) && !empty($batch_id))
        {
            $bath_name = Batch::findOne($batch_id);
            $batch_name_id = $bath_name->batch_name;
        }
        if($practical_check==10)
        {
            $add_in_theQuery = isset($batch_id) && !empty($batch_id) ? " and A.coe_batch_id='".$batch_id."' and A.coe_batch_id='".$batch_id."' and batch_name='".$batch_name_id."' ":'';

            $add_in_theQuerySem = isset($semester) && !empty($semester) ? " and G.semester='".$semester."' ":'';

            $query_2 = "SELECT L.batch_name,D.register_number,D.name,D.dob,B.degree_code,C.programme_name,G.semester,F.subject_code,F.subject_name,$a as exam_date, $a as category_type, $a as hall_name ,$a as row, $a as row_column,$a as seat_no  FROM coe_bat_deg_reg as A JOIN coe_degree as B ON A.coe_degree_id=B.coe_degree_id JOIN coe_programme C ON A.coe_programme_id=C.coe_programme_id JOIN coe_student_mapping E ON  A.coe_bat_deg_reg_id=E.course_batch_mapping_id JOIN coe_student D ON E.student_rel_id=D.coe_student_id JOIN coe_subjects_mapping G ON A.coe_bat_deg_reg_id=G.batch_mapping_id JOIN coe_subjects F ON G.subject_id=F.coe_subjects_id JOIN coe_nominal as I ON I.coe_subjects_id=F.coe_subjects_id AND I.coe_student_id=D.coe_student_id and G.subject_id=I.coe_subjects_id and I.course_batch_mapping_id=G.batch_mapping_id JOIN coe_category_type H ON H.coe_category_type_id=G.paper_type_id JOIN coe_batch L ON A.coe_batch_id=L.coe_batch_id WHERE  G.paper_type_id='".$practical_check."' and  G.subject_type_id='".$stu_elective."' AND status_category_type_id not in('".$det_disc_type."' ) $add_in_theQuery $add_in_theQuerySem group by D.register_number,F.subject_code ORDER BY G.semester,D.register_number";
            $practical_elective = Yii::$app->db->createCommand($query_2)->queryAll();

            $query_3 = "SELECT L.batch_name,D.register_number,D.name,D.dob,B.degree_code,C.programme_name,G.semester,F.subject_code,F.subject_name,$a  as exam_date, $a  as category_type, $a  as hall_name ,$a  as row, $a  as row_column,$a  as seat_no  FROM coe_bat_deg_reg as A JOIN coe_degree as B ON A.coe_degree_id=B.coe_degree_id JOIN coe_programme C ON A.coe_programme_id=C.coe_programme_id JOIN coe_student_mapping E ON  A.coe_bat_deg_reg_id=E.course_batch_mapping_id JOIN coe_student D ON E.student_rel_id=D.coe_student_id JOIN coe_subjects_mapping G ON A.coe_bat_deg_reg_id=G.batch_mapping_id JOIN coe_subjects F ON G.subject_id=F.coe_subjects_id JOIN coe_category_type H ON H.coe_category_type_id=G.paper_type_id JOIN coe_batch L ON A.coe_batch_id=L.coe_batch_id WHERE  G.paper_type_id='".$practical_check."' AND G.subject_type_id!='".$stu_elective."' AND status_category_type_id not in('".$det_disc_type."' ) $add_in_theQuery $add_in_theQuerySem group by D.register_number,F.subject_code ORDER BY G.semester,D.register_number";
            $practical_common = Yii::$app->db->createCommand($query_3)->queryAll();
            if(!empty($practical_elective))
            {
                if(!empty($practical_common))
                {
                    $practical_common = array_merge($practical_common,$practical_elective);
                }
            }
            $query_4 = "SELECT L.batch_name,D.register_number,D.name,D.dob,B.degree_code,C.programme_name,G.semester,F.subject_code,F.subject_name,$a  as exam_date, $a  as category_type, $a  as hall_name ,$a  as row, $a  as row_column,$a  as seat_no  FROM coe_bat_deg_reg as A JOIN coe_degree as B ON A.coe_degree_id=B.coe_degree_id JOIN coe_programme C ON A.coe_programme_id=C.coe_programme_id JOIN coe_student_mapping E ON  A.coe_bat_deg_reg_id=E.course_batch_mapping_id JOIN coe_student D ON E.student_rel_id=D.coe_student_id JOIN coe_subjects_mapping G ON A.coe_bat_deg_reg_id=G.batch_mapping_id and E.course_batch_mapping_id=G.batch_mapping_id JOIN coe_subjects F ON G.subject_id=F.coe_subjects_id JOIN coe_category_type H ON H.coe_category_type_id=G.paper_type_id JOIN coe_batch L ON A.coe_batch_id=L.coe_batch_id JOIN coe_mark_entry_master as M ON M.student_map_id=E.coe_student_mapping_id and M.subject_map_id=G.coe_subjects_mapping_id WHERE  G.paper_type_id='".$practical_check."' AND status_category_type_id not in('".$det_disc_type."' ) $add_in_theQuery $add_in_theQuerySem group by D.register_number,F.subject_code ORDER BY G.semester,D.register_number";
            $prac_arrear = Yii::$app->db->createCommand($query_4)->queryAll();

            if(!empty($prac_arrear))
            {
                if(!empty($practical_common))
                {
                    $practical_common = array_merge($practical_common,$prac_arrear);
                }
            }
            $subject = $practical_common;
            $subject = array_map("unserialize", array_unique(array_map("serialize", $subject)));

        }
        else
        {
            $examsIdsMer = array_filter(['']);
            $examSIds = ExamTimetable::find()->where(['exam_year'=>$year,'exam_month'=>$month])->all();
            foreach ($examSIds as $key => $exams) 
            {
               $examsIdsMer[$exams['coe_exam_timetable_id']]=$exams['coe_exam_timetable_id'];
            }
            $examsIdsMer = array_filter($examsIdsMer);
            $query = new Query();
            $query->select('L.batch_name,D.register_number,D.name,D.dob,B.degree_code,C.programme_name,G.semester,F.subject_code,F.subject_name,H.exam_date,K.category_type,I.hall_name,J.row,J.row_column,J.seat_no,H.exam_type')
                ->from('coe_bat_deg_reg A')
                ->join('JOIN', 'coe_degree B', 'A.coe_degree_id=B.coe_degree_id')
                ->join('JOIN', 'coe_programme C', 'A.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_student_mapping E', 'E.course_batch_mapping_id=A.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_student D', 'D.coe_student_id=E.student_rel_id')
                ->join('JOIN', 'coe_subjects_mapping G', 'G.batch_mapping_id=E.course_batch_mapping_id and G.batch_mapping_id=A.coe_bat_deg_reg_id')
                ->join('JOIN', 'coe_subjects F', 'F.coe_subjects_id=G.subject_id')
                ->join('JOIN', 'coe_exam_timetable H', 'H.subject_mapping_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_hall_allocate J', 'J.exam_timetable_id=H.coe_exam_timetable_id and J.register_number=D.register_number and J.year=H.exam_year and J.month=H.exam_month')
                ->join('JOIN', 'coe_hall_master I', 'I.coe_hall_master_id=J.hall_master_id')
                ->join('JOIN', 'coe_category_type K', 'K.coe_category_type_id=H.exam_session')
                ->join('JOIN', 'coe_batch L', 'A.coe_batch_id=L.coe_batch_id')
                ->where(['J.year' => $year,'J.month' => $month,'H.exam_year'=> $year,'H.exam_month'=>$month]);
                if(isset($batch_id) && !empty($batch_id))
                {
                    $query->andWhere(['L.coe_batch_id'=>$batch_id,'A.coe_batch_id'=>$batch_id,'batch_name'=>$batch_name_id]);
                }
                
            $query->andWhere(['<>', 'status_category_type_id', $det_disc_type])
                ->andWhere(['<>', 'G.subject_type_id', $stu_elective])
                ->andWhere(['IN', 'coe_exam_timetable_id', $examsIdsMer])
                ->andWhere(['IN', 'exam_timetable_id', $examsIdsMer])
                ->groupBy('D.register_number,F.subject_code')
                ->orderBy('G.semester,D.register_number,H.exam_date');
            $subject = $query->createCommand()->queryAll();

            $query_1 = new Query();
            $query_1->select('L.batch_name,D.register_number,D.name,D.dob,B.degree_code,C.programme_name,G.semester,F.subject_code,F.subject_name,H.exam_date,K.category_type,I.hall_name,J.row,J.row_column,J.seat_no,H.exam_type')
                ->from('coe_bat_deg_reg A')
                ->join('JOIN', 'coe_degree B', 'A.coe_degree_id=B.coe_degree_id')
                ->join('JOIN', 'coe_programme C', 'A.coe_programme_id=C.coe_programme_id')
                ->join('JOIN', 'coe_batch L', 'A.coe_batch_id=L.coe_batch_id')
                ->join('JOIN', 'coe_student_mapping E', 'A.coe_bat_deg_reg_id=E.course_batch_mapping_id')
                ->join('JOIN', 'coe_student D', 'E.student_rel_id=D.coe_student_id')
                ->join('JOIN', 'coe_subjects_mapping G', 'A.coe_bat_deg_reg_id=G.batch_mapping_id')
                ->join('JOIN', 'coe_subjects F', 'G.subject_id=F.coe_subjects_id')
                ->join('JOIN', 'coe_nominal N', 'N.coe_subjects_id=F.coe_subjects_id AND N.coe_student_id=D.coe_student_id and N.course_batch_mapping_id=E.course_batch_mapping_id and N.semester=G.semester and N.course_batch_mapping_id=G.batch_mapping_id')
                ->join('JOIN', 'coe_exam_timetable H', 'H.subject_mapping_id=G.coe_subjects_mapping_id')
                ->join('JOIN', 'coe_hall_allocate J', 'J.exam_timetable_id=H.coe_exam_timetable_id and D.register_number=J.register_number and J.year=H.exam_year and J.month=H.exam_month')
                ->join('JOIN', 'coe_hall_master I', 'I.coe_hall_master_id=J.hall_master_id')
                ->join('JOIN', 'coe_category_type K', 'K.coe_category_type_id=H.exam_session')
                ->where(['J.year' => $year, 'J.month' => $month,'H.exam_year'=> $year,'H.exam_month'=>$month]);


                if(isset($batch_id) && !empty($batch_id))
                {
                    $query->andWhere(['L.coe_batch_id'=>$batch_id,'A.coe_batch_id'=>$batch_id,'batch_name'=>$batch_name_id]);
                }
                
             $query->andWhere(['<>', 'status_category_type_id', $det_disc_type])
               ->andWhere(['=', 'G.subject_type_id', $stu_elective])
                ->andWhere(['IN', 'coe_exam_timetable_id', $examsIdsMer])
                ->andWhere(['IN', 'exam_timetable_id', $examsIdsMer])
                ->groupBy('D.register_number,F.subject_code')
                ->orderBy('G.semester,D.register_number,H.exam_date');
            $subject_elec = $query_1->createCommand()->queryAll();

            
           
            if(!empty($subject_elec))
            {
                $subject = array_merge($subject,$subject_elec);
            }
        }
        $subject = array_map("unserialize", array_unique(array_map("serialize", $subject)));
        if (count($subject) > 0) 
        {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table width="100%" ><tbody align="center">';
            
            $table .= '
                        <tr>
                            <td><b> S.NO </b></td>
                            <td><b> Batch </b></td>
                            <td><b> Register number </b></td>
                            <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' Name </b></td>
                            <td><b> DOB </b></td>
                            <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' </b></td>
                            <td><b> Semester </b></td>
                            <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </b></td>
                            <td><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </b></td>
                            <td><b> Exam date </b></td>
                            <td><b> Session </b></td>
                            <td><b> Hallname </b></td>
                            
                            <td><b> Seat no </b></td>
                            <td><b> Exam Type </b></td>
                        </tr>';
            foreach ($subject as $subject1) 
            {
                $dergreee_code = strstr($subject1['degree_code'], "MBATRISEM") ? "MBA" : $subject1['degree_code'];
                $exam_date = $subject1['exam_date']=='400' ? '-' : date('d-M-Y',strtotime($subject1['exam_date']));
                $hall_name = $subject1['hall_name']=='400' ? '-' : $subject1['hall_name'];
                $seat_no = $subject1['seat_no']=='400' ? '-' : $subject1['seat_no'];
                $category_type = $subject1['category_type']=='400' ? '-' : $subject1['category_type'];
                 $exam_type = Yii::$app->db->createCommand("select category_type from coe_category_type where coe_category_type_id='".$subject1['exam_type']."'")->queryScalar();
                $table .= '
                    <tr>
                        <td> ' . $sn . ' </td>
                        <td> ' . $subject1['batch_name'] . ' </td>
                        <td> ' . $subject1['register_number'] . ' </td>
                        <td> ' . $subject1['name'] . ' </td>
                        <td> ' . $subject1['dob'] . ' </td>
                        <td> ' . $dergreee_code . ' ' . $subject1['programme_name'] . ' </td>
                        <td> ' . $subject1['semester'] . ' </td>
                        <td> ' . $subject1['subject_code'] . ' </td>
                        <td> ' . $subject1['subject_name'] . ' </td>
                        <td> ' . $exam_date. ' </td>
                        <td> ' . $category_type . ' </td>
                        <td> ' . $hall_name . ' </td>
                        <td> ' . $seat_no . ' </td>
                         <td> ' . $exam_type . ' </td>
                    </tr>';
                $sn++;
            }
            $table .= '</table>';
        } else {
            $table .= 0;
        }
        if (isset($_SESSION['hallticket_export_print'])) {
            unset($_SESSION['hallticket_export_print']);
        }
        $_SESSION['hallticket_export_print'] = $table;
        return $table;
    }
    public function actionHallticketexportPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['hallticket_export_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Hall Ticket Export.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; }
                    }   
                ',
            'options' => ['title' => 'Hallticket export Information'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Hallticket ' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelHallticketexport()
    {
        
            $content = $_SESSION['hallticket_export_print'];
            
        $fileName = "Hallticket export Information " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    //Hallticket export ends here
    //University report starts here
    public function actionUniversityreport()
    {
        $model = new MarkEntry();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to University ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('universityreport', [
            'model' => $model,
        ]);
    }
   public function actionUniversityreportdata_old()
    {
        $batch = Yii::$app->request->post('batch');
        $bat_map_id = Yii::$app->request->post('bat_map_id');
        $exam_type = Yii::$app->request->post('exam_type');
        $passed_stu = array();
        $failed_stu = array();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_cat_transfer= Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();
        
        $fail_query = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.result='Fail'";
                
        $fail_list = Yii::$app->db->createCommand($fail_query)->queryAll();

            $fail_stu = [];
            foreach ($fail_list as $key => $value) {
                $fail_stu[$value['id']]=$value['id'];
            }

        $fail_stu = array_filter($fail_stu);

        $fail_stu = implode(',', $fail_stu);

        $man_ra_query = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.mark_type=28 AND A.result='Pass'";
                
        $man_ra_list = Yii::$app->db->createCommand($man_ra_query)->queryAll();

            $man_ra_stu = [];
            foreach ($man_ra_list as $key => $value) {
                $man_ra_stu[$value['id']]=$value['id'];
            }

        $man_ra_stu = array_filter($man_ra_stu);

        $man_ra_stu = implode(',', $man_ra_stu);

        $ra_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.mark_type=28 AND A.result='Pass'";
                
        $ra_list = Yii::$app->db->createCommand($ra_query)->queryAll();

            $ra_stu = [];
            foreach ($ra_list as $key => $value) {
                $ra_stu[$value['id']]=$value['id'];
            }

        $ra_stu = array_filter($ra_stu);

        $ra_stu = implode(',', $ra_stu);

        if(!empty($fail_stu))
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))";
            if($exam_type == 27)
            {
                $get_stu_query .=" AND F.mark_type=27";
                if(!empty($man_ra_stu))
                {
                    $get_stu_query .=" AND B.coe_student_mapping_id NOT IN(".$man_ra_stu.")";
                }
                if(!empty($ra_stu))
                {
                    $get_stu_query .=" AND B.coe_student_mapping_id NOT IN(".$ra_stu.")";
                }
            }
             if($exam_type == 28)
            {
                $get_stu_query .=" AND F.mark_type!=27 ";
                
            }

            $get_stu_query .= " AND B.coe_student_mapping_id NOT IN(".$fail_stu.") and B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
        else
        {

            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."'
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))";
            if($exam_type == 27)
            {
                $get_stu_query .=" AND F.mark_type=27";
                if(!empty($man_ra_stu))
                {
                    $get_stu_query .=" AND B.coe_student_mapping_id NOT IN(".$man_ra_stu.")";
                }
                if(!empty($ra_stu))
                {
                    $get_stu_query .=" AND B.coe_student_mapping_id NOT IN(".$ra_stu.")";
                }
            }
             if($exam_type == 28)
            {
                $get_stu_query .=" AND F.mark_type!=27 ";
                
            }
            $get_stu_query .=" AND  B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }

        $final_student = Yii::$app->db->createCommand($get_stu_query)->queryAll();
       

        $last_appearance_of = Yii::$app->db->createCommand("SELECT max(F.year_of_passing) as last_appearance FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id  where G.batch_mapping_id='".$bat_map_id."' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number")->queryScalar();
        if(!empty($last_appearance_of))
        {
            $ex_plode = explode('-', $last_appearance_of);
            $month_name = Categorytype::findOne($ex_plode[0]);
            $month_and_year = strtoupper($month_name['description']."-".$ex_plode[1]);
        }
        else
        {
            $month_and_year = DATE('Y');
        }
        
        
        $table = "";
        $sn = 1;
        $query = new Query();
        if (count($final_student) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table border=1 id="checkAllFeet" class="table table-responsive table-striped" align="center" >
                <tbody align="center">';
            $table .= '
                        <tr>                           
                            <td colspan=14 align="center"> 
                                <center><b><font size="4px">' . strtoupper($org_name) . '</font></b></center>
                                <center>' . strtoupper($org_address) . '</center>                                
                                <center>DETAILS OF CANDIDATES ELIGIBLE FOR THE AWARD OF DEGREE</center> 
                                <center> MONTH AND YEAR OF EXAMINATION '.$month_and_year.' </center>
                            </td>                           
                            
                        </tr>';
            $table .= '
                    <tr>
                        <td align="center"><b> S.NO </b></td>
                        <td align="center"><b> Reg No </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' name </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . ' CODE </b></td>
                        <td align="center"><b> BRANCH / SPECILIZATION </b></td>
                        <td align="center"><b> Gender </b></td>
                        <td align="center"><b> DOB </b></td>
                        <td align="center"><b> Total CGPA Secured </b></td>
                        <td align="center"><b> Total CGPA Maximum </b></td>
                        <td align="center"><b> ATTEMPT </b></td>
                        <td align="center"><b> Classification </b></td>
                        <td align="center"><b> Ref.No. of the University approving the admission of the student </b></td>
                        <td align="center"><b> Remarks </b></td>
                        <td align="center"><b> Year Of Passing </b></td>
                    </tr>';
            
            foreach ($final_student as $final_student1) 
            {
                $attempt = 'NO';
                    $attempt_check = MarkEntryMaster::find()->where(['year_of_passing'=>'','student_map_id'=>$final_student1['student_map_id']])->andWhere(['NOT LIKE','grade_name','COMPLETED'])->all();

                    $withdraw_check = MarkEntryMaster::find()->where(['grade_name'=>'WD','student_map_id'=>$final_student1['student_map_id']])->all();

                    $with_dr_count = 0;
                     if(!empty($withdraw_check) && count($withdraw_check)>0)
                    {

                        foreach ($withdraw_check as $key => $value) 
                        {                            
                            $month = $value['month']==29?30:29;
                            
                            //$year = $month==29?$value['year']:($value['year']+1);
                            $year = $month==29?($value['year']+1):$value['year'];
                           //print_r( $year);exit;


                  $withdraw_count = Yii::$app->db->createCommand('SELECT count(*) as count FROM coe_mark_entry_master WHERE student_map_id="'.$final_student1['student_map_id'].'" and result like "%pass%" and grade_name not like "%WD%" AND subject_map_id="'.$value['subject_map_id'].'"  and month="'.$month.'" and year="'.$year.'"')->queryScalar();
                           

                  $with_dr_count = (!empty($withdraw_count) && $withdraw_count!='') ? $with_dr_count+$withdraw_count : $with_dr_count;


                    }                        
                        $attempt = count($withdraw_check)==$with_dr_count?'WITH DRAW IN '.count($withdraw_check)." CLEARED IN SINGLE ATTEMPTS" :'WITH DRAW IN '.count($withdraw_check)." CLEARED IN MULTIPLE ATTEMPTS";
                    }

                    else
                    {
                        $attempt = !empty($attempt_check) && count($attempt_check)>0 ?'YES':'NO';
                    }
                    $add_css = $attempt!='NO' ? 'style="background: #f24400; color: #fff; padding: 5px 0 5px 0;" ' : '';
                    $year = DATE('Y');
                   // $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($final_student1['year'],$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);

                    $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($year,$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    

       


                    $checkPrev_reg_num = StudentMapping::findOne($final_student1['student_map_id']);
                    $prev_reg_num = empty($checkPrev_reg_num->previous_reg_number)?0:$checkPrev_reg_num->previous_reg_number;

                    $transfer_stu = empty($checkPrev_reg_num->status_category_type_id)?0:$checkPrev_reg_num->status_category_type_id;
                    
                    if($transfer_stu==5)
                    {
                         $cgpa_calculation = ConfigUtilities::getCgpaCaluclationTransStu($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    else if($prev_reg_num!=0)
                    {
                       $getoldStu = Student::findOne(['register_number'=>$prev_reg_num]);
                       $oldMap = StudentMapping::findOne(['student_rel_id'=>$getoldStu->coe_student_id]);
                       $prev_stu_map = $oldMap->coe_student_mapping_id; 
                       $cgpa_calculation = ConfigUtilities::getCgpaCaluclationRejoin($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    $table .= '
                        <tr '.$add_css.'>
                            <td align="center"> ' . $sn . ' </td>
                            <td align="center"> ' . $final_student1['register_number'] . ' </td>
                            <td align="center"> ' . $final_student1['name'] . ' </td>
                            <td align="center"> ' . $final_student1['degree_code'] . ' </td>
                            <td align="center"> ' . $final_student1['programme_name'] . ' </td>
                            <td align="center"> ' . $final_student1['gender'] . ' </td>
                            <td align="center"> ' . DATE('d-M-Y',strtotime($final_student1['dob'])) . ' </td>
                            <td align="center"> ' . round($cgpa_calculation['final_cgpa'], 2) . ' </td>';
                    $Percentage = round($cgpa_calculation['final_cgpa'], 2);
                    $classification = ConfigUtilities::getClassification($Percentage,$final_student1['regulation_year'],$final_student1['register_number']);
                    $year_of_passing = ConfigUtilities::getLastYearOfPassing($final_student1['register_number']);
                    $table .= '<td align="center"> 10 </td>';                    

                    $table .= '<td align="center"> '.$attempt.' </td>';            
                    $table .= '<td align="center"> ' . $classification . ' </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> '.$year_of_passing.' </td>';
                    $table .= '</tr>';
                    $sn++;
            }
        } else {
            return 0;
        }
        $table .= "<tr><td colspan=7> COE </td><td colspan=7> SIGNATURE OF PRINCIPAL </td></tr>";
        $table .= '</table>';
        if (isset($_SESSION['university_report_print'])) 
        {
            unset($_SESSION['university_report_print']);
        }
        $_SESSION['university_report_print'] = $table;
        return $table;
    }
    public function actionUniversityreportdata()
    {
        $batch = Yii::$app->request->post('batch');
        $bat_map_id = Yii::$app->request->post('bat_map_id');
        $report_type = Yii::$app->request->post('report_type');
        $passed_stu = array();
        $failed_stu = array();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_cat_transfer= Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();

        $batch_year= Yii::$app->db->createCommand("select batch_name from coe_batch where coe_batch_id = '".$batch."'")->queryScalar();
        
        $batch_year=$batch_year+4;

        $ma_fail_query = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       join coe_mandatory_subjects  as x On x.coe_mandatory_subjects_id=A.subject_map_id
                        join coe_mandatory_subcat_subjects  as y On y.man_subject_id=x.coe_mandatory_subjects_id 

                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.result='Fail' AND y.is_additional!='Yes'";
                
        $ma_fail_list = Yii::$app->db->createCommand($ma_fail_query)->queryAll();


        $ra_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=A.student_map_id and result like '%Pass%')"; 
                
        $ra_fail_list = Yii::$app->db->createCommand($ra_query)->queryAll();

        $fail_list = array_merge($ma_fail_list,$ra_fail_list);

        $ra_fail_stu = [];
        foreach ($fail_list as $key => $value) 
        {
           $ra_fail_stu[$value['id']]=$value['id'];
        }

        $ra_fail_stu1 = $ra_fail_stu;

        $ra_fail_stu = array_filter($ra_fail_stu);

        $ra_fail_stu = implode(',', $ra_fail_stu);

        if(!empty($ra_fail_stu))
        {
            $rg_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$batch_year."' AND A.month='29' AND A.student_map_id NOT IN (".$ra_fail_stu.") AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=A.student_map_id and result like '%Pass%'))";
                
        }
        else
        {
            $rg_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$batch_year."' AND A.month='29' AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=A.student_map_id and result like '%Pass%'))";
                
        }
       
        $rg_list = Yii::$app->db->createCommand($rg_query)->queryAll();

        
            $stu_all = [];
            $stu_one = []; $stu_more = [];
            foreach ($rg_list as $key => $value) 
            {
                
                $subcount= Yii::$app->db->createCommand("SELECT count(DISTINCT subject_map_id) FROM coe_mark_entry_master as A JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$batch_year."' AND A.month='29' AND A.student_map_id='".$value['id']."'")->queryScalar();
                if($subcount==1)
                {
                    $stu_one[$value['id']]=$value['id'];
                }
                else
                {
                    $stu_more[$value['id']]=$value['id'];
                }

                $stu_all[$value['id']]=$value['id'];
            }

        $stu_one = array_merge($ra_fail_stu1    ,$stu_one);

        $stu_one = array_filter($stu_one);

        $stu_one = implode(',', $stu_one);

        $stu_more = array_merge($ra_fail_stu1,$stu_more);

        $stu_more = array_filter($stu_more);

        $stu_more = implode(',', $stu_more);

      //  $stu_all = array_merge($ra_fail_stu1,$stu_all);

       // $stu_all = array_filter($stu_all);

       // $stu_all = implode(',', $stu_all);

       // print_r($stu_more); exit;

        if($report_type==124)
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' AND F.student_map_id NOT IN (".$stu_more.") AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
      
       if($report_type==125)
        {

           $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."'";
            $get_stu_query .= " AND F.student_map_id NOT IN (".$stu_one.") AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number order by A.register_number, G.semester, paper_no";
        }

        if($report_type=='All')
        {

            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."'";
            if(!empty($ra_fail_stu))
            {
                 $get_stu_query .= " AND F.student_map_id NOT IN (".$ra_fail_stu.") AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%Pass%')) AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number order by A.register_number, G.semester, paper_no";
            }
            else
            {
                $get_stu_query .= " AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%Pass%')) AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number order by A.register_number, G.semester, paper_no";
            }
           
        }

        $final_student = Yii::$app->db->createCommand($get_stu_query)->queryAll();
       

        $last_appearance_of = Yii::$app->db->createCommand("SELECT max(F.year_of_passing) as last_appearance FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id  where G.batch_mapping_id='".$bat_map_id."' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD')  group by A.register_number")->queryScalar();
        if(!empty($last_appearance_of))
        {
            $ex_plode = explode('-', $last_appearance_of);
            $month_name = Categorytype::findOne($ex_plode[0]);
            $month_and_year = strtoupper($month_name['description']."-".$ex_plode[1]);
        }
        else
        {
            $month_and_year = DATE('Y');
        }
        
        
        $table = "";
        $sn = 1;
        $query = new Query();
        if (count($final_student) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table border=1 id="checkAllFeet" class="table table-responsive table-striped" align="center" >
                <tbody align="center">';
            $table .= '
                        <tr>                           
                            <td colspan=14 align="center"> 
                                <center><b><font size="4px">' . strtoupper($org_name) . '</font></b></center>
                                <center>' . strtoupper($org_address) . '</center>                                
                                <center>DETAILS OF CANDIDATES ELIGIBLE FOR THE AWARD OF DEGREE</center> 
                                <center> </center>
                            </td>                           
                            
                        </tr>';
            $table .= '
                    <tr>
                        <td align="center"><b> S.NO </b></td>
                        <td align="center"><b> Reg No </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' name </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . ' CODE </b></td>
                        <td align="center"><b> BRANCH / SPECILIZATION </b></td>
                        <td align="center"><b> Gender </b></td>
                        <td align="center"><b> DOB </b></td>
                        <td align="center"><b> Total CGPA Secured </b></td>
                        <td align="center"><b> Total CGPA Maximum </b></td>
                        <td align="center"><b> ATTEMPT </b></td>
                        <td align="center"><b> Classification </b></td>
                        <td align="center"><b> Ref.No. of the University approving the admission of the student </b></td>
                        <td align="center"><b> Remarks </b></td>
                        <td align="center"><b> Year Of Passing </b></td>
                    </tr>';
            
            foreach ($final_student as $final_student1) 
            {
                $attempt = 'NO';
                    $attempt_check = MarkEntryMaster::find()->where(['year_of_passing'=>'','student_map_id'=>$final_student1['student_map_id']])->andWhere(['NOT LIKE','grade_name','COMPLETED'])->all();

                    $withdraw_check = MarkEntryMaster::find()->where(['grade_name'=>'WD','student_map_id'=>$final_student1['student_map_id']])->all();

                    $with_dr_count = 0;
                     if(!empty($withdraw_check) && count($withdraw_check)>0)
                    {

                        foreach ($withdraw_check as $key => $value) 
                        {                            
                            $month = $value['month']==29?30:29;
                            
                            //$year = $month==29?$value['year']:($value['year']+1);
                            $year = $month==29?($value['year']+1):$value['year'];
                           //print_r( $year);exit;


                  $withdraw_count = Yii::$app->db->createCommand('SELECT count(*) as count FROM coe_mark_entry_master WHERE student_map_id="'.$final_student1['student_map_id'].'" and result like "%pass%" and grade_name not like "%WD%" AND subject_map_id="'.$value['subject_map_id'].'"  and month="'.$month.'" and year="'.$year.'"')->queryScalar();
                           

                  $with_dr_count = (!empty($withdraw_count) && $withdraw_count!='') ? $with_dr_count+$withdraw_count : $with_dr_count;


                    }                        
                        $attempt = count($withdraw_check)==$with_dr_count?'WITH DRAW IN '.count($withdraw_check)." CLEARED IN SINGLE ATTEMPTS" :'WITH DRAW IN '.count($withdraw_check)." CLEARED IN MULTIPLE ATTEMPTS";
                    }

                    else
                    {
                        $attempt = !empty($attempt_check) && count($attempt_check)>0 ?'YES':'NO';
                    }
                    $add_css = $attempt!='NO' ? 'style="background: #f24400; color: #fff; padding: 5px 0 5px 0;" ' : '';
                    $year = DATE('Y');
                   // $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($final_student1['year'],$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);

                    $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($year,$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    

       


                    $checkPrev_reg_num = StudentMapping::findOne($final_student1['student_map_id']);
                    $prev_reg_num = empty($checkPrev_reg_num->previous_reg_number)?0:$checkPrev_reg_num->previous_reg_number;

                    $transfer_stu = empty($checkPrev_reg_num->status_category_type_id)?0:$checkPrev_reg_num->status_category_type_id;
                    
                    if($transfer_stu==5)
                    {
                         $cgpa_calculation = ConfigUtilities::getCgpaCaluclationTransStu($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    else if($prev_reg_num!=0)
                    {
                       $getoldStu = Student::findOne(['register_number'=>$prev_reg_num]);
                       $oldMap = StudentMapping::findOne(['student_rel_id'=>$getoldStu->coe_student_id]);
                       $prev_stu_map = $oldMap->coe_student_mapping_id; 
                       $cgpa_calculation = ConfigUtilities::getCgpaCaluclationRejoin($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    $table .= '
                        <tr '.$add_css.'>
                            <td align="center"> ' . $sn . ' </td>
                            <td align="center"> ' . $final_student1['register_number'] . ' </td>
                            <td align="center"> ' . $final_student1['name'] . ' </td>
                            <td align="center"> ' . $final_student1['degree_code'] . ' </td>
                            <td align="center"> ' . $final_student1['programme_name'] . ' </td>
                            <td align="center"> ' . $final_student1['gender'] . ' </td>
                            <td align="center"> ' . DATE('d-M-Y',strtotime($final_student1['dob'])) . ' </td>
                            <td align="center"> ' . round($cgpa_calculation['final_cgpa'], 2) . ' </td>';
                    $Percentage = round($cgpa_calculation['final_cgpa'], 2);
                    $classification = ConfigUtilities::getClassification($Percentage,$final_student1['regulation_year'],$final_student1['register_number']);
                    $year_of_passing = ConfigUtilities::getLastYearOfPassing($final_student1['register_number']);
                    $table .= '<td align="center"> 10 </td>';                    

                    $table .= '<td align="center"> '.$attempt.' </td>';            
                    $table .= '<td align="center"> ' . $classification . ' </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> '.$year_of_passing.' </td>';
                    $table .= '</tr>';
                    $sn++;
            }
        } else {
            return 0;
        }
        $table .= "<tr><td colspan=7> COE </td><td colspan=7> SIGNATURE OF PRINCIPAL </td></tr>";
        $table .= '</table>';
        if (isset($_SESSION['university_report_print'])) 
        {
            unset($_SESSION['university_report_print']);
        }
        $_SESSION['university_report_print'] = $table;
        return $table;
    }
    public function actionUniversityreportPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['university_report_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Universityreport.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #CCC;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            
                        }
                        table th{
                           
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                           
                        }
                    }   
                ',
            'options' => ['title' => 'University Report Information'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['University Report Information' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelUniversityreport()
    {        
        $content = $_SESSION['university_report_print'];           
        $fileName = "University Report Information " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionMyclassroom()
    {
        $model = new MarkEntry();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to My Class Room ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('myclassroom', [
            'model' => $model,
        ]);
    }
    public function actionMyclassroomdata()
    {
        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $degree = Yii::$app->request->post('degree');
        $passed_stu = array();
        $failed_stu = array();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();
        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $query = new  Query();
        $query->select('F.student_map_id,A.name, A.register_number, G.semester, A.dob,B.course_batch_mapping_id,F.year,F.month ,K.description as month_name , C.regulation_year,D.degree_code,D.degree_name,E.programme_name,part_no,mark_type,result_published_date')
            ->from('coe_student as A')
            ->join('JOIN', 'coe_student_mapping as B', 'B.student_rel_id=A.coe_student_id ')
            ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.course_batch_mapping_id')
            ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
            ->join('JOIN', 'coe_programme as E', 'E.coe_programme_id=C.coe_programme_id')
            ->join('JOIN', 'coe_batch as I', 'I.coe_batch_id=C.coe_batch_id')
            ->join('JOIN', 'coe_mark_entry_master as F', 'F.student_map_id=B.coe_student_mapping_id')
            ->join('JOIN', 'coe_category_type as K', 'K.coe_category_type_id=F.month')
            ->join('JOIN', 'coe_subjects_mapping as G', 'G.coe_subjects_mapping_id=F.subject_map_id')
            ->join('JOIN', 'coe_subjects H', 'H.coe_subjects_id=G.subject_id');
        $query->Where(['F.year' => $year, 'F.month' => $month, 'A.student_status' => 'Active','D.degree_type'=>$degree])
            ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
        $query->groupBy('F.student_map_id')
            ->orderBy('A.register_number,G.semester');
        $final_student = $query->createCommand()->queryAll();
        
        $table = "";
        $sn = 1;
        $query = new Query();
        if (count($final_student) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table border=1 id="checkAllFeet" class="table table-responsive table-striped" align="center" >
                <tbody align="center">';
           
            $table .= '
                    <tr>
                        <td align="center"><b> S.NO </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . ' CODE </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_PROGRAMME) . ' NAME </b></td>
                        <td align="center"><b> DATE OF RESULT </b></td>
                        <td align="center"><b> YEAR & MONTH </b></td>
                        <td align="center"><b> NAME </b></td>
                        <td align="center"><b> DATE OF BIRTH </b></td>
                        <td align="center"><b> ROLL NUMBER </b></td>
                        <td align="center"><b> PART  DETAILS</b><table width="100%" border=1 ><tr>';

            for ($i=1; $i <5 ; $i++) 
            { 
                $table .= '<td width="30px"><h4>'.$i.'</h4></td>
                        <td width="40px">CREDITS</td>
                        <td width="40px">SGPA</td>
                        <td width="40px">CGPA</td>';
            }   
            $table .= '</tr></table></td></tr>';         
            foreach ($final_student as $final_student1) 
            {       
                $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($final_student1['year'],$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id'],$final_student1['semester']);
                $date_of_result = isset($final_student1['result_published_date']) && !empty($final_student1['result_published_date']) && $final_student1['result_published_date']!='0000-00-00'?date('d-M-Y',strtotime($final_student1['result_published_date'])):date('d-m-Y');
                $table .= '
                    <tr>
                        <td align="center"> ' . $sn . ' </td>
                        <td align="center"> ' . $final_student1['degree_code'] . ' </td>
                        <td align="center"> ' . $final_student1['programme_name'] . ' </td>
                        <td align="center"> ' . $date_of_result . ' </td>
                        <td align="center"> ' . $final_student1['year']." - ".$final_student1['month_name']. ' </td>
                        <td align="center"> ' . $final_student1['name'] . ' </td>
                        <td align="center"> ' . date('d-M-Y' ,strtotime($final_student1['dob'])) . ' </td>
                        <td align="center"> ' . $final_student1['register_number'] . '</td> 
                        <td align="center"> <table border=1 >
                                <tr>';

                $getRegInfo = MarkEntryMaster::find()->where(['student_map_id'=>$final_student1['student_map_id'],'year'=>$final_student1['year'],'month'=>$final_student1['month'],'mark_type'=>27])->one();
                $semester_number = ConfigUtilities::semCaluclation($year, $final_student1['month'], $final_student1['course_batch_mapping_id']);
                $cgpa_calc = ConfigUtilities::getCgpaCaluclation($year,$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id'],$semester_number);
                
                for ($a=1; $a <5 ; $a++) 
                { 
                    
                    $table .= '<td width="30px"><h4>'.$a.'</h4></td>
                                <td width="40px">'.$cgpa_calc['part_'.$a.'_earned'].'</td>
                                <td width="40px">'.$cgpa_calc['part_'.$a.'_gpa'].'</td>
                                <td width="40px">'.$cgpa_calc['part_'.$a.'_cgpa'].'</td>
                    ';
                } 
                $table .= '</tr>
                            </table></td></tr>';
                $sn++;
            }
        } else {
            return 0;
        }
        
        $table .= '</table>';
        if (isset($_SESSION['my_class_university_report_print'])) 
        {
            unset($_SESSION['my_class_university_report_print']);
        }
        $_SESSION['my_class_university_report_print'] = $table;
        return $table;
    }
    public function actionMyclassroomPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['my_class_university_report_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Universityreport.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #CCC;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            
                        }
                        table th{
                           
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                           
                        }
                    }   
                ',
            'options' => ['title' => 'MyClassRoom Report Information'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['MyClassRoom Report Information' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelMyclassroom()
    {        
        $content = $_SESSION['my_class_university_report_print'];           
        $fileName = "MyClassRoom Report Information " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    //University report ends here

    //University report starts here
    public function actionUniversityreportCompleted()
    {
        $model = new MarkEntry();
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to University ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_REPORT));
        return $this->render('universityreport-completed', [
            'model' => $model,
        ]);
    }
    /*public function actionUniversityreportdatacomp()
    {
        $batch = Yii::$app->request->post('batch');

        $bat_map_id = Yii::$app->request->post('bat_map_id');

        $year = Yii::$app->request->post('year');

        $month = Yii::$app->request->post('month');

        $passed_stu = array();
        $failed_stu = array();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_cat_transfer=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();
       ;
       
       $fail_query = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$year."' AND A.month='".$month."' AND A.result='Fail'";
                
        $fail_list = Yii::$app->db->createCommand($fail_query)->queryAll();

            $fail_stu = [];
            foreach ($fail_list as $key => $value) {
                $fail_stu[$value['id']]=$value['id'];
            }

        $fail_stu = array_filter($fail_stu);

        $fail_stu = implode(',', $fail_stu);

        if(!empty($fail_stu))
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.coe_student_mapping_id NOT IN('".$fail_stu."') and B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."'  AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
        else
        {
             
            $fail_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$year."' AND A.month='".$month."' AND A.result='Fail'";
                
        $fail_list = Yii::$app->db->createCommand($fail_query)->queryAll();

            $fail_stu = [];
            foreach ($fail_list as $key => $value) {
                $fail_stu[$value['id']]=$value['id'];
            }

        $fail_stu = array_filter($fail_stu);

        $fail_stu = implode(',', $fail_stu);

            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.coe_student_mapping_id NOT IN('".$fail_stu."') AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."' AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }


        $final_student = Yii::$app->db->createCommand($get_stu_query)->queryAll();
        //print_r( $final_student);exit;


        $last_appearance_of = Yii::$app->db->createCommand("SELECT max(F.year_of_passing) as last_appearance FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id  where G.batch_mapping_id='".$bat_map_id."' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') and F.year ='".$year."' AND F.month='".$month."'   group by A.register_number")->queryScalar();
        $month_name_old= Categorytype::findOne($month);
        $month_and_year = $year." - ".strtoupper($month_name_old->description);

          

        $table = "";
        $sn = 1;
        $query = new Query();
       
        if (count($final_student) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table border=1 id="checkAllFeet" class="table table-responsive table-striped" align="center" >
                <tbody align="center">';
            $table .= '
                        <tr>                           
                            <td colspan=14 align="center"> 
                                <center><b><font size="4px">' . strtoupper($org_name) . '</font></b></center>
                                <center>' . strtoupper($org_address) . '</center>                                
                                <center>DETAILS OF CANDIDATES ELIGIBLE FOR THE AWARD OF DEGREE</center> 
                                <center> MONTH AND YEAR OF EXAMINATION '.$month_and_year.' </center>
                            </td>                           
                            
                        </tr>';
            $table .= '
                    <tr>
                        <td align="center"><b> S.NO </b></td>
                        <td align="center"><b> Reg No </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' name </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . ' CODE </b></td>
                        <td align="center"><b> BRANCH / SPECILIZATION </b></td>
                        <td align="center"><b> Gender </b></td>
                        <td align="center"><b> DOB </b></td>
                        <td align="center"><b> Total CGPA Secured </b></td>
                        <td align="center"><b> Total CGPA Maximum </b></td>
                        <td align="center"><b> ATTEMPT </b></td>
                        <td align="center"><b> Classification </b></td>
                        <td align="center"><b> Ref.No. of the University approving the admission of the student </b></td>
                        <td align="center"><b> Remarks </b></td>
                        <td align="center"><b> Year of Passing </b></td>
                    </tr>';

            
            foreach ($final_student as $final_student1) 
            {
                    $attempt_check = MarkEntryMaster::find()->where(['year_of_passing'=>'','student_map_id'=>$final_student1['student_map_id']])->all();

                    $withdraw_check = MarkEntryMaster::find()->where(['grade_name'=>'WD','student_map_id'=>$final_student1['student_map_id']])->all();
                    $with_dr_count = 0;
                    if(!empty($withdraw_check) && count($withdraw_check)>0)
                    {
                        foreach ($withdraw_check as $key => $value) 
                        {
                            $month = $value['month']==29?30:29;
                            //$year = $month==29?$value['year']:($value['year']+1);
                            $year = $month==29?($value['year']+1):$value['year'];
                            $withdraw_count = Yii::$app->db->createCommand('SELECT count(*) as count FROM coe_mark_entry_master WHERE student_map_id="'.$final_student1['student_map_id'].'" and result like "%pass%" and grade_name not like "%WD%" AND subject_map_id="'.$value['subject_map_id'].'" and year="'.$year.'" and month="'.$month.'"')->queryScalar();
                            $with_dr_count = (!empty($withdraw_count) && $withdraw_count!='') ? $with_dr_count+$withdraw_count : $with_dr_count;
                        }
                        $attempt = count($withdraw_check)==$with_dr_count?'WITH DRAW IN '.count($withdraw_check)." CLEARED IN SINGLE ATTEMPTS" :'WITH DRAW IN '.count($withdraw_check)." CLEARED IN MULTIPLE ATTEMPTS";
                    }
                    else
                    {
                        $attempt = !empty($attempt_check) && count($attempt_check)>0 ?'YES':'NO';
                    }
                    $add_css = $attempt!='NO' ? 'style="background: #f24400; color: #fff; padding: 5px 0 5px 0;" ' : '';

                    $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($final_student1['year'],$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);

                     $checkPrev_reg_num = StudentMapping::findOne($final_student1['student_map_id']);
                    $prev_reg_num = empty($checkPrev_reg_num->previous_reg_number)?0:$checkPrev_reg_num->previous_reg_number;

                    $transfer_stu = empty($checkPrev_reg_num->status_category_type_id)?0:$checkPrev_reg_num->status_category_type_id;
                    
                    if($transfer_stu==5)
                    {
                         $cgpa_calculation = ConfigUtilities::getCgpaCaluclationTransStu($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    else if($prev_reg_num!=0)
                    {
                       $getoldStu = Student::findOne(['register_number'=>$prev_reg_num]);
                       $oldMap = StudentMapping::findOne(['student_rel_id'=>$getoldStu->coe_student_id]);
                       $prev_stu_map = $oldMap->coe_student_mapping_id; 
                       $cgpa_calculation = ConfigUtilities::getCgpaCaluclationRejoin($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }

                    $table .= '
                        <tr '.$add_css.'>
                            <td align="center"> ' . $sn . ' </td>
                            <td align="center"> ' . $final_student1['register_number'] . ' </td>
                            <td align="center"> ' . $final_student1['name'] . ' </td>
                            <td align="center"> ' . $final_student1['degree_code'] . ' </td>
                            <td align="center"> ' . $final_student1['programme_name'] . ' </td>
                            <td align="center"> ' . $final_student1['gender'] . ' </td>
                            <td align="center"> ' . DATE('d-M-Y',strtotime($final_student1['dob'])) . ' </td>
                            <td align="center"> ' . $cgpa_calculation['final_cgpa'] . ' </td>';
                    $Percentage = round($cgpa_calculation['final_cgpa'], 2);
                    $classification = ConfigUtilities::getClassification($Percentage,$final_student1['regulation_year'],$final_student1['register_number']);
                    $year_of_passing = ConfigUtilities::getYearOfPassing($final_student1['year_of_passing']);
                   
                    $table .= '<td align="center"> 10 </td>';                    

                    $table .= '<td align="center"> '.$attempt.' </td>';            
                    $table .= '<td align="center"> ' . $classification . ' </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center">'.$year_of_passing.' </td>';
                    $table .= '</tr>';
                    $sn++;
            }
        
        } else {
            return 0;
        }
        $table .= "<tr><td colspan=7> COE </td><td colspan=7> SIGNATURE OF PRINCIPAL </td></tr>";
        $table .= '</table>';
        if (isset($_SESSION['university_report_print'])) {
            unset($_SESSION['university_report_print']);
        }
        $_SESSION['university_report_print'] = $table;
        return $table;
    }
    */
   public function actionUniversityreportdatacomp()
    {
        $batch = Yii::$app->request->post('batch');

        $bat_map_id = Yii::$app->request->post('bat_map_id');

        $year = Yii::$app->request->post('year');

        $month = Yii::$app->request->post('month');

        $passed_stu = array();
        $failed_stu = array();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        $det_cat_transfer=Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Transfer%'")->queryScalar();
        $det_cat_rejoin = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Rejoin%'")->queryScalar();       
       
       $fail_all = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year<='".$year."' AND A.result='Fail'";

        $fail_all_list = Yii::$app->db->createCommand($fail_all)->queryAll();
       
       $fail_query = "SELECT DISTINCT student_map_id as id FROM coe_mandatory_stu_marks as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$year."' AND A.month='".$month."' AND A.result='Fail'";
                
        $fail_stu_list = Yii::$app->db->createCommand($fail_query)->queryAll();

        $fail_list = array_merge($fail_all_list,$fail_stu_list);

            $fail_stu = [];
            foreach ($fail_list as $key => $value) {
                $fail_stu[$value['id']]=$value['id'];
            }

        $fail_stu = array_filter($fail_stu);

        $fail_stu = implode(',', $fail_stu);

        $fail_paper_query = "SELECT DISTINCT student_map_id as id FROM coe_mark_entry_master as A
                       JOIN coe_student_mapping as B ON B.coe_student_mapping_id=A.student_map_id
                       JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id
                       WHERE B.course_batch_mapping_id='".$bat_map_id."' AND C.coe_batch_id='".$batch."' AND A.year='".$year."' AND A.month='".$month."' AND A.result='Fail'";
                
        $fail_paper_list = Yii::$app->db->createCommand($fail_paper_query)->queryAll();

            $fail_paper_stu = [];
            foreach ($fail_paper_list as $key => $value) {
                $fail_paper_stu[$value['id']]=$value['id'];
            }

        $fail_paper_stu = array_filter($fail_paper_stu);

        $fail_paper_stu = implode(',', $fail_paper_stu);


        if(!empty($fail_stu) && !empty($fail_paper_stu))
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.coe_student_mapping_id NOT IN(".$fail_paper_stu.") AND B.coe_student_mapping_id NOT IN(".$fail_stu.") and B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."'  AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
        else if(!empty($fail_stu) && empty($fail_paper_stu))
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.coe_student_mapping_id NOT IN(".$fail_stu.") and B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."'  AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
        else if(empty($fail_stu) && !empty($fail_paper_stu))
        {
            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.coe_student_mapping_id NOT IN(".$fail_paper_stu.") and B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."'  AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }
        else
        {

            $get_stu_query = "SELECT F.student_map_id,A.register_number,A.dob,A.name,A.gender,D.degree_code,D.degree_name,E.programme_name,H.subject_code,C.regulation_year,H.subject_name,G.semester,H.credit_points,H.CIA_max,H.ESE_max,F.grade_point,F.grade_name,F.year,F.month,B.course_batch_mapping_id,F.year_of_passing,paper_no,F.result,max(F.year_of_passing) as last_appearance,round (sum(H.credit_points*F.grade_point)/sum(H.credit_points),5) as total FROM coe_student as A 
            JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id 
            JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id 
            JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id 
            JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id 
            JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id 
            JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id 
            JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id 
            JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id where G.batch_mapping_id='".$bat_map_id."' 
            AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='' and subject_map_id NOT IN(select subject_map_id FROM coe_mark_entry_master where student_map_id=F.student_map_id and result like '%pass%'))
            AND B.status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND F.year='".$year."' AND F.month='".$month."'  AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') group by A.register_number order by A.register_number, G.semester, paper_no"; 
        }


        $final_student = Yii::$app->db->createCommand($get_stu_query)->queryAll();


        $last_appearance_of = Yii::$app->db->createCommand("SELECT max(F.year_of_passing) as last_appearance FROM coe_student as A JOIN coe_student_mapping as B ON B.student_rel_id=A.coe_student_id JOIN coe_bat_deg_reg as C ON C.coe_bat_deg_reg_id=B.course_batch_mapping_id JOIN coe_degree as D ON D.coe_degree_id=C.coe_degree_id JOIN coe_programme as E ON E.coe_programme_id=C.coe_programme_id JOIN coe_mark_entry_master as F ON F.student_map_id=B.coe_student_mapping_id JOIN coe_subjects_mapping as G ON G.coe_subjects_mapping_id=F.subject_map_id JOIN coe_subjects as H ON H.coe_subjects_id=G.subject_id JOIN coe_batch as I ON I.coe_batch_id=C.coe_batch_id  where G.batch_mapping_id='".$bat_map_id."' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') AND B.coe_student_mapping_id NOT IN(select student_map_id from coe_mark_entry_master where year_of_passing='') AND F.grade_name not IN ('RA','wh','AB','ab','WH','ra','wd','WD') and F.year ='".$year."' AND F.month='".$month."'   group by A.register_number")->queryScalar();
        $month_name_old= Categorytype::findOne($month);
        $month_and_year = $year." - ".strtoupper($month_name_old->description);

          

        $table = "";
        $sn = 1;
        $query = new Query();
       
        if (count($final_student) > 0) {
            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            $table = '<table border=1 id="checkAllFeet" class="table table-responsive table-striped" align="center" >
                <tbody align="center">';
            $table .= '
                        <tr>                           
                            <td colspan=14 align="center"> 
                                <center><b><font size="4px">' . strtoupper($org_name) . '</font></b></center>
                                <center>' . strtoupper($org_address) . '</center>                                
                                <center>DETAILS OF CANDIDATES ELIGIBLE FOR THE AWARD OF DEGREE</center> 
                                <center> MONTH AND YEAR OF EXAMINATION '.$month_and_year.' </center>
                            </td>                           
                            
                        </tr>';
            $table .= '
                    <tr>
                        <td align="center"><b> S.NO </b></td>
                        <td align="center"><b> Reg No </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT) . ' name </b></td>
                        <td align="center"><b> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE) . ' CODE </b></td>
                        <td align="center"><b> BRANCH / SPECILIZATION </b></td>
                        <td align="center"><b> Gender </b></td>
                        <td align="center"><b> DOB </b></td>
                        <td align="center"><b> Total CGPA Secured </b></td>
                        <td align="center"><b> Total CGPA Maximum </b></td>
                        <td align="center"><b> ATTEMPT </b></td>
                        <td align="center"><b> Classification </b></td>
                        <td align="center"><b> Ref.No. of the University approving the admission of the student </b></td>
                        <td align="center"><b> Remarks </b></td>
                        <td align="center"><b> Year of Passing </b></td>
                    </tr>';

            
            foreach ($final_student as $final_student1) 
            {
                    $attempt_check = MarkEntryMaster::find()->where(['year_of_passing'=>'','student_map_id'=>$final_student1['student_map_id']])->all();

                    $withdraw_check = MarkEntryMaster::find()->where(['grade_name'=>'WD','student_map_id'=>$final_student1['student_map_id']])->all();
                    $with_dr_count = 0;
                    if(!empty($withdraw_check) && count($withdraw_check)>0)
                    {
                        foreach ($withdraw_check as $key => $value) 
                        {
                            $month = $value['month']==29?30:29;
                            //$year = $month==29?$value['year']:($value['year']+1);
                            $year = $month==29?($value['year']+1):$value['year'];
                            $withdraw_count = Yii::$app->db->createCommand('SELECT count(*) as count FROM coe_mark_entry_master WHERE student_map_id="'.$final_student1['student_map_id'].'" and result like "%pass%" and grade_name not like "%WD%" AND subject_map_id="'.$value['subject_map_id'].'" and year="'.$year.'" and month="'.$month.'"')->queryScalar();
                            $with_dr_count = (!empty($withdraw_count) && $withdraw_count!='') ? $with_dr_count+$withdraw_count : $with_dr_count;
                        }
                        $attempt = count($withdraw_check)==$with_dr_count?'WITH DRAW IN '.count($withdraw_check)." CLEARED IN SINGLE ATTEMPTS" :'WITH DRAW IN '.count($withdraw_check)." CLEARED IN MULTIPLE ATTEMPTS";
                    }
                    else
                    {
                        $attempt = !empty($attempt_check) && count($attempt_check)>0 ?'YES':'NO';
                    }
                    $add_css = $attempt!='NO' ? 'style="background: #f24400; color: #fff; padding: 5px 0 5px 0;" ' : '';

                    $cgpa_calculation = ConfigUtilities::getCgpaCaluclation($final_student1['year'],$final_student1['month'],$final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);

                     $checkPrev_reg_num = StudentMapping::findOne($final_student1['student_map_id']);
                    $prev_reg_num = empty($checkPrev_reg_num->previous_reg_number)?0:$checkPrev_reg_num->previous_reg_number;

                    $transfer_stu = empty($checkPrev_reg_num->status_category_type_id)?0:$checkPrev_reg_num->status_category_type_id;
                    
                    if($transfer_stu==5)
                    {
                         $cgpa_calculation = ConfigUtilities::getCgpaCaluclationTransStu($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }
                    else if($prev_reg_num!=0)
                    {
                       $getoldStu = Student::findOne(['register_number'=>$prev_reg_num]);
                       $oldMap = StudentMapping::findOne(['student_rel_id'=>$getoldStu->coe_student_id]);
                       $prev_stu_map = $oldMap->coe_student_mapping_id; 
                       $cgpa_calculation = ConfigUtilities::getCgpaCaluclationRejoin($final_student1['course_batch_mapping_id'],$final_student1['student_map_id']);
                    }

                    $table .= '
                        <tr '.$add_css.'>
                            <td align="center"> ' . $sn . ' </td>
                            <td align="center"> ' . $final_student1['register_number'] . ' </td>
                            <td align="center"> ' . $final_student1['name'] . ' </td>
                            <td align="center"> ' . $final_student1['degree_code'] . ' </td>
                            <td align="center"> ' . $final_student1['programme_name'] . ' </td>
                            <td align="center"> ' . $final_student1['gender'] . ' </td>
                            <td align="center"> ' . DATE('d-M-Y',strtotime($final_student1['dob'])) . ' </td>
                            <td align="center"> ' . $cgpa_calculation['final_cgpa'] . ' </td>';
                    $Percentage = round($cgpa_calculation['final_cgpa'], 2);
                    $classification = ConfigUtilities::getClassification($Percentage,$final_student1['regulation_year'],$final_student1['register_number']);
                    $year_of_passing = ConfigUtilities::getYearOfPassing($final_student1['year_of_passing']);
                   
                    $table .= '<td align="center"> 10 </td>';                    

                    $table .= '<td align="center"> '.$attempt.' </td>';            
                    $table .= '<td align="center"> ' . $classification . ' </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center"> &nbsp; </td>';
                    $table .= '<td align="center">'.$year_of_passing.' </td>';
                    $table .= '</tr>';
                    $sn++;
            }
        
        } else {
            return 0;
        }
        $table .= "<tr><td colspan=7> COE </td><td colspan=7> SIGNATURE OF PRINCIPAL </td></tr>";
        $table .= '</table>';
        if (isset($_SESSION['university_report_print'])) {
            unset($_SESSION['university_report_print']);
        }
        $_SESSION['university_report_print'] = $table;
        return $table;
    }
    public function actionUniversityreportCompletedPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['university_report_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Universityreport.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_LANDSCAPE,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border-collapse: collapse;  text-align: center;  font-family:"Roboto, sans-serif"; width:100%; font-size: 14px; } 
                        
                        table td{
                            border: 1px solid #CCC;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                            
                        }
                        table th{
                           
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            text-align: center;
                           
                        }
                    }   
                ',
            'options' => ['title' => 'University Report Information'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['University Report Information' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelUniversityCompletedreport()
    {        
        $content = $_SESSION['university_report_print'];           
        $fileName = "University Report Information " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    //AdditionalCredits Starts Here
    public function actionAdditionalcredits()
    {
        $model = new MarkEntry();
        $add_credits = new AdditionalCredits();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        if (isset($_POST['add_submit_btn'])) 
        {
            
            $sn = Yii::$app->request->post('sn');
            $subject_code = $_POST['add_sub_code'];
            $subject_name = $_POST['add_sub_name'];
            $credit = $_POST['add_credits'];
            $created_by = Yii::$app->user->getId();
            $created_at = date("Y-m-d H:i:s");            
            $exam_year = $_POST['MarkEntry']['year'];
            $exam_month = $_POST['month'];
            for ($k = 1; $k <= $sn; $k++) 
            {
                if (isset($_POST['add' . $k]) && $_POST['add' . $k]=='on') 
                {
                    $query = new Query();
                    $query->select('a.coe_student_mapping_id')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                        ->where(['b.register_number' => $_POST['reg_num' . $k]])
                        ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                        ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_map_id = $query->createCommand()->queryScalar();
                    $marks = $_POST['actxt_' . $k];
                    $result = $_POST['acresult_' . $k];
                    $grade_name = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $_POST['grade_' . $k]:'RA';
                    $grade_point = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $_POST['grade_point_' . $k]:'0';
                    $result = $_POST['acresult_' . $k];
                    $year_of_passing = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $exam_month."-".$exam_year: "";

                    $check_query = new Query();
                    $check_query->select('*')
                        ->from('coe_additional_credits')
                        ->where(['student_map_id' => $student_map_id, 'subject_code' => $subject_code]);
                    $check_exist = $check_query->createCommand()->queryAll();
                    //echo $check_exist;exit;
                    if (empty($check_exist)) 
                    {
                        $insert_additional_credit = Yii::$app->db->createCommand("insert into   `coe_additional_credits` (`coe_additional_credits_id`, `exam_year`, `exam_month`, `student_map_id`, `subject_code`, `subject_name`, `credits`,   `ESE`, `total`, `grade_point`, `grade_name`,  `result`, `year_of_passing`, `created_at`, `created_by`, `updated_at`, `updated_by`)  values ('','" . $exam_year . "','" . $exam_month . "','" . $student_map_id . "','" . $subject_code . "','" . $subject_name . "','" . $credit . "','" . $marks . "','" . $marks . "','" . $grade_point . "','" . $grade_name . "','" . $result . "','" . $year_of_passing . "','" . $created_at . "','" . $created_by . "','" . $created_at . "','" . $created_by . "') ")->execute();
                    }
                }
            }
            Yii::$app->ShowFlashMessages->setMsg('Success', 'Additional Credits Successfully Inserted!!!');
            return $this->redirect(['additionalcredits',]);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Additional Credits Mark Entry');
            return $this->render('additionalcredits', [
                'model' => $model, 'add_credits' => $add_credits,
            ]);
        }
    }
    public function actionDeleteAdditionalcredits()
    {
        $model = new MarkEntry();
        $add_credits = new AdditionalCredits();
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        if($checkAccess=='Yes')
        {
            if (isset($_POST['add_submit_btn'])) 
            {
                
                $sn = Yii::$app->request->post('sn');
                $subject_code = $_POST['add_sub_code'];
                $subject_name = $_POST['add_sub_name'];
                $credit = $_POST['add_credits'];
                $created_by = Yii::$app->user->getId();
                $created_at = date("Y-m-d H:i:s");            
                $exam_year = $_POST['MarkEntry']['year'];
                $exam_month = $_POST['month'];
                for ($k = 1; $k <= $sn; $k++) 
                {
                    if (isset($_POST['add' . $k]) && $_POST['add' . $k]=='on') 
                    {
                        $query = new Query();
                        $query->select('a.coe_student_mapping_id')
                            ->from('coe_student_mapping a')
                            ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                            ->where(['b.register_number' => $_POST['reg_num' . $k]])
                            ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                            ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                        $student_map_id = $query->createCommand()->queryScalar();
                        $marks = $_POST['actxt_' . $k];
                        $result = $_POST['acresult_' . $k];
                        $grade_name = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $_POST['grade_' . $k]:'RA';
                        $grade_point = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $_POST['grade_point_' . $k]:'0';
                        $result = $_POST['acresult_' . $k];
                        $year_of_passing = $result=='Pass' || $result=='PASS' || $result=='PASS' ? $exam_month."-".$exam_year: "";

                        $check_query = new Query();
                        $check_query->select('*')
                            ->from('coe_additional_credits')
                            ->where(['student_map_id' => $student_map_id, 'subject_code' => $subject_code]);
                        $check_exist = $check_query->createCommand()->queryAll();
                        //echo $check_exist;exit;
                        if (empty($check_exist)) 
                        {
                            $insert_additional_credit = Yii::$app->db->createCommand("insert into coe_additional_credits values('','" . $exam_year . "','" . $exam_month . "','" . $student_map_id . "','" . $subject_code . "','" . $subject_name . "','" . $credit . "','" . $marks . "','" . $grade_point . "','" . $grade_name . "','" . $result . "','" . $year_of_passing . "','" . $created_at . "','" . $created_by . "','" . $created_at . "','" . $created_by . "') ")->execute();
                        }
                    }
                }
                Yii::$app->ShowFlashMessages->setMsg('Success', 'Additional Credits Successfully Inserted!!!');
                return $this->redirect(['delete-additionalcredits',]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Additional Credits Mark Entry');
                return $this->render('delete-additionalcredits', [
                    'model' => $model, 'add_credits' => $add_credits,
                ]);
            }
        }
        else
        {
            $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;

            //print_r(parse_url($url)); // This will returns the parts of the URL
            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
    }
    public function actionAdditionalcreditsArts()
    {
        $model = new MarkEntry();
        $add_credits = new AdditionalCredits();
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();
        if (isset($_POST['add_submit_btn'])) 
        {
            $sn = Yii::$app->request->post('sn');
            $subject_code = $_POST['add_sub_code'];
            $subject_name = $_POST['add_sub_name'];
            $credit = $_POST['add_credits'];
            $cia_min = $_POST['AdditionalCredits']['cia_minimum'];
            $cia_max = $_POST['AdditionalCredits']['cia_maximum'];
            $ese_min = $_POST['AdditionalCredits']['ese_minimum'];
            $ese_max = $_POST['AdditionalCredits']['ese_maximum'];
            $total_min = $_POST['AdditionalCredits']['total_minimum_pass'];
            $created_by = Yii::$app->user->getId();
            $created_at = date("Y-m-d H:i:s");            
            $exam_year = $_POST['MarkEntry']['year'];
            $exam_month = $_POST['month'];
            $bat_val = $_POST['bat_val'];
            $bat_map_val = $_POST['bat_map_val'];
            $final_sub_total= $cia_max+$ese_max;
            $coe_batch_id = Batch::findOne($bat_val);
              $regulation = CoeBatDegReg::find()->where(['coe_batch_id'=>$coe_batch_id->coe_batch_id,'coe_bat_deg_reg_id'=>$bat_map_val])->one();
              $grade_details = Regulation::find()->where(['regulation_year'=>$regulation->regulation_year])->all();
              require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
            for ($k = 1; $k <= $sn; $k++) 
            {
                if (isset($_POST['add' . $k]) && $_POST['add' . $k]=='on') 
                {
                    $query = new Query();
                    $query->select('a.coe_student_mapping_id')
                        ->from('coe_student_mapping a')
                        ->join('JOIN', 'coe_student b', 'a.student_rel_id=b.coe_student_id')
                        ->where(['b.register_number' => $_POST['reg_num' . $k]])
                        ->andWhere(['<>', 'status_category_type_id', $det_cat_type])
                        ->andWhere(['<>', 'status_category_type_id', $det_disc_type]);
                    $student_map_id = $query->createCommand()->queryScalar();
                    $out_of_maximum = $_POST['actxt_' . $k];
                    $cia_marks = $grade_cia_check = $cia_max==0?0:$_POST['actxttotal_' . $k];
                    $ese_marks = $ese_max==0?0:$_POST['actxttotal_' . $k];
                    $total_marks = $_POST['actxttotal_' . $k];
                    $result = $_POST['acresult_' . $k];
                    $arts_college_grade = round(($out_of_maximum/$final_sub_total)*10,1);
                      
                      foreach($grade_details as $value) 
                      {
                          if($value['grade_point_to']!='')
                          {                            
                              if($total_marks >= $value['grade_point_from'] &&  $total_marks <= $value['grade_point_to'] )
                              {
                                  if($grade_cia_check<$cia_min || $ese_marks<$ese_min || $total_marks<$total_min)
                                  {
                                    $stu_result_data = ['result'=>'Fail','total_marks'=>$total_marks,'grade_name'=>'RA','grade_point'=>0,'year_of_passing'=>'','ese_marks'=>$ese_marks];        
                                  }      
                                  else
                                  {
                                    $grade_name_prit = $value['grade_name'];
                                    $grade_point_arts = $arts_college_grade;
                                    
                                    $stu_result_data = ['result'=>'Pass','total_marks'=>$total_marks,'grade_name'=>$grade_name_prit,'grade_point'=>$grade_point_arts,'ese_marks'=>$ese_marks,'year_of_passing'=>$exam_month."-".$exam_year];
                                    
                                    
                                  }
                              } // Grade Point Caluclation
                          } // Not Empty of the Grade Point                               
                      }
                    
                    $check_query = new Query();
                    $check_query->select('*')
                        ->from('coe_additional_credits')
                        ->where(['student_map_id' => $student_map_id, 'subject_code' => $subject_code]);
                    $check_exist = $check_query->createCommand()->queryAll();
                    //echo $check_exist;exit;
                    if (empty($check_exist)) 
                    {
                        $model_save = new AdditionalCredits();
                        $model_save->exam_year = $exam_year;
                        $model_save->exam_month = $exam_month;
                        $model_save->student_map_id = $student_map_id;
                        $model_save->subject_code = $subject_code;
                        $model_save->subject_name = $subject_name;
                        $model_save->credits = $credit;
                        $model_save->out_of_maximum = $out_of_maximum;
                        $model_save->CIA = $cia_marks;
                        $model_save->ESE = $stu_result_data['ese_marks'];
                        $model_save->total = $stu_result_data['total_marks'];
                        $model_save->result = $stu_result_data['result'];
                        $model_save->grade_point = $stu_result_data['grade_point'];
                        $model_save->grade_name = $stu_result_data['grade_name'];
                        $model_save->year_of_passing = $stu_result_data['year_of_passing'];
                        $model_save->cia_minimum = $cia_min;                        
                        $model_save->cia_maximum = $cia_max;
                        $model_save->ese_minimum = $ese_min;
                        $model_save->ese_maximum = $ese_max;
                        $model_save->total_minimum_pass = $total_min;
                        $model_save->created_at = $created_at;
                        $model_save->created_by = $created_by;
                        $model_save->updated_at = $created_at;
                        $model_save->updated_by = $created_by;
                        if($model_save->save(false))
                        {
                            Yii::$app->ShowFlashMessages->setMsg('SUCCESS', 'ADDITIONAL CREDITS INSERTED SUCCESSFULLY!!!');
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('ERROR', 'SOMETHING WRONG');
                        }
                    }
                }
            }
            return $this->redirect(['additionalcredits-arts']);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Additional Credits Mark Entry');
            return $this->render('additionalcredits-arts', [
                'model' => $model, 'add_credits' => $add_credits,
            ]);
        }
    }
    public function actionAdditionalcreditsUpdate()
    {
        $model = new MarkEntry();
        $add_credits = new AdditionalCredits();       
        if (isset($_POST['add_submit_btn'])) 
        {
            return $this->redirect(['additionalcredits-update']);
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Additional Credits Subject Name Update');
            return $this->render('additionalcredits-update', [
                'model' => $model, 'add_credits' => $add_credits,
            ]);
        }
    }
    //AdditionalCredits Ends Here
    //Withdraw starts here
    public function actionWithdraw()
    {
        $model = new MarkEntry();
        $student = new Student();
        $subject = new SubjectsMapping();
        $sn = Yii::$app->request->post('sn');
        $updated_at = date("Y-m-d H:i:s");
        $updated_by = Yii::$app->user->getId();
        for ($k = 1; $k <= $sn; $k++) {
            if (isset($_POST["withdraw" . $k])) {

                //// TRCKING CODE STARTS //////

                 $getMarksdata = MarkEntryMaster::find()->where(['subject_map_id'=>$_POST['sub_code' . $k],'student_map_id'=>$_POST['stu_map_id'],'year'=>$_POST['withdraw_year'],'month'=>$_POST['withdraw_month'] ])->one();

                 $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                  $data_updated = 'Withdraw : Prev ESE Marks : '.$getMarksdata['ESE'].' New ESE Marks : 0 Prev Total Marks : '.$getMarksdata['total'].' New Total Marks: '.$getMarksdata['CIA'];

                 $data_array = ['subject_map_id'=>$_POST['sub_code' . $k],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$_POST['withdraw_month'] ,'exam_year'=>$_POST['withdraw_year'],'student_map_id'=>$_POST['stu_map_id']];            
                  $update_track = ConfigUtilities::updateTracker($data_array);

                //// TRCKING CODE ENDS //////

                Yii::$app->db->createCommand("update coe_mark_entry_master set withdraw='wd',updated_by='".$updated_by."',updated_at='".$updated_at."',grade_name='WD' where student_map_id='" . $_POST['stu_map_id'] . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $_POST['withdraw_year'] . "' and month='" . $_POST['withdraw_month'] . "'")->execute();
            } else {
                Yii::$app->db->createCommand("update coe_mark_entry_master set withdraw='NULL', updated_by='".$updated_by."',updated_at='".$updated_at."' where student_map_id='" . $_POST['stu_map_id'] . "' and subject_map_id='" . $_POST['sub_code' . $k] . "' and year='" . $_POST['withdraw_year'] . "' and month='" . $_POST['withdraw_month'] . "'")->execute();
            }
            Yii::$app->ShowFlashMessages->setMsg('Success', 'With Draw Status Updated Successfully!!');
        }
        Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to Withdraw Entry');
        return $this->render('withdraw', ['model' => $model, 'student' => $student, 'subject' => $subject]);
    }
    public function actionWithdrawsublist()
    {
        $det_cat_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%detain%'")->queryScalar();

        $det_disc_type = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Discontinued%'")->queryScalar();

        $year = Yii::$app->request->post('year');
        $month = Yii::$app->request->post('month');
        $sem = Yii::$app->request->post('sem');
        $reg = Yii::$app->request->post('reg');

        $check_result_publish = ConfigUtilities::getResultPublishStatus($year,$month);
        if($check_result_publish==1)
        {
            Yii::$app->ShowFlashMessages->setMsg('Error', 'Results already published');
            //return $this->redirect(['withdraw']);
        }

        $mark_check_fail = Yii::$app->db->createCommand("select coe_subjects_mapping_id,subject_code,subject_name,coe_student_mapping_id from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry_master as E where A.coe_subjects_id=B.subject_id and C.coe_student_id=D.student_rel_id and B.coe_subjects_mapping_id=E.subject_map_id and D.coe_student_mapping_id=E.student_map_id and C.register_number='" . $reg . "' and B.semester<'" . $sem . "' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') and E.year<='" . $year . "' and E.month<='" . $month . "' and result like '%fail%' ")->queryAll();

        $check_withdraw = Yii::$app->db->createCommand("select coe_subjects_mapping_id,subject_code,subject_name,coe_student_mapping_id from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry_master as E where A.coe_subjects_id=B.subject_id and C.coe_student_id=D.student_rel_id and B.coe_subjects_mapping_id=E.subject_map_id and D.coe_student_mapping_id=E.student_map_id and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') and C.register_number='" . $reg . "' and E.withdraw like '%WD%' ")->queryAll();

        if(!empty($mark_check_fail) || !empty($check_withdraw))
        {
            Yii::$app->ShowFlashMessages->setMsg('Error', '<b> '.$reg. ' NOT <b>ELIGIBLE</b> for WITHDRAWAL');
            return $this->redirect(['withdraw']);
        }
        $sub_list = Yii::$app->db->createCommand("select coe_subjects_mapping_id,subject_code,subject_name,coe_student_mapping_id from coe_subjects as A,coe_subjects_mapping as B,coe_student as C,coe_student_mapping as D,coe_mark_entry_master as E where A.coe_subjects_id=B.subject_id and C.coe_student_id=D.student_rel_id and B.coe_subjects_mapping_id=E.subject_map_id and D.coe_student_mapping_id=E.student_map_id and C.register_number='" . $reg . "' and B.semester='" . $sem . "' and status_category_type_id NOT IN('".$det_cat_type."','".$det_disc_type."') and E.year='" . $year . "' and E.month='" . $month . "'")->queryAll();
        $table = '';
        $sn = 1;
        $table .= '<table id="checkAllFeat" class="table table-striped" align="right" border=1>     
                   <thead id="t_head">                                                                                                               
                    <th> S.NO </th> 
                    <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Code </th>
                    <th> ' . ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT) . ' Name </th>  
                    <th> Status </th>
                    </thead><tbody>';
        if (count($sub_list) > 0) 
        {
            foreach ($sub_list as $sublist) {
                $table .= "<tr>" .
                    "<td><input type='hidden' name='sn' value=" . $sn . ">" . $sn . "</td> " .
                    "<td><input type='hidden' name=sub_code" . $sn . " value='" . $sublist['coe_subjects_mapping_id'] . "'>" . $sublist['subject_code'] . "</td>" .
                    "<td><input type='hidden' name=sub_name" . $sn . " value='" . $sublist['subject_name'] . "'>" . $sublist['subject_name'] . "</td>";
                $table .= "<input type='hidden' name='stu_map_id' id='stu_map_id' value='" . $sublist['coe_student_mapping_id'] . "'>";
                $check_mark_entry_master = Yii::$app->db->createCommand("select student_map_id from coe_mark_entry_master where student_map_id='" . $sublist['coe_student_mapping_id'] . "' and subject_map_id='" . $sublist['coe_subjects_mapping_id'] . "' and year='" . $year . "' and month='" . $month . "' and withdraw='wd'")->queryAll();
                if (count($check_mark_entry_master) > 0) {
                    $table .= "</td><td align='center'><input type='checkbox' name=withdraw" . $sn . " checked></td>";
                } else {
                    $table .= "</td><td align='center'><input type='checkbox' onchange='withdraw_check(this.id)' name=withdraw" . $sn . " id=withdraw_" . $sn . "></td>";
                }
                $table .= "</tr>";
                $sn++;
            }
            $table .= "</tbody></table>";
            return $table;
        } else {
            return 0;
        }
    }
    public function actionViewTransparencySubject()
    {
        $model = new Revaluation();
        $markentry = new MarkEntry();
        if (isset($_POST['view_reval_btn'])) 
        {
            $join_in_query='where';
            $select_column = ',A.subject_code,A.subject_name ';
            $add_where_condition = '';
            if(isset($_POST['Revaluation']['is_transparency'][0]) && $_POST['Revaluation']['is_transparency'][0]=='yes')
            {
                $join_in_query = ' JOIN coe_dummy_number as F WHERE F.student_map_id=E.student_map_id and F.subject_map_id=E.subject_map_id and F.year=E.year and F.month=E.month and  ';
                $select_column .= ',F.dummy_number ';
                $add_where_condition = ' and F.year="'.$_POST['mark_year'].'" and F.month="'.$_POST['month'].'"  ';
            }
            
            $revaluation = Yii::$app->db->createCommand("select C.register_number,E.year,DF.description as month,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id JOIN coe_category_type as DF ON DF.coe_category_type_id=E.month ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and  A.subject_code='" . $_POST['subject_code'] . "' $add_where_condition group by C.register_number,A.subject_code order by A.subject_code")->queryAll();
            
            if (count($revaluation) > 0) {
                return $this->render('view-transparency-subject', [
                    'model' => $model,
                    'markentry' => $markentry,
                    'revaluation' => $revaluation,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Tranparancy");
                return $this->render('view-transparency-subject', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Tranparancy');
            return $this->render('view-transparency-subject', [
                'model' => $model,
                'markentry' => $markentry,
            ]);
        }
    }
    public function actionTransparencyViewPdf()
    {
        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
        $content = $_SESSION['transparency_print'];
        //unset($_SESSION['student_application_date']);
        $pdf = new Pdf([
            'mode' => Pdf::MODE_CORE,
            'filename' => 'Tranparancy.pdf',
            'format' => Pdf::FORMAT_A4,
            'orientation' => Pdf::ORIENT_PORTRAIT,
            'content' => $content,
            'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
            'cssInline' => ' @media all{
                        table{border: none; font-family:"Roboto, sans-serif"; width:100%; font-size: 12.5px; }
                    }   
                ',
            'options' => ['title' => 'Tranparancy Data'],
            'methods' => [
                'SetHeader' => ["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name],
                'SetFooter' => ['Tranparancy Data' . ' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
            ]
        ]);
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render();
    }
    public function actionExcelTransparencyview()
    {
        
        $content = $_SESSION['transparency_print'];   
        $fileName = "Tranparancy Data " . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    public function actionViewTransparency()
    {
        $model = new Revaluation();
        $markentry = new MarkEntry();
        if (isset($_POST['view_reval_btn'])) 
        {
            $join_in_query='where';
            $select_column = 'A.subject_code,A.subject_name,B.coe_subjects_mapping_id ';
            $add_where_condition = '';
            if(isset($_POST['Revaluation']['is_transparency'][0]) && $_POST['Revaluation']['is_transparency'][0]=='yes')
            {
                $join_in_query = ' JOIN coe_dummy_number as F WHERE F.student_map_id=E.student_map_id and F.subject_map_id=E.subject_map_id and F.year=E.year and F.month=E.month and ';
                $select_column .= ',F.dummy_number ';
                $add_where_condition = ' and F.year="'.$_POST['mark_year'].'" and F.month="'.$_POST['month'].'"  ';
            }
            
            $revaluation = Yii::$app->db->createCommand("select ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and G.coe_programme_id='".$_POST['bat_map_val']."' $add_where_condition and H.coe_programme_id='".$_POST['bat_map_val']."' group by A.subject_code order by A.subject_code ")->queryAll();

           
            
            if (count($revaluation) > 0) {
                return $this->render('view-transparency', [
                    'model' => $model,
                    'markentry' => $markentry,
                    'revaluation' => $revaluation,
                    'exam_month'=>$_POST['month'],
                    'exam_year'=>$_POST['mark_year']
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Tranparancy");
                return $this->render('view-transparency', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Tranparancy');
            return $this->render('view-transparency', [
                'model' => $model,
                'markentry' => $markentry,
            ]);
        }
    }

    public function actionViewTransparencyDept()
    {
        $model = new Revaluation();
        $markentry = new MarkEntry();
        if (isset($_POST['view_reval_btn'])) 
        {
            $join_in_query='where';
            $select_column = ',A.subject_code,A.subject_name ';
            $add_where_condition = '';
            if(isset($_POST['Revaluation']['is_transparency'][0]) && $_POST['Revaluation']['is_transparency'][0]=='yes')
            {
                $join_in_query = ' JOIN coe_dummy_number as F WHERE F.student_map_id=E.student_map_id and F.subject_map_id=E.subject_map_id and F.year=E.year and F.month=E.month and ';
                $select_column .= ',F.dummy_number ';
                $add_where_condition = ' and F.year="'.$_POST['mark_year'].'" and F.month="'.$_POST['month'].'"  ';
            }
            if(isset($_POST['bat_val']) && !empty($_POST['bat_val']) && isset($_POST['month']) && isset($_POST['bat_map_val']) && !empty($_POST['bat_map_val']))
            {
                $revaluation = Yii::$app->db->createCommand("select C.register_number,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_batch as abc ON abc.coe_batch_id=G.coe_batch_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and G.coe_batch_id='".$_POST['bat_val']."' $add_where_condition and abc.coe_batch_id='".$_POST['bat_val']."' and G.coe_programme_id='".$_POST['bat_map_val']."' and H.coe_programme_id='".$_POST['bat_map_val']."' group by C.register_number,A.subject_code order by A.subject_code")->queryAll();

            }
            else if(isset($_POST['bat_val']) && !empty($_POST['bat_val']) && isset($_POST['month']))
            {
                $revaluation = Yii::$app->db->createCommand("select C.register_number,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_batch as abc ON abc.coe_batch_id=G.coe_batch_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and G.coe_batch_id='".$_POST['bat_val']."' $add_where_condition and abc.coe_batch_id='".$_POST['bat_val']."' group by C.register_number,A.subject_code order by A.subject_code")->queryAll();

            }
            else if(isset($_POST['bat_map_val']) && !empty($_POST['bat_map_val'])  && isset($_POST['month']))
            {
                $revaluation = Yii::$app->db->createCommand("select C.register_number,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and G.coe_programme_id='".$_POST['bat_map_val']."' $add_where_condition and H.coe_programme_id='".$_POST['bat_map_val']."' group by C.register_number,A.subject_code order by A.subject_code")->queryAll();
            }
            else if(isset($_POST['month']))
            {
                $revaluation = Yii::$app->db->createCommand("select C.register_number,C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' $add_where_condition group by C.register_number,A.subject_code order by A.subject_code")->queryAll();
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('Error', 'NO DATA FOUND');
                return $this->render('view-transparency-dept', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }


            
            
            if (count($revaluation) > 0) {
                return $this->render('view-transparency-dept', [
                    'model' => $model,
                    'markentry' => $markentry,
                    'revaluation' => $revaluation,
                ]);
            } else {
                Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Tranparancy");
                return $this->render('view-transparency-dept', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }
        } else {
            Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Tranparancy');
            return $this->render('view-transparency-dept', [
                'model' => $model,
                'markentry' => $markentry,
            ]);
        }
    }
    public function actionUpdateTransparencyDept()
    {
        $model = new Revaluation();
        $markentry = new MarkEntry();
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        $updated_at = date("Y-m-d H:i:s");
        $updated_by = Yii::$app->user->getId();

        if($checkAccess=='Yes')
        {

            if (isset($_POST['view_reval_btn'])) 
            {
                $join_in_query='where';
                $select_column = ',A.subject_code,A.subject_name ';
                $add_where_condition = '';
                $stu_details = Student::findOne(['register_number'=>$_POST['bat_map_val']]);
                $stuMapDet = StudentMapping::findOne(['student_rel_id'=>$stu_details->coe_student_id]);
                if(isset($_POST['Revaluation']['is_transparency'][0]) && $_POST['Revaluation']['is_transparency'][0]=='yes')
                {
                    $join_in_query = ' JOIN coe_dummy_number as F WHERE F.student_map_id=E.student_map_id and F.subject_map_id=E.subject_map_id and F.year=E.year and F.month=E.month and ';
                    $select_column .= ',F.dummy_number ';
                    $add_where_condition = ' and F.year="'.$_POST['mark_year'].'" and F.month="'.$_POST['month'].'"  ';
                }
                $revaluation = Yii::$app->db->createCommand("select C.register_number,E.student_map_id,E.subject_map_id,E.year,E.month,1 as is_checked,E.mark_type, C.name ".$select_column."  from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id JOIN coe_revaluation as E JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id and A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and E.student_map_id='".$stuMapDet->coe_student_mapping_id."' and coe_student_mapping_id='".$stuMapDet->coe_student_mapping_id."' and register_number='".$_POST['bat_map_val']."' $add_where_condition and register_number='".$_POST['bat_map_val']."' group by E.student_map_id,E.subject_map_id order by A.subject_code")->queryAll();

                $revaluation_1 = Yii::$app->db->createCommand("select C.register_number,E.student_map_id,E.subject_map_id,E.year,0 as is_checked,E.month,E.mark_type, C.name ".$select_column." from coe_subjects as A JOIN coe_subjects_mapping as B ON B.subject_id=A.coe_subjects_id JOIN coe_student_mapping as D ON D.course_batch_mapping_id=B.batch_mapping_id  JOIN coe_student as C ON C.coe_student_id=D.student_rel_id  JOIN coe_bat_deg_reg as G ON G.coe_bat_deg_reg_id=D.course_batch_mapping_id and G.coe_bat_deg_reg_id=B.batch_mapping_id JOIN coe_programme as H ON H.coe_programme_id=G.coe_programme_id JOIN coe_mark_entry_master as E ON A.coe_subjects_id=B.subject_id and B.coe_subjects_mapping_id=E.subject_map_id and E.student_map_id=D.coe_student_mapping_id and D.student_rel_id=C.coe_student_id ".$join_in_query."  E.year='" . $_POST['mark_year'] . "' and E.month='" . $_POST['month'] . "' and register_number='".$_POST['bat_map_val']."' $add_where_condition and register_number='".$_POST['bat_map_val']."' and subject_map_id NOT IN(select subject_map_id FROM coe_revaluation where year='".$_POST['mark_year']."' and month='".$_POST['month']."' and student_map_id='".$stuMapDet->coe_student_mapping_id."' ) group by E.student_map_id,E.subject_map_id order by A.subject_code")->queryAll();

                if(!empty($revaluation_1))
                {
                    $revaluation = array_merge($revaluation,$revaluation_1);
                }
                
                if (count($revaluation) > 0) {
                    return $this->render('update-transparency-dept', [
                        'model' => $model,
                        'markentry' => $markentry,
                        'revaluation' => $revaluation,
                    ]);
                } else {
                    Yii::$app->ShowFlashMessages->setMsg('Error', "No data Available for Tranparancy");
                    return $this->render('update-transparency-dept', [
                        'model' => $model,
                        'markentry' => $markentry,
                    ]);
                }
            }
            else if (isset($_POST['view_reval_btn_UPDATE']) && $_POST['view_reval_btn_UPDATE']=='UPDATE') 
            {

                $TOTAL_subs_stu = ($_POST['total_subs']-1);
                $succesS = 0;
                for ($i=1; $i <=$TOTAL_subs_stu ; $i++) 
                {                    
                    if(isset($_POST['checkbox'.$i]) && $_POST['checkbox'.$i]=='YES')
                    {

                        $reval = Revaluation::findOne(['student_map_id'=>$_POST['student_map_id'.$i],'subject_map_id'=>$_POST['subject_map_id'.$i],'year'=>$_POST['year'.$i],'month'=>$_POST['month'.$i],'mark_type'=>$_POST['mark_type'.$i],'is_transparency'=>'S']);

                        $reval_remove = Revaluation::findOne(['student_map_id'=>$_POST['student_map_id'.$i],'subject_map_id'=>$_POST['subject_map_id'.$i],'year'=>$_POST['year'.$i],'month'=>$_POST['month'.$i],'mark_type'=>$_POST['mark_type'.$i],'is_transparency'=>'S','reval_status'=>'YES']);
                        
                        if(empty($reval))
                        {                           
                            $revalInsert = new Revaluation();
                            $revalInsert->student_map_id = $_POST['student_map_id'.$i];
                            $revalInsert->subject_map_id = $_POST['subject_map_id'.$i];
                            $revalInsert->year = $_POST['year'.$i];
                            $revalInsert->month = $_POST['month'.$i];
                            $revalInsert->mark_type = $_POST['mark_type'.$i];
                            $revalInsert->is_transparency = 'S';
                            $revalInsert->reval_status = 'NO';
                            $revalInsert->updated_by = $updated_by;
                            $revalInsert->created_by = $updated_by;
                            $revalInsert->created_at = $updated_at;
                            $revalInsert->updated_at = $updated_at;
                            $revalInsert->save();
                            unset($revalInsert);
                            $succesS++;
                        }
                        if( !empty($reval) && isset($_POST['checkbox_REVAL'.$i]) && $_POST['checkbox_REVAL'.$i]=='YES')
                        {
                          
                          //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Update Revaluation YES ';

                             $data_array = ['subject_map_id'=>$reval['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$reval['month'] ,'exam_year'=>$reval['year'],'student_map_id'=>$reval['student_map_id']];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                        //// TRCKING CODE ENDS //////

                            $command1 = Yii::$app->db->createCommand('UPDATE coe_revaluation SET reval_status="YES",updated_by="'.$updated_by.'",updated_at="'.$updated_at.'" WHERE coe_revaluation_id="'.$reval->coe_revaluation_id.'"');
                            $command1->execute();
                            $succesS++;
                        }
                        else if( !empty($reval_remove) && !isset($_POST['checkbox_REVAL'.$i]) && empty($_POST['checkbox_REVAL'.$i]))
                        {
                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Update Revaluation NO ';

                             $data_array = ['subject_map_id'=>$reval_remove['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$reval_remove['month'] ,'exam_year'=>$reval_remove['year'],'student_map_id'=>$reval_remove['student_map_id']];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                            //// TRCKING CODE ENDS //////

                            $command1 = Yii::$app->db->createCommand('UPDATE coe_revaluation SET reval_status="NO",updated_by="'.$updated_by.'",updated_at="'.$updated_at.'" WHERE coe_revaluation_id="'.$reval_remove->coe_revaluation_id.'"');
                            $command1->execute();
                            $succesS++;
                        }

                    }
                    else
                    {
                        
                        $reval = Revaluation::findOne(['student_map_id'=>$_POST['student_map_id'.$i],'subject_map_id'=>$_POST['subject_map_id'.$i],'year'=>$_POST['year'.$i],'month'=>$_POST['month'.$i],'mark_type'=>$_POST['mark_type'.$i],'is_transparency'=>'S','reval_status'=>'NO']);
                        $reval_yes = Revaluation::findOne(['student_map_id'=>$_POST['student_map_id'.$i],'subject_map_id'=>$_POST['subject_map_id'.$i],'year'=>$_POST['year'.$i],'month'=>$_POST['month'.$i],'mark_type'=>$_POST['mark_type'.$i],'is_transparency'=>'S','reval_status'=>'YES']);

                        if(!empty($reval))
                        {
                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Delete Revaluation ';

                             $data_array = ['subject_map_id'=>$reval['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$reval['month'] ,'exam_year'=>$reval['year'],'student_map_id'=>$reval['student_map_id']];    
                              $update_track = ConfigUtilities::updateTracker($data_array);

                            //// TRCKING CODE ENDS //////

                            $del = Yii::$app->db->createCommand('delete from coe_revaluation where coe_revaluation_id="'.$reval->coe_revaluation_id.'" ');
                            if($del->execute())
                            {
                                $succesS++;
                            }
                            else
                            {
                                 Yii::$app->ShowFlashMessages->setMsg('WARNING', 'SOMETHING WRONG WITH DELETE');
                            }
                        }
                        else if (!empty($reval_yes)) 
                        {
                            //// TRCKING CODE STARTS //////

                             $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Update Revaluation NO ';

                             $data_array = ['subject_map_id'=>$reval_yes['subject_map_id'],'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$reval_yes['month'] ,'exam_year'=>$reval_yes['year'],'student_map_id'=>$reval_yes['student_map_id']];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                            //// TRCKING CODE ENDS //////
                              
                           $command1 = Yii::$app->db->createCommand('UPDATE coe_revaluation SET reval_status="NO",updated_by="'.$updated_by.'",updated_at="'.$updated_at.'" WHERE coe_revaluation_id="'.$reval_yes->coe_revaluation_id.'"');
                            if($command1->execute())
                            {
                                $succesS++;
                            }
                            else
                            {
                                 Yii::$app->ShowFlashMessages->setMsg('WARNING', 'SOMETHING WRONG WITH DELETE');
                            }
                        }
                        
                    }

                }
                Yii::$app->ShowFlashMessages->setMsg('Success', 'Tranparancy / Revaluation Removed / Updated for '.$succesS);
                return $this->redirect(['update-transparency-dept']);

            }
             else {
                Yii::$app->ShowFlashMessages->setMsg('Welcome', 'Welcome to View Tranparancy');
                return $this->render('update-transparency-dept', [
                    'model' => $model,
                    'markentry' => $markentry,
                ]);
            }

        }
        else
        {
            $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;

            //print_r(parse_url($url)); // This will returns the parts of the URL
            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
    }
    protected function valueReplaceNumber($array_data) {
        $array = array('1' => 'FIRST YEAR', '2' => 'FIRST YEAR', '3' => 'SECOND YEAR', '4' => 'SECOND YEAR', '5' => 'THIRD YEAR', '6' => 'THIRD YEAR', '7' => 'FINAL YEAR', '8' => 'FINAL YEAR', '9' => 'FINAL YEAR', '10' => 'FINAL YEAR',''=>'NO DATA FOUND');
        
        return !empty($array[$array_data]) ? $array[$array_data] : 'No Data Found';
    }
    /* 
    * COVID Marks Conversion 
    * Author : Sai Nagendra
    */
    public function actionExternalWightage()
    {
        $model = new MarkEntry();
        if($model->load(Yii::$app->request->post()))
        {
            $session = Yii::$app->session;
            if($session->has('migrate_data'))
            {
                $complete_data = $session->get('migrate_data');
                ExternalWightageMarks::saveData($complete_data);
                MarkEntry::saveRecords($complete_data);
                MarkEntryMaster::saveRecords($complete_data);
                $session->remove('migrate_data');
                Yii::$app->ShowFlashMessages->setMsg('Success','Data Saved Successfully!!');
                return $this->redirect('external-wightage'); 
            }
        }
        else
        {
            return $this->render('external-wightage', [
                'model' => $model,
            ]);
        }
    }
    /* 
    * COVID Marks Conversion 
    * Author : Sai Nagendra
    */
    public function actionGetConversionDetails()
    {
        $session = Yii::$app->session;
        $data = Yii::$app->request->post();
        $MarkEntry = new MarkEntry();
        $studentMarks = $MarkEntry->getStudentMarks($data);
        if($session->has('dataModels'))
        {
            $session->remove('dataModels');
        }
        $session->set('dataModels',$data);
        $content = $this->renderPartial('_conversion_marks', [
            'studentMarks' => $studentMarks,
            'data'=>$data,
        ]);
        if($session->has('migrate_data'))
        {
            $session->remove('migrate_data');
        }
        $session->set('migrate_data',$studentMarks);
        return Json::encode($content);
    }
    /* 
    * COVID Marks Conversion 
    * Sai Nagendra
    */
    public function actionExcelConvertMarks()
    {
        $session = Yii::$app->session;
        $data = $session->get('dataModels');
        
        $MarkEntry = new MarkEntry();
        $studentMarks = $MarkEntry->getStudentMarks($data);

        $content = $this->renderPartial('_conversion_marks', [
            'studentMarks' => $studentMarks,
            'data'=>$data,
        ]);
        
        $session->remove('dataModels');
        $fileName = 'Excel Wightage Marks ' . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }

    /* 
    * COVID Marks Conversion 
    * Author : Sai Nagendra
    */
    public function actionExternalWightageTracker()
    {
        $model = new MarkEntry();
        return $this->render('external-wightage-tracker', [
            'model' => $model,
        ]);
    }

    /* 
    * COVID Marks Conversion 
    * Author : Sai Nagendra
    */
    public function actionGetExternalTracking()
    {
        $session = Yii::$app->session;
        $data = Yii::$app->request->post();
        $MarkEntry = new MarkEntry();
        $studentMarks = $MarkEntry->getWightageTracking($data);
        if($session->has('submittedData'))
        {
            $session->remove('submittedData');
        }
        $session->set('submittedData',$data);
        $content = $this->renderPartial('_external_marks_wightage', [
            'studentMarks' => $studentMarks,
            'data'=>$data,
        ]);
        
        return Json::encode($content);
    }

    /* 
    * COVID Marks Conversion 
    * Sai Nagendra
    */
    public function actionExcelConvertMarksTracker()
    {
        $session = Yii::$app->session;
        $data = $session->get('submittedData');
        
        $MarkEntry = new MarkEntry();
        $studentMarks = $MarkEntry->getWightageTracking($data);

        $content = $this->renderPartial('_external_marks_wightage', [
            'studentMarks' => $studentMarks,
            'data'=>$data,
        ]);
        
        $session->remove('submittedData');
        $fileName = 'Excel Wightage Marks Tracking' . date('Y-m-d-H-i-s') . '.xls';
        $options = ['mimeType' => 'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
}
