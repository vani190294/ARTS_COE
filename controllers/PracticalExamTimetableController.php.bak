<?php

namespace app\controllers;

use Yii;
use yii\db\Query;
use app\models\PracticalExamTimetable;
use app\models\PracticalExamTimetableSearch;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
use yii\filters\VerbFilter;
use app\components\ConfigConstants;
use app\components\ConfigUtilities;
use app\models\PracticalEntry;
use app\models\MarkEntry;
use app\models\StuInfo;
use app\models\UpdateTracker;
use app\models\SubInfo;
use app\models\AbsentEntry;
use app\models\Student;
use app\models\StudentMapping;
use app\models\MarkEntryMaster;
use app\models\SubjectsMapping;
use app\models\Subjects;
use app\models\Categorytype;
use kartik\mpdf\Pdf;
/**
 * PracticalExamTimetableController implements the CRUD actions for PracticalExamTimetable model.
 */
class PracticalExamTimetableController extends Controller
{
    /**
     * @inheritdoc
     */
    public function behaviors()
    {
        return [
            'verbs' => [
                'class' => VerbFilter::className(),
                'actions' => [
                    'delete' => ['POST'],
                ],
            ],
        ];
    }

    /**
     * Lists all PracticalExamTimetable models.
     * @return mixed
     */
    public function actionIndex()
    {
        $searchModel = new PracticalExamTimetableSearch();
        $dataProvider = $searchModel->search(Yii::$app->request->queryParams);
        if(isset($_POST['delete'])  && !empty($_POST['finalString']))
        {
          $finalString = $_POST['finalString'];
          $exam_id = split('[\^]', $finalString);
          $del_ids =[];
          $exam_dates='';
          for($i=0;$i<count($exam_id)-1;$i++)
          {     
            if(!empty($exam_id[$i]))
            {
                $exam_date = PracticalExamTimetable::findOne($exam_id[$i]);                
                $hall_allo_check = PracticalEntry::find()->where(['student_map_id'=>$exam_date['student_map_id'],'subject_map_id'=>$exam_date['subject_map_id'],'year'=>$exam_date['exam_year'],'month'=>$exam_date['exam_month']])->all();                
                $absent_check = AbsentEntry::find()->where(['absent_student_reg'=>$exam_date['student_map_id'],'exam_subject_id'=>$exam_date['subject_map_id']])->all();
                if(empty($absent_check) && empty($hall_allo_check))
                {
                    $del_ids[$exam_id[$i]] = $exam_id[$i];                    
                }          
                $stuInfo = StuInfo::findOne(['stu_map_id'=>$exam_date['student_map_id']]);
                $exam_dates[] = !empty($stuInfo) ? $stuInfo['reg_num'] :'';      
            }            
          }
          $del_ids = array_filter($del_ids);
          $exam_dates = array_unique(array_filter($exam_dates));
          $exam_dates = implode(', ', $exam_dates); 
          $exam_dates = trim($exam_dates,', ');
          if(!empty($del_ids))
          {             
             $query = (new Query)
                        ->createCommand()
                        ->delete('coe_prac_exam_ttable', ['IN','coe_prac_exam_ttable_id',$del_ids])
                        ->execute();
            Yii::$app->ShowFlashMessages->setMsg('Success','Selected Practical '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM). ' Dates <b>'.$exam_dates.'</b> Deleted Successfully!!');
          }
          else
          {
                Yii::$app->ShowFlashMessages->setMsg('Error','Unable to Delete '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM). ' <b>'.$exam_dates.'</b> Mark Entry / Absent Entry Available ');
          }
        }
        return $this->render('index', [
            'searchModel' => $searchModel,
            'dataProvider' => $dataProvider,
        ]);
    }

    /**
     * Displays a single PracticalExamTimetable model.
     * @param integer $id
     * @return mixed
     */
    public function actionView($id)
    {
        return $this->render('view', [
            'model' => $this->findModel($id),
        ]);
    }

    /**
     * Creates a new PracticalExamTimetable model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionCreate()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        if ($model->load(Yii::$app->request->post())) 
        {           
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId(); 
            if(isset($_POST['reg_number']) && count($_POST['reg_number'])>0 && !empty($model->exam_session) && !empty($_POST['exam_date']))
            {
                $checkRegNums = array_filter(['']);
                for ($abse=0; $abse <count($_POST['reg_number']) ; $abse++) 
                { 
                    $checkRegNums[$_POST['reg_number'][$abse]] = $_POST['reg_number'][$abse];  
                }                
                $checkExam = PracticalExamTimetable::find()->where(['exam_year'=>$model->exam_year,'exam_month'=>$model->exam_month,'subject_map_id'=>$model->subject_map_id])->andWhere(['IN','student_map_id',$checkRegNums])->all();               
                if(count($checkExam)>=3)
                {
                    Yii::$app->ShowFlashMessages->setMsg('ERROR',ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' CONDUCTION ALREADY COMPLETED CONTACT COE FOR MORE HELP!!');
                    return $this->redirect(['create']);
                }
                for ($i=0; $i <count($_POST['reg_number']) ; $i++) 
                { 
                    $batch_mapping_id = $model->batch_mapping_id;
                    $exam_year = $model->exam_year;
                    $exam_month = $model->exam_month;
                    $exam_session = $model->exam_session;
                    $subject_map_id = $model->subject_map_id;
                    $exam_date = date('Y-m-d',strtotime($_POST['exam_date']));
                    $check_data = PracticalExamTimetable::find()->where(['exam_year'=>$exam_year,'exam_month'=>$exam_month,'student_map_id'=>$_POST['reg_number'][$i],'exam_date'=>$exam_date,'mark_type'=>$model->mark_type])->all();
                    $check_data_stu = PracticalExamTimetable::find()->where(['exam_year'=>$exam_year,'exam_month'=>$exam_month,'student_map_id'=>$_POST['reg_number'][$i],'exam_date'=>$exam_date,'mark_type'=>$model->mark_type,'exam_session'=>$exam_session])->all();
                    
                    $STUmAP = StudentMapping::findOne($_POST['reg_number'][$i]);
                    $stuData = Student::findOne($STUmAP['student_rel_id']);
                    $getMaxExams = ConfigUtilities::getConfigDesc(ConfigConstants::CONFIG_MAX_PRAC_EXAM_CONDUTION);
                    
                    if(count($check_data)<$getMaxExams && empty($check_data_stu))
                    {
                        $check_same_student = PracticalExamTimetable::find()->where(['exam_year'=>$exam_year,'exam_month'=>$exam_month,'student_map_id'=>$_POST['reg_number'][$i],'exam_date'=>$exam_date,'exam_session'=>$exam_session])->all();
                        if(empty($check_same_student))
                        {
                            $save_model = new PracticalExamTimetable();
                            $save_model->batch_mapping_id = $batch_mapping_id;
                            $save_model->student_map_id = $_POST['reg_number'][$i];
                            $save_model->subject_map_id = $subject_map_id;
                            $save_model->exam_year = $exam_year;
                            $save_model->exam_month = $exam_month;
                            $save_model->mark_type = $model->mark_type;
                            $save_model->term = 34;
                            $save_model->exam_date = $exam_date;
                            $save_model->exam_session = $exam_session;
                            $save_model->internal_examiner_name = $model->internal_examiner_name;
                            $save_model->semester = $model->semester;
                            $save_model->created_at = $created_at;
                            $save_model->created_by = $updateBy;
                            $save_model->updated_at = $created_at;
                            $save_model->updated_by = $updateBy;
                            $save_model->save();
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('ERROR','SESSION ISSUE UNABLE TO CREATE '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' <b>'.$stuData['register_number'].'</b> HAVE ANOTHER EXAM CONTACT COE!!');
                            return $this->redirect(['create']);
                        }

                    }
                    else 
                    {
                        Yii::$app->ShowFlashMessages->setMsg('ERROR','MULTIPLE ' .ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' FOR <b>'.$stuData['register_number'] .'</b> UNABLE TO CREATE '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' CONTACT COE!!');
                        return $this->redirect(['create']);
                    }
                    
                }
                if($i>0)
                {
                    Yii::$app->ShowFlashMessages->setMsg('SUCCESS',ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' CREATED SUCCESSFULLY!! ');
                    $query = new Query();
                    $query->select('C.name,C.register_number,A.exam_year as year ,A.exam_date,H.category_type as exam_session,E.category_type as month,G.subject_code,G.subject_name,internal_examiner_name as examiner_name')
                              ->from('coe_prac_exam_ttable as A')
                              ->join('JOIN','coe_subjects_mapping as F','F.coe_subjects_mapping_id=A.subject_map_id')
                              ->join('JOIN','coe_subjects as G','G.coe_subjects_id=F.subject_id')
                              ->join('JOIN','coe_student_mapping as B','B.course_batch_mapping_id=F.batch_mapping_id and B.coe_student_mapping_id=A.student_map_id')
                              ->join('JOIN','coe_student as C','C.coe_student_id=B.student_rel_id')
                              ->join('JOIN','coe_category_type as E','E.coe_category_type_id=A.exam_month')
                              ->join('JOIN','coe_category_type as H','H.coe_category_type_id=A.exam_session')
                              ->join('JOIN','coe_bat_deg_reg as I','I.coe_bat_deg_reg_id=B.course_batch_mapping_id and I.coe_bat_deg_reg_id=F.batch_mapping_id')
                              ->join('JOIN','coe_batch as J','J.coe_batch_id=I.coe_batch_id');
                    $query->where(['B.course_batch_mapping_id'=>$batch_mapping_id,'A.exam_year'=>$exam_year,'A.exam_month'=>$exam_month,'A.exam_date'=>$exam_date,'A.exam_session'=>$exam_session,'A.subject_map_id'=>$subject_map_id,'F.semester'=>$model->semester,'A.semester'=>$model->semester,'mark_type'=>$model->mark_type])
                          ->andWhere(['BETWEEN','C.register_number',$_POST['from_reg'],$_POST['to_reg']]);
                    if($_POST['MarkEntry']['section']!=='All')
                    {
                        $query->andWhere(['=','B.section_name',$_POST['MarkEntry']['section']]);
                    }
                    $query->groupBy('C.register_number,A.exam_session');
                    $print_for = 'Practical';
                    $get_data = $query->createCommand()->queryAll();

                    if(isset($get_data) && !empty($get_data))
                    {
                        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                        /* 
                        *   Already Defined Variables from the above included file
                        *   $org_name,$org_email,$org_phone,$org_web,$org_address,$org_tagline, 
                        *   use these variables for application
                        *   use $file_content_available="Yes" for Content Status of the Organisation
                        */
                       
                        if($file_content_available=="Yes")
                        {
                            $html = "";
                            $header = "";
                            $body ="";
                            $footer = "";
                            $prev_hall_name = "";
                            $new_stu_flag=0;
                            $print_stu_data ='';
                            $get_page_count = count($get_data);
                            $i=0;
                            $searial_num = 0;
                            $stu_count_break = 1;
                            foreach ($get_data as $value) 
                            {
                                $searial_num++;
                                if($stu_count_break%31==0 || $stu_count_break==1)
                                {
                                    $new_stu_flag=$new_stu_flag + 1;
                                    if($new_stu_flag > 1) 
                                    {
                                            //print_r($new_stu_flag);
                                            $html = $header .$body.$footer; 
                                            $print_stu_data .= $html;
                                            $header = "";
                                            $body ="";
                                            $footer = "";
                                            $new_stu_flag = 1;
                                    }

                                    $header .="<table style='overflow:wrap;font-size:16px;border: 2px solid #999;' class='table table-bordered table-responsive table-hover'>";
                                    $header .= '<tr>
                                    <td colspan=8>
                                        <center><h3>'.strtoupper($org_name).'</h3></center>
                                          
                                     </td>                          
                                    </tr>
                                    <tr>
                                      <td colspan=8 align="center">                               
                                          <center><h4>'.strtoupper($org_address).'<br /> '.strtoupper($org_tagline).'</h4></center>
                                     </td>                          
                                    </tr>
                                    <tr>
                                      <td colspan=8 align="center"> <h4>
                                          ATTENDANCE SHEET FOR SEMESTER EXAMINATIONS : '.$value['month']." - ".$value['year'].' </h4>
                                     </td>                          
                                    </tr>
                                    <tr>
                                      <td colspan=4 align="left"> <h4>
                                          DATE OF EXAMINATION : '.date('d/m/Y',strtotime($value['exam_date']))." <br />
                                          EXAM SESSION : ".$value['exam_session'].' </h4>
                                     </td>   
                                     <td colspan=4 align="left"> <h5><b>
                                          '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' CODE :  '.$value['subject_code'].' </b></h5>
                                          <h5><b>
                                          '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' NAME :  '.$value['subject_name'].'</b></h5>
                                     </td>                       
                                    </tr>
                                   
                                    <tr>
                                     <td align="left"> S.NO </td>
                                     <td align="left"> REGISTER NUMBER </td> 
                                     <td width="150px" colspan=2 align="left"> '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)).' NAME </td> 
                                     <td align="left"> '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)).' CODE </td> 
                                     <td width="100px" colspan=3 align="left"> '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_STUDENT)).'\'S SIGNATURE </td>  
                                    </tr>
                                    ';
                                    $body .='
                                    <tr>
                                        <td height="28px" align="left"> '.$searial_num.'</td>
                                        <td height="28px" align="left" > '.strtoupper($value['register_number']).'</td>
                                        <td width="150px" colspan=2 height="28px" align="left"> '.strtoupper($value['name']).'</td>
                                        <td height="28px" align="left"> '.strtoupper($value['subject_code']).'</td>
                                        <td width="100px" height="28px" colspan=3  align="left"> &nbsp; </td>
                                    </tr>
                                    ';
                                    $footer .='
                                    <tr>
                                        <td height="30px" colspan=8 style="text-transform: uppercase;" > * Mark AB in <b>RED INK</b> if the candidate is ABSENT
                                        </td>
                                    </tr>
                                    <tr>
                                        <td height="30px" colspan=3> PRESENT : </td>
                                        <td> &nbsp; </td>
                                        <td height="30px" colspan=3> ABSENT : </td>
                                        <td> &nbsp; </td>
                                    </tr>
                                    <tr>
                                        <td align="left" colspan=4> '.$value['examiner_name'].' </td>
                                        <td align="left" colspan=4> &nbsp;  </td>
                                    </tr>
                                    <tr>
                                        <td align="left" colspan=4> Internal Examiner With Date </td>
                                        <td align="left" colspan=4> Signature of the External Examiner  </td>
                                    </tr>
                                    </table>
                                    <pagebreak />';

                                }
                                else
                                {
                                    $body .='
                                    <tr>
                                        <td height="28px" align="left"> '.$searial_num.'</td>
                                        <td height="28px" align="left" > '.strtoupper($value['register_number']).'</td>
                                        <td width="150px" colspan=2 height="28px" align="left"> '.strtoupper($value['name']).'</td>
                                        <td height="28px" align="left"> '.strtoupper($value['subject_code']).'</td>
                                        <td width="100px" height="28px" colspan=3 align="left"> &nbsp; </td>
                                    </tr>
                                    ';
                                    
                                } // Else Not the same hall name
                                
                                $stu_count_break = $stu_count_break+1;
                            } // For each Ends Here 
                            $footer = trim($footer,"<pagebreak>");
                            $html = $header .$body.$footer;
                            $print_stu_data .=$html;

                            $content = $print_stu_data;  
                            $pdf = new Pdf([
                               
                                'mode' => Pdf::MODE_CORE,
                                'filename' => 'Attendance Sheet Practical.pdf',                
                                'format' => Pdf::FORMAT_LEGAL,                 
                                'orientation' => Pdf::ORIENT_PORTRAIT,                 
                                'destination' => Pdf::DEST_BROWSER,                 
                                'content' => $content,  
                                'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                                'cssInline' => ' @media all{
                                        table{border-collapse: collapse; font-family:Helvetica Neue, Helvetica, Arial, sans-serif; width:100%;   }

                                        table td table{border: none !important;}
                                        table td{
                                            font-size: 13px !important; 
                                            padding: 1px 0 !important; 
                                            text-align: left;
                                        }
                                        table th{
                                            font-size: 11px !important; 
                                            text-align: left;
                                            padding: 1px 0 !important; 
                                           
                                        }
                                    }   
                                ', 
                                'options' => ['title' => 'Attendance Sheet'],
                                'methods' => [ 
                                    'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                                    'SetFooter'=>['Attendance Sheet Practical'.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                                ]
                            ]);

                        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
                        $headers = Yii::$app->response->headers;
                        $headers->add('Content-Type', 'application/pdf');
                        return $pdf->render();
                    }
                    else{

                         Yii::$app->ShowFlashMessages->setMsg('error',"Not Found the Organisation Information" );
                       return $this->redirect(['create']);
                    }
                }
                else
                {
                     Yii::$app->ShowFlashMessages->setMsg('error',"Not Found the Organisation Information" );
                    return $this->redirect(['create']);
                }

                }
                else
                {
                    Yii::$app->ShowFlashMessages->setMsg('FAILURE','UNABLE TO CREATE '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' CONTACT COE');
                        return $this->redirect(['create']);
                }
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('ERROR','UNABLE TO CREATE '.ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM).' CONTACT COE!');
                return $this->redirect(['create']);
            }
            
            
        } else {
            Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to Practical Exam Timetable');
            return $this->render('create', [
                'model' => $model,
                'student'=>$student,
                'markEntry'=>$markEntry,
                'MarkEntryMaster'=>$MarkEntryMaster,
            ]);
        }
    }

    public function actionAttendanceSheetPractical()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        if ($model->load(Yii::$app->request->post())) 
        {           
            $batch_mapping_id = $model->batch_mapping_id;
            $exam_year = $model->exam_year;
            $exam_month = $model->exam_month;
            $exam_session = $model->exam_session;
            $subject_map_id = $model->subject_map_id;
            $exam_date = date('Y-m-d',strtotime($_POST['exam_date']));   
            $query = new Query();
            $query->select('C.name,C.register_number,A.exam_year as year ,A.exam_date,H.category_type as exam_session,E.category_type as month,G.subject_code,G.subject_name,internal_examiner_name as examiner_name')
                      ->from('coe_prac_exam_ttable as A')
                      ->join('JOIN','coe_subjects_mapping as F','F.coe_subjects_mapping_id=A.subject_map_id')
                      ->join('JOIN','coe_subjects as G','G.coe_subjects_id=F.subject_id')
                      ->join('JOIN','coe_student_mapping as B','B.course_batch_mapping_id=F.batch_mapping_id and B.coe_student_mapping_id=A.student_map_id')
                      ->join('JOIN','coe_student as C','C.coe_student_id=B.student_rel_id')
                      ->join('JOIN','coe_category_type as E','E.coe_category_type_id=A.exam_month')
                      ->join('JOIN','coe_category_type as H','H.coe_category_type_id=A.exam_session')
                      ->join('JOIN','coe_bat_deg_reg as I','I.coe_bat_deg_reg_id=B.course_batch_mapping_id and I.coe_bat_deg_reg_id=F.batch_mapping_id')
                      ->join('JOIN','coe_batch as J','J.coe_batch_id=I.coe_batch_id');
            $query->where(['B.course_batch_mapping_id'=>$batch_mapping_id,'A.exam_year'=>$exam_year,'A.exam_month'=>$exam_month,'A.exam_date'=>$exam_date,'A.exam_session'=>$exam_session,'A.subject_map_id'=>$subject_map_id,'F.semester'=>$model->semester,'A.semester'=>$model->semester,'mark_type'=>$model->mark_type]);
            if($_POST['MarkEntry']['section']!=='All')
            {
                $query->andWhere(['=','B.section_name',$_POST['MarkEntry']['section']]);
            }
            $query->groupBy('C.register_number');
            $print_for = 'Practical';
            $get_data = $query->createCommand()->queryAll();  

            if(isset($get_data) && !empty($get_data))
            {
                return $this->render('attendance-sheet-practical', [
                    'model' => $model,
                    'student'=>$student,
                    'get_data'=>$get_data,
                    'markEntry'=>$markEntry,
                    'MarkEntryMaster'=>$MarkEntryMaster,
                ]);
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('ERROR','NO DATA FOUND');
                return $this->redirect(['attendance-sheet-practical']);
            }   
            
        } else {
            Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to Re Print the Attendance Sheet Practical');
            return $this->render('attendance-sheet-practical', [
                'model' => $model,
                'student'=>$student,
                'markEntry'=>$markEntry,
                'MarkEntryMaster'=>$MarkEntryMaster,
            ]);
        }
    }
    public function actionExternalExaminerReport()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to External Examiner Report');
        return $this->render('external-examiner-report', [
            'model' => $model,
            'student'=>$student,
            'markEntry'=>$markEntry,
            'MarkEntryMaster'=>$MarkEntryMaster,
        ]);
        
    }
    public function actionExternalExaminerReportPdf(){
        
        require(Yii::getAlias('@webroot/includes/use_institute_info.php')); 
        $content = $_SESSION['export_eaminer_repo'];        
        //unset($_SESSION['student_application_date']);
            $pdf = new Pdf([
               
                'mode' => Pdf::MODE_CORE,
                'filename' => 'Practical External Examiners List.pdf',                
                'format' => Pdf::FORMAT_LEGAL,                 
                'orientation' => Pdf::ORIENT_LANDSCAPE,                 
                'destination' => Pdf::DEST_BROWSER,                 
                'content' => $content,  
                'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                'cssInline' => ' @media all{
                        table{border-collapse: collapse; font-family:Helvetica Neue, Helvetica, Arial, sans-serif; width:100%;   }

                        table td table{border: none !important;}
                        table td{
                          white-space: nowrap;
                            font-size: 13px !important; 
                            padding: 1px 0 !important; 
                            text-align: left;
                        }
                        table th{
                            font-size: 11px !important; 
                            text-align: left;
                            padding: 1px 0 !important; 
                           
                        }
                    }   
                ', 
                'options' => ['title' => 'Practical External Examiners List'],
                'methods' => [ 
                    'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                    'SetFooter'=>['Practical External Examiners List'.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                ]
            ]);

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render(); 
    }

    public function actionExcelExternalExaminer()
    {
        $content = $_SESSION['export_eaminer_repo'];
        $fileName ='Practical External Examiners List'.date('Y-m-d-H-i-s').'.xls';        
        $options = ['mimeType'=>'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionAttendanceSheetPracticalPdf(){
        
        require(Yii::getAlias('@webroot/includes/use_institute_info.php')); 
        $content = $_SESSION['Exam_attendance_sheet_practical'];        
        //unset($_SESSION['student_application_date']);
            $pdf = new Pdf([
               
                'mode' => Pdf::MODE_CORE,
                'filename' => 'Attendance Sheet Practical.pdf',                
                'format' => Pdf::FORMAT_LEGAL,                 
                'orientation' => Pdf::ORIENT_PORTRAIT,                 
                'destination' => Pdf::DEST_BROWSER,                 
                'content' => $content,  
                'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                'cssInline' => ' @media all{
                        table{border-collapse: collapse; font-family:Helvetica Neue, Helvetica, Arial, sans-serif; width:100%;   }

                        table td table{border: none !important;}
                        table td{
                            font-size: 13px !important; 
                            padding: 1px 0 !important; 
                            text-align: left;
                        }
                        table th{
                            font-size: 11px !important; 
                            text-align: left;
                            padding: 1px 0 !important; 
                           
                        }
                    }   
                ', 
                'options' => ['title' => 'Attendance Sheet'],
                'methods' => [ 
                    'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                    'SetFooter'=>['Attendance Sheet Practical'.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                ]
            ]);

        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render(); 
    }

    public function actionExcelAttendancePracticalSheet()
    {
        $content = $_SESSION['Exam_attendance_sheet_practical'];
        $fileName ='Attendance-Sheet-'.date('Y-m-d-H-i-s').'.xls';        
        $options = ['mimeType'=>'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    public function actionReportExaminerPracticalPdf(){
        
        require(Yii::getAlias('@webroot/includes/use_institute_info.php')); 
        $content = $_SESSION['reval_course_marks'];        
        //unset($_SESSION['student_application_date']);
            $pdf = new Pdf([
               
                'mode' => Pdf::MODE_CORE,
                'filename' => 'Practical Exams Report.pdf',                
                'format' => Pdf::FORMAT_LEGAL,                 
                'orientation' => Pdf::ORIENT_PORTRAIT,                 
                'destination' => Pdf::DEST_BROWSER,                 
                'content' => $content,  
                'cssFile' => '@vendor/kartik-v/yii2-mpdf/assets/kv-mpdf-bootstrap.min.css',
                'cssInline' => ' @media all{
                        table{border-collapse: collapse; font-family:Helvetica Neue, Helvetica, Arial, sans-serif; width:100%;   }

                        table td table{border: none !important;}
                        table td{
                            font-size: 13px !important; 
                            padding: 1px 0 !important; 
                            text-align: left;
                        }
                        table th{
                            font-size: 11px !important; 
                            text-align: left;
                            padding: 1px 0 !important; 
                           
                        }
                    }   
                ', 
                'options' => ['title' => 'Practical Exams Report'],
                'methods' => [ 
                    'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                    'SetFooter'=>['Practical Exams Report'.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                ]
            ]);
         $pdf->marginTop = "7";
          $pdf->marginLeft = "5.5";
          $pdf->marginRight = "3";
          $pdf->marginBottom = "0";
          $pdf->marginHeader = "3";
          $pdf->marginFooter = "0";
        Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
        $headers = Yii::$app->response->headers;
        $headers->add('Content-Type', 'application/pdf');
        return $pdf->render(); 
    }

    public function actionExcelReportExaminerSheet()
    {
        $content = $_SESSION['reval_course_marks'];
        $fileName ='Practical-Exams-Report'.date('Y-m-d-H-i-s').'.xls';        
        $options = ['mimeType'=>'application/vnd.ms-excel'];
        return Yii::$app->excel->exportExcel($content, $fileName, $options);
    }
    /**
     * Creates a new PracticalExamTimetable model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionMarkEntry()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        if ($model->load(Yii::$app->request->post())) 
        {
           $limit = 38;
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId(); 
            
            if(isset($_POST['reg_number']) && count($_POST['reg_number'])>0 && !empty($model->exam_session) && !empty($model->exam_date))
            {                   
                $chief_exam_name = '';
                $mark_type = $model->mark_type;
                $reguLar = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Regular%'")->queryScalar();
                $get_cat_entry_type = Categorytype::find()->where(['description'=>'Practical Entry'])->orWhere(['category_type'=>'Practical Entry'])->one();
                $absent_entry_type = $get_cat_entry_type['coe_category_type_id'];

                $totalSuccess = '';
                $subject_map_id = $model->subject_map_id;// as subject_id
                $year = $model->exam_year;
                $section_name = $_POST['MarkEntry']['section']!='All'?$_POST['MarkEntry']['section']:'';
                $term = 34;
                $stu_map_id_in = array_filter(['']);
                $totalSuccess = 0;
                $month = $model->exam_month;
                $exam_session=$model->exam_session;
                
                $count_of_reg_num = count($_POST['reg_number']);
                $created_at = date("Y-m-d H:i:s");
                $updateBy = Yii::$app->user->getId(); 
                $subject_map_id_de =SubjectsMapping::findOne($subject_map_id); 
                $subjMax = Subjects::findOne($subject_map_id_de->subject_id);
                if(isset($section_name) && !empty($section_name))
                {
                  $getExternalEntry = Yii::$app->db->createCommand('select A.* FROM coe_prac_exam_ttable  as A join coe_student_mapping as B On A.student_map_id=B.coe_student_mapping_id   where A.exam_year="'.$year.'" and A.exam_month="'.$month.'" and A.subject_map_id="'.$subject_map_id.'" and A.exam_date="'.$model->exam_date.'" and B.section_name="'.$section_name.'" and A.exam_session="'.$exam_session.'"')->QueryOne(); 
                  
                }
                else
                {

                  $getExternalEntry = PracticalExamTimetable::find()->where(['batch_mapping_id'=>$subject_map_id_de['batch_mapping_id'],'subject_map_id'=>$subject_map_id,'exam_year'=>$year,'exam_month'=>$month,'mark_type'=>$mark_type,'exam_session'=>$model->exam_session,'exam_date'=>$model->exam_date])->one();  
                }


                $getExternalExaminer = PracticalExamTimetable::find()->where(['batch_mapping_id'=>$subject_map_id_de['batch_mapping_id'],'subject_map_id'=>$subject_map_id,'exam_year'=>$year,'exam_month'=>$month,'mark_type'=>$mark_type])->one();
                
                $examiner_name = $getExternalEntry['internal_examiner_name'];
                $chief_exam_name =  $getExternalExaminer['external_examiner_name'];

                for($i=0; $i < count($_POST['reg_number']) ; $i++) 
                { 
                    if(!empty($_POST['reg_number'][$i]) && (!empty($_POST['ese_marks'][$i])  || $_POST['ese_marks'][$i]<=0 ) && !empty($getExternalEntry) && !empty($getExternalExaminer))
                    {  

                        $student_map_id = $_POST['reg_number'][$i];
                        $check_inserted = PracticalEntry::find()->where(['year'=>$year,'month'=>$month,'student_map_id'=>$_POST['reg_number'][$i],'subject_map_id'=>$subject_map_id,'mark_type'=>$mark_type])->one();

                        if(empty($check_inserted) && ( $_POST['ese_marks'][$i]=='-1' || $_POST['ese_marks'][$i]<0) )
                        {
                            $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'absent_term'=>$term,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year,'absent_student_reg'=>$_POST['reg_number'][$i]])->all();
                            $absentInsert = new AbsentEntry();
                            $absentInsert->absent_student_reg = $student_map_id;
                            $absentInsert->exam_type = $mark_type;
                            $absentInsert->absent_term = $term;
                            $absentInsert->exam_subject_id = $subject_map_id;
                            $absentInsert->exam_absent_status = $absent_entry_type;
                            $absentInsert->exam_month = $month;
                            $absentInsert->exam_year = $year;
                            $absentInsert->created_by = $updateBy;
                            $absentInsert->updated_by = $updateBy;
                            $absentInsert->created_at = $created_at;
                            $absentInsert->updated_at = $created_at;
                            if(empty($getAbsentList))
                            {
                               $absentInsert->save(false);
                            }
                        }
                        if(empty($check_inserted))
                        {
                            $INSERT_ESE_MARKS = ( $_POST['ese_marks'][$i]=='-1' || $_POST['ese_marks'][$i]<=0) ?0:$_POST['ese_marks'][$i];
                            $converted_ese = (($subjMax->ESE_max*$INSERT_ESE_MARKS)/100);

                            $getDetails = PracticalExamTimetable::find()->where(['student_map_id'=>$_POST['reg_number'][$i],'subject_map_id'=>$subject_map_id,'exam_year'=>$year,'exam_month'=>$month,'mark_type'=>$mark_type])->one();

                            if(!empty($getDetails))
                            {
                              $connection = Yii::$app->db;
                              $command1 = $connection->createCommand('UPDATE coe_prac_exam_ttable SET out_of_100="'.$INSERT_ESE_MARKS.'",ESE="'.$converted_ese.'",updated_by="'.$updateBy.'",updated_at="'.$created_at.'" WHERE coe_prac_exam_ttable_id="'.$getDetails['coe_prac_exam_ttable_id'].'"');
                              $res = $command1->execute();
                            }

                            $model_save = new PracticalEntry();
                            $model_save->student_map_id = $_POST['reg_number'][$i];
                            $model_save->subject_map_id = $subject_map_id;
                            $model_save->out_of_100 = $INSERT_ESE_MARKS;
                            $model_save->ESE =$converted_ese;
                            $model_save->year = $year;
                            $model_save->month = $month;
                            $model_save->term = $term;
                            $model_save->mark_type = $mark_type;
                            $model_save->chief_exam_name = $chief_exam_name;
                            $model_save->examiner_name = $examiner_name;
                            $model_save->created_at = $created_at;
                            $model_save->created_by = $updateBy;
                            $model_save->updated_at = $created_at;
                            $model_save->updated_by = $updateBy;

                            if($model_save->save(false))
                            {
                                $totalSuccess+=1;
                                $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                            }
                            else
                            {
                                $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                            }
                            unset($model_save);
                            $model_save = new PracticalEntry();
                            Yii::$app->ShowFlashMessages->setMsg('Success','Practical Marks Inserted Successfully!!!');
                        }
                        else
                        {
                            Yii::$app->ShowFlashMessages->setMsg('Error','Unable to Insert the Marks');
                        }
                        $stu_map_id_in[$_POST['reg_number'][$i]] = $_POST['reg_number'][$i];
                    }//Not Empty of the Register Number
                   
                } // For Loop
                
                if($totalSuccess>0)
                {

                      $getSubsInfo = new Query();              
                      $getSubsInfo->select(['A.register_number','F.subject_name','F.subject_code','out_of_100','chief_exam_name']);
                      $getSubsInfo->from('coe_subjects_mapping as E')                
                      ->join('JOIN', 'coe_subjects as F', 'F.coe_subjects_id=E.subject_id')
                      ->join('JOIN', 'coe_practical_entry as B', 'B.subject_map_id=E.coe_subjects_mapping_id')
                      ->join('JOIN', 'coe_student_mapping as C', 'C.coe_student_mapping_id=B.student_map_id')
                      ->join('JOIN', 'coe_student as A', 'A.coe_student_id=C.student_rel_id')
                      ->Where(['B.subject_map_id'=>$subject_map_id,'year'=>$year,'month'=>$month,'term'=>$term,'mark_type'=>$mark_type])
                      ->andWhere(['IN','C.coe_student_mapping_id',$stu_map_id_in])
                      ->groupBy('register_number')
                      ->orderBy('register_number')
                      ->limit($limit);                    
                      $getSubsInfoDet = $getSubsInfo->createCommand()->queryAll();
                      $chief_exam_name = '';
                      foreach ($getSubsInfoDet as $key => $examName) 
                      {
                        $chief_exam_name = $examName['chief_exam_name'];
                      }
                      if(!empty($getSubsInfoDet))
                      {
                        require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                        $table='';
                        $get_month_name=Categorytype::findOne($month);
                        $header = $footer = $final_html = $body = '';
                        $header = '<table width="100%" class="table table-bordered table-responsive bulk_edit_table table-hover"  >
                            <tr>
                                    
                                      <td> 
                                        <img width="100" height="100" src="'.Yii::getAlias("@web").'/images/main_logo.png" alt="College Logo">
                                      </td>

                                      <td colspan=2 align="center"> 
                                          <center><b>'.$org_name.'</b></center>
                                          <center> '.$org_address.'</center>
                                          
                                          <center class="tag_line"><b>'.$org_tagline.'</b></center> 
                                     </td>
                                      <td align="center">  
                                        <img width="100" height="100" class="img-responsive" src="'.Yii::getAlias("@web").'/images/skacas.png" alt="College Logo 2">
                                      </td>
                                    </tr>
                                    
                                    
                                    <tr>
                                    <td align="center" colspan=4><h5>PRACTICAL MARK ENTRY FOR EXAMINATIONS '.$year.' - '.strtoupper($get_month_name['description']).'</h5>
                                    </td></tr>
                                    <tr>
                                    <td align="center" colspan=4><h5>MARKS VERIFICATION AND APPROVAL FROM EXAMINER</h5></td></tr>
                                    <tr>                                        
                                        <td align="right" colspan=4>
                                            DATE OF VALUATION : '.date("d/m/Y").'
                                        </td> 
                                    </tr>
                                    <tr>
                                        <td height="15px" align="left" colspan=4> <b>
                                            '.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)." CODE").' : ('.$subjMax->subject_code.') '.$subjMax->subject_name.'</b>
                                        </td>
                                    </tr>
                                    <tr class="table-danger">
                                        <th>SNO</th>  
                                        <th>REGISTER NUMBER</th>
                                        <th>'.strtoupper("Marks Out of 100").'</th>
                                        <th>'.strtoupper("Marks In Words").'</th>
                                    </tr>               
                                    
                                    ';
                          $footer .='<tr class ="alternative_border">
                                <td align="left" colspan=2>
                                    NAME OF THE INTERNAL EXAMINER <br /><br />
                                    '.$examiner_name.' <br />
                                </td>
                                <td align="right" colspan=2>
                                    NAME OF THE EXTERNAL EXAMINER <br /><br />
                                    '.$chief_exam_name.' <br />
                                </td>
                                
                            </tr>
                            <tr>
                                <td align="left" colspan=2>
                                   Signature With Date <br /><br /><br />
                                </td>
                                <td align="right" colspan=2>
                                    Signature With Date <br /><br /><br />
                                </td> 
                            </tr></table>';

                          $increment = 1;
                          $Num_30_nums = 0;
                            foreach ($getSubsInfoDet as $value)
                            {
                                if(isset($value["out_of_100"]))
                                {
                                    $split_number = str_split($value["out_of_100"]);
                                }
                                
                                $print_text = $this->valueReplaceNumber($split_number);
                               $body .='<tr><td>'.$increment.'</td><td>'.$value["register_number"].'</td><td>'.$value["out_of_100"].'</td><td>'.$print_text.'</td></tr>';
                                $increment++;
                                if($increment%31==0)
                                {
                                    $Num_30_nums =1;
                                    $html = $header.$body.$footer;
                                    $final_html .=$html;
                                    $html = $body = '';
                                }
                            }
                            if($Num_30_nums<=30)
                              {
                                $html = $header.$body.$footer;     
                              }                  
                          $final_html .=$html;               
                          $content = $final_html;


                            $pdf = new Pdf([                   
                                'mode' => Pdf::MODE_CORE,                 
                                'filename' => 'PRACTICAL EXAM MARK VERIFICATION.pdf',                
                                'format' => Pdf::FORMAT_A4,                 
                                'orientation' => Pdf::ORIENT_PORTRAIT,                 
                                'destination' => Pdf::DEST_BROWSER,                 
                                'content' => $content,                     
                                'cssInline' => ' @media all{
                                    table{border-collapse: collapse;  text-align: left;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                                    
                                    table td{
                                        border: 1px solid #000;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        text-align: center;
                                    }
                                    table th{
                                        border: 1px solid #000;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        text-align: center;
                                    }
                                }   
                            ',            
                                           
                                'options' => ['title' => strtoupper('PRACTICAL').' MARK VERIFICATION'],
                                'methods' => [ 
                                    'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                                    'SetFooter'=>[strtoupper('PRACTICAL').' MARK VERIFICATION '.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                                ],
                                
                            ]);
                            
                            $pdf->marginLeft="8";
                            $pdf->marginRight="8";
                            $pdf->marginBottom="8";
                            $pdf->marginFooter="8";
                            Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
                            $headers = Yii::$app->response->headers;
                            $headers->add('Content-Type', 'application/pdf');
                            return $pdf->render(); 
                    } // Successfull data Available
                    else
                    {
                         Yii::$app->ShowFlashMessages->setMsg('Error','NO DATA FOUND');
                         return $this->redirect(['mark-entry']);
                    }
                } // Successful insertion
                else
                {
                         Yii::$app->ShowFlashMessages->setMsg('Error','NOTHING INSERTED');
                       return $this->redirect(['mark-entry']);
                }
            }
            else
            {
                Yii::$app->ShowFlashMessages->setMsg('ERROR','KINDLY RESUBMIT THE FORM!!');
                return $this->redirect(['mark-entry']);
            }
            
            
        } else {
            Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to Practical Mark Entry');
            return $this->render('mark-entry', [
                'model' => $model,
                'student'=>$student,
                'markEntry'=>$markEntry,
                'MarkEntryMaster'=>$MarkEntryMaster,
            ]);
        }
    }
    /**
     * Creates a new PracticalExamTimetable model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionEditMarkEntry()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        $ip_address = Yii::$app->params['ipAddress'];
        if($checkAccess=='Yes')
        {
          if ($model->load(Yii::$app->request->post())) 
          {
              $created_at = date("Y-m-d H:i:s");
              $updateBy = Yii::$app->user->getId(); 
              
              if(isset($_POST['reg_number']) && count($_POST['reg_number'])>0 && !empty($model->exam_session) && !empty($model->exam_date))
              {                    
                  $chief_exam_name = '';
                  $mark_type = $model->mark_type;
                  $reguLar = Yii::$app->db->createCommand("select coe_category_type_id from coe_category_type where category_type like '%Regular%'")->queryScalar();
                  $get_cat_entry_type = Categorytype::find()->where(['description'=>'Practical Entry'])->orWhere(['category_type'=>'Practical Entry'])->one();
                  $absent_entry_type = $get_cat_entry_type['coe_category_type_id'];

                  $totalSuccess = '';
                  $subject_map_id = $model->subject_map_id;// as subject_id
                  $year = $model->exam_year;
                  $term = 34;
                  $stu_map_id_in = array_filter(['']);
                  $totalSuccess = 0;
                  $month = $model->exam_month;
                  
                  $count_of_reg_num = count($_POST['reg_number']);
                  $created_at = date("Y-m-d H:i:s");
                  $updateBy = Yii::$app->user->getId(); 
                  $subject_map_id_de =SubjectsMapping::findOne($subject_map_id); 
                  $subjMax = Subjects::findOne($subject_map_id_de->subject_id);

                  $getExternalEntry = PracticalExamTimetable::find()->where(['batch_mapping_id'=>$subject_map_id_de['batch_mapping_id'],'subject_map_id'=>$subject_map_id,'exam_year'=>$year,'exam_month'=>$month,'mark_type'=>$mark_type,'exam_session'=>$model->exam_session,'exam_date'=>$model->exam_date])->one();
                  
                  $examiner_name = $getExternalEntry['internal_examiner_name'];
                  $chief_exam_name =  $getExternalEntry['external_examiner_name'];
                  $failedJobs = '';
                  for($i=0; $i < count($_POST['reg_number']) ; $i++) 
                  { 
                      if(!empty($_POST['reg_number'][$i]) && (!empty($_POST['ese_marks'][$i])  || $_POST['ese_marks'][$i]==0 || $_POST['ese_marks'][$i]<=0 ) && !empty($getExternalEntry))
                      {  
                        $student_map_id = $_POST['reg_number'][$i];
                         $stuMapid = StudentMapping::findOne($student_map_id);
                          $stuReg = Student::findOne($stuMapid['student_rel_id']);
                          $check_inserted = PracticalEntry::find()->where(['year'=>$year,'month'=>$month,'student_map_id'=>$_POST['reg_number'][$i],'subject_map_id'=>$subject_map_id,'mark_type'=>$mark_type])->one();

                          if(!empty($check_inserted) && ( $_POST['ese_marks'][$i]=='-1' || $_POST['ese_marks'][$i]<=0 ) )
                          {
                            //// TRCKING CODE STARTS //////

                            $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                            $data_updated = 'Prev ESE '.$check_inserted['out_of_100'].' New ESE -1 Entry';
                            $data_array = ['subject_map_id'=>$subject_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$student_map_id];            
                            $update_track = ConfigUtilities::updateTracker($data_array);
                            //// TRCKING CODE ENDS //////

                              $delete_data = Yii::$app->db->createCommand('DELETE FROM coe_practical_entry WHERE coe_practical_entry_id ="'.$check_inserted['coe_practical_entry_id'].'"')->execute();
                              if(!empty($delete_data))
                              {
                                $getAbsentList = AbsentEntry::find()->where(['exam_type'=>$mark_type,'absent_term'=>$term,'exam_subject_id'=>$subject_map_id,'exam_month'=>$month,'exam_year'=>$year,'absent_student_reg'=>$_POST['reg_number'][$i]])->all();
                                $absentInsert = new AbsentEntry();
                                $absentInsert->absent_student_reg = $student_map_id;
                                $absentInsert->exam_type = $mark_type;
                                $absentInsert->absent_term = $term;
                                $absentInsert->exam_subject_id = $subject_map_id;
                                $absentInsert->exam_absent_status = $absent_entry_type;
                                $absentInsert->exam_month = $month;
                                $absentInsert->exam_year = $year;
                                $absentInsert->created_by = $updateBy;
                                $absentInsert->updated_by = $updateBy;
                                $absentInsert->created_at = $created_at;
                                $absentInsert->updated_at = $created_at;
                                if(empty($getAbsentList))
                                {
                                   $absentInsert->save(false);
                                }
                              }
                              else{
                                $failedJobs .=$stuReg['register_number'].', ';
                              }                            
                          }
                          $connection = Yii::$app->db;
                          if(!empty($check_inserted))
                          {
                              $INSERT_ESE_MARKS = ($_POST['ese_marks'][$i]=='-1' || $_POST['ese_marks'][$i]<=0)?0:$_POST['ese_marks'][$i];
                              $converted_ese = (($subjMax->ESE_max*$INSERT_ESE_MARKS)/100);
                              
                              //// TRCKING CODE STARTS //////
                              
                              $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                              $data_updated = 'Prev ESE '.$check_inserted['ESE'].' New ESE '.$converted_ese.' Entry';
                              $data_array = ['subject_map_id'=>$subject_map_id,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$month,'exam_year'=>$year,'student_map_id'=>$student_map_id];            
                              $update_track = ConfigUtilities::updateTracker($data_array);

                              //// TRCKING CODE ENDS //////
                              
                              $getDetails = PracticalExamTimetable::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id,'exam_year'=>$year,'exam_month'=>$month,'mark_type'=>$mark_type])->one();

                              if(!empty($getDetails))
                              {
                                $connection = Yii::$app->db;
                                $command1 = $connection->createCommand('UPDATE coe_prac_exam_ttable SET out_of_100="'.$INSERT_ESE_MARKS.'",ESE="'.$converted_ese.'",updated_by="'.$updateBy.'",updated_at="'.$created_at.'" WHERE coe_prac_exam_ttable_id="'.$getDetails['coe_prac_exam_ttable_id'].'"');
                                $res = $command1->execute();
                              }
                              $res_1  = '';
                              $getDetailsPrac = PracticalEntry::find()->where(['student_map_id'=>$student_map_id,'subject_map_id'=>$subject_map_id,'year'=>$year,'month'=>$month,'mark_type'=>$mark_type])->one();

                              if(!empty($getDetailsPrac))
                              {
                                $connection = Yii::$app->db;
                                $command1 = $connection->createCommand('UPDATE coe_practical_entry SET out_of_100="'.$INSERT_ESE_MARKS.'",ESE="'.$converted_ese.'",updated_by="'.$updateBy.'",updated_at="'.$created_at.'" WHERE coe_practical_entry_id="'.$getDetailsPrac['coe_practical_entry_id'].'"');
                                $res_1 = $command1->execute();
                              }

                              if(isset($res_1) && !empty($res_1))
                              {
                                  $totalSuccess+=1;
                                  $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                              }
                              else
                              {
                                 $failedJobs .=$stuReg['register_number'].', ';
                                  $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                              }
                              Yii::$app->ShowFlashMessages->setMsg('Success','Practical Marks Updated Successfully!!!');
                          }
                          else
                          {
                              Yii::$app->ShowFlashMessages->setMsg('Error','Unable to Insert the Marks');
                          }
                          $stu_map_id_in[$_POST['reg_number'][$i]] = $_POST['reg_number'][$i];
                      }//Not Empty of the Register Number
                     
                  } // For Loop

                   if($totalSuccess>0)
                  {
                      Yii::$app->ShowFlashMessages->setMsg('SUCCESS','DATA UPDATED SUCCESSFULLY!!');
                      return $this->redirect(['edit-mark-entry']);  
                  } // Successful insertion
                  else
                  {
                      Yii::$app->ShowFlashMessages->setMsg('ERROR',$failedJobs.' UPDATING ERROR');
                      return $this->redirect(['edit-mark-entry']);  
                  }
              }
              else
              {
                  Yii::$app->ShowFlashMessages->setMsg('ERROR','KINDLY RESUBMIT THE FORM!!');
                  return $this->redirect(['edit-mark-entry']);
              }
              
              
          } else {
              Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to EDIT Practical Mark Entry');
              return $this->render('edit-mark-entry', [
                  'model' => $model,
                  'student'=>$student,
                  'markEntry'=>$markEntry,
                  'MarkEntryMaster'=>$MarkEntryMaster,
              ]);
          }
        }
        else
        {
          $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;

            //print_r(parse_url($url)); // This will returns the parts of the URL
            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
    }

    /**
     * Creates a new PracticalExamTimetable model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionAllocateExaminer()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());
        if($checkAccess=='Yes')
        {
            if ($model->load(Yii::$app->request->post())) 
            {          
                if(isset($_POST['sub_map_id']) && count($_POST['sub_map_id'])>0 && !empty($_POST['examiner_name']) )
                { 
                    $totalSuccess = '';
                    $year = $model->exam_year;
                    $term = 34;
                    $stu_map_id_in = array_filter(['']);
                    $totalSuccess = 0;
                    $month = $model->exam_month;
                    $exam_session=$model->exam_session;
                    $section_name=$_POST['MarkEntry']['section']=='All' ?'NO':$_POST['MarkEntry']['section'];
                    $get_session = Categorytype::findOne($exam_session);
                    $connection = Yii::$app->db;
                    $created_at = date("Y-m-d H:i:s");
                    $updateBy = Yii::$app->user->getId(); 

                    if($section_name==='NO')
                    {
                      Yii::$app->ShowFlashMessages->setMsg('ERROR','SECTION NOT SELECTED KINDLY RESUBMIT THE FORM WITH PROPER SECTION NAME!!');
                      return $this->redirect(['allocate-examiner']);
                    }
                    for($i=0; $i < count($_POST['sub_map_id']) ; $i++) 
                    { 

                        if(!empty($_POST['sub_map_id'][$i]) && !empty($_POST['examiner_name'][$i]) )
                        {  
                            $examiner_name = $_POST['examiner_name'][$i];
                            $subject_map_id = $_POST['sub_map_id'][$i];
                            if(isset($exam_session) && !empty($exam_session))
                            {
                              $check_inserted = PracticalExamTimetable::find()->where(['exam_year'=>$year,'exam_month'=>$month,'subject_map_id'=>$subject_map_id,'exam_session'=>$exam_session])->one();  
                            }
                            else
                            {
                              $check_inserted = PracticalExamTimetable::find()->where(['exam_year'=>$year,'exam_month'=>$month,'subject_map_id'=>$subject_map_id])->one();
                            }

                            if(!empty($check_inserted))
                            {
                                 $exam_dates =DATE('Y-m-d', strtotime($_POST['exam_dates'][$i]));
                                 if(isset($section_name) && !empty($section_name)  &&  !empty($_POST['exam_session']) )
                                  { 
                                    $update_query = $connection->createCommand('UPDATE coe_prac_exam_ttable  as A join coe_student_mapping as B On A.student_map_id=B.coe_student_mapping_id  set external_examiner_name="'.$examiner_name.'",A.updated_at="'.$created_at.'",A.updated_by="'.$updateBy.'"    where A.exam_year="'.$year.'" and A.exam_month="'.$month.'" and A.subject_map_id="'.$subject_map_id.'" and A.exam_date="'.$exam_dates.'" and B.section_name="'. $section_name.'" and A.exam_session="'.$exam_session.'"')->execute();

                                  }
                                  else if(isset($section_name) && !empty($section_name))
                                  {
                                   
                                      $update_query = $connection->createCommand('UPDATE coe_prac_exam_ttable  as A join coe_student_mapping as B On A.student_map_id=B.coe_student_mapping_id  set external_examiner_name="'.$examiner_name.'",A.updated_at="'.$created_at.'",A.updated_by="'.$updateBy.'" where A.exam_year="'.$year.'" and A.exam_month="'.$month.'" and A.subject_map_id="'.$subject_map_id.'" and A.exam_date="'.$exam_dates.'" and B.section_name="'. $section_name.'"')->execute();
                                  }
                                  else
                                  {
                                   
                                   $update_query = $connection->createCommand('UPDATE coe_prac_exam_ttable set external_examiner_name="'.$examiner_name.'",updated_at="'.$created_at.'",updated_by="'.$updateBy.'" where exam_year="'.$year.'" and exam_month="'.$month.'" and subject_map_id="'.$subject_map_id.'" and exam_date="'.$exam_dates.'"')->execute();

                                  }
                            
                               if($update_query)
                                {
                                    $totalSuccess+=1;
                                    $dispResults[] = ['type' => 'S',  'message' => 'Success'];    
                                }
                                else
                                {
                                    $dispResults[] = ['type' => 'E',  'message' => 'Error'];
                                }                            
                                Yii::$app->ShowFlashMessages->setMsg('Success','Practical External Examiner Updated Successfully!!!');
                            }
                            else
                            {
                                Yii::$app->ShowFlashMessages->setMsg('Error','Unable to Update the record');
                            }
                            
                        }//Not Empty of the Register Number
                       
                    } // For Loop
                    
                     if($totalSuccess>0)
                    {
                     
                        $getSubsInfo = new Query();              
                        $getSubsInfo->select(['external_examiner_name','F.subject_name','F.subject_code','B.exam_date','degree_code','programme_code','z.category_type','r.section_name','internal_examiner_name']);
                        $getSubsInfo->from('coe_subjects_mapping as E')                
                        ->join('JOIN', 'coe_subjects as F', 'F.coe_subjects_id=E.subject_id')
                        ->join('JOIN', 'coe_prac_exam_ttable as B', 'B.subject_map_id=E.coe_subjects_mapping_id and B.batch_mapping_id=E.batch_mapping_id')
                        ->join('JOIN', 'coe_bat_deg_reg as C', 'C.coe_bat_deg_reg_id=B.batch_mapping_id and C.coe_bat_deg_reg_id=E.batch_mapping_id')
                        ->join('JOIN', 'coe_degree as D', 'D.coe_degree_id=C.coe_degree_id')
                        ->join('JOIN', 'coe_programme as A', 'A.coe_programme_id=C.coe_programme_id')
                         ->join('JOIN', 'coe_category_type as  z', 'z.coe_category_type_id=B.exam_session')
                         ->join('JOIN', 'coe_student_mapping as  r', 'r.coe_student_mapping_id=B.student_map_id')

                        ->Where(['exam_year'=>$year,'exam_month'=>$month]);


                        if(isset($_POST['PracticalExamTimetable']['batch_mapping_id']))
                        {
                          $getSubsInfo->andWhere(['=','E.batch_mapping_id',$_POST['PracticalExamTimetable']['batch_mapping_id']])
                                      ->andWhere(['=','B.batch_mapping_id',$_POST['PracticalExamTimetable']['batch_mapping_id']]);   
                        }
                         if(isset($exam_dates) && !empty($exam_dates) )
                        {
                             $getSubsInfo->andWhere(['B.exam_date'=>$exam_dates]);
                         }

                          if(isset($exam_session) && !empty($exam_session) )
                        {
                             $getSubsInfo->andWhere(['B.exam_session'=>$exam_session]);
                         }

                      
                       $getSubsInfo->groupBy('subject_code,exam_date,exam_session,internal_examiner_name')
                         ->orderBy('exam_date');                    
                        $getSubsInfoDet = $getSubsInfo->createCommand()->queryAll();
                        
                        if(!empty($getSubsInfoDet))
                        {
                            require(Yii::getAlias('@webroot/includes/use_institute_info.php'));
                            $table='';
                            $get_month_name=Categorytype::findOne($month);
                            $header = $footer = $final_html = $body = '';
                            $header = '<table width="100%" class="table table-bordered table-responsive bulk_edit_table table-hover"  >
                                <tr>
                                        
                                          <td> 
                                            <img width="100" height="100" src="'.Yii::getAlias("@web").'/images/main_logo.png" alt="College Logo">
                                          </td>

                                          <td colspan=5 align="center"> 
                                              <center><b>'.$org_name.'</b></center>
                                              <center> '.$org_address.'</center>
                                              
                                              <center class="tag_line"><b>'.$org_tagline.'</b></center> 
                                         </td>
                                          <td align="center">  
                                            <img width="100" height="100" class="img-responsive" src="'.Yii::getAlias("@web").'/images/skacas.png" alt="College Logo 2">
                                          </td>
                                        </tr>
                                        
                                        
                                        <tr>
                                        <td align="center" colspan=7><h5>PRACTICAL EXAMINATIONS '.$year.' - '.strtoupper($get_month_name['description']).' EXTERNAL EXAMINER\' LIST </h5>
                                        </td></tr>
                                        <tr>
                                       
                                        <tr class="table-danger">
                                            <th>SNO</th>  
                                            <th>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_EXAM)).'</th>
                                            <th>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_DEGREE)." CODE").'</th>
                                            <th>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)." CODE").'</th>
                                            <th>'.strtoupper(ConfigUtilities::getConfigValue(ConfigConstants::CONFIG_SUBJECT)." NAME").'</th>
                                            <th>Exam Session</th>
                                            <th>'.strtoupper("External Examiner").'</th>
                                        </tr>               
                                        
                                        ';
                             

                              $increment = 1;
                              $Num_30_nums = 0;
                                foreach ($getSubsInfoDet as $value)
                                {
                                   
                                   $body .='<tr><td>'.$increment.'</td><td>'.DATE('d-m-Y',strtotime($value["exam_date"])).'</td><td>'.$value["degree_code"].'-'.$value["programme_code"].'</td><td>'.$value["subject_code"].'</td><td>'.strtoupper($value["subject_name"]).'</td><td>'.$value["category_type"].'</td><td>'.$value["external_examiner_name"].'</td></tr>';
                                    $increment++;
                                    if($increment%31==0)
                                    {
                                        $Num_30_nums =1;
                                        $html = $header.$body.'</table>';
                                        $final_html .=$html;
                                        $html = $body = '';
                                    }
                                }
                                if($Num_30_nums<=30)
                                  {
                                    $html = $header.$body.'</table>';     
                                  }                  
                              $final_html .=$html;               
                              $content = $final_html;


                                $pdf = new Pdf([                   
                                    'mode' => Pdf::MODE_CORE,                 
                                    'filename' => 'PRACTICAL EXTERNAL EXAMINER VERIFICATION REPORT.pdf',                
                                    'format' => Pdf::FORMAT_A4,                 
                                    'orientation' => Pdf::ORIENT_PORTRAIT,                 
                                    'destination' => Pdf::DEST_BROWSER,                 
                                    'content' => $content,                     
                                    'cssInline' => ' @media all{
                                        table{border-collapse: collapse;  text-align: left;  font-family:"Roboto, sans-serif"; width:100%; font-size: 15px; } 
                                        
                                        table td{
                                            border: 1px solid #000;
                                            white-space: nowrap;
                                            overflow: hidden;
                                            text-overflow: ellipsis;
                                            text-align: center;
                                        }
                                        table th{
                                            border: 1px solid #000;
                                            white-space: nowrap;
                                            overflow: hidden;
                                            text-overflow: ellipsis;
                                            text-align: center;
                                        }
                                    }   
                                ',            
                                               
                                    'options' => ['title' => strtoupper('PRACTICAL').' EXTERNAL EXAMINER '],
                                    'methods' => [ 
                                        'SetHeader'=>["OFFICE OF THE CONTROLLER OF EXAMINATIONS ".$org_name], 
                                        'SetFooter'=>[strtoupper('PRACTICAL').' EXTERNAL EXAMINER VERIFICATION REPORT '.' PRINTED ON : {DATE d-m-Y H:i:s:A}  PAGE :{PAGENO}'],
                                    ],
                                    
                                ]);
                                
                                $pdf->marginLeft="8";
                                $pdf->marginRight="8";
                                $pdf->marginBottom="8";
                                $pdf->marginFooter="8";
                                Yii::$app->response->format = \yii\web\Response::FORMAT_RAW;
                                $headers = Yii::$app->response->headers;
                                $headers->add('Content-Type', 'application/pdf');
                                return $pdf->render(); 
                        } // Successfull data Available
                        else
                        {
                             Yii::$app->ShowFlashMessages->setMsg('Error','NO DATA FOUND');
                             return $this->redirect(['allocate-examiner']);
                        }
                    } // Successful insertion
                    else
                    {
                         Yii::$app->ShowFlashMessages->setMsg('Error','Unable to save records');
                         return $this->redirect(['allocate-examiner']);
                    }
                }
                else
                {
                    Yii::$app->ShowFlashMessages->setMsg('ERROR','KINDLY RESUBMIT THE FORM!!');
                    return $this->redirect(['allocate-examiner']);
                }
                
                
            } else {
                Yii::$app->ShowFlashMessages->setMsg('WELCOME','WELCOME TO PRACTICAL EXAMINER ALLOCATION');
                return $this->render('allocate-examiner', [
                    'model' => $model,
                    'student'=>$student,
                    'markEntry'=>$markEntry,
                    'MarkEntryMaster'=>$MarkEntryMaster,
                ]);
            }
        }
        else
        {
            $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;

            //print_r(parse_url($url)); // This will returns the parts of the URL
            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
        
    }

    /**
     * Updates an existing PracticalExamTimetable model.
     * If update is successful, the browser will be redirected to the 'view' page.
     * @param integer $id
     * @return mixed
     */
    public function actionReportExaminer()
    {
        $model = new PracticalExamTimetable();
        if ($model->load(Yii::$app->request->post())) 
        {
            return $this->redirect(['report-examiner']);
        } else {
            return $this->render('report-examiner', [
                'model' => $model,
            ]);
        }
    }

    /**
     * Updates an existing PracticalExamTimetable model.
     * If update is successful, the browser will be redirected to the 'view' page.
     * @param integer $id
     * @return mixed
     */
    public function actionUpdate($id)
    {
      $checkAccess = ConfigUtilities::HasSuperAccess(Yii::$app->user->getId());

      if($checkAccess=='Yes')
      {
          $model = $this->findModel($id);
          if ($model->load(Yii::$app->request->post()) && isset($_POST['PracticalExamTimetable']['out_of_100']) && !empty($_POST['PracticalExamTimetable']['out_of_100']) ) 
          {
            
            $changeEse = $_POST['PracticalExamTimetable']['out_of_100'];
            if(!empty($changeEse) && $changeEse<=100 )
            {  
               $updaeQuery = Yii::$app->db->createCommand('UPDATE coe_prac_exam_ttable set out_of_100 = "'.$changeEse.'" WHERE coe_prac_exam_ttable_id="'.$id.'" ')->execute();
               Yii::$app->ShowFlashMessages->setMsg('Success','Updated Successfully!!!');
            }//Not Empty of the Register Number
              return $this->redirect(['index']);
          } 
          else 
          {
              return $this->render('update_stu_data', [
                  'model' => $model,        
              ]);
          }
      }
      else
        {
            $lockUser = Yii::$app->db->createCommand('UPDATE user SET status="11" WHERE id="'.Yii::$app->user->getId().'"')->execute();
            $created_by = $updated_by = Yii::$app->user->getId();
            $created_at = $updated_at = date("Y-m-d H:i:s");
            $protocol = ((!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] != 'off') || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
            $url = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];

            $filename =  Yii::getAlias("@webroot").'/access_logs/log_'.date("j.n.Y").'.txt';
            $content  = "User Name: ".Yii::$app->user->getUsername().' - '.date("F j, Y, g:i a").PHP_EOL.
                        "Accessed URLS: ".$url.PHP_EOL.
                        "----------------------------------------------------------------".PHP_EOL;            
            $removed_path = str_replace('index.php', '', parse_url($url, PHP_URL_PATH));
            $image_path = parse_url($url, PHP_URL_SCHEME)."://".parse_url($url, PHP_URL_HOST).parse_url($url, PHP_URL_PORT).$removed_path.'images/notfound.png'; 
            
            $image_path = Yii::getAlias("@web").'/images/notfound.png'; 

            if(file_put_contents($filename, $content.PHP_EOL , FILE_APPEND | LOCK_EX))
            {   
                $file_content = file_get_contents($filename, true);
                echo "<div style='width:1000px;  text-align: center; margin: 0 auto;'><img src='".$image_path."' alt='not found' height='600' width='900' align='center' /></div>";
                
            }
            unset($_SESSION);
            session_destroy();
            Yii::$app->ShowFlashMessages->setMsg('Error','OOOPS You are not allowed!!! Your Account is Locked!!!');
            return $this->redirect(['site/index']);            
        }
      
    }

    /**
     * Deletes an existing PracticalExamTimetable model.
     * If deletion is successful, the browser will be redirected to the 'index' page.
     * @param integer $id
     * @return mixed
     */
    public function actionDelete($id)
    {
        $this->findModel($id)->delete();

        return $this->redirect(['index']);
    }

    /**
     * Finds the PracticalExamTimetable model based on its primary key value.
     * If the model is not found, a 404 HTTP exception will be thrown.
     * @param integer $id
     * @return PracticalExamTimetable the loaded model
     * @throws NotFoundHttpException if the model cannot be found
     */
    protected function findModel($id)
    {
        if (($model = PracticalExamTimetable::findOne($id)) !== null) {
            return $model;
        } else {
            throw new NotFoundHttpException('The requested page does not exist.');
        }
    }
    protected function valueReplaceNumber($array_data)
    {
        $array= array('0'=>'ZERO','1'=>'ONE','2'=>'TWO','3'=>'THREE','4'=>'FOUR','5'=>'FIVE','6'=>'SIX','7'=>'SEVEN','8'=>'EIGHT','9'=>'NINE','10'=>'TEN','-'=>'ABSENT');  
        $return_string='';
        for($i=0;$i<count($array_data);$i++)
        {
            $return_string .=$array[$array_data[$i]]." ";
        }
        return !empty($return_string)?$return_string:'No Data Found';
           
    }
    /**
     * Creates a new PracticalExamTimetable model.
     * If creation is successful, the browser will be redirected to the 'view' page.
     * @return mixed
     */
    public function actionEditDates()
    {
        $model = new PracticalExamTimetable();
        $markEntry = new MarkEntry();
        $student = new Student();
        $MarkEntryMaster = new MarkEntryMaster();
        if ($model->load(Yii::$app->request->post())) 
        {           
            $created_at = date("Y-m-d H:i:s");
            $updateBy = Yii::$app->user->getId(); 
            
            if(isset($_POST['prac_id']) && count($_POST['prac_id']>0) && !empty($_POST['reason']) && !empty($_POST['new_exam_date']))
            {
                $new_exam_date = $_POST['new_exam_date'];
                $prev_exam_date = $model->exam_date;
                $reason = $_POST['reason'];
                for($i=0;$i<count($_POST['prac_id']);$i++)
                {
                  $exam_update = PracticalExamTimetable::findOne(['exam_year'=>$model->exam_year,'exam_month'=>$model->exam_month,'exam_date'=>$prev_exam_date,'exam_session'=>$model->exam_session,'subject_map_id'=>$_POST['sub_map_id'][$i],'student_map_id'=>$_POST['reg_number'][$i]]);
                  if(!empty($exam_update))
                  {
                    $exam_update->updateAttributes(['exam_date'=>$new_exam_date,'update_reason'=>$reason]);
                  }
                  
                }
                //// TRCKING CODE STARTS //////
                              
                $updated_from = ucwords( str_replace('-', ' ', Yii::$app->controller->action->controller->id.' '.Yii::$app->controller->action->id) );
                $data_updated = 'Practical Exam Dates Updated New Exam Date : '.$new_exam_date.' Prev Exam Date '.$prev_exam_date.' Reason : '.$reason;
                $data_array = ['subject_map_id'=>0,'updated_link_from'=>$updated_from,'data_updated'=>nl2br($data_updated),'exam_month'=>$model->exam_month,'exam_year'=>$model->exam_year,'student_map_id'=>0];            
                $update_track = ConfigUtilities::updateTracker($data_array);

                //// TRCKING CODE ENDS //////

            }
            Yii::$app->ShowFlashMessages->setMsg('Success','EXAM DATES UPDATE SUCCESSFULLY!!!');
            return $this->redirect(['edit-dates']);
            
            
        } else {
            Yii::$app->ShowFlashMessages->setMsg('WELCOME','Welcome to Practical Edit Exam Timetable');
            return $this->render('edit-dates', [
                'model' => $model,
                'student'=>$student,
                'markEntry'=>$markEntry,
                'MarkEntryMaster'=>$MarkEntryMaster,
            ]);
        }
    }
}
